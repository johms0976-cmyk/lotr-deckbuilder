<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOTR Deckbuilder v0.4</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
const { useState, useEffect, useCallback, useRef, useMemo, useReducer, memo } = React;

// ============================================
// PERFORMANCE: Memoized deck operations
// ============================================
const createMemoizedDeckOperations = () => ({
  shuffleDeck: (deck) => {
    const shuffled = [...deck];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  },
  
  drawCards: (count, drawPile, discardPile, hand) => {
    let newDrawPile = drawPile.slice(); // More efficient than spread for large arrays
    let newDiscardPile = discardPile.slice();
    let newHand = hand.slice();
    
    for (let i = 0; i < count && (newDrawPile.length > 0 || newDiscardPile.length > 0); i++) {
      if (newDrawPile.length === 0) {
        // Shuffle discard into draw pile
        for (let j = newDiscardPile.length - 1; j > 0; j--) {
          const k = Math.floor(Math.random() * (j + 1));
          [newDiscardPile[j], newDiscardPile[k]] = [newDiscardPile[k], newDiscardPile[j]];
        }
        newDrawPile = newDiscardPile;
        newDiscardPile = [];
      }
      if (newDrawPile.length > 0) {
        newHand.push(newDrawPile.pop());
      }
    }
    return { newHand, newDrawPile, newDiscardPile };
  }
});

// ============================================
// DATA PERSISTENCE: Robust storage with error handling
// ============================================
class GameStorage {
  static KEYS = {
    PLAYER_PROGRESS: 'lotrDeckbuilderProgress',
    SAVED_GAME: 'lotrDeckbuilderSave',
    SETTINGS: 'lotrDeckbuilderSettings'
  };

  static async save(data, key = GameStorage.KEYS.SAVED_GAME) {
    try {
      const serialized = JSON.stringify(data);
      localStorage.setItem(key, serialized);
      return true;
    } catch (error) {
      console.error('Save failed:', error);
      GameStorage.handleStorageError(error);
      return false;
    }
  }

  static load(key = GameStorage.KEYS.SAVED_GAME) {
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error('Load failed:', error);
      GameStorage.handleStorageError(error);
      return null;
    }
  }

  static delete(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error('Delete failed:', error);
      return false;
    }
  }

  static handleStorageError(error) {
    if (error.name === 'QuotaExceededError') {
      console.warn('Storage quota exceeded. Consider clearing old data.');
    }
    // Could add user notification here
  }

  static isAvailable() {
    try {
      const test = '__storage_test__';
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
      return true;
    } catch (e) {
      return false;
    }
  }
}

// ============================================
// ACCESSIBILITY: Screen reader announcements
// ============================================
const useGameAnnouncements = () => {
  const announce = useCallback((message, priority = 'polite') => {
    const announcement = document.createElement('div');
    announcement.setAttribute('aria-live', priority);
    announcement.setAttribute('aria-atomic', 'true');
    announcement.className = 'sr-only';
    announcement.style.cssText = 'position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;';
    announcement.textContent = message;
    
    document.body.appendChild(announcement);
    setTimeout(() => {
      if (document.body.contains(announcement)) {
        document.body.removeChild(announcement);
      }
    }, 1000);
  }, []);

  return { announce };
};

// ============================================
// ANIMATION: Reduced motion support
// ============================================
const useAnimationSettings = () => {
  const [animationsEnabled, setAnimationsEnabled] = useState(true);
  
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    setAnimationsEnabled(!mediaQuery.matches);
    
    const handler = (e) => setAnimationsEnabled(!e.matches);
    mediaQuery.addEventListener('change', handler);
    return () => mediaQuery.removeEventListener('change', handler);
  }, []);

  return { animationsEnabled };
};

// ============================================
// MOBILE: Touch and haptic feedback
// ============================================
const useMobileEnhancements = () => {
  const playHaptic = useCallback((intensity = 50) => {
    if (navigator.vibrate) {
      navigator.vibrate(intensity);
    }
  }, []);

  const [isMobile, setIsMobile] = useState(false);
  
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth <= 768 || 'ontouchstart' in window);
    };
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  return { playHaptic, isMobile };
};

// ============================================
// COMBAT STATE MACHINE: Prevents race conditions
// ============================================
const COMBAT_STATES = {
  IDLE: 'idle',
  INITIALIZING: 'initializing',
  DEALING_CARDS: 'dealing_cards',
  PLAYER_TURN: 'player_turn',
  PLAYING_CARD: 'playing_card',
  ENDING_TURN: 'ending_turn',
  ENEMY_TURN: 'enemy_turn',
  ENEMY_ACTING: 'enemy_acting',
  CHECKING_VICTORY: 'checking_victory',
  COMBAT_END: 'combat_end'
};

const combatStateReducer = (state, action) => {
  switch (action.type) {
    case 'START_COMBAT':
      return { ...state, phase: COMBAT_STATES.INITIALIZING };
    case 'CARDS_DEALT':
      return { ...state, phase: COMBAT_STATES.PLAYER_TURN };
    case 'PLAY_CARD':
      return { ...state, phase: COMBAT_STATES.PLAYING_CARD };
    case 'CARD_PLAYED':
      return { ...state, phase: COMBAT_STATES.PLAYER_TURN };
    case 'END_TURN':
      return { ...state, phase: COMBAT_STATES.ENDING_TURN };
    case 'START_ENEMY_TURN':
      return { ...state, phase: COMBAT_STATES.ENEMY_TURN };
    case 'ENEMY_ACTION':
      return { ...state, phase: COMBAT_STATES.ENEMY_ACTING };
    case 'ENEMY_DONE':
      return { ...state, phase: COMBAT_STATES.PLAYER_TURN, turnNumber: state.turnNumber + 1 };
    case 'CHECK_VICTORY':
      return { ...state, phase: COMBAT_STATES.CHECKING_VICTORY };
    case 'COMBAT_END':
      return { ...state, phase: COMBAT_STATES.COMBAT_END };
    case 'RESET':
      return { phase: COMBAT_STATES.IDLE, turnNumber: 1 };
    default:
      return state;
  }
};

// ============================================
// TIMER MANAGEMENT: Prevents memory leaks
// ============================================
const useTimerManager = () => {
  const timersRef = useRef([]);
  
  const addTimer = useCallback((callback, delay) => {
    const id = setTimeout(() => {
      callback();
      timersRef.current = timersRef.current.filter(t => t !== id);
    }, delay);
    timersRef.current.push(id);
    return id;
  }, []);
  
  const clearAllTimers = useCallback(() => {
    timersRef.current.forEach(clearTimeout);
    timersRef.current = [];
  }, []);
  
  useEffect(() => {
    return () => clearAllTimers();
  }, [clearAllTimers]);
  
  return { addTimer, clearAllTimers };
};

// ============================================
// SVG CHARACTER PORTRAITS
// ============================================

// Aragorn/Strider - Rugged ranger with hood
const AragornSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="aragornHood" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#4a3728"/>
        <stop offset="50%" stopColor="#2d1f14"/>
        <stop offset="100%" stopColor="#1a0f08"/>
      </linearGradient>
      <linearGradient id="aragornSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#d4a574"/>
        <stop offset="100%" stopColor="#b8956e"/>
      </linearGradient>
      <linearGradient id="aragornHair" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#2d1810"/>
        <stop offset="100%" stopColor="#1a0d08"/>
      </linearGradient>
      <radialGradient id="aragornBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3d4a3d"/>
        <stop offset="100%" stopColor="#1a2418"/>
      </radialGradient>
      <filter id="aragornShadow">
        <feDropShadow dx="0" dy="2" stdDeviation="3" floodOpacity="0.5"/>
      </filter>
    </defs>
    <rect width="120" height="168" fill="url(#aragornBg)"/>
    {/* Hood */}
    <ellipse cx="60" cy="25" rx="55" ry="35" fill="url(#aragornHood)"/>
    <path d="M5 25 Q60 -10 115 25 L115 90 Q60 110 5 90 Z" fill="url(#aragornHood)" filter="url(#aragornShadow)"/>
    {/* Face */}
    <ellipse cx="60" cy="75" rx="32" ry="40" fill="url(#aragornSkin)"/>
    {/* Hair falling from hood */}
    <path d="M30 50 Q25 80 35 110" stroke="url(#aragornHair)" strokeWidth="8" fill="none"/>
    <path d="M90 50 Q95 80 85 110" stroke="url(#aragornHair)" strokeWidth="8" fill="none"/>
    <path d="M35 55 Q30 75 40 95" stroke="url(#aragornHair)" strokeWidth="5" fill="none"/>
    <path d="M85 55 Q90 75 80 95" stroke="url(#aragornHair)" strokeWidth="5" fill="none"/>
    {/* Eyebrows */}
    <path d="M40 62 Q50 58 55 62" stroke="#2d1810" strokeWidth="2.5" fill="none"/>
    <path d="M65 62 Q70 58 80 62" stroke="#2d1810" strokeWidth="2.5" fill="none"/>
    {/* Eyes */}
    <ellipse cx="48" cy="70" rx="7" ry="5" fill="#fff"/>
    <ellipse cx="72" cy="70" rx="7" ry="5" fill="#fff"/>
    <circle cx="48" cy="70" r="4" fill="#4a6741"/>
    <circle cx="72" cy="70" r="4" fill="#4a6741"/>
    <circle cx="49" cy="69" r="2" fill="#1a2418"/>
    <circle cx="73" cy="69" r="2" fill="#1a2418"/>
    <circle cx="50" cy="68" r="1" fill="#fff"/>
    <circle cx="74" cy="68" r="1" fill="#fff"/>
    {/* Nose */}
    <path d="M60 70 L58 82 Q60 85 62 82 L60 70" fill="#c49564" stroke="#b8856e" strokeWidth="0.5"/>
    {/* Stubble */}
    <ellipse cx="60" cy="95" rx="20" ry="12" fill="#c49564" opacity="0.6"/>
    {/* Mouth */}
    <path d="M52 90 Q60 94 68 90" stroke="#8b6040" strokeWidth="2" fill="none"/>
    {/* Beard stubble texture */}
    <g fill="#3d2817" opacity="0.4">
      <circle cx="45" cy="92" r="0.8"/><circle cx="48" cy="95" r="0.8"/><circle cx="52" cy="97" r="0.8"/>
      <circle cx="56" cy="98" r="0.8"/><circle cx="60" cy="99" r="0.8"/><circle cx="64" cy="98" r="0.8"/>
      <circle cx="68" cy="97" r="0.8"/><circle cx="72" cy="95" r="0.8"/><circle cx="75" cy="92" r="0.8"/>
      <circle cx="50" cy="100" r="0.8"/><circle cx="55" cy="102" r="0.8"/><circle cx="60" cy="103" r="0.8"/>
      <circle cx="65" cy="102" r="0.8"/><circle cx="70" cy="100" r="0.8"/>
    </g>
    {/* Cloak clasp */}
    <circle cx="60" cy="125" r="8" fill="#d4af37" stroke="#8b7355" strokeWidth="2"/>
    <path d="M56 125 L60 120 L64 125 L60 130 Z" fill="#1a0f08"/>
    {/* Shoulders/Cloak */}
    <path d="M0 130 Q30 115 60 125 Q90 115 120 130 L120 168 L0 168 Z" fill="url(#aragornHood)"/>
    {/* Ranger star brooch detail */}
    <path d="M60 122 L61 124 L63 124 L61.5 125.5 L62 128 L60 126.5 L58 128 L58.5 125.5 L57 124 L59 124 Z" fill="#d4af37"/>
  </svg>
);

// Legolas - Elven archer with blonde hair
const LegolasSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="legolasHair" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#f4e4bc"/>
        <stop offset="50%" stopColor="#d4c49c"/>
        <stop offset="100%" stopColor="#c4a47c"/>
      </linearGradient>
      <linearGradient id="legolasSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#fce4d4"/>
        <stop offset="100%" stopColor="#e8d0c0"/>
      </linearGradient>
      <linearGradient id="legolasCloak" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#2d5a3d"/>
        <stop offset="100%" stopColor="#1a3828"/>
      </linearGradient>
      <radialGradient id="legolasBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#4a6a5a"/>
        <stop offset="100%" stopColor="#1a3828"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#legolasBg)"/>
    {/* Long flowing hair */}
    <ellipse cx="60" cy="50" rx="45" ry="40" fill="url(#legolasHair)"/>
    <path d="M15 50 Q10 100 25 150" stroke="url(#legolasHair)" strokeWidth="25" fill="none"/>
    <path d="M105 50 Q110 100 95 150" stroke="url(#legolasHair)" strokeWidth="25" fill="none"/>
    <path d="M25 45 Q20 90 30 140" stroke="#d4c49c" strokeWidth="15" fill="none"/>
    <path d="M95 45 Q100 90 90 140" stroke="#d4c49c" strokeWidth="15" fill="none"/>
    {/* Face */}
    <ellipse cx="60" cy="70" rx="28" ry="35" fill="url(#legolasSkin)"/>
    {/* Pointed elf ears */}
    <path d="M28 60 Q15 50 22 35 Q30 45 32 55 Z" fill="url(#legolasSkin)" stroke="#e8c0b0" strokeWidth="1"/>
    <path d="M92 60 Q105 50 98 35 Q90 45 88 55 Z" fill="url(#legolasSkin)" stroke="#e8c0b0" strokeWidth="1"/>
    {/* Elegant eyebrows */}
    <path d="M40 58 Q50 54 58 58" stroke="#c4a47c" strokeWidth="1.5" fill="none"/>
    <path d="M62 58 Q70 54 80 58" stroke="#c4a47c" strokeWidth="1.5" fill="none"/>
    {/* Elven eyes - larger and more luminous */}
    <ellipse cx="48" cy="65" rx="8" ry="6" fill="#fff"/>
    <ellipse cx="72" cy="65" rx="8" ry="6" fill="#fff"/>
    <circle cx="48" cy="65" r="5" fill="#6ba3c7"/>
    <circle cx="72" cy="65" r="5" fill="#6ba3c7"/>
    <circle cx="48" cy="65" r="3" fill="#2d5a7a"/>
    <circle cx="72" cy="65" r="3" fill="#2d5a7a"/>
    <circle cx="49" cy="64" r="1.5" fill="#fff"/>
    <circle cx="73" cy="64" r="1.5" fill="#fff"/>
    {/* Delicate nose */}
    <path d="M60 65 L58 78 Q60 80 62 78 L60 65" fill="#e8c0b0"/>
    {/* Subtle mouth */}
    <path d="M54 86 Q60 89 66 86" stroke="#c49a8a" strokeWidth="1.5" fill="none"/>
    {/* Elven circlet */}
    <path d="M32 45 Q60 35 88 45" stroke="#d4af37" strokeWidth="2" fill="none"/>
    <circle cx="60" cy="40" r="4" fill="#d4af37"/>
    <path d="M60 36 L62 40 L60 44 L58 40 Z" fill="#90ee90"/>
    {/* Green tunic/cloak */}
    <path d="M0 130 Q30 110 60 120 Q90 110 120 130 L120 168 L0 168 Z" fill="url(#legolasCloak)"/>
    {/* Collar detail */}
    <path d="M40 120 Q60 130 80 120" stroke="#1a3828" strokeWidth="3" fill="none"/>
    {/* Leaf brooch */}
    <ellipse cx="60" cy="135" rx="8" ry="5" fill="#4a8a5a" transform="rotate(-30 60 135)"/>
    <path d="M60 130 L60 140" stroke="#2d5a3d" strokeWidth="1"/>
  </svg>
);

// Gandalf - Grey wizard with staff
const GandalfSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gandalfRobe" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8a8a9a"/>
        <stop offset="50%" stopColor="#6a6a7a"/>
        <stop offset="100%" stopColor="#4a4a5a"/>
      </linearGradient>
      <linearGradient id="gandalfBeard" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#e8e8e8"/>
        <stop offset="100%" stopColor="#c0c0c0"/>
      </linearGradient>
      <linearGradient id="gandalfSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#e8d4c4"/>
        <stop offset="100%" stopColor="#d4c0b0"/>
      </linearGradient>
      <radialGradient id="gandalfBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#5a5a6a"/>
        <stop offset="100%" stopColor="#2a2a3a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#gandalfBg)"/>
    {/* Pointed wizard hat */}
    <path d="M60 0 L90 55 Q60 65 30 55 Z" fill="url(#gandalfRobe)" stroke="#3a3a4a" strokeWidth="1"/>
    <ellipse cx="60" cy="55" rx="35" ry="12" fill="url(#gandalfRobe)"/>
    {/* Hat brim shadow */}
    <ellipse cx="60" cy="57" rx="35" ry="10" fill="#3a3a4a" opacity="0.3"/>
    {/* Face */}
    <ellipse cx="60" cy="80" rx="25" ry="28" fill="url(#gandalfSkin)"/>
    {/* Bushy eyebrows */}
    <path d="M38 72 Q48 65 55 72" stroke="#c0c0c0" strokeWidth="4" fill="none"/>
    <path d="M65 72 Q72 65 82 72" stroke="#c0c0c0" strokeWidth="4" fill="none"/>
    {/* Wise eyes */}
    <ellipse cx="47" cy="78" rx="6" ry="4" fill="#fff"/>
    <ellipse cx="73" cy="78" rx="6" ry="4" fill="#fff"/>
    <circle cx="47" cy="78" r="3" fill="#4a6a8a"/>
    <circle cx="73" cy="78" r="3" fill="#4a6a8a"/>
    <circle cx="48" cy="77" r="1" fill="#fff"/>
    <circle cx="74" cy="77" r="1" fill="#fff"/>
    {/* Prominent nose */}
    <path d="M60 78 Q55 90 58 95 Q60 97 62 95 Q65 90 60 78" fill="#d4b0a0"/>
    {/* Long flowing beard */}
    <path d="M35 90 Q30 100 35 130 Q50 150 60 168" fill="url(#gandalfBeard)"/>
    <path d="M85 90 Q90 100 85 130 Q70 150 60 168" fill="url(#gandalfBeard)"/>
    <path d="M40 92 Q60 100 80 92 Q85 110 80 140 Q60 165 40 140 Q35 110 40 92" fill="url(#gandalfBeard)"/>
    {/* Beard texture */}
    <path d="M45 100 Q50 120 48 140" stroke="#d0d0d0" strokeWidth="2" fill="none"/>
    <path d="M55 98 Q58 125 55 150" stroke="#d0d0d0" strokeWidth="2" fill="none"/>
    <path d="M65 98 Q62 125 65 150" stroke="#d0d0d0" strokeWidth="2" fill="none"/>
    <path d="M75 100 Q70 120 72 140" stroke="#d0d0d0" strokeWidth="2" fill="none"/>
    {/* Mustache */}
    <path d="M45 92 Q52 88 60 92 Q68 88 75 92" fill="url(#gandalfBeard)"/>
    {/* Robe shoulders */}
    <path d="M0 100 Q30 90 60 95 Q90 90 120 100 L120 168 L0 168 Z" fill="url(#gandalfRobe)"/>
    {/* Robe details */}
    <path d="M50 95 L50 168" stroke="#5a5a6a" strokeWidth="2"/>
    <path d="M70 95 L70 168" stroke="#5a5a6a" strokeWidth="2"/>
  </svg>
);

// Gimli - Dwarf warrior with axe
const GimliSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gimliHelm" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8a7a6a"/>
        <stop offset="50%" stopColor="#6a5a4a"/>
        <stop offset="100%" stopColor="#4a3a2a"/>
      </linearGradient>
      <linearGradient id="gimliSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#e8c4a4"/>
        <stop offset="100%" stopColor="#d4a484"/>
      </linearGradient>
      <linearGradient id="gimliBeard" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8b4513"/>
        <stop offset="50%" stopColor="#a0522d"/>
        <stop offset="100%" stopColor="#6b3510"/>
      </linearGradient>
      <linearGradient id="gimliArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#5a5a6a"/>
        <stop offset="50%" stopColor="#4a4a5a"/>
        <stop offset="100%" stopColor="#3a3a4a"/>
      </linearGradient>
      <radialGradient id="gimliBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#4a4a5a"/>
        <stop offset="100%" stopColor="#2a2a3a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#gimliBg)"/>
    {/* Dwarf helm with nose guard */}
    <ellipse cx="60" cy="35" rx="42" ry="32" fill="url(#gimliHelm)"/>
    <path d="M18 35 Q60 5 102 35" fill="url(#gimliHelm)" stroke="#3a2a1a" strokeWidth="2"/>
    {/* Helm decorations */}
    <ellipse cx="60" cy="18" rx="8" ry="5" fill="#d4af37"/>
    <path d="M35 25 L30 15 L38 22" fill="url(#gimliHelm)"/>
    <path d="M85 25 L90 15 L82 22" fill="url(#gimliHelm)"/>
    {/* Nose guard */}
    <path d="M55 40 L60 65 L65 40" fill="url(#gimliHelm)" stroke="#3a2a1a" strokeWidth="1"/>
    {/* Face - stocky and broad */}
    <ellipse cx="60" cy="65" rx="30" ry="28" fill="url(#gimliSkin)"/>
    {/* Bushy eyebrows */}
    <path d="M30 52 Q42 46 55 54" stroke="#5a3010" strokeWidth="5" fill="none"/>
    <path d="M65 54 Q78 46 90 52" stroke="#5a3010" strokeWidth="5" fill="none"/>
    {/* Fierce eyes */}
    <ellipse cx="42" cy="60" rx="7" ry="5" fill="#fff"/>
    <ellipse cx="78" cy="60" rx="7" ry="5" fill="#fff"/>
    <circle cx="42" cy="60" r="4" fill="#5a3a1a"/>
    <circle cx="78" cy="60" r="4" fill="#5a3a1a"/>
    <circle cx="43" cy="59" r="1.5" fill="#fff"/>
    <circle cx="79" cy="59" r="1.5" fill="#fff"/>
    {/* Ruddy cheeks */}
    <ellipse cx="35" cy="70" rx="8" ry="5" fill="#d4846a" opacity="0.4"/>
    <ellipse cx="85" cy="70" rx="8" ry="5" fill="#d4846a" opacity="0.4"/>
    {/* Broad nose */}
    <ellipse cx="60" cy="72" rx="8" ry="6" fill="#d4946a"/>
    {/* Magnificent beard - very long and braided */}
    <path d="M25 75 Q20 90 25 130 Q40 160 50 168" fill="url(#gimliBeard)"/>
    <path d="M95 75 Q100 90 95 130 Q80 160 70 168" fill="url(#gimliBeard)"/>
    <path d="M30 78 Q60 95 90 78 Q100 100 90 140 Q60 168 30 140 Q20 100 30 78" fill="url(#gimliBeard)"/>
    {/* Beard braids */}
    <path d="M40 85 Q35 110 40 145 Q45 160 50 168" stroke="#6b3510" strokeWidth="3" fill="none"/>
    <path d="M80 85 Q85 110 80 145 Q75 160 70 168" stroke="#6b3510" strokeWidth="3" fill="none"/>
    {/* Beard rings/beads */}
    <circle cx="40" cy="110" r="3" fill="#d4af37"/>
    <circle cx="80" cy="110" r="3" fill="#d4af37"/>
    <circle cx="42" cy="135" r="3" fill="#d4af37"/>
    <circle cx="78" cy="135" r="3" fill="#d4af37"/>
    {/* Mustache */}
    <path d="M40 78 Q50 74 60 78 Q70 74 80 78" fill="url(#gimliBeard)"/>
    <path d="M42 80 Q48 76 55 80" stroke="#8b4513" strokeWidth="2" fill="none"/>
    <path d="M65 80 Q72 76 78 80" stroke="#8b4513" strokeWidth="2" fill="none"/>
    {/* Mouth in beard */}
    <path d="M50 82 Q60 86 70 82" stroke="#6a4030" strokeWidth="2" fill="none"/>
    {/* Heavy armor shoulders */}
    <path d="M0 95 Q30 80 60 90 Q90 80 120 95 L120 168 L0 168 Z" fill="url(#gimliArmor)"/>
    {/* Chainmail texture */}
    <ellipse cx="30" cy="120" rx="15" ry="10" fill="none" stroke="#5a5a6a" strokeWidth="1"/>
    <ellipse cx="60" cy="115" rx="15" ry="10" fill="none" stroke="#5a5a6a" strokeWidth="1"/>
    <ellipse cx="90" cy="120" rx="15" ry="10" fill="none" stroke="#5a5a6a" strokeWidth="1"/>
    <ellipse cx="45" cy="135" rx="15" ry="10" fill="none" stroke="#5a5a6a" strokeWidth="1"/>
    <ellipse cx="75" cy="135" rx="15" ry="10" fill="none" stroke="#5a5a6a" strokeWidth="1"/>
    {/* Belt with axe symbol */}
    <rect x="20" y="145" width="80" height="8" fill="#4a3a2a"/>
    <ellipse cx="60" cy="149" rx="8" ry="4" fill="#d4af37"/>
    <path d="M57 147 L60 145 L63 147 L63 153 L60 151 L57 153 Z" fill="#3a3a4a"/>
  </svg>
);

// Orc Warrior - Green brutish creature
const OrcSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="orcSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#5a7a4a"/>
        <stop offset="100%" stopColor="#3a5a2a"/>
      </linearGradient>
      <linearGradient id="orcArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#4a4a4a"/>
        <stop offset="50%" stopColor="#3a3a3a"/>
        <stop offset="100%" stopColor="#2a2a2a"/>
      </linearGradient>
      <radialGradient id="orcBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#4a3a2a"/>
        <stop offset="100%" stopColor="#2a1a0a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#orcBg)"/>
    {/* Crude helmet */}
    <ellipse cx="60" cy="35" rx="40" ry="30" fill="url(#orcArmor)"/>
    <path d="M20 35 Q60 10 100 35" fill="url(#orcArmor)" stroke="#1a1a1a" strokeWidth="2"/>
    {/* Helmet spike */}
    <path d="M60 5 L65 25 L55 25 Z" fill="#5a5a5a" stroke="#3a3a3a" strokeWidth="1"/>
    {/* Brutish face */}
    <ellipse cx="60" cy="75" rx="35" ry="40" fill="url(#orcSkin)"/>
    {/* Prominent brow ridge */}
    <path d="M25 55 Q60 45 95 55 Q95 65 60 70 Q25 65 25 55" fill="#4a6a3a"/>
    {/* Angry eyes */}
    <ellipse cx="45" cy="65" rx="10" ry="6" fill="#8a0a0a"/>
    <ellipse cx="75" cy="65" rx="10" ry="6" fill="#8a0a0a"/>
    <circle cx="45" cy="65" r="4" fill="#ffcc00"/>
    <circle cx="75" cy="65" r="4" fill="#ffcc00"/>
    <circle cx="45" cy="65" r="2" fill="#1a0a0a"/>
    <circle cx="75" cy="65" r="2" fill="#1a0a0a"/>
    {/* Flat nose */}
    <ellipse cx="60" cy="82" rx="10" ry="8" fill="#4a6a3a"/>
    <circle cx="55" cy="84" r="3" fill="#3a5a2a"/>
    <circle cx="65" cy="84" r="3" fill="#3a5a2a"/>
    {/* Tusks */}
    <path d="M40 95 Q35 110 38 120" fill="#e8e0c0" stroke="#c0b890" strokeWidth="1"/>
    <path d="M80 95 Q85 110 82 120" fill="#e8e0c0" stroke="#c0b890" strokeWidth="1"/>
    {/* Mouth with teeth */}
    <path d="M40 95 Q60 105 80 95" fill="#2a1a0a"/>
    <path d="M45 95 L48 102" stroke="#c0b890" strokeWidth="2"/>
    <path d="M55 97 L56 103" stroke="#c0b890" strokeWidth="2"/>
    <path d="M65 97 L64 103" stroke="#c0b890" strokeWidth="2"/>
    <path d="M75 95 L72 102" stroke="#c0b890" strokeWidth="2"/>
    {/* Scars */}
    <path d="M75 55 L85 75" stroke="#2a4a1a" strokeWidth="2"/>
    <path d="M30 70 L40 80" stroke="#2a4a1a" strokeWidth="2"/>
    {/* Crude armor */}
    <path d="M0 115 Q30 100 60 110 Q90 100 120 115 L120 168 L0 168 Z" fill="url(#orcArmor)"/>
    {/* Armor details - studs */}
    <circle cx="30" cy="130" r="4" fill="#5a5a5a" stroke="#3a3a3a" strokeWidth="1"/>
    <circle cx="60" cy="125" r="4" fill="#5a5a5a" stroke="#3a3a3a" strokeWidth="1"/>
    <circle cx="90" cy="130" r="4" fill="#5a5a5a" stroke="#3a3a3a" strokeWidth="1"/>
    <circle cx="45" cy="145" r="4" fill="#5a5a5a" stroke="#3a3a3a" strokeWidth="1"/>
    <circle cx="75" cy="145" r="4" fill="#5a5a5a" stroke="#3a3a3a" strokeWidth="1"/>
  </svg>
);

// Goblin Scout - Small sneaky creature
const GoblinSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="goblinSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#7a8a5a"/>
        <stop offset="100%" stopColor="#5a6a3a"/>
      </linearGradient>
      <radialGradient id="goblinBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3a4a3a"/>
        <stop offset="100%" stopColor="#1a2a1a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#goblinBg)"/>
    {/* Large pointed ears */}
    <path d="M15 50 Q0 30 10 15 Q25 35 30 55 Z" fill="url(#goblinSkin)" stroke="#4a5a3a" strokeWidth="1"/>
    <path d="M105 50 Q120 30 110 15 Q95 35 90 55 Z" fill="url(#goblinSkin)" stroke="#4a5a3a" strokeWidth="1"/>
    {/* Inner ear */}
    <path d="M18 45 Q12 35 18 25" stroke="#5a4a3a" strokeWidth="2" fill="none"/>
    <path d="M102 45 Q108 35 102 25" stroke="#5a4a3a" strokeWidth="2" fill="none"/>
    {/* Bald wrinkled head */}
    <ellipse cx="60" cy="60" rx="32" ry="35" fill="url(#goblinSkin)"/>
    {/* Wrinkles */}
    <path d="M35 45 Q45 42 55 45" stroke="#5a6a3a" strokeWidth="1" fill="none"/>
    <path d="M65 45 Q75 42 85 45" stroke="#5a6a3a" strokeWidth="1" fill="none"/>
    {/* Large glowing yellow eyes */}
    <ellipse cx="45" cy="60" rx="12" ry="10" fill="#1a1a0a"/>
    <ellipse cx="75" cy="60" rx="12" ry="10" fill="#1a1a0a"/>
    <ellipse cx="45" cy="60" rx="10" ry="8" fill="#ffdd00"/>
    <ellipse cx="75" cy="60" rx="10" ry="8" fill="#ffdd00"/>
    <ellipse cx="45" cy="60" rx="5" ry="7" fill="#1a0a00"/>
    <ellipse cx="75" cy="60" rx="5" ry="7" fill="#1a0a00"/>
    <circle cx="42" cy="57" r="2" fill="#fff" opacity="0.7"/>
    <circle cx="72" cy="57" r="2" fill="#fff" opacity="0.7"/>
    {/* Long crooked nose */}
    <path d="M60 60 Q50 75 55 90 Q60 93 62 90 Q58 80 60 60" fill="#6a7a4a"/>
    {/* Wide grinning mouth */}
    <path d="M35 95 Q60 115 85 95" fill="#1a0a00"/>
    {/* Jagged teeth */}
    <path d="M40 95 L43 102 L46 95 L49 103 L52 95 L55 102 L58 95 L61 103 L64 95 L67 102 L70 95 L73 103 L76 95 L79 102 L82 95" 
          stroke="#c0b890" strokeWidth="2" fill="none"/>
    {/* Hunched body in rags */}
    <path d="M0 110 Q40 95 60 105 Q80 95 120 110 L120 168 L0 168 Z" fill="#4a3a2a"/>
    {/* Tattered cloth details */}
    <path d="M30 120 L25 145" stroke="#3a2a1a" strokeWidth="2"/>
    <path d="M50 115 L45 140" stroke="#3a2a1a" strokeWidth="2"/>
    <path d="M70 115 L75 140" stroke="#3a2a1a" strokeWidth="2"/>
    <path d="M90 120 L95 145" stroke="#3a2a1a" strokeWidth="2"/>
    {/* Crude dagger hint */}
    <path d="M100 130 L110 145 L105 147 L95 135 Z" fill="#8a8a8a" stroke="#5a5a5a" strokeWidth="1"/>
  </svg>
);

// Uruk-hai Berserker - Large black orc with white hand
const UrukHaiSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="urukSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#3a3a3a"/>
        <stop offset="100%" stopColor="#1a1a1a"/>
      </linearGradient>
      <linearGradient id="urukArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#2a2a2a"/>
        <stop offset="100%" stopColor="#0a0a0a"/>
      </linearGradient>
      <radialGradient id="urukBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3a2a1a"/>
        <stop offset="100%" stopColor="#1a0a00"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#urukBg)"/>
    {/* Massive head */}
    <ellipse cx="60" cy="55" rx="42" ry="45" fill="url(#urukSkin)"/>
    {/* White hand war paint */}
    <path d="M40 30 L40 50 L35 50 L35 30 Z" fill="#e8e8e8"/>
    <path d="M48 28 L48 52 L43 52 L43 28 Z" fill="#e8e8e8"/>
    <path d="M56 26 L56 55 L51 55 L51 26 Z" fill="#e8e8e8"/>
    <path d="M64 28 L64 52 L59 52 L59 28 Z" fill="#e8e8e8"/>
    <path d="M72 30 L72 50 L67 50 L67 30 Z" fill="#e8e8e8"/>
    <ellipse cx="56" cy="60" rx="22" ry="12" fill="#e8e8e8"/>
    {/* Fierce eyes */}
    <ellipse cx="42" cy="65" rx="10" ry="7" fill="#5a0a0a"/>
    <ellipse cx="78" cy="65" rx="10" ry="7" fill="#5a0a0a"/>
    <circle cx="42" cy="65" r="5" fill="#ff3300"/>
    <circle cx="78" cy="65" r="5" fill="#ff3300"/>
    <circle cx="42" cy="65" r="2" fill="#1a0a0a"/>
    <circle cx="78" cy="65" r="2" fill="#1a0a0a"/>
    {/* Flat brutish nose */}
    <ellipse cx="60" cy="80" rx="12" ry="8" fill="#2a2a2a"/>
    <circle cx="55" cy="82" r="4" fill="#1a1a1a"/>
    <circle cx="65" cy="82" r="4" fill="#1a1a1a"/>
    {/* Snarling mouth */}
    <path d="M35 92 Q60 105 85 92" fill="#0a0a0a"/>
    {/* Large fangs */}
    <path d="M42 92 L45 105 L48 92" fill="#c0b890"/>
    <path d="M72 92 L75 105 L78 92" fill="#c0b890"/>
    {/* Smaller teeth */}
    <path d="M52 94 L54 100" stroke="#a09870" strokeWidth="2"/>
    <path d="M60 95 L60 102" stroke="#a09870" strokeWidth="2"/>
    <path d="M68 94 L66 100" stroke="#a09870" strokeWidth="2"/>
    {/* Massive armored shoulders */}
    <path d="M0 100 Q30 85 60 95 Q90 85 120 100 L120 168 L0 168 Z" fill="url(#urukArmor)"/>
    {/* Shoulder spikes */}
    <path d="M15 105 L10 85 L20 100 Z" fill="#3a3a3a" stroke="#1a1a1a" strokeWidth="1"/>
    <path d="M105 105 L110 85 L100 100 Z" fill="#3a3a3a" stroke="#1a1a1a" strokeWidth="1"/>
    {/* Armor details */}
    <rect x="45" y="120" width="30" height="40" fill="#1a1a1a" stroke="#3a3a3a" strokeWidth="2"/>
    <line x1="60" y1="120" x2="60" y2="160" stroke="#3a3a3a" strokeWidth="2"/>
    <circle cx="52" cy="135" r="3" fill="#5a5a5a"/>
    <circle cx="68" cy="135" r="3" fill="#5a5a5a"/>
  </svg>
);

// NazgÃ»l - Hooded wraith
const NazgulSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="nazgulCloak" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#1a1a1a"/>
        <stop offset="100%" stopColor="#0a0a0a"/>
      </linearGradient>
      <radialGradient id="nazgulBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#2a2a3a"/>
        <stop offset="100%" stopColor="#0a0a1a"/>
      </radialGradient>
      <radialGradient id="nazgulVoid" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stopColor="#0a0a1a"/>
        <stop offset="100%" stopColor="#000000"/>
      </radialGradient>
      <filter id="nazgulGlow">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    <rect width="120" height="168" fill="url(#nazgulBg)"/>
    {/* Ethereal mist */}
    <ellipse cx="60" cy="150" rx="55" ry="20" fill="#2a2a3a" opacity="0.3"/>
    <ellipse cx="60" cy="145" rx="45" ry="15" fill="#3a3a4a" opacity="0.2"/>
    {/* Large dark hood */}
    <path d="M60 5 Q100 20 105 70 Q105 100 60 110 Q15 100 15 70 Q20 20 60 5" fill="url(#nazgulCloak)"/>
    {/* Hood inner shadow */}
    <ellipse cx="60" cy="65" rx="35" ry="40" fill="url(#nazgulVoid)"/>
    {/* Spectral eyes */}
    <ellipse cx="45" cy="60" rx="8" ry="4" fill="#4a0a1a" filter="url(#nazgulGlow)"/>
    <ellipse cx="75" cy="60" rx="8" ry="4" fill="#4a0a1a" filter="url(#nazgulGlow)"/>
    <ellipse cx="45" cy="60" rx="5" ry="2" fill="#8a1a2a"/>
    <ellipse cx="75" cy="60" rx="5" ry="2" fill="#8a1a2a"/>
    <ellipse cx="45" cy="60" rx="2" ry="1" fill="#ff3344"/>
    <ellipse cx="75" cy="60" rx="2" ry="1" fill="#ff3344"/>
    {/* Void face hint */}
    <path d="M50 75 Q60 80 70 75" stroke="#1a1a2a" strokeWidth="2" fill="none" opacity="0.5"/>
    {/* Flowing cloak */}
    <path d="M0 95 Q30 85 60 100 Q90 85 120 95 L120 168 L0 168 Z" fill="url(#nazgulCloak)"/>
    {/* Cloak folds */}
    <path d="M30 100 Q25 130 30 168" stroke="#2a2a2a" strokeWidth="3" fill="none"/>
    <path d="M50 105 Q45 135 50 168" stroke="#2a2a2a" strokeWidth="2" fill="none"/>
    <path d="M70 105 Q75 135 70 168" stroke="#2a2a2a" strokeWidth="2" fill="none"/>
    <path d="M90 100 Q95 130 90 168" stroke="#2a2a2a" strokeWidth="3" fill="none"/>
    {/* Morgul blade hint */}
    <path d="M95 120 L110 100 L112 103 L100 125 Z" fill="#3a4a5a" opacity="0.7"/>
    <path d="M107 102 L110 100 L112 103 L109 105 Z" fill="#6a7a8a"/>
    {/* Crown hint under hood */}
    <path d="M35 40 L38 30 L42 38 L48 28 L52 40" stroke="#3a3a4a" strokeWidth="1.5" fill="none" opacity="0.4"/>
    <path d="M68 40 L72 28 L78 38 L82 30 L85 40" stroke="#3a3a4a" strokeWidth="1.5" fill="none" opacity="0.4"/>
  </svg>
);

// Balrog - Fiery demon
const BalrogSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="balrogBody" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#3a1a0a"/>
        <stop offset="100%" stopColor="#1a0a00"/>
      </linearGradient>
      <linearGradient id="balrogFire" x1="0%" y1="100%" x2="0%" y2="0%">
        <stop offset="0%" stopColor="#ff3300"/>
        <stop offset="50%" stopColor="#ff6600"/>
        <stop offset="100%" stopColor="#ffcc00"/>
      </linearGradient>
      <radialGradient id="balrogBg" cx="50%" cy="50%" r="60%">
        <stop offset="0%" stopColor="#4a1a00"/>
        <stop offset="100%" stopColor="#1a0a00"/>
      </radialGradient>
      <filter id="fireGlow">
        <feGaussianBlur stdDeviation="4" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    <rect width="120" height="168" fill="url(#balrogBg)"/>
    {/* Fire aura */}
    <ellipse cx="60" cy="80" rx="55" ry="70" fill="url(#balrogFire)" opacity="0.3" filter="url(#fireGlow)"/>
    {/* Massive horns */}
    <path d="M25 50 Q10 20 25 5 Q35 25 40 45" fill="#2a1a0a" stroke="#1a0a00" strokeWidth="2"/>
    <path d="M95 50 Q110 20 95 5 Q85 25 80 45" fill="#2a1a0a" stroke="#1a0a00" strokeWidth="2"/>
    {/* Demonic head */}
    <ellipse cx="60" cy="60" rx="38" ry="35" fill="url(#balrogBody)"/>
    {/* Burning cracks in skin */}
    <path d="M30 50 Q40 55 35 70" stroke="#ff3300" strokeWidth="2" fill="none" filter="url(#fireGlow)"/>
    <path d="M90 50 Q80 55 85 70" stroke="#ff3300" strokeWidth="2" fill="none" filter="url(#fireGlow)"/>
    <path d="M50 40 Q55 50 50 60" stroke="#ff6600" strokeWidth="1.5" fill="none"/>
    <path d="M70 40 Q65 50 70 60" stroke="#ff6600" strokeWidth="1.5" fill="none"/>
    {/* Fiery eyes */}
    <ellipse cx="42" cy="55" rx="12" ry="8" fill="#ff0000" filter="url(#fireGlow)"/>
    <ellipse cx="78" cy="55" rx="12" ry="8" fill="#ff0000" filter="url(#fireGlow)"/>
    <ellipse cx="42" cy="55" rx="8" ry="5" fill="#ffcc00"/>
    <ellipse cx="78" cy="55" rx="8" ry="5" fill="#ffcc00"/>
    <ellipse cx="42" cy="55" rx="4" ry="6" fill="#1a0a00"/>
    <ellipse cx="78" cy="55" rx="4" ry="6" fill="#1a0a00"/>
    {/* Flaming maw */}
    <path d="M35 80 Q60 95 85 80 Q85 100 60 105 Q35 100 35 80" fill="#1a0a00"/>
    <path d="M40 82 Q60 90 80 82" fill="#ff3300" opacity="0.7"/>
    {/* Fangs */}
    <path d="M42 80 L45 92 L48 80" fill="#e8d0a0"/>
    <path d="M55 82 L58 90 L61 82" fill="#e8d0a0"/>
    <path d="M68 82 L65 90 L62 82" fill="#e8d0a0"/>
    <path d="M78 80 L75 92 L72 80" fill="#e8d0a0"/>
    {/* Massive shoulders with flames */}
    <path d="M0 100 Q30 80 60 95 Q90 80 120 100 L120 168 L0 168 Z" fill="url(#balrogBody)"/>
    {/* Shoulder flames */}
    <path d="M15 90 Q10 70 20 60 Q25 75 30 95" fill="url(#balrogFire)" opacity="0.8" filter="url(#fireGlow)"/>
    <path d="M105 90 Q110 70 100 60 Q95 75 90 95" fill="url(#balrogFire)" opacity="0.8" filter="url(#fireGlow)"/>
    {/* Body cracks */}
    <path d="M45 110 Q50 130 45 150" stroke="#ff3300" strokeWidth="2" fill="none"/>
    <path d="M75 110 Q70 130 75 150" stroke="#ff3300" strokeWidth="2" fill="none"/>
    <path d="M60 105 L60 168" stroke="#ff6600" strokeWidth="1.5" fill="none" opacity="0.7"/>
  </svg>
);

// Gothmog - Scarred orc commander
const GothmogSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="gothmogSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#6a5a4a"/>
        <stop offset="100%" stopColor="#4a3a2a"/>
      </linearGradient>
      <linearGradient id="gothmogArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#4a4a4a"/>
        <stop offset="100%" stopColor="#2a2a2a"/>
      </linearGradient>
      <radialGradient id="gothmogBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#4a3a2a"/>
        <stop offset="100%" stopColor="#2a1a0a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#gothmogBg)"/>
    {/* Deformed head - asymmetric */}
    <ellipse cx="55" cy="60" rx="38" ry="42" fill="url(#gothmogSkin)"/>
    {/* Tumor/growth on right side */}
    <ellipse cx="85" cy="55" rx="15" ry="18" fill="#5a4a3a"/>
    <ellipse cx="88" cy="52" rx="8" ry="10" fill="#6a5a4a"/>
    {/* Melted/burned left side of face */}
    <path d="M20 45 Q15 60 25 80 Q35 85 40 75 Q30 60 35 45 Z" fill="#5a4030"/>
    {/* One working eye (right) */}
    <ellipse cx="65" cy="55" rx="10" ry="7" fill="#2a1a0a"/>
    <circle cx="65" cy="55" r="5" fill="#aa2200"/>
    <circle cx="65" cy="55" r="2" fill="#1a0a00"/>
    {/* Blind/missing left eye */}
    <ellipse cx="40" cy="55" rx="8" ry="5" fill="#3a2a1a"/>
    <path d="M32 55 Q40 50 48 55" stroke="#5a3a2a" strokeWidth="3" fill="none"/>
    {/* Heavy scarring */}
    <path d="M30 40 L45 70" stroke="#4a3020" strokeWidth="3"/>
    <path d="M25 50 L40 75" stroke="#4a3020" strokeWidth="2"/>
    <path d="M35 35 Q45 45 40 55" stroke="#5a4030" strokeWidth="2"/>
    {/* Crooked nose */}
    <path d="M55 55 Q45 70 50 85 Q55 88 60 85 Q55 75 55 55" fill="#5a4a3a"/>
    {/* Twisted snarling mouth */}
    <path d="M30 92 Q55 100 80 88" fill="#2a1a0a"/>
    {/* Uneven teeth */}
    <path d="M35 92 L38 100" stroke="#a09070" strokeWidth="3"/>
    <path d="M50 95 L52 103" stroke="#a09070" strokeWidth="2"/>
    <path d="M65 93 L63 100" stroke="#a09070" strokeWidth="3"/>
    {/* Commander's armor with spikes */}
    <path d="M0 105 Q30 90 60 100 Q90 90 120 105 L120 168 L0 168 Z" fill="url(#gothmogArmor)"/>
    {/* Shoulder spikes */}
    <path d="M10 100 L5 75 L18 95 Z" fill="#5a5a5a"/>
    <path d="M110 100 L115 75 L102 95 Z" fill="#5a5a5a"/>
    {/* Skull decoration on chest */}
    <ellipse cx="60" cy="135" rx="12" ry="14" fill="#c0b090"/>
    <circle cx="55" cy="132" r="3" fill="#2a2a2a"/>
    <circle cx="65" cy="132" r="3" fill="#2a2a2a"/>
    <path d="M55 142 L57 145 L60 142 L63 145 L65 142" stroke="#2a2a2a" strokeWidth="1.5" fill="none"/>
  </svg>
);

// Mouth of Sauron - Helmeted herald
const MouthOfSauronSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="mosHelmet" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#2a2a2a"/>
        <stop offset="50%" stopColor="#1a1a1a"/>
        <stop offset="100%" stopColor="#0a0a0a"/>
      </linearGradient>
      <linearGradient id="mosSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8a7a6a"/>
        <stop offset="100%" stopColor="#6a5a4a"/>
      </linearGradient>
      <radialGradient id="mosBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3a2a1a"/>
        <stop offset="100%" stopColor="#1a0a00"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#mosBg)"/>
    {/* Tall spiked helmet */}
    <path d="M60 5 L75 40 L80 35 L85 50 L90 45 L95 70 L60 80 L25 70 L30 45 L35 50 L40 35 L45 40 Z" fill="url(#mosHelmet)"/>
    {/* Helmet face guard - covers eyes */}
    <path d="M25 70 Q60 75 95 70 Q95 90 60 95 Q25 90 25 70" fill="url(#mosHelmet)"/>
    {/* Eye slits (dark, no eyes visible) */}
    <ellipse cx="42" cy="80" rx="10" ry="3" fill="#0a0a0a"/>
    <ellipse cx="78" cy="80" rx="10" ry="3" fill="#0a0a0a"/>
    {/* Exposed mouth area */}
    <path d="M35 95 Q60 90 85 95 Q85 120 60 125 Q35 120 35 95" fill="url(#mosSkin)"/>
    {/* Horrible grinning mouth with rotted teeth */}
    <path d="M40 105 Q60 115 80 105 Q80 120 60 122 Q40 120 40 105" fill="#2a1a0a"/>
    {/* Diseased, rotted teeth - large and disturbing */}
    <rect x="42" y="105" width="6" height="10" fill="#4a4a30"/>
    <rect x="50" y="106" width="5" height="11" fill="#5a5a40"/>
    <rect x="57" y="105" width="6" height="12" fill="#4a4a30"/>
    <rect x="65" y="106" width="5" height="10" fill="#5a5a40"/>
    <rect x="72" y="105" width="6" height="9" fill="#4a4a30"/>
    {/* Cracked lips */}
    <path d="M40 105 Q50 102 60 105 Q70 102 80 105" stroke="#5a4a3a" strokeWidth="2" fill="none"/>
    {/* Black gums */}
    <path d="M42 116 Q60 120 78 116" stroke="#1a0a00" strokeWidth="2" fill="none"/>
    {/* Chin visible */}
    <ellipse cx="60" cy="128" rx="15" ry="8" fill="url(#mosSkin)"/>
    {/* Armored collar/neck */}
    <path d="M0 125 Q30 115 60 125 Q90 115 120 125 L120 168 L0 168 Z" fill="url(#mosHelmet)"/>
    {/* Armor details */}
    <rect x="50" y="135" width="20" height="30" fill="#1a1a1a" stroke="#2a2a2a" strokeWidth="2"/>
    {/* Sauron's eye symbol */}
    <ellipse cx="60" cy="150" rx="8" ry="5" fill="none" stroke="#8a2a0a" strokeWidth="2"/>
    <ellipse cx="60" cy="150" rx="3" ry="5" fill="#8a2a0a"/>
  </svg>
);

// Create data URIs from SVG components
const svgToDataUri = (SvgComponent) => {
  const svgString = `<svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">${SvgComponent}</svg>`;
  return `data:image/svg+xml,${encodeURIComponent(svgString)}`;
};

// Warg - Wolf-like mount creature
const WargSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="wargFur" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#4a4a4a"/>
        <stop offset="100%" stopColor="#2a2a2a"/>
      </linearGradient>
      <radialGradient id="wargBg" cx="50%" cy="50%" r="70%">
        <stop offset="0%" stopColor="#3a3a3a"/>
        <stop offset="100%" stopColor="#1a1a1a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#wargBg)"/>
    {/* Pointed ears */}
    <path d="M25 30 L35 5 L45 35 Z" fill="url(#wargFur)" stroke="#1a1a1a" strokeWidth="1"/>
    <path d="M75 35 L85 5 L95 30 Z" fill="url(#wargFur)" stroke="#1a1a1a" strokeWidth="1"/>
    <path d="M30 28 L35 12 L40 30" fill="#5a4a4a"/>
    <path d="M80 30 L85 12 L90 28" fill="#5a4a4a"/>
    {/* Wolf head - large and menacing */}
    <ellipse cx="60" cy="70" rx="45" ry="40" fill="url(#wargFur)"/>
    {/* Snout */}
    <ellipse cx="60" cy="95" rx="25" ry="20" fill="#3a3a3a"/>
    <ellipse cx="60" cy="100" rx="20" ry="15" fill="#2a2a2a"/>
    {/* Nose */}
    <ellipse cx="60" cy="90" rx="10" ry="7" fill="#1a1a1a"/>
    <ellipse cx="58" cy="88" rx="3" ry="2" fill="#3a3a3a" opacity="0.5"/>
    {/* Fierce yellow eyes */}
    <ellipse cx="40" cy="60" rx="12" ry="8" fill="#1a0a00"/>
    <ellipse cx="80" cy="60" rx="12" ry="8" fill="#1a0a00"/>
    <ellipse cx="40" cy="60" rx="9" ry="6" fill="#ffcc00"/>
    <ellipse cx="80" cy="60" rx="9" ry="6" fill="#ffcc00"/>
    <ellipse cx="40" cy="60" rx="4" ry="5" fill="#1a0a00"/>
    <ellipse cx="80" cy="60" rx="4" ry="5" fill="#1a0a00"/>
    {/* Snarling mouth with fangs */}
    <path d="M35 105 Q60 120 85 105" fill="#2a0a0a"/>
    <path d="M40 105 L45 118 L50 105" fill="#e8e0c0"/>
    <path d="M55 107 L60 116 L65 107" fill="#e8e0c0"/>
    <path d="M70 105 L75 118 L80 105" fill="#e8e0c0"/>
    {/* Fur texture */}
    <path d="M20 50 Q25 45 20 40" stroke="#5a5a5a" strokeWidth="2" fill="none"/>
    <path d="M100 50 Q95 45 100 40" stroke="#5a5a5a" strokeWidth="2" fill="none"/>
    {/* Neck/body hint */}
    <path d="M15 110 Q40 100 60 115 Q80 100 105 110 L110 168 L10 168 Z" fill="url(#wargFur)"/>
    <path d="M30 120 Q35 140 30 160" stroke="#3a3a3a" strokeWidth="2" fill="none"/>
    <path d="M90 120 Q85 140 90 160" stroke="#3a3a3a" strokeWidth="2" fill="none"/>
  </svg>
);

// Cave Troll - Large brutish creature
const CaveTrollSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="trollSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#6a6a5a"/>
        <stop offset="100%" stopColor="#4a4a3a"/>
      </linearGradient>
      <radialGradient id="trollBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3a3a2a"/>
        <stop offset="100%" stopColor="#1a1a0a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#trollBg)"/>
    {/* Massive head */}
    <ellipse cx="60" cy="55" rx="50" ry="45" fill="url(#trollSkin)"/>
    {/* Small beady eyes */}
    <circle cx="40" cy="45" r="8" fill="#2a2a1a"/>
    <circle cx="80" cy="45" r="8" fill="#2a2a1a"/>
    <circle cx="40" cy="45" r="5" fill="#aa4400"/>
    <circle cx="80" cy="45" r="5" fill="#aa4400"/>
    <circle cx="40" cy="45" r="2" fill="#1a1a0a"/>
    <circle cx="80" cy="45" r="2" fill="#1a1a0a"/>
    {/* Heavy brow */}
    <path d="M25 38 Q40 30 55 40" fill="#5a5a4a"/>
    <path d="M65 40 Q80 30 95 38" fill="#5a5a4a"/>
    {/* Large flat nose */}
    <ellipse cx="60" cy="65" rx="18" ry="12" fill="#5a5a4a"/>
    <circle cx="52" cy="68" r="5" fill="#3a3a2a"/>
    <circle cx="68" cy="68" r="5" fill="#3a3a2a"/>
    {/* Wide mouth */}
    <path d="M30 85 Q60 100 90 85" fill="#2a2a1a"/>
    {/* Crooked teeth */}
    <rect x="38" y="85" width="8" height="12" fill="#9a9a7a" transform="rotate(-10 42 91)"/>
    <rect x="52" y="87" width="7" height="10" fill="#8a8a6a"/>
    <rect x="64" y="86" width="8" height="11" fill="#9a9a7a" transform="rotate(8 68 91)"/>
    <rect x="77" y="85" width="7" height="10" fill="#8a8a6a" transform="rotate(15 80 90)"/>
    {/* Ears */}
    <ellipse cx="15" cy="55" rx="10" ry="15" fill="url(#trollSkin)"/>
    <ellipse cx="105" cy="55" rx="10" ry="15" fill="url(#trollSkin)"/>
    {/* Massive shoulders */}
    <path d="M0 95 Q30 80 60 90 Q90 80 120 95 L120 168 L0 168 Z" fill="url(#trollSkin)"/>
    {/* Chain/collar */}
    <ellipse cx="60" cy="105" rx="30" ry="8" fill="none" stroke="#5a5a5a" strokeWidth="4"/>
    <circle cx="60" cy="115" r="6" fill="#4a4a4a" stroke="#3a3a3a" strokeWidth="2"/>
  </svg>
);

// Shelob - Giant spider
const ShelobSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="spiderBody" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#2a2a2a"/>
        <stop offset="100%" stopColor="#1a1a1a"/>
      </linearGradient>
      <radialGradient id="spiderBg" cx="50%" cy="50%" r="70%">
        <stop offset="0%" stopColor="#2a2a3a"/>
        <stop offset="100%" stopColor="#0a0a1a"/>
      </radialGradient>
      <radialGradient id="spiderEye" cx="30%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#4a0a2a"/>
        <stop offset="100%" stopColor="#2a0a1a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#spiderBg)"/>
    {/* Legs - back */}
    <path d="M15 80 Q0 60 10 40 Q15 35 20 40" stroke="#1a1a1a" strokeWidth="6" fill="none"/>
    <path d="M105 80 Q120 60 110 40 Q105 35 100 40" stroke="#1a1a1a" strokeWidth="6" fill="none"/>
    <path d="M20 90 Q0 80 5 55" stroke="#2a2a2a" strokeWidth="5" fill="none"/>
    <path d="M100 90 Q120 80 115 55" stroke="#2a2a2a" strokeWidth="5" fill="none"/>
    {/* Abdomen */}
    <ellipse cx="60" cy="120" rx="40" ry="35" fill="url(#spiderBody)"/>
    <path d="M30 110 Q60 100 90 110" stroke="#3a3a3a" strokeWidth="2" fill="none"/>
    <path d="M35 125 Q60 115 85 125" stroke="#3a3a3a" strokeWidth="2" fill="none"/>
    {/* Legs - front */}
    <path d="M25 75 Q5 55 15 30" stroke="#2a2a2a" strokeWidth="5" fill="none"/>
    <path d="M95 75 Q115 55 105 30" stroke="#2a2a2a" strokeWidth="5" fill="none"/>
    <path d="M35 70 Q20 45 30 20" stroke="#1a1a1a" strokeWidth="4" fill="none"/>
    <path d="M85 70 Q100 45 90 20" stroke="#1a1a1a" strokeWidth="4" fill="none"/>
    {/* Cephalothorax (head) */}
    <ellipse cx="60" cy="70" rx="30" ry="25" fill="url(#spiderBody)"/>
    {/* Multiple eyes */}
    <circle cx="45" cy="60" r="8" fill="url(#spiderEye)"/>
    <circle cx="75" cy="60" r="8" fill="url(#spiderEye)"/>
    <circle cx="45" cy="60" r="4" fill="#8a1a3a"/>
    <circle cx="75" cy="60" r="4" fill="#8a1a3a"/>
    <circle cx="52" cy="68" r="5" fill="url(#spiderEye)"/>
    <circle cx="68" cy="68" r="5" fill="url(#spiderEye)"/>
    <circle cx="52" cy="68" r="2" fill="#6a1a2a"/>
    <circle cx="68" cy="68" r="2" fill="#6a1a2a"/>
    <circle cx="50" cy="52" r="4" fill="url(#spiderEye)"/>
    <circle cx="70" cy="52" r="4" fill="url(#spiderEye)"/>
    {/* Fangs */}
    <path d="M50 78 Q48 90 52 95" stroke="#4a4a4a" strokeWidth="4" fill="none"/>
    <path d="M70 78 Q72 90 68 95" stroke="#4a4a4a" strokeWidth="4" fill="none"/>
    <circle cx="52" cy="95" r="2" fill="#2a8a2a"/>
    <circle cx="68" cy="95" r="2" fill="#2a8a2a"/>
    {/* Web strands */}
    <path d="M0 20 Q60 40 120 20" stroke="#4a4a5a" strokeWidth="1" fill="none" opacity="0.3"/>
    <path d="M0 168 Q60 140 120 168" stroke="#4a4a5a" strokeWidth="1" fill="none" opacity="0.3"/>
  </svg>
);

// Witch King - Armored Nazgul lord
const WitchKingSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="witchArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#3a3a4a"/>
        <stop offset="50%" stopColor="#2a2a3a"/>
        <stop offset="100%" stopColor="#1a1a2a"/>
      </linearGradient>
      <radialGradient id="witchBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#2a2a3a"/>
        <stop offset="100%" stopColor="#0a0a1a"/>
      </radialGradient>
      <filter id="witchGlow">
        <feGaussianBlur stdDeviation="2" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect width="120" height="168" fill="url(#witchBg)"/>
    {/* Crown - spiked iron */}
    <path d="M30 25 L35 5 L40 20 L50 0 L55 22 L60 8 L65 22 L70 0 L80 20 L85 5 L90 25" 
          fill="url(#witchArmor)" stroke="#1a1a2a" strokeWidth="1"/>
    <path d="M25 25 Q60 35 95 25 Q95 45 60 50 Q25 45 25 25" fill="url(#witchArmor)"/>
    {/* Helm */}
    <path d="M20 45 Q60 35 100 45 Q105 80 60 95 Q15 80 20 45" fill="url(#witchArmor)"/>
    {/* Face void */}
    <ellipse cx="60" cy="70" rx="25" ry="20" fill="#0a0a1a"/>
    {/* Burning eyes */}
    <ellipse cx="48" cy="65" rx="8" ry="4" fill="#ff2200" filter="url(#witchGlow)"/>
    <ellipse cx="72" cy="65" rx="8" ry="4" fill="#ff2200" filter="url(#witchGlow)"/>
    <ellipse cx="48" cy="65" rx="4" ry="2" fill="#ffff00"/>
    <ellipse cx="72" cy="65" rx="4" ry="2" fill="#ffff00"/>
    {/* Helm details */}
    <path d="M60 45 L60 55" stroke="#4a4a5a" strokeWidth="3"/>
    <path d="M35 50 L40 60" stroke="#4a4a5a" strokeWidth="2"/>
    <path d="M85 50 L80 60" stroke="#4a4a5a" strokeWidth="2"/>
    {/* Armored shoulders */}
    <path d="M0 90 Q30 75 60 85 Q90 75 120 90 L120 168 L0 168 Z" fill="url(#witchArmor)"/>
    {/* Shoulder spikes */}
    <path d="M20 85 L10 60 L30 80 Z" fill="#3a3a4a"/>
    <path d="M100 85 L110 60 L90 80 Z" fill="#3a3a4a"/>
    {/* Chest plate with symbol */}
    <path d="M40 100 L60 95 L80 100 L75 140 L60 145 L45 140 Z" fill="#2a2a3a" stroke="#3a3a4a" strokeWidth="2"/>
    {/* Morgul symbol */}
    <circle cx="60" cy="120" r="12" fill="none" stroke="#4a1a2a" strokeWidth="2"/>
    <path d="M60 108 L60 132 M48 120 L72 120" stroke="#4a1a2a" strokeWidth="2"/>
    {/* Cloak edges */}
    <path d="M10 100 Q15 130 10 168" stroke="#1a1a2a" strokeWidth="4" fill="none"/>
    <path d="M110 100 Q105 130 110 168" stroke="#1a1a2a" strokeWidth="4" fill="none"/>
  </svg>
);

// Sauron - The Dark Lord
const SauronSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="sauronArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#2a2a2a"/>
        <stop offset="50%" stopColor="#1a1a1a"/>
        <stop offset="100%" stopColor="#0a0a0a"/>
      </linearGradient>
      <radialGradient id="sauronBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3a1a0a"/>
        <stop offset="100%" stopColor="#1a0a00"/>
      </radialGradient>
      <radialGradient id="sauronEye" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stopColor="#ffcc00"/>
        <stop offset="40%" stopColor="#ff6600"/>
        <stop offset="100%" stopColor="#aa0000"/>
      </radialGradient>
      <filter id="sauronGlow">
        <feGaussianBlur stdDeviation="4" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect width="120" height="168" fill="url(#sauronBg)"/>
    {/* Great helm with crown */}
    <path d="M25 20 L30 5 L40 25 L50 10 L60 30 L70 10 L80 25 L90 5 L95 20" 
          fill="#1a1a1a" stroke="#3a3a3a" strokeWidth="1"/>
    <path d="M15 20 Q60 5 105 20 Q110 70 60 85 Q10 70 15 20" fill="url(#sauronArmor)"/>
    {/* The Eye of Sauron in helm */}
    <ellipse cx="60" cy="55" rx="25" ry="18" fill="#0a0a0a"/>
    <ellipse cx="60" cy="55" rx="22" ry="15" fill="url(#sauronEye)" filter="url(#sauronGlow)"/>
    <ellipse cx="60" cy="55" rx="6" ry="14" fill="#1a0a00"/>
    {/* Fire wisps around eye */}
    <path d="M35 50 Q30 45 35 40" stroke="#ff6600" strokeWidth="2" fill="none" opacity="0.7"/>
    <path d="M85 50 Q90 45 85 40" stroke="#ff6600" strokeWidth="2" fill="none" opacity="0.7"/>
    <path d="M40 65 Q35 70 40 75" stroke="#ff3300" strokeWidth="2" fill="none" opacity="0.7"/>
    <path d="M80 65 Q85 70 80 75" stroke="#ff3300" strokeWidth="2" fill="none" opacity="0.7"/>
    {/* Helm cheek guards */}
    <path d="M20 45 Q25 70 35 80" fill="url(#sauronArmor)"/>
    <path d="M100 45 Q95 70 85 80" fill="url(#sauronArmor)"/>
    {/* Massive armored shoulders */}
    <path d="M0 85 Q30 70 60 80 Q90 70 120 85 L120 168 L0 168 Z" fill="url(#sauronArmor)"/>
    {/* Shoulder spikes - many */}
    <path d="M15 80 L5 55 L25 75 Z" fill="#2a2a2a"/>
    <path d="M25 75 L15 50 L35 70 Z" fill="#2a2a2a"/>
    <path d="M105 80 L115 55 L95 75 Z" fill="#2a2a2a"/>
    <path d="M95 75 L105 50 L85 70 Z" fill="#2a2a2a"/>
    {/* Chest with One Ring symbol */}
    <ellipse cx="60" cy="125" rx="20" ry="15" fill="#1a1a1a" stroke="#d4af37" strokeWidth="2"/>
    <ellipse cx="60" cy="125" rx="12" ry="9" fill="none" stroke="#d4af37" strokeWidth="1"/>
    {/* Tengwar-like inscriptions */}
    <path d="M40 110 Q50 105 60 110 Q70 105 80 110" stroke="#8a2a0a" strokeWidth="1" fill="none"/>
    <path d="M45 145 Q55 150 60 145 Q65 150 75 145" stroke="#8a2a0a" strokeWidth="1" fill="none"/>
    {/* Mace hint on side */}
    <path d="M100 120 L115 105" stroke="#3a3a3a" strokeWidth="4"/>
    <circle cx="115" cy="100" r="8" fill="#2a2a2a" stroke="#3a3a3a" strokeWidth="2"/>
  </svg>
);

// Haradrim - Eastern warrior
const HaradrimSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="haradSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8a6a4a"/>
        <stop offset="100%" stopColor="#6a4a2a"/>
      </linearGradient>
      <linearGradient id="haradCloth" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8a2020"/>
        <stop offset="100%" stopColor="#5a1010"/>
      </linearGradient>
      <radialGradient id="haradBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#5a4a3a"/>
        <stop offset="100%" stopColor="#2a1a0a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#haradBg)"/>
    {/* Turban/Headwrap */}
    <ellipse cx="60" cy="40" rx="35" ry="30" fill="url(#haradCloth)"/>
    <path d="M25 40 Q40 25 60 30 Q80 25 95 40" fill="#7a1818"/>
    <path d="M30 35 Q60 20 90 35" stroke="#5a1010" strokeWidth="3" fill="none"/>
    <ellipse cx="60" cy="50" rx="30" ry="20" fill="url(#haradCloth)"/>
    {/* Gold ornament on turban */}
    <circle cx="60" cy="30" r="8" fill="#d4af37" stroke="#8a7020" strokeWidth="1"/>
    <circle cx="60" cy="30" r="4" fill="#aa2020"/>
    {/* Face */}
    <ellipse cx="60" cy="75" rx="25" ry="28" fill="url(#haradSkin)"/>
    {/* Fierce eyes */}
    <ellipse cx="50" cy="68" rx="6" ry="4" fill="#fff"/>
    <ellipse cx="70" cy="68" rx="6" ry="4" fill="#fff"/>
    <circle cx="50" cy="68" r="3" fill="#2a1a0a"/>
    <circle cx="70" cy="68" r="3" fill="#2a1a0a"/>
    {/* Strong nose */}
    <path d="M60 68 L57 82 Q60 85 63 82 L60 68" fill="#7a5a3a"/>
    {/* Beard */}
    <path d="M40 85 Q60 100 80 85 Q85 105 60 115 Q35 105 40 85" fill="#1a1a1a"/>
    <path d="M45 90 Q60 100 75 90" stroke="#2a2a2a" strokeWidth="2" fill="none"/>
    {/* Armor/Clothing */}
    <path d="M0 105 Q30 95 60 105 Q90 95 120 105 L120 168 L0 168 Z" fill="url(#haradCloth)"/>
    {/* Scale armor pattern */}
    <ellipse cx="40" cy="125" rx="10" ry="6" fill="#6a1818" stroke="#4a0808" strokeWidth="1"/>
    <ellipse cx="60" cy="120" rx="10" ry="6" fill="#6a1818" stroke="#4a0808" strokeWidth="1"/>
    <ellipse cx="80" cy="125" rx="10" ry="6" fill="#6a1818" stroke="#4a0808" strokeWidth="1"/>
    <ellipse cx="50" cy="135" rx="10" ry="6" fill="#6a1818" stroke="#4a0808" strokeWidth="1"/>
    <ellipse cx="70" cy="135" rx="10" ry="6" fill="#6a1818" stroke="#4a0808" strokeWidth="1"/>
    {/* Gold necklace */}
    <path d="M40 105 Q60 115 80 105" stroke="#d4af37" strokeWidth="3" fill="none"/>
  </svg>
);

// Mordor Orc - Darker more evil orc variant
const MordorOrcSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="mordorSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#3a4a3a"/>
        <stop offset="100%" stopColor="#1a2a1a"/>
      </linearGradient>
      <radialGradient id="mordorBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#2a1a0a"/>
        <stop offset="100%" stopColor="#0a0a00"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#mordorBg)"/>
    {/* Spiked helm */}
    <ellipse cx="60" cy="40" rx="35" ry="25" fill="#1a1a1a"/>
    <path d="M60 5 L65 30 L55 30 Z" fill="#2a2a2a"/>
    <path d="M35 20 L45 40 L38 42 Z" fill="#2a2a2a"/>
    <path d="M85 20 L75 40 L82 42 Z" fill="#2a2a2a"/>
    {/* Face */}
    <ellipse cx="60" cy="70" rx="32" ry="35" fill="url(#mordorSkin)"/>
    {/* Red eyes */}
    <ellipse cx="45" cy="60" rx="9" ry="6" fill="#2a0a0a"/>
    <ellipse cx="75" cy="60" rx="9" ry="6" fill="#2a0a0a"/>
    <circle cx="45" cy="60" r="4" fill="#aa0000"/>
    <circle cx="75" cy="60" r="4" fill="#aa0000"/>
    <circle cx="45" cy="60" r="2" fill="#ff3300"/>
    <circle cx="75" cy="60" r="2" fill="#ff3300"/>
    {/* Flat nose */}
    <ellipse cx="60" cy="78" rx="10" ry="7" fill="#2a3a2a"/>
    <circle cx="55" cy="80" r="3" fill="#1a2a1a"/>
    <circle cx="65" cy="80" r="3" fill="#1a2a1a"/>
    {/* Snarling mouth */}
    <path d="M40 92 Q60 105 80 92" fill="#0a0a0a"/>
    <path d="M45 92 L48 100" stroke="#8a8a6a" strokeWidth="3"/>
    <path d="M60 95 L60 103" stroke="#8a8a6a" strokeWidth="3"/>
    <path d="M75 92 L72 100" stroke="#8a8a6a" strokeWidth="3"/>
    {/* Eye of Sauron brand on forehead */}
    <ellipse cx="60" cy="48" rx="8" ry="5" fill="none" stroke="#aa2200" strokeWidth="1.5"/>
    <ellipse cx="60" cy="48" rx="2" ry="4" fill="#aa2200"/>
    {/* Crude armor */}
    <path d="M0 105 Q30 90 60 100 Q90 90 120 105 L120 168 L0 168 Z" fill="#1a1a1a"/>
    <circle cx="35" cy="125" r="5" fill="#2a2a2a" stroke="#1a1a1a" strokeWidth="1"/>
    <circle cx="60" cy="120" r="5" fill="#2a2a2a" stroke="#1a1a1a" strokeWidth="1"/>
    <circle cx="85" cy="125" r="5" fill="#2a2a2a" stroke="#1a1a1a" strokeWidth="1"/>
  </svg>
);

// Gandalf the White - Transformed Gandalf
const GandalfWhiteSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="whiteRobe" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#ffffff"/>
        <stop offset="50%" stopColor="#e8e8e8"/>
        <stop offset="100%" stopColor="#d0d0d0"/>
      </linearGradient>
      <linearGradient id="whiteBeard" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#ffffff"/>
        <stop offset="100%" stopColor="#e0e0e0"/>
      </linearGradient>
      <radialGradient id="whiteBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#8a8aaa"/>
        <stop offset="100%" stopColor="#4a4a6a"/>
      </radialGradient>
      <filter id="whiteGlow">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect width="120" height="168" fill="url(#whiteBg)"/>
    {/* Radiant aura */}
    <ellipse cx="60" cy="80" rx="55" ry="70" fill="#fff" opacity="0.1" filter="url(#whiteGlow)"/>
    {/* White pointed hat */}
    <path d="M60 0 L88 50 Q60 60 32 50 Z" fill="url(#whiteRobe)" stroke="#c0c0c0" strokeWidth="1"/>
    <ellipse cx="60" cy="52" rx="32" ry="10" fill="url(#whiteRobe)"/>
    {/* Face */}
    <ellipse cx="60" cy="78" rx="24" ry="26" fill="#e8d4c4"/>
    {/* Wise eyebrows */}
    <path d="M40 70 Q48 64 54 70" stroke="#d0d0d0" strokeWidth="3" fill="none"/>
    <path d="M66 70 Q72 64 80 70" stroke="#d0d0d0" strokeWidth="3" fill="none"/>
    {/* Radiant eyes */}
    <ellipse cx="48" cy="76" rx="5" ry="4" fill="#fff"/>
    <ellipse cx="72" cy="76" rx="5" ry="4" fill="#fff"/>
    <circle cx="48" cy="76" r="3" fill="#4a8aca"/>
    <circle cx="72" cy="76" r="3" fill="#4a8aca"/>
    <circle cx="49" cy="75" r="1" fill="#fff"/>
    <circle cx="73" cy="75" r="1" fill="#fff"/>
    {/* Noble nose */}
    <path d="M60 76 Q56 86 58 92 Q60 94 62 92 Q64 86 60 76" fill="#d4b0a0"/>
    {/* Long white beard */}
    <path d="M38 88 Q35 100 40 130 Q55 155 60 168" fill="url(#whiteBeard)"/>
    <path d="M82 88 Q85 100 80 130 Q65 155 60 168" fill="url(#whiteBeard)"/>
    <path d="M42 90 Q60 98 78 90 Q82 115 75 140 Q60 160 45 140 Q38 115 42 90" fill="url(#whiteBeard)"/>
    {/* Beard glow */}
    <path d="M50 100 Q55 120 52 145" stroke="#fff" strokeWidth="1" fill="none" opacity="0.5"/>
    <path d="M60 98 Q60 125 58 150" stroke="#fff" strokeWidth="1" fill="none" opacity="0.5"/>
    <path d="M70 100 Q65 120 68 145" stroke="#fff" strokeWidth="1" fill="none" opacity="0.5"/>
    {/* Mustache */}
    <path d="M48 90 Q54 86 60 90 Q66 86 72 90" fill="url(#whiteBeard)"/>
    {/* White robes */}
    <path d="M5 95 Q35 85 60 92 Q85 85 115 95 L120 168 L0 168 Z" fill="url(#whiteRobe)"/>
    {/* Elven brooch */}
    <path d="M60 105 L55 110 L60 130 L65 110 Z" fill="#d4af37"/>
    <circle cx="60" cy="108" r="3" fill="#90ee90"/>
  </svg>
);

// King Aragorn - Transformed Strider
const KingAragornSVG = () => (
  <svg viewBox="0 0 120 168" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="kingArmor" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#4a4a5a"/>
        <stop offset="50%" stopColor="#3a3a4a"/>
        <stop offset="100%" stopColor="#2a2a3a"/>
      </linearGradient>
      <linearGradient id="kingSkin" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#d4a574"/>
        <stop offset="100%" stopColor="#b8956e"/>
      </linearGradient>
      <linearGradient id="kingCrown" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#d4af37"/>
        <stop offset="50%" stopColor="#f4cf57"/>
        <stop offset="100%" stopColor="#d4af37"/>
      </linearGradient>
      <radialGradient id="kingBg" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stopColor="#3a4a5a"/>
        <stop offset="100%" stopColor="#1a2a3a"/>
      </radialGradient>
    </defs>
    <rect width="120" height="168" fill="url(#kingBg)"/>
    {/* Crown of Gondor */}
    <path d="M30 30 L35 15 L45 28 L55 5 L60 25 L65 5 L75 28 L85 15 L90 30" 
          fill="url(#kingCrown)" stroke="#8a7020" strokeWidth="1"/>
    <ellipse cx="60" cy="32" rx="35" ry="12" fill="url(#kingCrown)"/>
    {/* Crown jewel */}
    <circle cx="60" cy="12" r="5" fill="#4a9aca"/>
    <circle cx="60" cy="12" r="2" fill="#8acaff"/>
    {/* Wings on crown */}
    <path d="M25 25 Q15 20 20 10" stroke="url(#kingCrown)" strokeWidth="3" fill="none"/>
    <path d="M95 25 Q105 20 100 10" stroke="url(#kingCrown)" strokeWidth="3" fill="none"/>
    {/* Dark hair */}
    <ellipse cx="60" cy="50" rx="32" ry="25" fill="#2d1810"/>
    <path d="M28 50 Q25 70 32 90" stroke="#2d1810" strokeWidth="6" fill="none"/>
    <path d="M92 50 Q95 70 88 90" stroke="#2d1810" strokeWidth="6" fill="none"/>
    {/* Face */}
    <ellipse cx="60" cy="72" rx="28" ry="32" fill="url(#kingSkin)"/>
    {/* Noble eyebrows */}
    <path d="M42 60 Q50 56 56 60" stroke="#2d1810" strokeWidth="2" fill="none"/>
    <path d="M64 60 Q70 56 78 60" stroke="#2d1810" strokeWidth="2" fill="none"/>
    {/* Determined eyes */}
    <ellipse cx="48" cy="68" rx="6" ry="5" fill="#fff"/>
    <ellipse cx="72" cy="68" rx="6" ry="5" fill="#fff"/>
    <circle cx="48" cy="68" r="4" fill="#4a6741"/>
    <circle cx="72" cy="68" r="4" fill="#4a6741"/>
    <circle cx="49" cy="67" r="1.5" fill="#fff"/>
    <circle cx="73" cy="67" r="1.5" fill="#fff"/>
    {/* Noble nose */}
    <path d="M60 68 L58 80 Q60 83 62 80 L60 68" fill="#c49564"/>
    {/* Trimmed beard */}
    <path d="M40 88 Q60 95 80 88 Q82 100 60 108 Q38 100 40 88" fill="#3d2817"/>
    {/* Mouth */}
    <path d="M52 88 Q60 92 68 88" stroke="#8b6040" strokeWidth="2" fill="none"/>
    {/* Gondorian armor */}
    <path d="M0 105 Q30 95 60 105 Q90 95 120 105 L120 168 L0 168 Z" fill="url(#kingArmor)"/>
    {/* White Tree of Gondor on chest */}
    <path d="M60 115 L60 145" stroke="#c0c0c0" strokeWidth="2"/>
    <path d="M60 118 Q50 110 45 115" stroke="#c0c0c0" strokeWidth="2" fill="none"/>
    <path d="M60 118 Q70 110 75 115" stroke="#c0c0c0" strokeWidth="2" fill="none"/>
    <path d="M60 125 Q52 118 48 122" stroke="#c0c0c0" strokeWidth="1.5" fill="none"/>
    <path d="M60 125 Q68 118 72 122" stroke="#c0c0c0" strokeWidth="1.5" fill="none"/>
    <path d="M60 132 Q55 128 52 130" stroke="#c0c0c0" strokeWidth="1" fill="none"/>
    <path d="M60 132 Q65 128 68 130" stroke="#c0c0c0" strokeWidth="1" fill="none"/>
    {/* Seven stars */}
    <circle cx="40" cy="120" r="2" fill="#e0e0e0"/>
    <circle cx="35" cy="130" r="2" fill="#e0e0e0"/>
    <circle cx="45" cy="135" r="2" fill="#e0e0e0"/>
    <circle cx="80" cy="120" r="2" fill="#e0e0e0"/>
    <circle cx="85" cy="130" r="2" fill="#e0e0e0"/>
    <circle cx="75" cy="135" r="2" fill="#e0e0e0"/>
    <circle cx="60" cy="150" r="2" fill="#e0e0e0"/>
  </svg>
);

// Character image components for direct use
const CharacterPortraits = {
  Aragorn: AragornSVG,
  Legolas: LegolasSVG,
  Gandalf: GandalfSVG,
  Gimli: GimliSVG,
  GandalfWhite: GandalfWhiteSVG,
  KingAragorn: KingAragornSVG,
  Orc: OrcSVG,
  Goblin: GoblinSVG,
  UrukHai: UrukHaiSVG,
  Nazgul: NazgulSVG,
  Balrog: BalrogSVG,
  Gothmog: GothmogSVG,
  MouthOfSauron: MouthOfSauronSVG,
  Warg: WargSVG,
  CaveTroll: CaveTrollSVG,
  Shelob: ShelobSVG,
  WitchKing: WitchKingSVG,
  Sauron: SauronSVG,
  Haradrim: HaradrimSVG,
  MordorOrc: MordorOrcSVG
};

// SVG Portrait wrapper component
const SVGPortrait = ({ character, size = 120, border = '#d4af37' }) => {
  const PortraitComponent = CharacterPortraits[character];
  if (!PortraitComponent) return null;
  
  return (
    <div style={{
      width: size,
      height: size * 1.4,
      borderRadius: '12px',
      overflow: 'hidden',
      border: `3px solid ${border}`,
      boxShadow: '0 8px 25px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.3)',
      background: 'linear-gradient(135deg, #2d1f14 0%, #1a0f08 100%)',
    }}>
      <PortraitComponent />
    </div>
  );
};

// Character images mapping for the game
const characterImages = {
  strider: 'Aragorn',
  legolas: 'Legolas', 
  gimli: 'Gimli',
  saruman: 'Gandalf',
  gandalf: 'Gandalf',
  gandalfWhite: 'GandalfWhite',
  kingAragorn: 'KingAragorn',
  orc: 'Orc',
  goblin: 'Goblin',
  urukhai: 'UrukHai',
  nazgul: 'Nazgul',
  balrog: 'Balrog',
  gothmog: 'Gothmog',
  mouthofsauron: 'MouthOfSauron',
  warg: 'Warg',
  caveTroll: 'CaveTroll',
  shelob: 'Shelob',
  witchKing: 'WitchKing',
  sauron: 'Sauron',
  haradrim: 'Haradrim',
  mordorOrc: 'MordorOrc'
};

// ============================================
// SOUND SYSTEM
// ============================================


// ============================================
// SAVE/LOAD SYSTEM
// ============================================


// ============================================
// DIFFICULTY SETTINGS
// ============================================


// ============================================
// ANIMATION STYLES
// ============================================
const AnimationStyles = () => (
  <style>{`
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); }
      50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes cardDeal {
      from { opacity: 0; transform: translateY(50px) rotateY(90deg); }
      to { opacity: 1; transform: translateY(0) rotateY(0deg); }
    }
    @keyframes damageFlash {
      0% { filter: brightness(1); }
      50% { filter: brightness(2) sepia(1) hue-rotate(-50deg); }
      100% { filter: brightness(1); }
    }
    @keyframes healGlow {
      0% { filter: brightness(1); }
      50% { filter: brightness(1.3) sepia(0.5) hue-rotate(60deg); }
      100% { filter: brightness(1); }
    }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    .animate-slide-in { animation: slideIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-shake { animation: shake 0.5s ease-in-out; }
    .animate-glow { animation: glow 2s ease-in-out infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-card-deal { animation: cardDeal 0.3s ease-out; }
    .animate-damage { animation: damageFlash 0.3s ease-out; }
    .animate-heal { animation: healGlow 0.5s ease-out; }
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .game-card { 
        width: 100px !important; 
        min-height: 140px !important; 
      }
      .card-hand {
        gap: 8px !important;
      }
      .menu-screen {
        padding: 20px !important;
        margin: 10px !important;
      }
      .character-grid {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
      }
      .encounter-path {
        flex-direction: column !important;
        align-items: center !important;
      }
      .combat-screen {
        padding: 5px !important;
      }
      .shop-item {
        min-width: 100px !important;
        padding: 10px !important;
      }
      /* Mobile relic display */
      .relic-display {
        flex-direction: column !important;
        gap: 8px !important;
      }
      /* Mobile skill tree */
      .skill-branch {
        min-width: 100% !important;
      }
    }
    @media (max-width: 480px) {
      .game-card { 
        width: 75px !important; 
        min-height: 100px !important;
        font-size: 8px !important;
      }
      .button {
        padding: 14px 18px !important;
        font-size: 0.95rem !important;
        min-height: 48px !important;
      }
      .portrait {
        width: 50px !important;
        height: 70px !important;
      }
      /* Larger touch targets */
      .encounter-node {
        min-width: 80px !important;
        min-height: 80px !important;
      }
      /* Stack reward cards vertically on small screens */
      .reward-cards {
        flex-direction: column !important;
        align-items: center !important;
      }
      .reward-card {
        width: 90% !important;
        max-width: 280px !important;
      }
    }
    /* Touch-friendly tap targets */
    .touch-target {
      min-height: 44px;
      min-width: 44px;
    }
    /* Prevent text selection on interactive elements */
    .no-select {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    /* Better tap feedback */
    .tap-feedback:active {
      transform: scale(0.97);
      opacity: 0.9;
    }
    /* Smooth scrolling for mobile */
    .scroll-container {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    /* Fix for iOS input zoom */
    input, select, textarea {
      font-size: 16px !important;
    }
    /* Modal backdrop touch handling */
    .modal-backdrop {
      -webkit-tap-highlight-color: transparent;
    }
    
    /* ACCESSIBILITY: Screen reader only content */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* ACCESSIBILITY: Focus visible for keyboard navigation */
    .focus-visible:focus {
      outline: 3px solid #d4af37;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3);
    }
    
    /* ACCESSIBILITY: Skip to main content link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #d4af37;
      color: #1a0f08;
      padding: 8px 16px;
      z-index: 10000;
      font-weight: bold;
      transition: top 0.3s;
    }
    .skip-link:focus {
      top: 0;
    }
    
    /* ACCESSIBILITY: Better focus indicators for cards */
    .card-focusable:focus {
      outline: 3px solid #005fcc;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(0, 95, 204, 0.5);
    }
    
    /* REDUCED MOTION: Respect user preferences */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      .animate-fade-in,
      .animate-slide-in,
      .animate-pulse,
      .animate-shake,
      .animate-glow,
      .animate-float,
      .animate-card-deal,
      .animate-damage,
      .animate-heal {
        animation: none !important;
      }
    }
    
    /* PARTICLES: Combat effect particles */
    .particle-container {
      position: absolute;
      pointer-events: none;
      z-index: 1000;
    }
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .particle--damage {
      background: radial-gradient(circle, #ff4444 0%, #880000 100%);
      box-shadow: 0 0 6px #ff0000;
    }
    .particle--heal {
      background: radial-gradient(circle, #44ff44 0%, #008800 100%);
      box-shadow: 0 0 6px #00ff00;
    }
    .particle--block {
      background: radial-gradient(circle, #4444ff 0%, #000088 100%);
      box-shadow: 0 0 6px #0000ff;
    }
    .particle--gold {
      background: radial-gradient(circle, #ffd700 0%, #b8860b 100%);
      box-shadow: 0 0 6px #ffd700;
    }
    
    /* HIGH CONTRAST: Better visibility option */
    @media (prefers-contrast: high) {
      .game-card {
        border-width: 3px !important;
      }
      .button {
        border-width: 2px !important;
      }
    }

  `}</style>
);

const DIFFICULTY = {
  easy: {
    name: 'Easy',
    description: 'For newcomers to Middle-earth',
    enemyHpMod: 0.7,
    enemyDamageMod: 0.8,
    playerHpMod: 1.2,
    startingGold: 100,
    energyBonus: 1
  },
  normal: {
    name: 'Normal',
    description: 'A balanced journey',
    enemyHpMod: 1.0,
    enemyDamageMod: 1.0,
    playerHpMod: 1.0,
    startingGold: 50,
    energyBonus: 0
  },
  hard: {
    name: 'Hard',
    description: 'For seasoned adventurers',
    enemyHpMod: 1.3,
    enemyDamageMod: 1.2,
    playerHpMod: 0.9,
    startingGold: 25,
    energyBonus: 0
  },
  nightmare: {
    name: 'Nightmare',
    description: 'Face the full wrath of Mordor',
    enemyHpMod: 1.5,
    enemyDamageMod: 1.4,
    playerHpMod: 0.8,
    startingGold: 0,
    energyBonus: -1
  }
};

// ============================================
// US-003: ADAPTIVE DIFFICULTY SCALING SYSTEM
// ============================================

// Performance tracking for adaptive difficulty
const ADAPTIVE_DIFFICULTY_STORAGE_KEY = 'lotr_adaptive_difficulty';

// Adaptive difficulty configuration
const ADAPTIVE_CONFIG = {
  // Performance windows (how many recent combats to consider)
  combatWindow: 10,
  runWindow: 5,
  
  // Scaling factors
  minScale: 0.7,    // Minimum difficulty scale (30% easier)
  maxScale: 1.5,    // Maximum difficulty scale (50% harder)
  
  // Weights for different performance metrics
  weights: {
    winStreak: 0.25,        // Consecutive wins
    perfectCombats: 0.20,   // Combats with no damage taken
    avgTurnsToWin: 0.15,    // Efficiency (fewer turns = harder)
    avgDamageTaken: 0.15,   // Survivability
    cardEfficiency: 0.15,   // Cards played vs damage dealt
    runCompletion: 0.10     // How far player typically gets
  },
  
  // Thresholds for scaling triggers
  thresholds: {
    winStreakUp: 3,         // Wins in a row to increase difficulty
    winStreakDown: 2,       // Losses in a row to decrease difficulty
    perfectCombatRate: 0.4, // >40% perfect combats = increase
    lowDamageRate: 0.3,     // >30% low damage combats = increase
    quickWinTurns: 4,       // Winning in <=4 turns = very efficient
    struggleWinTurns: 10    // Winning in >=10 turns = struggling
  }
};

// Load adaptive difficulty state
const loadAdaptiveState = () => {
  try {
    const saved = localStorage.getItem(ADAPTIVE_DIFFICULTY_STORAGE_KEY);
    if (saved) {
      return JSON.parse(saved);
    }
  } catch (e) {
    console.warn('Failed to load adaptive difficulty state');
  }
  
  return {
    recentCombats: [],      // Array of combat results
    recentRuns: [],         // Array of run results
    currentScale: 1.0,      // Current difficulty scale multiplier
    winStreak: 0,
    lossStreak: 0,
    totalCombatsWon: 0,
    totalCombatsLost: 0,
    perfectCombats: 0,
    lastUpdated: Date.now()
  };
};

// Save adaptive difficulty state
const saveAdaptiveState = (state) => {
  try {
    localStorage.setItem(ADAPTIVE_DIFFICULTY_STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn('Failed to save adaptive difficulty state');
  }
};

// Record a combat result for adaptive difficulty
const recordCombatResult = (adaptiveState, result) => {
  const newState = { ...adaptiveState };
  
  // Add combat to recent history
  newState.recentCombats = [
    result,
    ...newState.recentCombats.slice(0, ADAPTIVE_CONFIG.combatWindow - 1)
  ];
  
  // Update win/loss tracking
  if (result.victory) {
    newState.totalCombatsWon++;
    newState.winStreak++;
    newState.lossStreak = 0;
    
    if (result.damageTaken === 0) {
      newState.perfectCombats++;
    }
  } else {
    newState.totalCombatsLost++;
    newState.lossStreak++;
    newState.winStreak = 0;
  }
  
  // Recalculate adaptive scale
  newState.currentScale = calculateAdaptiveScale(newState);
  newState.lastUpdated = Date.now();
  
  saveAdaptiveState(newState);
  return newState;
};

// Record a run result
const recordRunResult = (adaptiveState, result) => {
  const newState = { ...adaptiveState };
  
  newState.recentRuns = [
    result,
    ...newState.recentRuns.slice(0, ADAPTIVE_CONFIG.runWindow - 1)
  ];
  
  // Recalculate based on run data too
  newState.currentScale = calculateAdaptiveScale(newState);
  newState.lastUpdated = Date.now();
  
  saveAdaptiveState(newState);
  return newState;
};

// Calculate the adaptive difficulty scale based on performance
const calculateAdaptiveScale = (state) => {
  const { recentCombats, recentRuns, winStreak, lossStreak } = state;
  const { weights, thresholds, minScale, maxScale } = ADAPTIVE_CONFIG;
  
  if (recentCombats.length < 3) {
    // Not enough data yet, use neutral scaling
    return 1.0;
  }
  
  let scaleFactor = 0;
  
  // Factor 1: Win/Loss streak
  if (winStreak >= thresholds.winStreakUp) {
    scaleFactor += weights.winStreak * (0.1 * Math.min(winStreak, 5));
  } else if (lossStreak >= thresholds.winStreakDown) {
    scaleFactor -= weights.winStreak * (0.1 * Math.min(lossStreak, 5));
  }
  
  // Factor 2: Perfect combat rate
  const perfectRate = recentCombats.filter(c => c.victory && c.damageTaken === 0).length / recentCombats.length;
  if (perfectRate > thresholds.perfectCombatRate) {
    scaleFactor += weights.perfectCombats * (perfectRate - thresholds.perfectCombatRate) * 2;
  } else if (perfectRate < 0.1) {
    scaleFactor -= weights.perfectCombats * 0.15;
  }
  
  // Factor 3: Average turns to win
  const wonCombats = recentCombats.filter(c => c.victory);
  if (wonCombats.length > 0) {
    const avgTurns = wonCombats.reduce((sum, c) => sum + c.turns, 0) / wonCombats.length;
    if (avgTurns <= thresholds.quickWinTurns) {
      scaleFactor += weights.avgTurnsToWin * 0.2;
    } else if (avgTurns >= thresholds.struggleWinTurns) {
      scaleFactor -= weights.avgTurnsToWin * 0.15;
    }
  }
  
  // Factor 4: Average damage taken
  const avgDamage = recentCombats.reduce((sum, c) => sum + c.damageTaken, 0) / recentCombats.length;
  const lowDamageRate = recentCombats.filter(c => c.victory && c.damageTaken < 10).length / recentCombats.length;
  if (lowDamageRate > thresholds.lowDamageRate) {
    scaleFactor += weights.avgDamageTaken * 0.15;
  } else if (avgDamage > 25) {
    scaleFactor -= weights.avgDamageTaken * 0.1;
  }
  
  // Factor 5: Card efficiency (damage dealt per card played)
  const totalDamage = recentCombats.reduce((sum, c) => sum + c.damageDealt, 0);
  const totalCards = recentCombats.reduce((sum, c) => sum + c.cardsPlayed, 0);
  if (totalCards > 0) {
    const efficiency = totalDamage / totalCards;
    if (efficiency > 8) {
      scaleFactor += weights.cardEfficiency * 0.2;
    } else if (efficiency < 3) {
      scaleFactor -= weights.cardEfficiency * 0.15;
    }
  }
  
  // Factor 6: Run completion rate
  if (recentRuns.length >= 2) {
    const avgCompletion = recentRuns.reduce((sum, r) => sum + r.completionPercent, 0) / recentRuns.length;
    if (avgCompletion > 80) {
      scaleFactor += weights.runCompletion * 0.2;
    } else if (avgCompletion < 30) {
      scaleFactor -= weights.runCompletion * 0.15;
    }
  }
  
  // Apply scale factor to get final multiplier
  const finalScale = 1.0 + scaleFactor;
  
  // Clamp to min/max bounds
  return Math.max(minScale, Math.min(maxScale, finalScale));
};

// Get adaptive modifiers for combat
const getAdaptiveModifiers = (adaptiveState, baseDifficulty) => {
  const scale = adaptiveState.currentScale || 1.0;
  const base = DIFFICULTY[baseDifficulty] || DIFFICULTY.normal;
  
  return {
    enemyHpMod: base.enemyHpMod * scale,
    enemyDamageMod: base.enemyDamageMod * scale,
    // Player modifiers scale inversely (higher scale = less player advantage)
    playerHpMod: base.playerHpMod / Math.sqrt(scale),
    startingGold: Math.floor(base.startingGold / scale),
    energyBonus: scale > 1.2 ? base.energyBonus - 1 : base.energyBonus,
    adaptiveScale: scale
  };
};

// Get readable difficulty description
const getAdaptiveDifficultyLabel = (scale) => {
  if (scale <= 0.75) return { label: 'Adjusted: Easier', color: '#66ff66', icon: 'ð¿' };
  if (scale <= 0.9) return { label: 'Adjusted: Slightly Easier', color: '#99ff99', icon: 'ð' };
  if (scale <= 1.1) return { label: 'Balanced', color: '#ffffff', icon: 'âï¸' };
  if (scale <= 1.25) return { label: 'Adjusted: Harder', color: '#ffaa66', icon: 'ð¥' };
  if (scale <= 1.4) return { label: 'Adjusted: Much Harder', color: '#ff6666', icon: 'ð' };
  return { label: 'Adjusted: Extreme', color: '#ff3333', icon: 'â ï¸' };
};

const SaveSystem = {
  saveKey: 'lotr_deckbuilder_save',
  _cache: null,
  
  async save(gameData) {
    try {
      if (window.storage) {
        const saveData = JSON.stringify(gameData);
        await window.storage.set(this.saveKey, saveData);
        this._cache = gameData;
        return true;
      }
      // ENHANCEMENT: Fallback to localStorage via GameStorage
      if (GameStorage.isAvailable()) {
        const success = await GameStorage.save(gameData, this.saveKey);
        if (success) this._cache = gameData;
        return success;
      }
      return false;
    } catch (e) {
      console.error('Save failed:', e);
      return false;
    }
  },
  
  async load() {
    try {
      if (window.storage) {
        const result = await window.storage.get(this.saveKey);
        if (result && result.value) {
          this._cache = JSON.parse(result.value);
          return this._cache;
        }
      }
      // ENHANCEMENT: Fallback to localStorage via GameStorage
      if (GameStorage.isAvailable()) {
        const data = GameStorage.load(this.saveKey);
        if (data) {
          this._cache = data;
          return this._cache;
        }
      }
      return null;
    } catch (e) {
      console.error('Load failed:', e);
      return null;
    }
  },
  
  async hasSave() {
    try {
      if (window.storage) {
        const result = await window.storage.get(this.saveKey);
        return result && result.value !== null;
      }
      // ENHANCEMENT: Fallback check
      if (GameStorage.isAvailable()) {
        return GameStorage.load(this.saveKey) !== null;
      }
      return false;
    } catch (e) {
      return false;
    }
  },
  
  async deleteSave() {
    try {
      if (window.storage) {
        await window.storage.delete(this.saveKey);
        this._cache = null;
      }
      // ENHANCEMENT: Also clear localStorage fallback
      if (GameStorage.isAvailable()) {
        GameStorage.delete(this.saveKey);
      }
    } catch (e) {
      console.error('Delete failed:', e);
    }
  }
};

const SoundSystem = {
  audioContext: null,
  
  init() {
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return this.audioContext;
  },
  
  enabled: true,
  
  playTone(frequency, duration, type = 'sine', volume = 0.3) {
    if (!this.enabled) return;
    try {
      const ctx = this.init();
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = type;
      gainNode.gain.setValueAtTime(volume, ctx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
      
      oscillator.start(ctx.currentTime);
      oscillator.stop(ctx.currentTime + duration);
    } catch (e) {}
  },
  
  cardPlay() {
    this.playTone(440, 0.1, 'sine', 0.2);
    setTimeout(() => this.playTone(554, 0.1, 'sine', 0.15), 50);
  },
  
  attack() {
    this.playTone(150, 0.15, 'sawtooth', 0.3);
    setTimeout(() => this.playTone(100, 0.2, 'sawtooth', 0.2), 100);
  },
  
  block() {
    this.playTone(800, 0.05, 'square', 0.15);
    this.playTone(600, 0.1, 'square', 0.1);
  },
  
  heal() {
    this.playTone(523, 0.15, 'sine', 0.2);
    setTimeout(() => this.playTone(659, 0.15, 'sine', 0.2), 100);
    setTimeout(() => this.playTone(784, 0.2, 'sine', 0.2), 200);
  },
  
  damage() {
    this.playTone(200, 0.1, 'sawtooth', 0.25);
    this.playTone(150, 0.15, 'sawtooth', 0.2);
  },
  
  victory() {
    const notes = [523, 659, 784, 1047];
    notes.forEach((freq, i) => {
      setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.25), i * 150);
    });
  },
  
  defeat() {
    const notes = [400, 350, 300, 250];
    notes.forEach((freq, i) => {
      setTimeout(() => this.playTone(freq, 0.4, 'sine', 0.2), i * 200);
    });
  },
  
  buttonClick() {
    this.playTone(600, 0.05, 'sine', 0.1);
  },
  
  turnStart() {
    this.playTone(330, 0.1, 'sine', 0.15);
    setTimeout(() => this.playTone(440, 0.15, 'sine', 0.15), 80);
  },
  
  enemyTurn() {
    this.playTone(220, 0.2, 'triangle', 0.2);
  }
};


// ============================================
// CARD ART SVG COMPONENTS
// ============================================
const SwordIcon = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 40 40">
    <defs>
      <linearGradient id="swordBlade" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stopColor="#c0c0c0" />
        <stop offset="50%" stopColor="#ffffff" />
        <stop offset="100%" stopColor="#a0a0a0" />
      </linearGradient>
    </defs>
    <path d="M20 2 L23 30 L26 32 L20 38 L14 32 L17 30 Z" fill="url(#swordBlade)" stroke="#666" strokeWidth="1" />
    <rect x="14" y="30" width="12" height="4" fill="#8b4513" />
    <circle cx="20" cy="32" r="2" fill="#d4af37" />
  </svg>
);

const ShieldIcon = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 40 40">
    <defs>
      <linearGradient id="shieldMetal" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#8b7355" />
        <stop offset="50%" stopColor="#d4af37" />
        <stop offset="100%" stopColor="#8b7355" />
      </linearGradient>
    </defs>
    <path d="M20 4 L35 10 L35 22 Q35 35 20 38 Q5 35 5 22 L5 10 Z" fill="url(#shieldMetal)" stroke="#654321" strokeWidth="2" />
    <path d="M20 8 L30 12 L30 21 Q30 31 20 34 Q10 31 10 21 L10 12 Z" fill="#2d4a2d" stroke="#d4af37" strokeWidth="1" />
  </svg>
);

const BowArrowIcon = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 40 40">
    <defs>
      <linearGradient id="bowWood" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stopColor="#8b4513" />
        <stop offset="50%" stopColor="#d2691e" />
        <stop offset="100%" stopColor="#8b4513" />
      </linearGradient>
    </defs>
    <path d="M8 5 Q2 20 8 35" stroke="url(#bowWood)" strokeWidth="3" fill="none" />
    <line x1="8" y1="5" x2="8" y2="35" stroke="#c0a080" strokeWidth="1" />
    <line x1="10" y1="20" x2="38" y2="20" stroke="#654321" strokeWidth="2" />
    <polygon points="38,20 32,16 32,24" fill="#808080" />
  </svg>
);

const MagicIcon = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 40 40">
    <defs>
      <filter id="magicGlow">
        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <linearGradient id="magicGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#9370db" />
        <stop offset="100%" stopColor="#4b0082" />
      </linearGradient>
    </defs>
    <circle cx="20" cy="20" r="15" fill="url(#magicGrad)" filter="url(#magicGlow)" />
    <path d="M20 8 L22 17 L30 17 L24 22 L26 32 L20 26 L14 32 L16 22 L10 17 L18 17 Z" fill="#ffd700" />
  </svg>
);

const DrawCardIcon = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 40 40">
    <rect x="8" y="5" width="18" height="26" rx="2" fill="#4a3728" stroke="#d4af37" strokeWidth="1" />
    <rect x="14" y="9" width="18" height="26" rx="2" fill="#5a4738" stroke="#d4af37" strokeWidth="1" />
    <path d="M23 15 L23 28 M17 22 L29 22" stroke="#d4af37" strokeWidth="2" />
  </svg>
);

const StrengthIcon = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 40 40">
    <defs>
      <linearGradient id="muscleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#dc143c" />
        <stop offset="100%" stopColor="#8b0000" />
      </linearGradient>
    </defs>
    <ellipse cx="20" cy="20" rx="12" ry="14" fill="url(#muscleGrad)" />
    <text x="20" y="25" textAnchor="middle" fill="#fff" fontSize="14" fontWeight="bold">ðª</text>
  </svg>
);

const getCardArt = (cardId, type) => {
  const artMap = {
    'strike': SwordIcon, 'defend': ShieldIcon, 'bash': SwordIcon, 'courage': MagicIcon,
    'arrow': BowArrowIcon, 'dodge': ShieldIcon, 'multishot': BowArrowIcon, 'focus': DrawCardIcon,
    'keen': BowArrowIcon, 'heavy_strike': SwordIcon, 'pommel_strike': SwordIcon, 'iron_wave': SwordIcon,
    'shrug_off': ShieldIcon, 'true_grit': ShieldIcon, 'cleave': SwordIcon, 'clothesline': SwordIcon,
    'flex': StrengthIcon, 'rage': StrengthIcon, 'seeing_red': MagicIcon, 'quick_shot': BowArrowIcon,
    'piercing_shot': BowArrowIcon, 'retreat': ShieldIcon, 'backflip': ShieldIcon, 'acrobatics': DrawCardIcon,
    'poison_shot': BowArrowIcon, 'deadly_shot': BowArrowIcon, 'blur': ShieldIcon, 'dodge_roll': ShieldIcon,
    'prepared': DrawCardIcon,
    // Gandalf cards
    'staff_strike': MagicIcon, 'magic_barrier': ShieldIcon, 'spark': MagicIcon, 'fireball': MagicIcon,
    'illuminate': DrawCardIcon, 'lightning': MagicIcon, 'flame_wave': MagicIcon, 'arcane_shield': ShieldIcon,
    'meditation': DrawCardIcon, 'channel': MagicIcon, 'inferno': MagicIcon, 'frost_nova': MagicIcon,
    'mana_surge': MagicIcon, 'arcane_intellect': DrawCardIcon, 'counterspell': ShieldIcon,
    'you_shall_not_pass': MagicIcon, 'white_light': MagicIcon, 'wizard_staff': MagicIcon,
    'time_warp': DrawCardIcon, 'meteor': MagicIcon,
    // Gimli cards
    'axe_strike': SwordIcon, 'dwarf_guard': ShieldIcon, 'heavy_axe': SwordIcon, 'iron_skin': ShieldIcon,
    'cleaving_blow': SwordIcon, 'moria_stance': ShieldIcon, 'battle_axe': SwordIcon, 'stone_wall': ShieldIcon,
    'reckless_swing': SwordIcon, 'dwarven_resilience': ShieldIcon, 'baruk_khazad': SwordIcon,
    'mithril_armor': ShieldIcon, 'khazad_dum': SwordIcon, 'durin_crown': StrengthIcon, 'battle_fury': SwordIcon,
    'orc_slayer': SwordIcon, 'dwarven_rage': StrengthIcon, 'berserk': StrengthIcon, 'son_of_gloin': SwordIcon,
  };
  
  // Curse card icons
  if (type === 'curse') {
    const curseIcons = {
      wound: 'ð©¸', dazed: 'ð«', saurons_gaze: 'ðï¸',
      ring_temptation: 'ð', morgul_wound: 'ð¡ï¸', shadow_grip: 'ðï¸',
      despair: 'ð¢', regret: 'ð­', ring_whispers: 'ð'
    };
    return (
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.8rem' }}>
        {curseIcons[cardId] || 'â ï¸'}
      </div>
    );
  }
  
  const ArtComponent = artMap[cardId];
  if (ArtComponent) return <ArtComponent size={36} />;
  if (type === 'attack') return <SwordIcon size={36} />;
  if (type === 'skill') return <ShieldIcon size={36} />;
  return <MagicIcon size={36} />;
};

const getCardDescription = (card, playerStrength = 0, playerDexterity = 0) => {
  const parts = [];
  if (card.damage) {
    const totalDamage = card.damage + playerStrength;
    parts.push(`Deal ${totalDamage} damage${card.hits > 1 ? ` ${card.hits} times` : ''}`);
  }
  if (card.block) {
    const totalBlock = card.block + playerDexterity;
    parts.push(`Gain ${totalBlock} block`);
  }
  if (card.draw) parts.push(`Draw ${card.draw} card${card.draw > 1 ? 's' : ''}`);
  if (card.strength) parts.push(`Gain ${card.strength} Strength`);
  if (card.dexterity) parts.push(`Gain ${card.dexterity} Dexterity`);
  if (card.vulnerable) parts.push(`Apply ${card.vulnerable} Vulnerable`);
  if (card.weak) parts.push(`Apply ${card.weak} Weak`);
  if (card.poison) parts.push(`Apply ${card.poison} Poison`);
  if (card.burn) parts.push(`Apply ${card.burn} Burn`);
  if (card.heal) parts.push(`Heal ${card.heal} HP`);
  if (card.energy) parts.push(`Gain ${card.energy} Energy`);
  if (card.dodge) parts.push(`Block is retained next turn`);
  if (card.exhaust) parts.push(`Exhaust (removed for this combat)`);
  return parts.join('. ') + '.';
};

// ============================================
// PORTRAIT COMPONENT
// ============================================
const Portrait = ({ src, size = 120, border = '#d4af37', responsive = false }) => {
  // src is now a character key like 'Aragorn', 'Legolas', etc.
  const PortraitComponent = CharacterPortraits[src];
  
  return (
    <div style={{
      width: size,
      height: size * 1.4,
      borderRadius: '12px',
      overflow: 'hidden',
      border: `3px solid ${border}`,
      boxShadow: '0 8px 25px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.3)',
      background: 'linear-gradient(135deg, #2d1f14 0%, #1a0f08 100%)',
    }}>
      {PortraitComponent ? <PortraitComponent /> : (
        <div style={{
          width: '100%',
          height: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: '#666',
          fontSize: '10px'
        }}>
          ?
        </div>
      )}
    </div>
  );
};

// ============================================
// CARD FRAME COMPONENT
// ============================================
const CardFrame = ({ type, children, rarity = 'common' }) => {
  const borderColors = { attack: '#dc143c', skill: '#4169e1', power: '#9370db', curse: '#660099' };
  const bgColors = {
    attack: 'linear-gradient(135deg, #4a1a1a 0%, #2d0d0d 100%)',
    skill: 'linear-gradient(135deg, #1a2a4a 0%, #0d1a2d 100%)',
    power: 'linear-gradient(135deg, #2d1a4a 0%, #1a0d2d 100%)',
    curse: 'linear-gradient(135deg, #2d002d 0%, #1a001a 100%)'
  };
  const rarityGlow = {
    common: 'none',
    uncommon: '0 0 10px rgba(30, 144, 255, 0.5)',
    rare: '0 0 15px rgba(255, 215, 0, 0.6)',
    curse: '0 0 12px rgba(102, 0, 153, 0.6)'
  };
  return (
    <div style={{
      background: bgColors[type] || bgColors.skill,
      border: `2px solid ${borderColors[type] || '#666'}`,
      borderRadius: '8px',
      padding: '3px',
      boxShadow: rarityGlow[rarity] || 'none',
      position: 'relative',
      overflow: 'hidden'
    }}>
      {children}
    </div>
  );
};

// ============================================
// THEMATIC UI COMPONENTS - Middle-earth styled
// ============================================

// MiddleEarthButton - Tolkien-themed button with parchment texture
const MiddleEarthButton = ({ variant = 'primary', children, disabled = false, style = {}, ...props }) => (
  <button
    disabled={disabled}
    style={{
      background: variant === 'primary' 
        ? 'linear-gradient(145deg, #8b4513, #5a2d0a)'
        : variant === 'secondary'
        ? 'linear-gradient(145deg, #2d4a2d, #1a2f1a)'
        : variant === 'danger'
        ? 'linear-gradient(145deg, #8b0000, #5a0000)'
        : 'linear-gradient(145deg, #4a4a5a, #2a2a3a)',
      border: '2px solid #d4af37',
      borderRadius: '8px',
      padding: '12px 24px',
      color: disabled ? '#888' : '#f4e4bc',
      fontFamily: "'Cinzel', 'Eczar', Georgia, serif",
      fontSize: '1rem',
      fontWeight: '600',
      textShadow: '1px 1px 2px rgba(0,0,0,0.8)',
      boxShadow: disabled 
        ? 'none' 
        : '0 4px 15px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15)',
      cursor: disabled ? 'not-allowed' : 'pointer',
      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
      position: 'relative',
      overflow: 'hidden',
      opacity: disabled ? 0.6 : 1,
      // Parchment texture overlay
      backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E")`,
      backgroundBlendMode: 'overlay',
      letterSpacing: '1px',
      ...style
    }}
    onMouseOver={(e) => {
      if (!disabled) {
        e.currentTarget.style.transform = 'translateY(-2px) scale(1.02)';
        e.currentTarget.style.boxShadow = '0 6px 20px rgba(212, 175, 55, 0.4), inset 0 1px 0 rgba(255,255,255,0.2)';
      }
    }}
    onMouseOut={(e) => {
      e.currentTarget.style.transform = 'translateY(0) scale(1)';
      e.currentTarget.style.boxShadow = disabled ? 'none' : '0 4px 15px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15)';
    }}
    {...props}
  >
    {children}
  </button>
);

// RunicDivider - Decorative divider with runic pattern
const RunicDivider = ({ width = '100%', opacity = 0.6 }) => (
  <svg width={width} height="3" style={{ margin: '20px 0', display: 'block' }}>
    <defs>
      <pattern id="runicPattern" x="0" y="0" width="40" height="3" patternUnits="userSpaceOnUse">
        <path 
          d="M0,1.5 L8,1.5 M12,1.5 L16,1.5 M20,0 L20,3 M24,1.5 L32,1.5 M36,1.5 L40,1.5" 
          stroke="#d4af37" 
          strokeWidth="1" 
          strokeLinecap="round"
        />
      </pattern>
    </defs>
    <rect width="100%" height="3" fill="url(#runicPattern)" opacity={opacity}/>
  </svg>
);

// StatusEffectSummary - Progressive disclosure UI for combat status effects
const StatusEffectSummary = ({ player, enemies, targetedEnemy }) => {
  const [expanded, setExpanded] = useState(false);
  
  const enemy = enemies && enemies[targetedEnemy] ? enemies[targetedEnemy] : null;
  
  // Group player buffs
  const offensiveBuffs = [
    player?.strength > 0 && { icon: 'ðª', value: player.strength, label: 'Strength', color: '#ff8866' },
    player?.dexterity > 0 && { icon: 'ð', value: player.dexterity, label: 'Dexterity', color: '#66ff88' }
  ].filter(Boolean);
  
  const defensiveBuffs = [
    player?.block > 0 && { icon: 'ð¡ï¸', value: player.block, label: 'Block', color: '#6b8bff' }
  ].filter(Boolean);
  
  // Group enemy debuffs
  const debuffs = enemy ? [
    enemy.vulnerable > 0 && { icon: 'ð¯', value: enemy.vulnerable, label: 'Vulnerable', color: '#ff6b6b' },
    enemy.weak > 0 && { icon: 'ðµ', value: enemy.weak, label: 'Weak', color: '#9966ff' },
    enemy.poison > 0 && { icon: 'ð§ª', value: enemy.poison, label: 'Poison', color: '#00ff00' },
    enemy.burn > 0 && { icon: 'ð¥', value: enemy.burn, label: 'Burn', color: '#ff6600' }
  ].filter(Boolean) : [];
  
  const totalEffects = offensiveBuffs.length + defensiveBuffs.length + debuffs.length;
  
  if (totalEffects === 0) return null;
  
  return (
    <div style={{
      background: 'rgba(0,0,0,0.6)',
      borderRadius: '12px',
      padding: '12px',
      marginTop: '10px',
      border: '1px solid rgba(212, 175, 55, 0.3)',
      transition: 'all 0.3s ease'
    }}>
      {/* COMPACT VIEW: Show only totals */}
      {!expanded && (
        <div style={{ display: 'flex', gap: '15px', justifyContent: 'center', alignItems: 'center', flexWrap: 'wrap' }}>
          {offensiveBuffs.length > 0 && (
            <span style={{ color: '#ff8866', fontSize: '0.9rem' }}>
              âï¸ +{offensiveBuffs.reduce((sum, b) => sum + b.value, 0)}
            </span>
          )}
          {defensiveBuffs.length > 0 && (
            <span style={{ color: '#6b8bff', fontSize: '0.9rem' }}>
              ð¡ï¸ {defensiveBuffs[0].value}
            </span>
          )}
          {debuffs.length > 0 && (
            <span style={{ color: '#ff6b6b', fontSize: '0.9rem' }}>
              ð {debuffs.length} effect{debuffs.length > 1 ? 's' : ''}
            </span>
          )}
          <button 
            onClick={() => setExpanded(true)}
            style={{ 
              background: 'rgba(212, 175, 55, 0.2)', 
              border: '1px solid rgba(212, 175, 55, 0.5)', 
              color: '#d4af37', 
              cursor: 'pointer',
              fontSize: '0.75rem',
              padding: '4px 10px',
              borderRadius: '12px',
              transition: 'all 0.2s ease'
            }}
            onMouseOver={(e) => {
              e.currentTarget.style.background = 'rgba(212, 175, 55, 0.3)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.background = 'rgba(212, 175, 55, 0.2)';
            }}
          >
            Details â¼
          </button>
        </div>
      )}
      
      {/* EXPANDED VIEW: Full breakdown */}
      {expanded && (
        <div style={{ animation: 'fadeIn 0.3s' }}>
          <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            marginBottom: '12px',
            borderBottom: '1px solid rgba(212, 175, 55, 0.2)',
            paddingBottom: '8px'
          }}>
            <h4 style={{ margin: 0, color: '#d4af37', fontSize: '0.9rem', letterSpacing: '1px' }}>
              âï¸ ACTIVE EFFECTS
            </h4>
            <button 
              onClick={() => setExpanded(false)}
              style={{ 
                background: 'rgba(139, 0, 0, 0.3)', 
                border: '1px solid rgba(220, 20, 60, 0.5)', 
                color: '#ff6b6b', 
                cursor: 'pointer',
                fontSize: '1rem',
                width: '28px',
                height: '28px',
                borderRadius: '50%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                transition: 'all 0.2s ease'
              }}
              onMouseOver={(e) => {
                e.currentTarget.style.background = 'rgba(139, 0, 0, 0.5)';
              }}
              onMouseOut={(e) => {
                e.currentTarget.style.background = 'rgba(139, 0, 0, 0.3)';
              }}
            >
              â
            </button>
          </div>
          
          {offensiveBuffs.length > 0 && (
            <div style={{ marginBottom: '10px' }}>
              <div style={{ color: '#ff8866', fontSize: '0.7rem', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                âï¸ Your Offense
              </div>
              <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                {offensiveBuffs.map((buff, i) => (
                  <span key={i} style={{
                    background: 'rgba(255,136,102,0.2)',
                    padding: '5px 10px',
                    borderRadius: '8px',
                    fontSize: '0.85rem',
                    color: '#f4e4bc',
                    border: '1px solid rgba(255,136,102,0.3)'
                  }}>
                    {buff.icon} {buff.label}: <strong>+{buff.value}</strong>
                  </span>
                ))}
              </div>
            </div>
          )}
          
          {defensiveBuffs.length > 0 && (
            <div style={{ marginBottom: '10px' }}>
              <div style={{ color: '#6b8bff', fontSize: '0.7rem', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                ð¡ï¸ Your Defense
              </div>
              <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                {defensiveBuffs.map((buff, i) => (
                  <span key={i} style={{
                    background: 'rgba(107,139,255,0.2)',
                    padding: '5px 10px',
                    borderRadius: '8px',
                    fontSize: '0.85rem',
                    color: '#f4e4bc',
                    border: '1px solid rgba(107,139,255,0.3)'
                  }}>
                    {buff.icon} {buff.label}: <strong>{buff.value}</strong>
                  </span>
                ))}
              </div>
            </div>
          )}
          
          {debuffs.length > 0 && (
            <div>
              <div style={{ color: '#ff6b6b', fontSize: '0.7rem', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                ð Enemy Debuffs
              </div>
              <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                {debuffs.map((debuff, i) => (
                  <span key={i} style={{
                    background: 'rgba(255,107,107,0.2)',
                    padding: '5px 10px',
                    borderRadius: '8px',
                    fontSize: '0.85rem',
                    color: '#f4e4bc',
                    border: `1px solid ${debuff.color}40`
                  }}>
                    {debuff.icon} {debuff.label}: <strong>{debuff.value}</strong>
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// CardDetailOverlay - Full card preview overlay with detailed information
const CardDetailOverlay = ({ card, player, onClose, getCardArt }) => {
  if (!card) return null;
  
  const totalDamage = (card.damage || 0) + (player?.strength || 0);
  const totalBlock = (card.block || 0) + (player?.dexterity || 0);
  
  const rarityColors = {
    common: { bg: 'linear-gradient(145deg, #888, #555)', text: '#ddd' },
    uncommon: { bg: 'linear-gradient(145deg, #1e90ff, #1560a0)', text: '#fff' },
    rare: { bg: 'linear-gradient(145deg, #ffd700, #b8960c)', text: '#000' },
    ultra_rare: { bg: 'linear-gradient(145deg, #ff00ff, #aa00aa)', text: '#fff' }
  };
  
  const typeColors = {
    attack: '#dc143c',
    skill: '#4169e1', 
    power: '#9370db'
  };
  
  return (
    <div 
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.9)',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        zIndex: 5000,
        animation: 'fadeIn 0.2s ease-out',
        cursor: 'pointer'
      }}
      onClick={onClose}
    >
      <div 
        style={{
          background: 'linear-gradient(145deg, #2d1a0a, #1a0f05)',
          borderRadius: '20px',
          padding: '30px',
          maxWidth: '450px',
          width: '90%',
          border: '3px solid #d4af37',
          boxShadow: '0 0 60px rgba(212, 175, 55, 0.4), 0 20px 60px rgba(0,0,0,0.8)',
          cursor: 'default',
          position: 'relative'
        }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Close button */}
        <button
          onClick={onClose}
          style={{
            position: 'absolute',
            top: '-15px',
            right: '-15px',
            background: 'linear-gradient(145deg, #8b0000, #5a0000)',
            border: '2px solid #ff6b6b',
            borderRadius: '50%',
            width: '40px',
            height: '40px',
            color: '#fff',
            fontSize: '1.2rem',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 4px 15px rgba(0,0,0,0.5)'
          }}
        >
          â
        </button>
        
        {/* Large card art */}
        <div style={{ 
          textAlign: 'center', 
          marginBottom: '20px',
          padding: '20px',
          background: 'rgba(0,0,0,0.3)',
          borderRadius: '12px',
          border: `2px solid ${typeColors[card.type] || '#666'}`
        }}>
          <div style={{ 
            transform: 'scale(1.8)',
            transformOrigin: 'center',
            marginBottom: '30px',
            marginTop: '20px'
          }}>
            {getCardArt && getCardArt(card.id, card.type)}
          </div>
        </div>
        
        {/* Card name with rarity badge */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: '15px',
          flexWrap: 'wrap',
          gap: '10px'
        }}>
          <h3 style={{ 
            color: '#f4e4bc', 
            margin: 0, 
            fontSize: '1.5rem',
            textShadow: '0 2px 4px rgba(0,0,0,0.5)'
          }}>
            {card.name}
            {card.upgraded && <span style={{ color: '#90ee90', marginLeft: '8px' }}>â¨</span>}
          </h3>
          <span style={{
            background: rarityColors[card.rarity || 'common'].bg,
            padding: '4px 12px',
            borderRadius: '12px',
            fontSize: '0.75rem',
            fontWeight: 'bold',
            color: rarityColors[card.rarity || 'common'].text,
            textTransform: 'uppercase',
            letterSpacing: '1px'
          }}>
            {card.rarity || 'common'}
          </span>
        </div>
        
        {/* Cost and type */}
        <div style={{ 
          display: 'flex', 
          gap: '20px', 
          marginBottom: '20px',
          fontSize: '1rem',
          color: '#c4b89a',
          flexWrap: 'wrap'
        }}>
          <span style={{
            background: 'rgba(255, 215, 0, 0.2)',
            padding: '6px 12px',
            borderRadius: '8px',
            border: '1px solid rgba(255, 215, 0, 0.4)'
          }}>
            â¡ Cost: <strong style={{ color: '#ffd700' }}>{card.cost}</strong>
          </span>
          <span style={{
            background: `${typeColors[card.type]}20`,
            padding: '6px 12px',
            borderRadius: '8px',
            border: `1px solid ${typeColors[card.type]}40`,
            color: typeColors[card.type]
          }}>
            ð­ {card.type?.charAt(0).toUpperCase() + card.type?.slice(1)}
          </span>
        </div>
        
        {/* Effects breakdown */}
        <div style={{
          background: 'rgba(0,0,0,0.4)',
          borderRadius: '12px',
          padding: '15px',
          marginBottom: '15px'
        }}>
          <h4 style={{ color: '#d4af37', marginBottom: '12px', fontSize: '1rem', borderBottom: '1px solid rgba(212,175,55,0.3)', paddingBottom: '8px' }}>
            ð Effects
          </h4>
          <div style={{ display: 'grid', gap: '10px' }}>
            {card.damage && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#ff6b6b' }}>âï¸ Damage:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>
                  {card.damage} 
                  {player?.strength > 0 && (
                    <span style={{ color: '#90ee90' }}> (+{player.strength}) = {totalDamage}</span>
                  )}
                  {card.hits > 1 && <span style={{ color: '#ffd700' }}> Ã {card.hits}</span>}
                </span>
              </div>
            )}
            {card.block && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#6b8bff' }}>ð¡ï¸ Block:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>
                  {card.block}
                  {player?.dexterity > 0 && (
                    <span style={{ color: '#90ee90' }}> (+{player.dexterity}) = {totalBlock}</span>
                  )}
                </span>
              </div>
            )}
            {card.heal && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#90ee90' }}>â¤ï¸ Heal:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>{card.heal}</span>
              </div>
            )}
            {card.draw && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#87ceeb' }}>ð Draw:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>+{card.draw} card{card.draw > 1 ? 's' : ''}</span>
              </div>
            )}
            {card.strength && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#ff8866' }}>ðª Strength:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>+{card.strength}</span>
              </div>
            )}
            {card.dexterity && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#66ff88' }}>ð Dexterity:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>+{card.dexterity}</span>
              </div>
            )}
            {card.energy && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#ffd700' }}>â¡ Energy:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>+{card.energy}</span>
              </div>
            )}
            {card.vulnerable && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#ff6b6b' }}>ð¯ Vulnerable:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>{card.vulnerable} turns</span>
              </div>
            )}
            {card.weak && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#9966ff' }}>ðµ Weak:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>{card.weak} turns</span>
              </div>
            )}
            {card.poison && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#00ff00' }}>ð§ª Poison:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>{card.poison}</span>
              </div>
            )}
            {card.burn && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#ff6600' }}>ð¥ Burn:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>{card.burn}</span>
              </div>
            )}
            {card.exhaust && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#ff6b6b' }}>ð Exhaust:</span>
                <span style={{ color: '#ff6b6b', fontWeight: 'bold' }}>Yes</span>
              </div>
            )}
            {card.dodge && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#87ceeb' }}>ð¨ Dodge:</span>
                <span style={{ color: '#f4e4bc', fontWeight: 'bold' }}>Next attack</span>
              </div>
            )}
          </div>
        </div>
        
        {/* Keyboard hint */}
        <div style={{
          textAlign: 'center',
          color: '#666',
          fontSize: '0.8rem',
          marginTop: '15px'
        }}>
          Click anywhere or press Escape to close
        </div>
      </div>
    </div>
  );
};

// ============================================
// MEMOIZED GAME CARD - Performance optimization
// ============================================
const GameCard = memo(({ 
  card, 
  isPlayable, 
  isHovered, 
  playerStrength, 
  playerDexterity,
  dealDelay, 
  onPlay, 
  onHover, 
  onLeave,
  onPreview,
  styles,
  animationsEnabled = true
}) => {
  const handleKeyDown = (e) => {
    if ((e.key === 'Enter' || e.key === ' ') && isPlayable) {
      e.preventDefault();
      onPlay(card);
    }
  };
  
  const handleRightClick = (e) => {
    e.preventDefault();
    if (onPreview) {
      onPreview(card);
    }
  };

  const getAccessibleDescription = () => {
    const parts = [];
    if (card.damage) parts.push(`Deals ${card.damage + playerStrength} damage${card.hits > 1 ? ` ${card.hits} times` : ''}`);
    if (card.block) parts.push(`Gains ${card.block + playerDexterity} block`);
    if (card.draw) parts.push(`Draws ${card.draw} cards`);
    if (card.strength) parts.push(`Gains ${card.strength} strength`);
    if (card.exhaust) parts.push(`Exhausts after use`);
    return parts.join('. ');
  };

  return (
    <div 
      role="button"
      tabIndex={isPlayable ? 0 : -1}
      aria-label={`${card.name}, costs ${card.cost} energy. ${getAccessibleDescription()}. ${isPlayable ? 'Press enter to play.' : 'Cannot play - insufficient energy.'} Right-click to preview.`}
      aria-disabled={!isPlayable}
      style={{
        ...styles.card,
        ...(!isPlayable ? styles.cardUnplayable : {}),
        transform: isHovered && isPlayable ? 'translateY(-20px) scale(1.1)' : 'translateY(0) scale(1)',
        animation: animationsEnabled ? `cardDeal 0.3s ease-out ${dealDelay}s both` : 'none',
        zIndex: isHovered ? 100 : 1,
        outline: 'none',
      }}
      onClick={() => isPlayable && onPlay(card)}
      onContextMenu={handleRightClick}
      onKeyDown={handleKeyDown}
      onMouseEnter={() => onHover(card.uid)}
      onMouseLeave={onLeave}
      onFocus={() => onHover(card.uid)}
      onBlur={onLeave}
      className="card-focusable"
    >
      <CardFrame type={card.type} rarity={card.rarity}>
        <div style={styles.cardInner}>
          <div style={styles.cardCost}>{card.cost}</div>
          <div style={styles.cardArt}>
            {getCardArt(card.id, card.type)}
          </div>
          <div style={styles.cardName}>{card.name}</div>
          <div style={styles.cardEffects}>
            {card.damage && <div>âï¸ {card.damage + playerStrength}{card.hits > 1 ? ` x${card.hits}` : ''}</div>}
            {card.block && <div>ð¡ï¸ {card.block + playerDexterity}</div>}
            {card.draw && <div>ð +{card.draw}</div>}
            {card.strength && <div>ðª +{card.strength}</div>}
            {card.dexterity && <div>ð +{card.dexterity}</div>}
            {card.vulnerable && <div>ð¯ {card.vulnerable}</div>}
            {card.weak && <div>ðµ {card.weak}</div>}
            {card.poison && <div>ð§ª {card.poison}</div>}
            {card.burn && <div>ð¥ {card.burn}</div>}
            {card.dodge && <div>ð¨ Dodge</div>}
            {card.exhaust && <div style={{color: '#ff6b6b'}}>Exhaust</div>}
            {card.energy && <div>â¡ +{card.energy}</div>}
          </div>
        </div>
      </CardFrame>
      {isHovered && (
        <div style={styles.tooltip} id={`card-tooltip-${card.uid}`} role="tooltip">
          <div style={styles.tooltipTitle}>{card.name}</div>
          <div style={styles.tooltipText}>
            {getCardDescription(card, playerStrength, playerDexterity)}
          </div>
          <div style={{marginTop: '6px', fontSize: '10px', color: '#888', textTransform: 'uppercase'}}>
            {card.type} â¢ {card.rarity || 'common'}
          </div>
        </div>
      )}
    </div>
  );
});

GameCard.displayName = 'GameCard';

// ============================================
// PARTICLE EFFECT COMPONENT - Visual polish
// ============================================
const CombatParticles = memo(({ effect, position, isActive }) => {
  const particles = useMemo(() => {
    if (!isActive) return [];
    return Array.from({ length: 15 }, (_, i) => ({
      id: i,
      x: (Math.random() - 0.5) * 60,
      y: (Math.random() - 0.5) * 60,
      velocityX: (Math.random() - 0.5) * 4,
      velocityY: (Math.random() - 0.5) * 4,
    }));
  }, [isActive]);

  if (!isActive || particles.length === 0) return null;

  return (
    <div className="particle-container" style={{ left: position?.x || '50%', top: position?.y || '50%' }}>
      {particles.map(particle => (
        <div
          key={particle.id}
          className={`particle particle--${effect}`}
          style={{
            left: particle.x,
            top: particle.y,
            animation: `fadeIn 0.3s ease-out`,
            transform: `translate(${particle.velocityX * 30}px, ${particle.velocityY * 30}px)`,
            opacity: 0,
            transition: 'all 0.8s ease-out',
          }}
        />
      ))}
    </div>
  );
});

CombatParticles.displayName = 'CombatParticles';

// ============================================
// GAME DATA
// ============================================
const CHARACTERS = {
  aragorn: {
    name: "Strider",
    class: "Ranger", 
    maxHp: 80,
    energyType: "Courage",
    maxEnergy: 3,
    image: characterImages.strider,
    starterRelicChoices: ['burning_blood', 'rangers_mark', 'dunedain_sigil'],
    startingDeck: [
      { id: 'strike', name: 'Sword Strike', cost: 1, damage: 6, type: 'attack' },
      { id: 'strike', name: 'Sword Strike', cost: 1, damage: 6, type: 'attack' },
      { id: 'strike', name: 'Sword Strike', cost: 1, damage: 6, type: 'attack' },
      { id: 'strike', name: 'Sword Strike', cost: 1, damage: 6, type: 'attack' },
      { id: 'defend', name: 'Shield Block', cost: 1, block: 5, type: 'skill' },
      { id: 'defend', name: 'Shield Block', cost: 1, block: 5, type: 'skill' },
      { id: 'defend', name: 'Shield Block', cost: 1, block: 5, type: 'skill' },
      { id: 'defend', name: 'Shield Block', cost: 1, block: 5, type: 'skill' },
      { id: 'bash', name: 'Shield Bash', cost: 2, damage: 8, vulnerable: 2, type: 'attack' },
      { id: 'courage', name: 'Kingly Courage', cost: 1, strength: 2, type: 'power' }
    ]
  },
  legolas: {
    name: "Legolas", 
    class: "Archer",
    maxHp: 70,
    energyType: "Focus",
    maxEnergy: 3,
    image: characterImages.legolas,
    starterRelicChoices: ['snecko_eye', 'mirkwood_bow', 'elven_boots'],
    startingDeck: [
      { id: 'arrow', name: 'Precise Shot', cost: 1, damage: 5, type: 'attack' },
      { id: 'arrow', name: 'Precise Shot', cost: 1, damage: 5, type: 'attack' },
      { id: 'arrow', name: 'Precise Shot', cost: 1, damage: 5, type: 'attack' },
      { id: 'arrow', name: 'Precise Shot', cost: 1, damage: 5, type: 'attack' },
      { id: 'dodge', name: 'Elven Grace', cost: 1, block: 4, dexterity: 1, type: 'skill' },
      { id: 'dodge', name: 'Elven Grace', cost: 1, block: 4, dexterity: 1, type: 'skill' },
      { id: 'dodge', name: 'Elven Grace', cost: 1, block: 4, dexterity: 1, type: 'skill' },
      { id: 'multishot', name: 'Multi Shot', cost: 2, damage: 5, hits: 2, type: 'attack' },
      { id: 'focus', name: 'Elven Focus', cost: 1, draw: 2, type: 'skill' },
      { id: 'keen', name: 'Keen Eye', cost: 2, damage: 12, type: 'attack' }
    ]
  },
  gandalf: {
    name: "Gandalf the Grey",
    class: "Wizard",
    maxHp: 70,
    energyType: "Mana",
    maxEnergy: 3,
    image: characterImages.gandalf,
    starterRelicChoices: ['volcanic_egg', 'ancient_tome', 'narya_spark'],
    startingDeck: [
      { id: 'staff_strike', name: 'Staff Strike', cost: 1, damage: 5, type: 'attack' },
      { id: 'staff_strike', name: 'Staff Strike', cost: 1, damage: 5, type: 'attack' },
      { id: 'staff_strike', name: 'Staff Strike', cost: 1, damage: 5, type: 'attack' },
      { id: 'magic_barrier', name: 'Magic Barrier', cost: 1, block: 6, type: 'skill' },
      { id: 'magic_barrier', name: 'Magic Barrier', cost: 1, block: 6, type: 'skill' },
      { id: 'magic_barrier', name: 'Magic Barrier', cost: 1, block: 6, type: 'skill' },
      { id: 'spark', name: 'Spark', cost: 0, damage: 3, draw: 1, type: 'attack' },
      { id: 'spark', name: 'Spark', cost: 0, damage: 3, draw: 1, type: 'attack' },
      { id: 'fireball', name: 'Fireball', cost: 2, damage: 10, burn: 3, type: 'attack' },
      { id: 'illuminate', name: 'Illuminate', cost: 1, draw: 2, energy: 1, type: 'skill' }
    ]
  },
  gimli: {
    name: "Gimli",
    class: "Warrior",
    maxHp: 90,
    energyType: "Fury",
    maxEnergy: 3,
    image: characterImages.gimli,
    starterRelicChoices: ['red_skull', 'paper_crane', 'golden_idol'],
    startingDeck: [
      { id: 'axe_strike', name: 'Axe Strike', cost: 1, damage: 7, type: 'attack' },
      { id: 'axe_strike', name: 'Axe Strike', cost: 1, damage: 7, type: 'attack' },
      { id: 'axe_strike', name: 'Axe Strike', cost: 1, damage: 7, type: 'attack' },
      { id: 'axe_strike', name: 'Axe Strike', cost: 1, damage: 7, type: 'attack' },
      { id: 'dwarf_guard', name: 'Dwarf Guard', cost: 1, block: 6, type: 'skill' },
      { id: 'dwarf_guard', name: 'Dwarf Guard', cost: 1, block: 6, type: 'skill' },
      { id: 'dwarf_guard', name: 'Dwarf Guard', cost: 1, block: 6, type: 'skill' },
      { id: 'dwarf_guard', name: 'Dwarf Guard', cost: 1, block: 6, type: 'skill' },
      { id: 'reckless_swing', name: 'Reckless Swing', cost: 2, damage: 12, type: 'attack' },
      { id: 'dwarven_resilience', name: 'Dwarven Resilience', cost: 1, block: 4, strength: 1, type: 'skill' }
    ]
  }
};

// ============================================
// CURSE CARDS SYSTEM
// Status cards that clog the deck - added by enemies/events
// Now with upgrade paths to make them useful!
// ============================================
const CURSE_CARDS = {
  wound: {
    id: 'wound',
    name: 'Wound',
    cost: 999,
    type: 'curse',
    rarity: 'curse',
    unplayable: true,
    upgradeable: true,
    upgradesTo: 'scarred',
    description: 'Unplayable. Clogs your deck. Can be upgraded at rest sites.',
    flavorText: 'A lasting injury from battle.'
  },
  scarred: {
    id: 'scarred',
    name: 'Scarred',
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    selfDamage: 3,
    draw: 1,
    exhaust: true,
    upgraded: true,
    description: 'Take 3 damage. Draw 1 card. Exhaust. Pain teaches.',
    flavorText: 'Every scar tells a story of survival.'
  },
  dazed: {
    id: 'dazed',
    name: 'Dazed',
    cost: 999,
    type: 'curse',
    rarity: 'curse',
    unplayable: true,
    upgradeable: true,
    upgradesTo: 'clarity',
    description: 'Unplayable. Clogs your deck. Can be upgraded at rest sites.',
    flavorText: 'The world spins around you.'
  },
  clarity: {
    id: 'clarity',
    name: 'Moment of Clarity',
    cost: 0,
    type: 'curse',
    rarity: 'curse',
    draw: 1,
    exhaust: true,
    upgraded: true,
    description: 'Draw 1 card. Exhaust. The fog lifts, briefly.',
    flavorText: 'In confusion, sometimes truth appears.'
  },
  saurons_gaze: {
    id: 'saurons_gaze',
    name: "Sauron's Gaze",
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    corruption: 5,
    exhaust: true,
    upgradeable: true,
    upgradesTo: 'defiant_stare',
    description: 'Gain 5 corruption. Exhaust. Can be upgraded.',
    flavorText: 'The Eye sees all.'
  },
  defiant_stare: {
    id: 'defiant_stare',
    name: 'Defiant Stare',
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    corruption: 2,
    strength: 2,
    exhaust: true,
    upgraded: true,
    description: 'Gain 2 corruption. Gain 2 Strength. Exhaust.',
    flavorText: 'You meet the Eye and do not flinch.'
  },
  ring_temptation: {
    id: 'ring_temptation',
    name: 'Ring Temptation',
    cost: 0,
    type: 'curse',
    rarity: 'curse',
    draw: 2,
    corruption: 8,
    exhaust: true,
    upgradeable: true,
    upgradesTo: 'ring_mastery',
    description: 'Draw 2 cards. Gain 8 corruption. Exhaust. Can be upgraded.',
    flavorText: 'Such power... if only you would use it.'
  },
  ring_mastery: {
    id: 'ring_mastery',
    name: 'Ring Mastery',
    cost: 0,
    type: 'curse',
    rarity: 'curse',
    draw: 3,
    corruption: 3,
    exhaust: true,
    upgraded: true,
    description: 'Draw 3 cards. Gain 3 corruption. Exhaust.',
    flavorText: 'You bend the Ring to your will... for now.'
  },
  morgul_wound: {
    id: 'morgul_wound',
    name: 'Morgul Wound',
    cost: 999,
    type: 'curse',
    rarity: 'curse',
    unplayable: true,
    damagePerTurn: 2,
    upgradeable: true,
    upgradesTo: 'battle_scar',
    description: 'Unplayable. Take 2 damage at start of each turn. Can be upgraded.',
    flavorText: 'The blade of the NazgÃ»l leaves wounds that never heal.'
  },
  battle_scar: {
    id: 'battle_scar',
    name: 'Battle Scar',
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    damage: 8,
    selfDamage: 2,
    exhaust: true,
    upgraded: true,
    description: 'Deal 8 damage. Take 2 damage. Exhaust.',
    flavorText: 'The pain reminds you why you fight.'
  },
  shadow_grip: {
    id: 'shadow_grip',
    name: 'Shadow Grip',
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    selfWeak: 2,
    selfVulnerable: 1,
    exhaust: true,
    upgradeable: true,
    upgradesTo: 'shadow_embrace',
    description: 'Apply 2 Weak and 1 Vulnerable to yourself. Exhaust. Can be upgraded.',
    flavorText: 'The shadow reaches for your heart.'
  },
  shadow_embrace: {
    id: 'shadow_embrace',
    name: 'Shadow Embrace',
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    weak: 2,
    vulnerable: 2,
    selfWeak: 1,
    exhaust: true,
    upgraded: true,
    description: 'Apply 2 Weak and 2 Vulnerable to enemy. Apply 1 Weak to yourself. Exhaust.',
    flavorText: 'You wield the shadow against your foes.'
  },
  despair: {
    id: 'despair',
    name: 'Despair',
    cost: 0,
    type: 'curse',
    rarity: 'curse',
    loseEnergy: 1,
    ethereal: true,
    upgradeable: true,
    upgradesTo: 'grim_resolve',
    description: 'Lose 1 energy. Ethereal. Can be upgraded.',
    flavorText: 'What hope remains?'
  },
  grim_resolve: {
    id: 'grim_resolve',
    name: 'Grim Resolve',
    cost: 0,
    type: 'curse',
    rarity: 'curse',
    block: 6,
    ethereal: true,
    upgraded: true,
    description: 'Gain 6 Block. Ethereal.',
    flavorText: 'Despair hardens into determination.'
  },
  regret: {
    id: 'regret',
    name: 'Regret',
    cost: 1,
    type: 'curse',
    rarity: 'curse',
    exhaust: true,
    description: 'Does nothing. Exhaust.',
    flavorText: 'If only things had been different...'
  },
  ring_whispers: {
    id: 'ring_whispers',
    name: 'Ring Whispers',
    cost: 0,
    type: 'curse',
    rarity: 'curse',
    corruption: 3,
    strength: 1,
    exhaust: true,
    description: 'Gain 1 Strength and 3 corruption. Exhaust.',
    flavorText: '"Use me... and all your enemies shall fall."'
  }
};

// Create curse card instance with unique ID
const createCurseCard = (curseId) => {
  const curse = CURSE_CARDS[curseId];
  if (!curse) return null;
  return {
    ...curse,
    uid: `curse_${curseId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  };
};

// ============================================
// ENEMIES - Organized by Act
// ============================================

const ENEMIES = {
  // === ACT 1: Fellowship of the Ring ===
  // Regular enemies
  goblin: {
    name: "Goblin Scout",
    maxHp: 38,  // +35% HP
    tier: 'regular',
    difficultyTier: 1,
    image: characterImages.goblin,
    actions: [
      { type: 'attack', damage: 8, name: 'Quick Stab' },      // +3 damage
      { type: 'attack', damage: 11, name: 'Backstab' },       // +3 damage
      { type: 'buff', strength: 2, name: 'Frenzy' }           // +1 strength
    ]
  },
  goblinArcher: {
    name: "Goblin Archer",
    maxHp: 30,  // +35% HP
    tier: 'regular',
    difficultyTier: 1,
    image: characterImages.goblin,
    actions: [
      { type: 'attack', damage: 9, name: 'Arrow Shot' },      // +3 damage
      { type: 'attack', damage: 6, hits: 2, name: 'Double Shot' },  // +2 per hit
      { type: 'defend', block: 6, name: 'Take Cover' }
    ]
  },
  orc: {
    name: "Orc Warrior",
    maxHp: 51,  // +35% HP
    tier: 'regular',
    difficultyTier: 2,
    image: characterImages.orc,
    actions: [
      { type: 'attack', damage: 10, name: 'Crude Strike' },   // +3 damage
      { type: 'attack', damage: 14, name: 'Savage Blow' },    // +3 damage
      { type: 'defend', block: 8, name: 'Shield Up' }
    ]
  },
  warg: {
    name: "Warg",
    maxHp: 43,  // +35% HP
    tier: 'regular',
    difficultyTier: 2,
    image: characterImages.warg,
    actions: [
      { type: 'attack', damage: 11, name: 'Bite' },           // +3 damage
      { type: 'attack', damage: 9, name: 'Claw Swipe' },      // +3 damage
      { type: 'buff', strength: 3, name: 'Howl' }             // +1 strength
    ]
  },
  // Elite enemies - Act 1
  caveTroll: {
    name: "Cave Troll",
    maxHp: 86,  // +15% HP
    tier: 'elite',
    difficultyTier: 2,
    image: characterImages.caveTroll,
    ability: { name: 'Thick Hide', type: 'passive', damageReduction: 2, description: 'Takes 2 less damage from attacks' },
    actions: [
      { type: 'attack', damage: 16, name: 'Club Smash' },     // +2 damage
      { type: 'attack', damage: 12, name: 'Chain Sweep' },    // +2 damage
      { type: 'attack', damage: 22, name: 'Devastating Blow' } // +2 damage
    ]
  },
  wargRider: {
    name: "Warg Rider",
    maxHp: 69,  // +25% HP
    tier: 'elite',
    difficultyTier: 1,
    image: characterImages.warg,
    ability: { name: 'Mounted', type: 'passive', extraDamage: 3, description: 'Deals +3 damage on attacks' },
    actions: [
      { type: 'attack', damage: 12, name: 'Charging Strike' }, // +2 damage
      { type: 'attack', damage: 10, name: 'Trample' },         // +2 damage
      { type: 'buff', strength: 3, name: 'Ride Down' }         // +1 strength
    ]
  },
  // Boss - Act 1
  balrog: {
    name: "Balrog of Morgoth",
    maxHp: 150,
    tier: 'boss',
    difficultyTier: 2,
    ability: { name: 'Flame Aura', type: 'passive', damageOnHit: 3, description: 'Burns attackers for 3 damage' },
    image: characterImages.balrog,
    actions: [
      { type: 'attack', damage: 18, name: 'Flame Whip' },
      { type: 'attack', damage: 14, name: 'Shadow Strike' },
      { type: 'buff', strength: 3, name: 'Ancient Fury' },
      { type: 'attack', damage: 25, name: 'Infernal Wrath' }
    ]
  },

  // === ACT 2: The Two Towers ===
  // Regular enemies
  urukhai: {
    name: "Uruk-hai Warrior", 
    maxHp: 56,  // +25% HP
    tier: 'regular',
    difficultyTier: 3,
    image: characterImages.urukhai,
    actions: [
      { type: 'attack', damage: 13, name: 'Sword Slash' },    // +3 damage
      { type: 'attack', damage: 17, name: 'Berserker Rage' }, // +3 damage
      { type: 'defend', block: 10, name: 'Shield Wall' }
    ]
  },
  urukhaiBerserker: {
    name: "Uruk-hai Berserker", 
    maxHp: 50,  // +25% HP
    tier: 'regular',
    difficultyTier: 4,
    image: characterImages.urukhai,
    actions: [
      { type: 'attack', damage: 15, name: 'Wild Strike' },    // +3 damage
      { type: 'attack', damage: 19, name: 'Frenzy' },         // +3 damage
      { type: 'buff', strength: 4, name: 'Blood Rage' }       // +1 strength
    ]
  },
  urukScout: {
    name: "Uruk Scout",
    maxHp: 44,  // +25% HP
    tier: 'regular',
    difficultyTier: 3,
    image: characterImages.urukhai,
    actions: [
      { type: 'attack', damage: 11, name: 'Crossbow Bolt' },  // +3 damage
      { type: 'attack', damage: 8, hits: 2, name: 'Quick Shots' }, // +2 per hit
      { type: 'buff', weak: 2, name: 'Mark Target' }
    ]
  },
  wildMan: {
    name: "Dunlending Warrior",
    maxHp: 48,  // +25% HP
    tier: 'regular',
    difficultyTier: 3,
    image: characterImages.haradrim,
    actions: [
      { type: 'attack', damage: 12, name: 'Axe Swing' },      // +3 damage
      { type: 'attack', damage: 10, name: 'Shield Bash' },    // +3 damage
      { type: 'buff', strength: 3, name: 'War Cry' }          // +1 strength
    ]
  },
  // New enemies with special mechanics
  urukShieldbearer: {
    name: "Uruk Shieldbearer",
    maxHp: 63,  // +25% HP
    tier: 'regular',
    difficultyTier: 4,
    image: characterImages.urukhai,
    ability: { name: 'Tower Shield', type: 'startCombat', startBlock: 15, description: 'Starts combat with 15 block' },
    actions: [
      { type: 'attack', damage: 11, name: 'Shield Strike' },  // +3 damage
      { type: 'defend', block: 14, name: 'Brace Shield' },
      { type: 'attack', damage: 9, name: 'Shield Bash' }      // +3 damage
    ]
  },
  berserkerOrc: {
    name: "Berserker Orc",
    maxHp: 44,  // +25% HP
    tier: 'regular',
    difficultyTier: 4,
    image: characterImages.orc,
    ability: { name: 'Enrage', type: 'onDamaged', enrageStrength: 1, description: 'Gains 1 strength when damaged' },
    actions: [
      { type: 'attack', damage: 13, name: 'Reckless Swing' }, // +3 damage
      { type: 'attack', damage: 17, name: 'Berserk Fury' },   // +3 damage
      { type: 'buff', strength: 3, name: 'Blood Rage' }       // +1 strength
    ]
  },
  spikedTroll: {
    name: "Spiked Troll",
    maxHp: 75,  // +25% HP
    tier: 'regular',
    difficultyTier: 4,
    image: characterImages.caveTroll,
    ability: { name: 'Spiked Armor', type: 'thorns', thornsDamage: 4, description: 'Deals 4 damage when attacked' },
    actions: [
      { type: 'attack', damage: 15, name: 'Crushing Blow' },  // +3 damage
      { type: 'attack', damage: 11, name: 'Spike Slam' },     // +3 damage
      { type: 'defend', block: 12, name: 'Hunker Down' }
    ]
  },
  // Elite enemies - Act 2
  urukCaptain: {
    name: "Uruk-hai Captain",
    maxHp: 88,  // +25% HP
    tier: 'elite',
    difficultyTier: 4,
    image: characterImages.urukhai,
    ability: { name: 'Commander', type: 'startTurn', strength: 1, description: 'Gains 1 strength each turn' },
    actions: [
      { type: 'attack', damage: 17, name: 'Commanding Strike' }, // +3 damage
      { type: 'attack', damage: 13, name: 'Shield Slam' },       // +3 damage
      { type: 'buff', strength: 3, name: 'Rally Troops' }        // +1 strength
    ]
  },
  wargChieftain: {
    name: "Warg Chieftain",
    maxHp: 81,  // +25% HP
    tier: 'elite',
    difficultyTier: 3,
    image: characterImages.warg,
    ability: { name: 'Pack Leader', type: 'passive', extraDamage: 3, description: 'All attacks deal +3 damage' },
    actions: [
      { type: 'attack', damage: 15, name: 'Alpha Strike' },      // +3 damage
      { type: 'attack', damage: 10, hits: 2, name: 'Savage Assault' }, // +2 per hit
      { type: 'buff', strength: 4, name: 'Pack Howl' }           // +1 strength
    ]
  },
  // Boss - Act 2 (Scaled proportionally to Balrog - players are ~40% stronger here)
  saruman: {
    name: "Saruman the White",
    maxHp: 210,  // Balrog HP 150 * 1.4 = 210
    tier: 'boss',
    difficultyTier: 4,
    ability: { name: 'Voice of Command', type: 'startTurn', weakPlayer: 1, description: 'Weakens you each turn' },
    image: characterImages.saruman,
    actions: [
      { type: 'attack', damage: 16, name: 'Staff Strike' },      // +4 damage (scaled)
      { type: 'attack', damage: 22, name: 'Voice of Command' },  // +6 damage
      { type: 'defend', block: 20, name: 'Magic Shield' },
      { type: 'buff', strength: 4, name: 'Dark Knowledge' },
      { type: 'attack', damage: 30, name: 'Betrayer\'s Wrath' }  // Big attack like Balrog
    ]
  },
  
  // Nerfed Saruman for Gandalf's early encounter (Act 1)
  sarumanNerfed: {
    name: "Saruman (Isengard)",
    maxHp: 90,  // Much lower for Act 1
    tier: 'elite',
    difficultyTier: 2,
    ability: { name: 'Voice of Saruman', type: 'startTurn', weakPlayer: 1, description: 'His voice clouds your mind' },
    image: characterImages.saruman,
    actions: [
      { type: 'attack', damage: 10, name: 'Staff Strike' },
      { type: 'attack', damage: 14, name: 'Voice of Command' },
      { type: 'defend', block: 12, name: 'Magic Shield' },
      { type: 'buff', strength: 2, name: 'Dark Knowledge' }
    ]
  },

  // === ACT 3: Return of the King ===
  // Regular enemies
  mordorOrc: {
    name: "Mordor Orc",
    maxHp: 54,  // +28% HP
    tier: 'regular',
    difficultyTier: 5,
    image: characterImages.mordorOrc,
    actions: [
      { type: 'attack', damage: 14, name: 'Crude Strike' },   // +4 damage
      { type: 'attack', damage: 18, name: 'Savage Blow' },    // +4 damage
      { type: 'defend', block: 10, name: 'Shield Up' }
    ]
  },
  haradrim: {
    name: "Haradrim Warrior",
    maxHp: 60,  // +25% HP
    tier: 'regular',
    difficultyTier: 5,
    image: characterImages.haradrim,
    actions: [
      { type: 'attack', damage: 15, name: 'Scimitar Slash' }, // +4 damage
      { type: 'attack', damage: 12, name: 'Poisoned Blade', poison: 4 }, // +3 damage, +1 poison
      { type: 'buff', strength: 3, name: 'Eastern Fury' }     // +1 strength
    ]
  },
  nazgul: {
    name: "NazgÃ»l",
    maxHp: 110,  // Buffed for challenge
    tier: 'elite',
    difficultyTier: 6,
    ability: { name: 'Morgul Curse', type: 'onDamage', heal: 3, description: 'Heals 3 HP when it damages you' },
    image: characterImages.nazgul,
    actions: [
      { type: 'attack', damage: 17, name: 'Morgul Blade', corruption: 1 }, // Reduced corruption
      { type: 'attack', damage: 14, name: 'Fell Cry' },
      { type: 'buff', strength: 3, name: 'Terror' }
    ]
  },
  orcChampion: {
    name: "Orc Champion",
    maxHp: 70,  // +27% HP
    tier: 'regular',
    difficultyTier: 6,
    image: characterImages.mordorOrc,
    actions: [
      { type: 'attack', damage: 18, name: 'Heavy Strike' },    // +4 damage
      { type: 'attack', damage: 14, name: 'Crushing Blow' },   // +4 damage
      { type: 'defend', block: 15, name: 'Brace' }
    ]
  },
  // Elite enemies - Act 3
  gothmog: {
    name: "Gothmog",
    maxHp: 106,  // +25% HP
    tier: 'elite',
    difficultyTier: 5,
    ability: { name: 'War Leader', type: 'passive', extraStrength: 2, description: 'Gains 2 strength each turn' },
    image: characterImages.gothmog,
    actions: [
      { type: 'attack', damage: 18, name: 'Mace Smash' },      // +3 damage
      { type: 'attack', damage: 22, name: 'Brutal Charge' },   // +4 damage
      { type: 'buff', strength: 3, name: 'War Cry' }           // +1 strength
    ]
  },
  mouthofsauron: {
    name: "Mouth of Sauron",
    maxHp: 100,  // +25% HP
    tier: 'elite',
    difficultyTier: 6,
    ability: { name: 'Dark Whispers', type: 'onBlock', reduceBlock: 5, description: 'Reduces your block by 5' },
    image: characterImages.mouthofsauron,
    actions: [
      { type: 'attack', damage: 16, name: 'Dark Words' },      // +4 damage
      { type: 'attack', damage: 20, name: 'Deceive' },         // +4 damage
      { type: 'buff', strength: 4, name: "Sauron's Will" }     // +1 strength
    ]
  },
  shelob: {
    name: "Shelob",
    maxHp: 113,  // +25% HP
    tier: 'elite',
    difficultyTier: 5,
    ability: { name: 'Venomous', type: 'onAttack', poison: 3, description: 'Attacks apply 3 poison' },
    image: characterImages.shelob,
    actions: [
      { type: 'attack', damage: 17, name: 'Venomous Bite' },   // +3 damage
      { type: 'attack', damage: 13, name: 'Web Snare', weak: 3 }, // +3 damage, +1 weak
      { type: 'attack', damage: 10, hits: 2, name: 'Fang Strike' } // +2 per hit
    ]
  },
  witchKing: {
    name: "Witch-king of Angmar",
    maxHp: 125,  // +25% HP
    tier: 'elite',
    difficultyTier: 6,
    ability: { name: 'No Man Can Kill Me', type: 'passive', damageReduction: 4, description: 'Takes 4 less damage' },
    image: characterImages.witchKing,
    actions: [
      { type: 'attack', damage: 22, name: 'Morgul Strike', corruption: 3 }, // +4 damage, added corruption
      { type: 'attack', damage: 17, name: 'Fell Beast Screech', weak: 3 }, // +3 damage, +1 weak
      { type: 'buff', strength: 5, name: 'Lord of the NazgÃ»l' } // +1 strength
    ]
  },
  // Boss - Act 3 (Scaled proportionally to Balrog - players are ~80% stronger here)
  // MULTI-PHASE BOSS: Transforms at 50% HP!
  sauron: {
    name: "Sauron, The Dark Lord",
    maxHp: 270,  // Balrog HP 150 * 1.8 = 270
    tier: 'boss',
    difficultyTier: 6,
    ability: { name: 'The Eye', type: 'startTurn', vulnerable: 2, description: 'Applies 2 vulnerable each turn' },
    image: characterImages.sauron,
    isMultiPhase: true,
    phases: {
      1: {
        name: "Sauron, The Dark Lord",
        ability: { name: 'The Eye', type: 'startTurn', vulnerable: 2, description: 'The Eye sees all weakness' },
        actions: [
          { type: 'attack', damage: 26, name: 'Mace of Morgoth' },
          { type: 'attack', damage: 22, name: 'Dark Gaze', corruption: 4 },
          { type: 'buff', strength: 5, name: "One Ring's Power" },
          { type: 'defend', block: 30, name: 'Shadow Armor' }
        ]
      },
      2: {
        name: "Sauron Unleashed",
        triggerAtHpPercent: 50,
        phaseTransitionText: "Sauron's form blazes with dark fire! His true power awakens!",
        healOnTransition: 30,
        ability: { name: 'Ring of Power', type: 'startTurn', strength: 2, vulnerable: 1, description: 'Gains 2 strength and applies 1 vulnerable each turn' },
        actions: [
          { type: 'attack', damage: 32, name: 'Annihilating Strike' },
          { type: 'attack', damage: 18, hits: 2, name: 'Shadow Barrage', corruption: 3 },
          { type: 'attack', damage: 45, name: 'Apocalyptic Fury' },
          { type: 'buff', strength: 4, block: 20, name: 'Dark Ascension' },
          { type: 'special', name: 'Ring Domination', corruption: 10, weak: 3, vulnerable: 3, description: 'Overwhelms your will' }
        ]
      }
    },
    actions: [
      { type: 'attack', damage: 26, name: 'Mace of Morgoth' },    // +6 damage
      { type: 'attack', damage: 22, name: 'Dark Gaze', corruption: 4 }, // +6 damage, added corruption
      { type: 'buff', strength: 5, name: 'One Ring\'s Power' },   // +1 strength
      { type: 'attack', damage: 38, name: 'Apocalyptic Fury' },   // Big attack proportional to Balrog's 25
      { type: 'defend', block: 30, name: 'Shadow Armor' }
    ]
  }
};

// ============================================
// TIER-BASED ENEMY SELECTION SYSTEM
// ============================================

// Get all enemies of a specific difficulty tier and type
const getEnemiesByTier = (difficultyTier, enemyType = null) => {
  return Object.entries(ENEMIES).filter(([key, enemy]) => {
    const tierMatch = enemy.difficultyTier === difficultyTier;
    const typeMatch = enemyType ? enemy.tier === enemyType : true;
    return tierMatch && typeMatch;
  }).map(([key]) => key);
};

// Determine which tier to use based on act and position within act
const getEncounterTier = (act, encounterIndexInAct, totalEncountersInAct) => {
  const isFirstHalf = encounterIndexInAct < totalEncountersInAct / 2;
  if (act === 1) return isFirstHalf ? 1 : 2;
  if (act === 2) return isFirstHalf ? 3 : 4;
  return isFirstHalf ? 5 : 6;
};

// Select random enemy by tier with fallback
const selectRandomEnemyByTier = (difficultyTier, enemyType = 'regular') => {
  const enemies = getEnemiesByTier(difficultyTier, enemyType);
  if (enemies.length === 0) {
    // Fallback to adjacent tier
    const fallbackTier = difficultyTier > 1 ? difficultyTier - 1 : difficultyTier + 1;
    const fallbackEnemies = getEnemiesByTier(fallbackTier, enemyType);
    if (fallbackEnemies.length === 0) return 'goblin';
    return fallbackEnemies[Math.floor(Math.random() * fallbackEnemies.length)];
  }
  return enemies[Math.floor(Math.random() * enemies.length)];
};

// Main function to get random enemy for an encounter
const getRandomEnemyForEncounter = (encounter, act, encounterIndexInAct, totalEncountersInAct) => {
  // If specific enemy is defined (like bosses), use it
  if (encounter.enemy && !encounter.enemyTier) {
    return encounter.enemy;
  }
  
  // Use enemyTier if specified, otherwise calculate from position
  const tier = encounter.enemyTier || getEncounterTier(act, encounterIndexInAct, totalEncountersInAct);
  const enemyType = encounter.tier || 'regular';
  
  return selectRandomEnemyByTier(tier, enemyType);
};

// ============================================
// US-001: MULTI-ENEMY ENCOUNTER SYSTEM
// ============================================

const MULTI_ENEMY_ENCOUNTERS = {
  // Special encounter: Weathertop (Aragorn only)
  weathertop: {
    name: "Weathertop Ambush",
    difficultyTier: 2,
    enemies: ['nazgul', 'nazgul'],
    fleeOnFirstKill: true, // Player wins when one NazgÃ»l is killed
    storyOnVictory: {
      title: "The Morgul Blade",
      text: "As the first NazgÃ»l falls, its piercing shriek echoes through the night. But in the chaos, the Witch-King's blade finds Frodo! The Ringbearer collapses, wounded by a Morgul blade. You drive off the remaining wraiths with flame, but time is short. Frodo grows cold and pale - you must reach Rivendell before the wound claims him!",
      corruptionGain: 10
    }
  },
  // US-001: Tier 1 groups
  goblinAmbush: {
    name: "Goblin Ambush", 
    difficultyTier: 1,
    enemies: ['goblin', 'goblin', 'goblinArcher']
  },
  archerDuo: {
    name: "Goblin Archers",
    difficultyTier: 1,
    enemies: ['goblinArcher', 'goblinArcher']
  },
  // US-001: Tier 2 groups
  orcRaiders: {
    name: "Orc Raiders",
    difficultyTier: 2,
    enemies: ['orc', 'orc']
  },
  wargPack: {
    name: "Warg Pack",
    difficultyTier: 2,
    enemies: ['warg', 'warg', 'warg']
  },
  // US-001: Tier 3 groups
  urukPatrol: {
    name: "Uruk Patrol",
    difficultyTier: 3,
    enemies: ['urukhai', 'urukScout']
  },
  dunlandRaiders: {
    name: "Dunland Raiders",
    difficultyTier: 3,
    enemies: ['wildMan', 'wildMan', 'wildMan']
  },
  // US-001: Tier 4 groups
  isengardForce: {
    name: "Isengard Force",
    difficultyTier: 4,
    enemies: ['urukhaiBerserker', 'urukShieldbearer']
  },
  orcWarband: {
    name: "Orc Warband",
    difficultyTier: 4,
    enemies: ['berserkerOrc', 'berserkerOrc']
  },
  // US-001: Tier 5 groups
  mordorSquad: {
    name: "Mordor Squad",
    difficultyTier: 5,
    enemies: ['mordorOrc', 'mordorOrc', 'orcArcher']
  },
  haradrimArchers: {
    name: "Haradrim Archers",
    difficultyTier: 5,
    enemies: ['haradrim', 'haradrim']
  },
  // US-001: Tier 6 groups
  nazgulPair: {
    name: "NazgÃ»l Pair",
    difficultyTier: 6,
    enemies: ['nazgul', 'nazgul']
  },
  finalHorde: {
    name: "Final Horde",
    difficultyTier: 6,
    enemies: ['orcChampion', 'orcChampion', 'nazgul']
  }
};

// Get multi-enemy encounter by tier
const getMultiEnemyEncounter = (difficultyTier) => {
  const encounters = Object.entries(MULTI_ENEMY_ENCOUNTERS)
    .filter(([_, enc]) => enc.difficultyTier === difficultyTier);
  if (encounters.length === 0) return null;
  const [key, encounter] = encounters[Math.floor(Math.random() * encounters.length)];
  return { ...encounter, key };
};

// Create enemy instances for multi-enemy combat
const createMultiEnemyInstances = (enemyKeys, difficultyMod = 1.0) => {
  return enemyKeys.map((key, index) => {
    const baseEnemy = ENEMIES[key];
    if (!baseEnemy) return null;
    return {
      ...baseEnemy,
      id: `${key}_${index}`,
      key: key,
      hp: Math.floor(baseEnemy.maxHp * difficultyMod * 0.8), // Slightly less HP for multi-enemy
      maxHp: Math.floor(baseEnemy.maxHp * difficultyMod * 0.8),
      block: 0,
      strength: 0,
      vulnerable: 0,
      weak: 0,
      poison: 0,
      burn: 0,
      actionIndex: Math.floor(Math.random() * baseEnemy.actions.length)
    };
  }).filter(e => e !== null);
};

// ============================================
// US-002: CONDITIONAL CARD EFFECTS SYSTEM
// ============================================

// Battle condition types
const BATTLE_CONDITIONS = {
  LOW_HP: 'low_hp',           // Player HP < 50%
  HIGH_HP: 'high_hp',         // Player HP > 75%
  NO_BLOCK: 'no_block',       // Player has 0 block
  HIGH_BLOCK: 'high_block',   // Player has 15+ block
  ENEMY_WEAK: 'enemy_weak',   // Enemy is weakened
  ENEMY_VULNERABLE: 'enemy_vulnerable', // Enemy is vulnerable
  FIRST_CARD: 'first_card',   // First card played this turn
  LAST_CARD: 'last_card',     // Last card in hand
  MULTI_ENEMY: 'multi_enemy', // Fighting multiple enemies
  SINGLE_ENEMY: 'single_enemy', // Fighting single enemy
  BOSS_FIGHT: 'boss_fight',   // Current enemy is a boss
  TURN_1: 'turn_1',           // First turn of combat
  TURN_5_PLUS: 'turn_5_plus'  // Turn 5 or later
};

// Check if a battle condition is met
const checkBattleCondition = (condition, gameState) => {
  const { player, enemy, enemies, hand, playedCardsThisTurn, combatTurn } = gameState;
  
  switch (condition) {
    case BATTLE_CONDITIONS.LOW_HP:
      return player.hp < player.maxHp * 0.5;
    case BATTLE_CONDITIONS.HIGH_HP:
      return player.hp > player.maxHp * 0.75;
    case BATTLE_CONDITIONS.NO_BLOCK:
      return (player.block || 0) === 0;
    case BATTLE_CONDITIONS.HIGH_BLOCK:
      return (player.block || 0) >= 15;
    case BATTLE_CONDITIONS.ENEMY_WEAK:
      return (enemy?.weak || 0) > 0;
    case BATTLE_CONDITIONS.ENEMY_VULNERABLE:
      return (enemy?.vulnerable || 0) > 0;
    case BATTLE_CONDITIONS.FIRST_CARD:
      return (playedCardsThisTurn?.length || 0) === 0;
    case BATTLE_CONDITIONS.LAST_CARD:
      return (hand?.length || 0) === 1;
    case BATTLE_CONDITIONS.MULTI_ENEMY:
      return (enemies?.length || 0) > 1;
    case BATTLE_CONDITIONS.SINGLE_ENEMY:
      return (enemies?.length || 1) === 1;
    case BATTLE_CONDITIONS.BOSS_FIGHT:
      return enemy?.tier === 'boss';
    case BATTLE_CONDITIONS.TURN_1:
      return combatTurn === 1;
    case BATTLE_CONDITIONS.TURN_5_PLUS:
      return combatTurn >= 5;
    default:
      return false;
  }
};

// Apply conditional effects to a card
const applyConditionalEffects = (card, gameState) => {
  if (!card.conditional) return card;
  
  const conditionMet = checkBattleCondition(card.conditional.condition, gameState);
  if (!conditionMet) return card;
  
  // Create modified card with bonus effects
  const modifiedCard = { ...card, conditionTriggered: true };
  const bonus = card.conditional.bonus;
  
  if (bonus.damage) modifiedCard.damage = (card.damage || 0) + bonus.damage;
  if (bonus.block) modifiedCard.block = (card.block || 0) + bonus.block;
  if (bonus.strength) modifiedCard.strength = (card.strength || 0) + bonus.strength;
  if (bonus.dexterity) modifiedCard.dexterity = (card.dexterity || 0) + bonus.dexterity;
  if (bonus.draw) modifiedCard.draw = (card.draw || 0) + bonus.draw;
  if (bonus.energy) modifiedCard.energy = (card.energy || 0) + bonus.energy;
  if (bonus.vulnerable) modifiedCard.vulnerable = (card.vulnerable || 0) + bonus.vulnerable;
  if (bonus.weak) modifiedCard.weak = (card.weak || 0) + bonus.weak;
  if (bonus.heal) modifiedCard.heal = (card.heal || 0) + bonus.heal;
  if (bonus.hits) modifiedCard.hits = (card.hits || 1) + bonus.hits;
  if (bonus.hitAll) modifiedCard.hitAll = true;
  if (bonus.doubleDamage) modifiedCard.damage = (modifiedCard.damage || card.damage || 0) * 2;
  
  return modifiedCard;
};

// Conditional cards for colorless pool
const CONDITIONAL_CARDS = [
  {
    id: 'desperate_strike',
    name: 'Desperate Strike',
    cost: 1,
    damage: 8,
    type: 'attack',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.LOW_HP,
      bonus: { damage: 10 }
    },
    conditionalText: 'If HP < 50%: +10 damage',
    description: 'Deal 8 damage. If HP < 50%, deal 18 instead.'
  },
  {
    id: 'overwhelming_force',
    name: 'Overwhelming Force',
    cost: 2,
    damage: 12,
    type: 'attack',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.ENEMY_VULNERABLE,
      bonus: { damage: 8, hits: 1 }
    },
    conditionalText: 'If enemy Vulnerable: +8 damage, hit twice',
    description: 'Deal 12 damage. If enemy is Vulnerable, deal 20 and hit twice.'
  },
  {
    id: 'defensive_rally',
    name: 'Defensive Rally',
    cost: 1,
    block: 6,
    type: 'skill',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.NO_BLOCK,
      bonus: { block: 8, dexterity: 1 }
    },
    conditionalText: 'If no Block: +8 block, +1 Dexterity',
    description: 'Gain 6 Block. If you have no Block, gain 14 and +1 Dexterity.'
  },
  {
    id: 'opening_gambit',
    name: 'Opening Gambit',
    cost: 1,
    damage: 6,
    type: 'attack',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.FIRST_CARD,
      bonus: { damage: 8, vulnerable: 2 }
    },
    conditionalText: 'First card: +8 damage, apply 2 Vulnerable',
    description: 'Deal 6 damage. If first card played this turn, deal 14 and apply 2 Vulnerable.'
  },
  {
    id: 'finishing_blow',
    name: 'Finishing Blow',
    cost: 2,
    damage: 10,
    type: 'attack',
    rarity: 'rare',
    conditional: {
      condition: BATTLE_CONDITIONS.LAST_CARD,
      bonus: { doubleDamage: true }
    },
    conditionalText: 'Last card in hand: Double damage',
    description: 'Deal 10 damage. If last card in hand, deal 20 instead.'
  },
  {
    id: 'swarm_tactics',
    name: 'Swarm Tactics',
    cost: 1,
    damage: 6,
    type: 'attack',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.MULTI_ENEMY,
      bonus: { damage: 4, hitAll: true }
    },
    conditionalText: 'Multiple enemies: +4 damage, hits ALL',
    description: 'Deal 6 damage. Against multiple enemies, deal 10 to ALL.'
  },
  {
    id: 'boss_slayer',
    name: 'Boss Slayer',
    cost: 3,
    damage: 14,
    type: 'attack',
    rarity: 'rare',
    conditional: {
      condition: BATTLE_CONDITIONS.BOSS_FIGHT,
      bonus: { damage: 16, strength: 2 }
    },
    conditionalText: 'Boss fight: +16 damage, +2 Strength',
    description: 'Deal 14 damage. Against bosses, deal 30 and gain 2 Strength.'
  },
  {
    id: 'early_advantage',
    name: 'Early Advantage',
    cost: 0,
    draw: 1,
    type: 'skill',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.TURN_1,
      bonus: { draw: 2, energy: 1 }
    },
    conditionalText: 'Turn 1: +2 Draw, +1 Energy',
    description: 'Draw 1 card. On Turn 1, draw 3 and gain 1 Energy.'
  },
  {
    id: 'endurance_test',
    name: 'Endurance Test',
    cost: 2,
    block: 8,
    type: 'skill',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.TURN_5_PLUS,
      bonus: { block: 10, heal: 5 }
    },
    conditionalText: 'Turn 5+: +10 Block, Heal 5',
    description: 'Gain 8 Block. On Turn 5+, gain 18 Block and heal 5 HP.'
  },
  {
    id: 'exploit_weakness',
    name: 'Exploit Weakness',
    cost: 1,
    damage: 8,
    weak: 1,
    type: 'attack',
    rarity: 'uncommon',
    conditional: {
      condition: BATTLE_CONDITIONS.ENEMY_WEAK,
      bonus: { damage: 12, draw: 1 }
    },
    conditionalText: 'If enemy Weak: +12 damage, Draw 1',
    description: 'Deal 8 damage, apply 1 Weak. If enemy is Weak, deal 20 and draw 1.'
  }
];

// ============================================
// US-003: ADAPTIVE DIFFICULTY SYSTEM
// ============================================

// Performance metrics for adaptive difficulty
const createPerformanceMetrics = () => ({
  perfectCombats: 0,      // Won without taking damage
  quickKills: 0,          // Won in 3 turns or less
  closeCalls: 0,          // Won with < 20% HP
  deaths: 0,              // Times died
  totalDamageDealt: 0,
  totalDamageTaken: 0,
  combatsCompleted: 0,
  averageTurnsPerCombat: 0
});

// Calculate adaptive difficulty modifier based on performance
const calculateAdaptiveDifficulty = (metrics) => {
  if (metrics.combatsCompleted < 2) return 1.0; // Not enough data
  
  let modifier = 1.0;
  
  // Skill indicators that increase difficulty
  const perfectRate = metrics.perfectCombats / metrics.combatsCompleted;
  const quickKillRate = metrics.quickKills / metrics.combatsCompleted;
  
  if (perfectRate > 0.3) modifier += 0.15;
  if (quickKillRate > 0.4) modifier += 0.1;
  
  // Struggle indicators that decrease difficulty
  const deathRate = metrics.deaths / (metrics.combatsCompleted + metrics.deaths);
  const closeCallRate = metrics.closeCalls / metrics.combatsCompleted;
  
  if (deathRate > 0.3) modifier -= 0.2;
  if (closeCallRate > 0.4) modifier -= 0.1;
  
  // Damage efficiency
  const damageRatio = metrics.totalDamageTaken / (metrics.totalDamageDealt || 1);
  if (damageRatio < 0.3) modifier += 0.1;
  if (damageRatio > 0.7) modifier -= 0.1;
  
  // Clamp between 0.7 and 1.5
  return Math.max(0.7, Math.min(1.5, modifier));
};

// Update performance metrics after combat
const updatePerformanceMetrics = (metrics, combatResult) => {
  const { won, playerHpPercent, turnsTaken, damageDealt, damageTaken } = combatResult;
  
  const newMetrics = { ...metrics };
  
  if (won) {
    newMetrics.combatsCompleted++;
    if (damageTaken === 0) newMetrics.perfectCombats++;
    if (turnsTaken <= 3) newMetrics.quickKills++;
    if (playerHpPercent < 0.2) newMetrics.closeCalls++;
  } else {
    newMetrics.deaths++;
  }
  
  newMetrics.totalDamageDealt += damageDealt;
  newMetrics.totalDamageTaken += damageTaken;
  newMetrics.averageTurnsPerCombat = 
    (newMetrics.averageTurnsPerCombat * (newMetrics.combatsCompleted - 1) + turnsTaken) / 
    newMetrics.combatsCompleted;
  
  return newMetrics;
};

// ============================================
// THREE-ACT ENCOUNTER STRUCTURE
// ============================================

const ACT_INFO = {
  1: {
    name: "The Fellowship of the Ring",
    subtitle: "From the Shire to Moria",
    boss: "balrog",
    bossIntro: "In the depths of Moria, an ancient evil awakens..."
  },
  2: {
    name: "The Two Towers", 
    subtitle: "The War of Rohan",
    boss: "saruman",
    bossIntro: "The White Wizard has betrayed the free peoples..."
  },
  3: {
    name: "The Return of the King",
    subtitle: "The Battle for Middle-earth",
    boss: "sauron",
    bossIntro: "The Dark Lord himself awaits at the Black Gate..."
  }
};

// ============================================
// R001 - STORY FRAMEWORK INTEGRATION
// ============================================

// Narrative Progression System - Story beats tied to game progression
const STORY_BEATS = {
  // Act 1 Story Beats
  act1_opening: {
    act: 1,
    trigger: 'act_start',
    title: "The Shadow Grows",
    narrative: "Darkness stirs in the East. The enemy's servants multiply, and whispers speak of a great evil awakening. You must journey forth to stop the shadow before it consumes all of Middle-earth.",
    quote: "\"All we have to decide is what to do with the time that is given us.\" - Gandalf",
    background: 'shire'
  },
  act1_midpoint: {
    act: 1,
    trigger: 'encounter',
    encounterIndex: 7,
    title: "The Road Goes Ever On",
    narrative: "The journey has tested you, but greater trials await. The mountains loom ahead, and beneath them lies a darkness not seen for an age.",
    quote: "\"The world is indeed full of peril, and in it there are many dark places.\" - Haldir",
    background: 'misty_mountains'
  },
  act1_preboss: {
    act: 1,
    trigger: 'encounter',
    encounterIndex: 14,
    title: "The Drums in the Deep",
    narrative: "You stand at the gates of Moria. The drums echo from below, growing louder. Something ancient and terrible stirs in the darknessâa foe beyond any you have faced.",
    quote: "\"They have a cave troll...\" - Boromir",
    background: 'moria_gates'
  },
  act1_victory: {
    act: 1,
    trigger: 'boss_defeated',
    title: "You Shall Not Pass!",
    narrative: "The Balrog has fallen into shadow, but the cost was great. The Fellowship's path forward is unclear, yet hope remains while the company is true.",
    quote: "\"Fly, you fools!\" - Gandalf",
    background: 'bridge_khazad_dum'
  },
  
  // Act 2 Story Beats
  act2_opening: {
    act: 2,
    trigger: 'act_start',
    title: "The Breaking of the Fellowship",
    narrative: "The company is scattered. War spreads across Rohan as Saruman's forces march from Isengard. You must rally the free peoples against this new threat.",
    quote: "\"The world is changed. I feel it in the water. I feel it in the earth.\" - Galadriel",
    background: 'fangorn'
  },
  act2_midpoint: {
    act: 2,
    trigger: 'encounter',
    encounterIndex: 23,
    title: "The White Rider",
    narrative: "From death, hope returns. Gandalf has returned as the White, more powerful than before. The tide may yet be turned against the enemy.",
    quote: "\"I am Gandalf the White. And I come back to you now, at the turn of the tide.\" - Gandalf",
    background: 'edoras'
  },
  act2_preboss: {
    act: 2,
    trigger: 'encounter',
    encounterIndex: 29,
    title: "The Voice of Saruman",
    narrative: "Isengard has fallen to the Ents, but Saruman remains in his tower, his voice still a weapon of deception and malice. The traitor must answer for his crimes.",
    quote: "\"He has a mind of metal and wheels.\" - Treebeard",
    background: 'orthanc'
  },
  act2_victory: {
    act: 2,
    trigger: 'boss_defeated',
    title: "The Fall of Isengard",
    narrative: "Saruman's power is broken, but Sauron's full might now turns toward Gondor. The final battle approachesâthe war to decide the fate of all Middle-earth.",
    quote: "\"The board is set. The pieces are moving.\" - Gandalf",
    background: 'isengard_flooded'
  },
  
  // Act 3 Story Beats
  act3_opening: {
    act: 3,
    trigger: 'act_start',
    title: "The Last Debate",
    narrative: "The forces of Mordor march on Minas Tirith. All hope now rests on a desperate gambitâto draw out Sauron's armies and give the Ring-bearer a chance to reach Mount Doom.",
    quote: "\"There is always hope.\" - Aragorn",
    background: 'minas_tirith'
  },
  act3_midpoint: {
    act: 3,
    trigger: 'encounter',
    encounterIndex: 38,
    title: "The Ride of the Rohirrim",
    narrative: "When all seems lost, the horns of Rohan sound! The cavalry of the Mark charges into the armies of Mordor, turning the tide of battle once more.",
    quote: "\"Arise, arise, Riders of ThÃ©oden!\" - King ThÃ©oden",
    background: 'pelennor_fields'
  },
  act3_preboss: {
    act: 3,
    trigger: 'encounter',
    encounterIndex: 44,
    title: "The Black Gate Opens",
    narrative: "You stand before the gates of Mordor itself. The Eye turns toward you, and all of Sauron's remaining forces marshal for the final confrontation.",
    quote: "\"For Frodo.\" - Aragorn",
    background: 'black_gate'
  },
  act3_victory: {
    act: 3,
    trigger: 'boss_defeated',
    title: "The End of All Things",
    narrative: "The Ring is destroyed! Sauron's physical form dissolves, his armies scatter, and the shadow lifts from Middle-earth at last. A new age begins.",
    quote: "\"I'm glad to be with you, Samwise Gamgee, here at the end of all things.\" - Frodo",
    background: 'mount_doom'
  }
};

// Character Backstory Reveals - Unlocked through gameplay milestones
const CHARACTER_BACKSTORIES = {
  aragorn: {
    identity: 'Strider / Aragorn',
    reveals: [
      {
        milestone: 'first_combat',
        title: "A Ranger of the North",
        text: "They call me Strider in these parts. I wander the wild lands, protecting the innocent from shadows they never see. Few know my true purposeâfewer still my true name.",
        unlockMessage: "Backstory unlocked: Aragorn's secret identity"
      },
      {
        milestone: 'encounters_5',
        title: "The DÃºnedain",
        text: "I am one of the DÃºnedainâthe Rangers of the North, descendants of the lost kingdom of Arnor. We are the last guardians of the bloodline of NÃºmenor.",
        unlockMessage: "Backstory unlocked: Heritage of the DÃºnedain"
      },
      {
        milestone: 'elite_defeated',
        title: "Heir of Isildur",
        text: "My true name is Aragorn, son of Arathorn. I carry Narsil reforgedâAndÃºril, Flame of the West. The sword that cut the Ring from Sauron's hand.",
        unlockMessage: "Backstory unlocked: The Heir of Isildur"
      },
      {
        milestone: 'act2_start',
        title: "The Promise",
        text: "I pledged my heart to Arwen UndÃ³miel, daughter of Elrond. For her sake, I must claim the throne of Gondorâor die in the attempt. Only then can we be united.",
        unlockMessage: "Backstory unlocked: Aragorn and Arwen"
      },
      {
        milestone: 'boss_defeated',
        title: "Return of the King",
        text: "The line of kings was broken, but not forever. I will restore the kingdoms of Men, unite Arnor and Gondor, and bring peace to Middle-earth at last.",
        unlockMessage: "Backstory unlocked: Destiny of the King"
      }
    ]
  },
  legolas: {
    identity: 'Legolas Greenleaf',
    reveals: [
      {
        milestone: 'first_combat',
        title: "Prince of the Woodland Realm",
        text: "I am Legolas, son of Thranduil, King of the Woodland Realm in northern Mirkwood. My people have fought the shadow since the dark days of Dol Guldur.",
        unlockMessage: "Backstory unlocked: Legolas's royal lineage"
      },
      {
        milestone: 'encounters_5',
        title: "The Elven Way",
        text: "I have walked Middle-earth for over two thousand years. In that time, I have seen the rise and fall of kingdoms, the fading of my people, and the growth of the shadow.",
        unlockMessage: "Backstory unlocked: Elven immortality"
      },
      {
        milestone: 'elite_defeated',
        title: "Friend of Gimli",
        text: "Strange how fate works. Dwarves and Elves have long been at odds, yet in Gimli, son of GlÃ³in, I have found a friendâperhaps the truest I have known among mortals.",
        unlockMessage: "Backstory unlocked: An unlikely friendship"
      },
      {
        milestone: 'act2_start',
        title: "The Sea-longing",
        text: "I have heard the gulls cry over the sea. The call of the West grows strong in my heart. One day, I shall sail to the Undying Landsâbut not yet. Not while my friends have need of me.",
        unlockMessage: "Backstory unlocked: The call of Valinor"
      },
      {
        milestone: 'boss_defeated',
        title: "Last of the Fellowship",
        text: "When this war ends, I shall remain in Middle-earth for a time. There is beauty here still, and friends to cherish. But eventually, all Elves must depart these shores.",
        unlockMessage: "Backstory unlocked: Legolas's fate"
      }
    ]
  },
  gandalf: {
    identity: 'Gandalf the Grey / Mithrandir',
    reveals: [
      {
        milestone: 'first_combat',
        title: "The Grey Pilgrim",
        text: "I am Gandalf, called Mithrandir by the Elvesâthe Grey Pilgrim. I have wandered Middle-earth for nearly two thousand years, though I am far older than these lands.",
        unlockMessage: "Backstory unlocked: Gandalf's many names"
      },
      {
        milestone: 'encounters_5',
        title: "The Istari",
        text: "I am one of the Istariâwizards sent by the Valar to aid the free peoples against Sauron. We are Maiar spirits, clothed in mortal flesh to better understand those we protect.",
        unlockMessage: "Backstory unlocked: Origin of the Wizards"
      },
      {
        milestone: 'elite_defeated',
        title: "Bearer of Narya",
        text: "Upon my hand rests Narya, the Ring of Fireâone of the three Elven Rings. CÃ­rdan the Shipwright gave it to me, saying it would kindle hearts against despair.",
        unlockMessage: "Backstory unlocked: The Ring of Fire"
      },
      {
        milestone: 'act2_start',
        title: "Gandalf the White",
        text: "I died upon the mountain, yet was sent back. Gandalf the Grey is no moreâI am Gandalf the White, clothed in the authority Saruman should have wielded.",
        unlockMessage: "Backstory unlocked: Death and return"
      },
      {
        milestone: 'boss_defeated',
        title: "The Flame of Anor",
        text: "I am a servant of the Secret Fire, wielder of the flame of Anor. Against the dark fire of Morgoth's servant, I stoodâand did not fall forever.",
        unlockMessage: "Backstory unlocked: Gandalf's true power"
      }
    ]
  },
  gimli: {
    identity: 'Gimli, son of GlÃ³in',
    reveals: [
      {
        milestone: 'first_combat',
        title: "Son of GlÃ³in",
        text: "I am Gimli, son of GlÃ³in, who traveled with Thorin Oakenshield to reclaim Erebor. The blood of Durin runs in my veinsâI fear no darkness.",
        unlockMessage: "Backstory unlocked: Gimli's heritage"
      },
      {
        milestone: 'encounters_5',
        title: "The Lonely Mountain",
        text: "My father helped reclaim the Lonely Mountain from Smaug the Terrible. I was raised in Erebor's restored glory, learning the craft and warfare of my people.",
        unlockMessage: "Backstory unlocked: Erebor restored"
      },
      {
        milestone: 'elite_defeated',
        title: "Memory of Moria",
        text: "Moria... Khazad-dÃ»m of old. My cousin Balin tried to reclaim it. We found only his tomb. The darkness there claimed them allâbut we avenged them.",
        unlockMessage: "Backstory unlocked: Balin's fate"
      },
      {
        milestone: 'act2_start',
        title: "Elf-friend",
        text: "Never thought I would die fighting side by side with an Elf. But with a friend? Ayeâthat I could do. Legolas has taught me that old prejudices serve only the enemy.",
        unlockMessage: "Backstory unlocked: Overcoming prejudice"
      },
      {
        milestone: 'boss_defeated',
        title: "Lord of the Glittering Caves",
        text: "When the war is won, I shall lead my people to the Glittering Caves of Aglarond. And one day, Legolas and I shall sail West togetherâthe first Dwarf to reach the Undying Lands.",
        unlockMessage: "Backstory unlocked: Gimli's destiny"
      }
    ]
  }
};

// Branching Fellowship Dialogue System
const FELLOWSHIP_DIALOGUES = {
  // Fellowship Meetings - Occur at rest sites with choices
  council_planning: {
    id: 'council_planning',
    title: "A Council of Friends",
    location: "Camp Fire",
    trigger: 'rest_site',
    actAvailable: [1, 2, 3],
    participants: ['all'],
    introduction: "As night falls and the fire crackles, your companions gather to discuss the journey ahead.",
    choices: [
      {
        id: 'tactical',
        text: "\"We should discuss our battle strategy.\"",
        speaker: 'player',
        response: {
          speaker: 'varies', // Changes based on character
          aragorn: "\"A wise approach. Let me share what the Rangers have learned of our enemies' weaknesses.\"",
          legolas: "\"Indeed. My elven eyes have spotted patterns in their movements we can exploit.\"",
          gandalf: "\"Ah, strategic thinking! Let me illuminate some secrets of our foes.\"",
          gimli: "\"Aye! Know your enemy, as we Dwarves say. Let me tell you where to hit them hardest.\""
        },
        effect: { strength: 1, revealTip: true },
        outcome: "Your companion shares tactical insights. (+1 Strength, Combat tip revealed)"
      },
      {
        id: 'rest',
        text: "\"Let us rest and recover our strength.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"Rest well, friend. I shall keep watch through the night.\"",
          legolas: "\"Sleep peacefully. Elven eyes need little restâI shall guard your dreams.\"",
          gandalf: "\"A pipe and some quiet reflection, then. The mind heals as surely as the body.\"",
          gimli: "\"Good idea! A Dwarf rests when he can. Battle waits for no one.\""
        },
        effect: { heal: 10 },
        outcome: "The company rests peacefully. (+10 HP)"
      },
      {
        id: 'story',
        text: "\"Tell me more about yourself.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"Few ask the Ranger his tale. Very wellâI shall share what I may.\"",
          legolas: "\"I have walked these lands since before Men built their first cities. What would you know?\"",
          gandalf: "\"Curious, are you? I suppose I have gathered a tale or two over the centuries.\"",
          gimli: "\"Ha! You want stories? The line of Durin has legends enough to fill the night!\""
        },
        effect: { backstoryReveal: true },
        outcome: "Your companion shares their history. (Backstory unlocked)"
      }
    ]
  },
  
  before_battle: {
    id: 'before_battle',
    title: "Words Before Battle",
    location: "Edge of Combat",
    trigger: 'pre_elite',
    actAvailable: [1, 2, 3],
    participants: ['all'],
    introduction: "A powerful enemy bars your path. Your companion turns to you before the fight.",
    choices: [
      {
        id: 'brave',
        text: "\"We face this together. No fear!\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"For this hour, we are the Fellowship. Let us show them the strength of Men!\"",
          legolas: "\"Side by side, then. Let them feel the wrath of the Eldar!\"",
          gandalf: "\"Courage, friend! Light always finds a way through darkness!\"",
          gimli: "\"That's the spirit! BARUK KHAZÃD! The axes of the Dwarves are upon them!\""
        },
        effect: { strength: 2, tempStrength: true },
        outcome: "Your spirits are lifted! (+2 Strength for this battle)"
      },
      {
        id: 'cautious',
        text: "\"We must be careful. Watch for weaknesses.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"A ranger's wisdom. Strike true when the moment comes.\"",
          legolas: "\"Patience is an elven virtue. I shall watch for openings.\"",
          gandalf: "\"Prudence serves us well. Every enemy has a flaw to exploit.\"",
          gimli: "\"Hmm, not how I'd put it, but fair enough. Hit them where it hurts!\""
        },
        effect: { dexterity: 2, tempDexterity: true },
        outcome: "You prepare for a tactical battle. (+2 Dexterity for this battle)"
      },
      {
        id: 'determined',
        text: "\"Whatever happens, we don't give up.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"Even in darkness, hope remains. We shall endure.\"",
          legolas: "\"The light of the Eldar does not fade easily. Fight on!\"",
          gandalf: "\"Despair is the enemy's greatest weapon. Deny them that victory!\"",
          gimli: "\"Nobody's harder to kill than a Dwarf who's decided not to die!\""
        },
        effect: { block: 15, tempBlock: true },
        outcome: "Your resolve hardens! (+15 Block at combat start)"
      }
    ]
  },
  
  after_loss: {
    id: 'after_loss',
    title: "Picking Up the Pieces",
    location: "Aftermath",
    trigger: 'low_hp',
    hpThreshold: 0.3, // Triggers when HP below 30%
    actAvailable: [1, 2, 3],
    participants: ['all'],
    introduction: "You've been badly wounded. Your companion kneels beside you with concern.",
    choices: [
      {
        id: 'accept_help',
        text: "\"I could use some healing.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"I know the healing arts of my people. Restâlet me tend your wounds.\"",
          legolas: "\"I carry Elvish medicine. It will ease your pain.\"",
          gandalf: "\"Hold still. A little wizardry goes a long way in healing.\"",
          gimli: "\"Not much for healing magic, but I've got some Dwarven spirits. Burns, but works!\""
        },
        effect: { heal: 25 },
        outcome: "Your wounds are tended. (+25 HP)"
      },
      {
        id: 'push_on',
        text: "\"No time. We must press forward.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"Your courage does you credit. Let it also fuel your strength.\"",
          legolas: "\"The will of mortals never ceases to amaze me. Fight on, friend.\"",
          gandalf: "\"Stubborn as a hobbit! Very wellâlet your determination be your shield.\"",
          gimli: "\"Ha! That's the spirit! A few scratches won't slow us down!\""
        },
        effect: { strength: 1, dexterity: 1, permanent: true },
        outcome: "Your determination inspires you. (+1 Strength, +1 Dexterity permanent)"
      }
    ]
  },
  
  act_transition: {
    id: 'act_transition',
    title: "The Journey Continues",
    location: "Crossroads",
    trigger: 'act_complete',
    actAvailable: [1, 2],
    participants: ['all'],
    introduction: "A great trial is behind you. Your companion reflects on what lies ahead.",
    choices: [
      {
        id: 'look_forward',
        text: "\"What can we expect ahead?\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"Darker roads than we've yet traveled. But also greater allies to find.\"",
          legolas: "\"The enemy's strength grows, but so does our own. We are ready.\"",
          gandalf: "\"Greater challenges await, but you have proven yourself worthy of them.\"",
          gimli: "\"More fighting, I expect! Good thing we're getting better at it!\""
        },
        effect: { maxHp: 10 },
        outcome: "You steel yourself for harder battles. (+10 Max HP)"
      },
      {
        id: 'reflect',
        text: "\"We've come far already.\"",
        speaker: 'player',
        response: {
          speaker: 'varies',
          aragorn: "\"Indeed. Every step brings us closer to victoryâor doom. I choose to believe in victory.\"",
          legolas: "\"The journey shapes us. You are not the same warrior who began this quest.\"",
          gandalf: "\"Growth comes through adversity. You've weathered much and emerged stronger.\"",
          gimli: "\"Aye, we've cracked some skulls! And we'll crack plenty more before the end!\""
        },
        effect: { upgradeRandomCard: true },
        outcome: "Experience has honed your abilities. (Random card upgraded)"
      }
    ]
  }
};

// ============================================
// US-001: ENHANCED STORY INTEGRATION
// Character-specific story journeys reflecting book lore
// ============================================

// Character-specific story journeys with branching paths
const CHARACTER_STORY_JOURNEYS = {
  aragorn: {
    name: "The Path of the King",
    theme: "From Ranger to King - embracing destiny",
    acts: {
      1: {
        title: "Strider in the Wild",
        description: "You have wandered the wilderness for decades, protecting the innocent from shadows they never see. Now the time approaches to reveal your true heritage.",
        keyLocations: ['bree', 'weathertop', 'rivendell'],
        storyBeats: [
          { encounter: 2, text: "At Bree, you sense the weight of watching eyes. The Enemy knows the heir of Isildur walks again." },
          { encounter: 8, text: "Weathertop - where the Witch-King nearly ended your quest before it began. The memory of that night still haunts you." },
          { encounter: 9, text: "Rivendell welcomes you home. Elrond looks upon you with hope - and concern. 'The time of hiding ends, Estel.'" }
        ]
      },
      2: {
        title: "The Broken Sword Reforged",
        description: "AndÃºril, Flame of the West, has been reforged from the shards of Narsil. With it, you carry the hope of Men against the darkness.",
        keyLocations: ['lothlorien', 'fangorn', 'helms_deep'],
        storyBeats: [
          { encounter: 17, text: "In LothlÃ³rien, Galadriel's mirror shows you a choice: the throne, or Arwen. Can you have both?" },
          { encounter: 23, text: "At Helm's Deep, you rally the defenders. 'Show them no mercy, for you shall receive none!'" },
          { encounter: 29, text: "The Paths of the Dead await. Only the heir of Isildur may summon the oathbreakers." }
        ]
      },
      3: {
        title: "Return of the King",
        description: "The final battle approaches. All your years of wandering have led to this moment - to claim your birthright and save Middle-earth.",
        keyLocations: ['minas_tirith', 'black_gate', 'mount_doom'],
        storyBeats: [
          { encounter: 32, text: "Minas Tirith - the White City of your ancestors. Denethor refuses to yield the Stewardship. Blood of NÃºmenor against blood of NÃºmenor." },
          { encounter: 40, text: "Before the Black Gate, you call out: 'For Frodo!' Every moment you buy brings hope closer to the fire." },
          { encounter: 44, text: "The Eye turns to you. Let it. Let Sauron see the heir of the man who once defeated him." }
        ]
      }
    }
  },
  
  legolas: {
    name: "The Song of the Eldar",
    theme: "Elven prince torn between duty and the call of the sea",
    acts: {
      1: {
        title: "Prince of Mirkwood",
        description: "You represent your father Thranduil at the Council of Elrond. The shadow that plagued your forest now threatens all Middle-earth.",
        keyLocations: ['mirkwood', 'rivendell', 'moria'],
        storyBeats: [
          { encounter: 2, text: "Mirkwood grows ever darker. Your father's realm shrinks year by year as the Enemy's influence spreads." },
          { encounter: 9, text: "At Rivendell, you meet a Dwarf - Gimli, son of GlÃ³in. Ancient grudges stir, yet fate has bound your paths together." },
          { encounter: 14, text: "The darkness of Moria reminds you of Dol Guldur. Even ancient Dwarven halls cannot keep out the shadow." }
        ]
      },
      2: {
        title: "An Unlikely Friendship",
        description: "Against all expectation, the Dwarf has become dear to you. Together you count your kills at Helm's Deep - and find something worth more than victories.",
        keyLocations: ['fangorn', 'helms_deep', 'isengard'],
        storyBeats: [
          { encounter: 16, text: "In Fangorn, you feel the ancient spirits of the trees. The Elves once walked with the Ents in ages past." },
          { encounter: 23, text: "'Forty-two!' 'Forty-three!' The competition with Gimli brings unexpected joy amid the horror of battle." },
          { encounter: 29, text: "Looking upon flooded Isengard, you and Gimli share a quiet moment. Who would have thought - an Elf and a Dwarf, brothers in arms." }
        ]
      },
      3: {
        title: "The Sea-Longing",
        description: "You have heard the gulls cry. The call of Valinor grows strong in your heart - but your friends still need you.",
        keyLocations: ['pelargir', 'minas_tirith', 'black_gate'],
        storyBeats: [
          { encounter: 32, text: "At Pelargir, you first hear the gulls. The sea-longing awakens in your heart. You will never be free of it." },
          { encounter: 40, text: "Before the Black Gate, Gimli stands beside you. 'Never thought I'd die fighting side by side with an Elf.' 'What about side by side with a friend?'" },
          { encounter: 44, text: "If this is the end, you will face it with friends - mortal friends, whose lives burn bright but brief." }
        ]
      }
    }
  },
  
  gimli: {
    name: "Durin's Heir",
    theme: "Dwarven warrior discovering beauty beyond gold",
    acts: {
      1: {
        title: "Son of GlÃ³in",
        description: "You represent the Dwarves at Rivendell, bringing dark news. Balin's colony in Moria has been silent for years. You must know their fate.",
        keyLocations: ['erebor', 'rivendell', 'moria'],
        storyBeats: [
          { encounter: 2, text: "You leave Erebor with your father's blessing. 'Find out what happened to Balin, my son. The Longbeards must know.'" },
          { encounter: 9, text: "At Rivendell, you distrust the Elves - especially that princeling Legolas. But the quest demands cooperation." },
          { encounter: 14, text: "Moria... 'Here lies Balin, son of Fundin, Lord of Moria.' Your cousin is dead. They are all dead." }
        ]
      },
      2: {
        title: "The Lady's Champion",
        description: "In LothlÃ³rien, you beheld Lady Galadriel - and your heart was changed forever. You now fight not for gold, but for beauty itself.",
        keyLocations: ['lothlorien', 'fangorn', 'helms_deep'],
        storyBeats: [
          { encounter: 17, text: "Galadriel gives you three golden hairs. No treasure in Erebor could match this gift. You will carry them always." },
          { encounter: 23, text: "At Helm's Deep, you fight not as Dwarf against Orc, but as a defender of beauty against ugliness incarnate." },
          { encounter: 29, text: "You have promised Legolas to visit the Glittering Caves. He has promised to walk with you in Fangorn. Strange days." }
        ]
      },
      3: {
        title: "Lord of the Glittering Caves",
        description: "The war ends, but your journey continues. Aglarond awaits, and a ship to bear you west with your truest friend.",
        keyLocations: ['minas_tirith', 'black_gate', 'aglarond'],
        storyBeats: [
          { encounter: 32, text: "In Minas Tirith, you see potential in the stonework. With Dwarven craft, this city could truly shine." },
          { encounter: 40, text: "'Side by side with a friend,' Legolas says. You realize the Elf has become dearer to you than any Dwarf save your father." },
          { encounter: 44, text: "If you survive this, you will build something beautiful. Not for gold, but for its own sake. The Lady taught you that." }
        ]
      }
    }
  },
  
  gandalf: {
    name: "Servant of the Secret Fire",
    theme: "The burden of wisdom and the courage to hope",
    acts: {
      1: {
        title: "The Grey Pilgrim",
        description: "For two thousand years you have walked Middle-earth. Now the great test approaches - Saruman has betrayed you, and the Enemy moves.",
        keyLocations: ['isengard', 'rivendell', 'moria'],
        storyBeats: [
          { encounter: 2, text: "Isengard - where Saruman revealed his treachery. 'Against the power of Mordor there can be no victory.' He is wrong. He must be." },
          { encounter: 9, text: "At Rivendell, you set the Fellowship on its path. The Ring must be destroyed - and Frodo must be the one to carry it." },
          { encounter: 14, text: "In Moria, something stirs. You feel it in your bones - an ancient evil. 'This foe is beyond any of you. Run!'" }
        ]
      },
      2: {
        title: "Gandalf the White",
        description: "Through fire and death you have returned, sent back until your task is done. Saruman must answer for his betrayal.",
        keyLocations: ['fangorn', 'edoras', 'orthanc'],
        storyBeats: [
          { encounter: 16, text: "You return in Fangorn - Gandalf the White, clothed in the color Saruman should have worn. The tide turns." },
          { encounter: 23, text: "You free ThÃ©oden from Saruman's spell. Rohan will ride again - and not too late, if fortune favors the brave." },
          { encounter: 29, text: "At Orthanc, you break Saruman's staff. He is cast from the order. Yet you pity him - he was not always fallen." }
        ]
      },
      3: {
        title: "The Last Battle",
        description: "This is what you were sent for - to guide the free peoples through their darkest hour. Win or lose, you will not fail them.",
        keyLocations: ['minas_tirith', 'black_gate', 'grey_havens'],
        storyBeats: [
          { encounter: 32, text: "Minas Tirith burns. Denethor has fallen to despair. You must hold the city until Rohan comes - or all is lost." },
          { encounter: 40, text: "Before the Black Gate, you lead the last army of the West. Not for victory - for hope. For Frodo." },
          { encounter: 44, text: "Your task is nearly done. Soon you will return West, to Valinor. But not until you see this through." }
        ]
      }
    }
  }
};

// Character-specific branching dialogues with meaningful choices
const CHARACTER_BRANCHING_DIALOGUES = {
  aragorn: [
    {
      id: 'aragorn_destiny',
      title: "The Weight of the Crown",
      trigger: 'act1_midpoint',
      location: "By the Campfire",
      introduction: "As you stare into the flames, memories of Rivendell surface. Elrond's words echo: 'Put aside the Ranger. Become who you were born to be.'",
      choices: [
        {
          id: 'accept_destiny',
          text: "\"I will claim my birthright. Gondor needs its king.\"",
          response: "The weight settles on your shoulders - not a burden, but a mantle. You feel the strength of your ancestors flowing through you.",
          effect: { strength: 2, permanentBonus: true, addCard: 'kings_authority' },
          outcome: "+2 Permanent Strength, Gained card: King's Authority",
          storyFlag: 'accepted_crown'
        },
        {
          id: 'doubt_destiny',
          text: "\"The same blood runs in my veins. The same weakness.\"",
          response: "Isildur's shadow haunts you still. But perhaps awareness of weakness is its own kind of strength.",
          effect: { dexterity: 2, permanentBonus: true, addCard: 'rangers_caution' },
          outcome: "+2 Permanent Dexterity, Gained card: Ranger's Caution",
          storyFlag: 'doubted_crown'
        },
        {
          id: 'arwen_focus',
          text: "\"My heart belongs to Arwen. That is my true north.\"",
          response: "Love gives you purpose beyond crowns and kingdoms. For her, you would storm Mordor itself.",
          effect: { maxHp: 10, permanentBonus: true, addCard: 'evenstar_blessing' },
          outcome: "+10 Max HP, Gained card: Evenstar's Blessing",
          storyFlag: 'chose_love'
        }
      ]
    },
    {
      id: 'aragorn_paths_of_dead',
      title: "The Paths of the Dead",
      trigger: 'act2_midpoint',
      location: "The Dark Door",
      introduction: "The entrance to the Paths of the Dead yawns before you. None but the heir of Isildur may summon the oathbreakers. Even Legolas and Gimli hesitate.",
      choices: [
        {
          id: 'command_dead',
          text: "\"I am Isildur's heir. I will have your allegiance or your destruction!\"",
          response: "Your voice carries the authority of Elendil himself. The dead bow to the true king.",
          effect: { addRelic: 'army_of_dead', strength: 1 },
          outcome: "Gained Relic: Army of the Dead, +1 Strength",
          storyFlag: 'commanded_dead'
        },
        {
          id: 'bargain_dead',
          text: "\"Fulfill your oath and find peace. This I offer you.\"",
          response: "Compassion reaches even the cursed. The dead follow - not from fear, but hope of redemption.",
          effect: { addRelic: 'oathbreakers_peace', corruptionResist: 10 },
          outcome: "Gained Relic: Oathbreaker's Peace, +10% Corruption Resistance",
          storyFlag: 'offered_peace'
        },
        {
          id: 'refuse_dead',
          text: "\"I will not traffic with the cursed. We find another way.\"",
          response: "Your companions look relieved - and surprised. Perhaps there is strength in refusing dark bargains.",
          effect: { heal: 999, corruptionRemove: 20 },
          outcome: "Full heal, -20 Corruption",
          storyFlag: 'refused_dead'
        }
      ]
    },
    {
      id: 'aragorn_black_gate',
      title: "Before the Black Gate",
      trigger: 'act3_preboss',
      location: "Morannon",
      introduction: "Ten thousand orcs stand between you and the Black Gate. This is not a battle you can win - only a distraction to buy Frodo time.",
      choices: [
        {
          id: 'charge_gate',
          text: "\"For Frodo!\" [Lead the charge yourself]",
          response: "You charge into legend. Songs will be sung of this day - if any survive to sing them.",
          effect: { strength: 3, vulnerable: 99 },
          outcome: "+3 Strength, but you take 50% more damage",
          storyFlag: 'led_charge'
        },
        {
          id: 'rally_troops',
          text: "\"Sons of Gondor! Of Rohan! My brothers!\" [Inspire your army]",
          response: "Your words kindle fire in mortal hearts. Men who expected death now fight for victory.",
          effect: { block: 30, heal: 20 },
          outcome: "+30 Block, +20 HP",
          storyFlag: 'rallied_army'
        },
        {
          id: 'face_sauron',
          text: "\"Sauron! I am the heir of Isildur! Face me!\" [Challenge the Dark Lord]",
          response: "The Eye turns fully upon you. The pressure is immense - but every moment Sauron watches you is a moment Frodo goes unnoticed.",
          effect: { addCard: 'defiance_of_kings', corruption: 15 },
          outcome: "Gained: Defiance of Kings, +15 Corruption from Sauron's gaze",
          storyFlag: 'challenged_sauron'
        }
      ]
    }
  ],
  
  legolas: [
    {
      id: 'legolas_moria',
      title: "The Memory of the Eldar",
      trigger: 'act1_midpoint',
      location: "Halls of Moria",
      introduction: "The darkness of Moria weighs upon you. This place was once a wonder - Khazad-dÃ»m, where Elves and Dwarves traded in friendship. Now only death remains.",
      choices: [
        {
          id: 'honor_past',
          text: "\"I will honor what this place once was.\" [Fight for the memory of friendship]",
          response: "You fight not as an Elf against goblins, but for the memory of a better age. Gimli notices - and something shifts between you.",
          effect: { strength: 1, dexterity: 1, addCard: 'memory_of_ages' },
          outcome: "+1 STR, +1 DEX, Gained: Memory of Ages",
          storyFlag: 'honored_dwarf_memory'
        },
        {
          id: 'elven_superiority',
          text: "\"The Dwarves delved too greedily. They brought this on themselves.\"",
          response: "Gimli's face hardens. The ancient grudge deepens - but so does your resolve to prove Elven superiority.",
          effect: { dexterity: 3, addCard: 'elven_pride' },
          outcome: "+3 Dexterity, Gained: Elven Pride",
          storyFlag: 'scorned_dwarves'
        },
        {
          id: 'sense_balrog',
          text: "\"Something else dwells here. Something ancient.\" [Focus your senses]",
          response: "Your elven senses pierce the darkness. You feel it - a Balrog. The Fellowship must be warned.",
          effect: { addRelic: 'elven_foresight', heal: 15 },
          outcome: "Gained Relic: Elven Foresight, +15 HP",
          storyFlag: 'sensed_balrog'
        }
      ]
    },
    {
      id: 'legolas_galadriel',
      title: "Gifts of Galadriel",
      trigger: 'act2_start',
      location: "LothlÃ³rien",
      introduction: "The Lady offers each of you a gift. For you, she holds a bow of the Galadhrim - but also a choice.",
      choices: [
        {
          id: 'take_bow',
          text: "\"I will wield your bow with honor, Lady.\" [Accept the weapon]",
          response: "The Bow of Galadriel sings in your hands. With it, you could strike down a NazgÃ»l mid-flight.",
          effect: { addRelic: 'bow_of_galadriel', addCard: 'galad_shot' },
          outcome: "Gained Relic: Bow of Galadriel, Gained: Galad Shot",
          storyFlag: 'took_bow'
        },
        {
          id: 'ask_blessing',
          text: "\"I ask only your blessing, Lady - for myself and for Gimli.\"",
          response: "Galadriel smiles. 'You have learned what many Elves never do. May your friendship endure beyond the ages.'",
          effect: { permanentBonus: true, dexterity: 2, corruptionResist: 15 },
          outcome: "+2 Permanent DEX, +15% Corruption Resistance",
          storyFlag: 'asked_blessing'
        },
        {
          id: 'sea_question',
          text: "\"Lady... will I ever sail to Valinor?\" [Ask about your fate]",
          response: "'You will, when the time comes - and not alone. The sea-longing will awaken, but do not fear it.'",
          effect: { heal: 999, maxHp: 5, addCard: 'sea_longing' },
          outcome: "Full heal, +5 Max HP, Gained: Sea-Longing",
          storyFlag: 'asked_fate'
        }
      ]
    },
    {
      id: 'legolas_friendship',
      title: "A Promise Between Friends",
      trigger: 'act3_midpoint',
      location: "Before the Final Battle",
      introduction: "Gimli approaches you before the battle. 'I never thought I'd die fighting side by side with an Elf.'",
      choices: [
        {
          id: 'friend_response',
          text: "\"What about side by side with a friend?\"",
          response: "'Aye,' Gimli says, tears in his eyes. 'I could do that.' In this moment, you know you will never abandon him.",
          effect: { strength: 2, dexterity: 2, addCard: 'bond_of_fellowship' },
          outcome: "+2 STR, +2 DEX, Gained: Bond of Fellowship",
          storyFlag: 'called_friend'
        },
        {
          id: 'competition',
          text: "\"One last count, then. Loser buys the drinks in Valinor.\"",
          response: "Gimli laughs - a good, Dwarven belly laugh. 'You're on, princeling!'",
          effect: { strength: 3, addCard: 'competitive_spirit' },
          outcome: "+3 Strength, Gained: Competitive Spirit",
          storyFlag: 'final_competition'
        },
        {
          id: 'promise_ship',
          text: "\"When I sail West, Gimli... I want you to come with me.\"",
          response: "The Dwarf's eyes widen. 'An Elf inviting a Dwarf to the Undying Lands? The world truly has changed.' He clasps your arm. 'I accept.'",
          effect: { addRelic: 'promise_of_valinor', corruptionResist: 20 },
          outcome: "Gained Relic: Promise of Valinor, +20% Corruption Resistance",
          storyFlag: 'promised_ship'
        }
      ]
    }
  ],
  
  gimli: [
    {
      id: 'gimli_moria',
      title: "Tomb of Balin",
      trigger: 'act1_midpoint',
      location: "Chamber of Mazarbul",
      introduction: "You find Balin's tomb. Your cousin - Lord of Moria - lies dead. The Book of Mazarbul tells the tale: 'We cannot get out. The drums, the drums in the deep...'",
      choices: [
        {
          id: 'rage',
          text: "\"BARUK KHAZÃD!\" [Let fury consume you]",
          response: "Dwarven rage fills you. Every orc in Moria will pay for what was done here!",
          effect: { strength: 4, addCard: 'dwarven_fury' },
          outcome: "+4 Strength, Gained: Dwarven Fury",
          storyFlag: 'raged_at_tomb'
        },
        {
          id: 'mourn',
          text: "\"Rest well, cousin. I will avenge you.\" [Take time to grieve]",
          response: "Tears fall on ancient stone. But grief, properly honored, becomes strength.",
          effect: { maxHp: 15, addCard: 'grief_into_strength' },
          outcome: "+15 Max HP, Gained: Grief Into Strength",
          storyFlag: 'mourned_balin'
        },
        {
          id: 'practical',
          text: "\"We cannot linger. They died fighting - we honor them by surviving.\"",
          response: "Legolas looks at you with new respect. 'Dwarven wisdom,' he admits quietly.",
          effect: { dexterity: 2, block: 20, addCard: 'dwarven_resilience' },
          outcome: "+2 DEX, +20 Block, Gained: Dwarven Resilience",
          storyFlag: 'honored_practically'
        }
      ]
    },
    {
      id: 'gimli_galadriel',
      title: "The Light of the Lady",
      trigger: 'act2_start',
      location: "LothlÃ³rien",
      introduction: "Galadriel stands before you - the most beautiful sight you have ever beheld. She asks what gift you would have of the Elves.",
      choices: [
        {
          id: 'ask_hair',
          text: "\"A single strand of your hair, Lady.\" [Make the legendary request]",
          response: "Galadriel laughs with delight - and gives you three. 'You have earned more than you know, Gimli son of GlÃ³in.'",
          effect: { addRelic: 'galadriel_hair', permanentBonus: true, maxHp: 10 },
          outcome: "Gained Relic: Galadriel's Hair, +10 Max HP",
          storyFlag: 'asked_for_hair'
        },
        {
          id: 'ask_nothing',
          text: "\"To have seen your beauty is gift enough.\" [Ask for nothing]",
          response: "'Truly the Dwarves have depths the Elves have forgotten,' Galadriel says softly. 'Take my blessing, and more.'",
          effect: { corruptionResist: 25, addCard: 'ladys_blessing' },
          outcome: "+25% Corruption Resistance, Gained: Lady's Blessing",
          storyFlag: 'asked_nothing'
        },
        {
          id: 'ask_weapon',
          text: "\"A weapon worthy of slaying orcs, Lady.\" [Request practical aid]",
          response: "An axe of mithril and mallorn-wood is brought forth. 'May it bite deep,' Galadriel says.",
          effect: { addRelic: 'lorien_axe', strength: 2 },
          outcome: "Gained Relic: Axe of LÃ³rien, +2 Strength",
          storyFlag: 'asked_weapon'
        }
      ]
    },
    {
      id: 'gimli_caves',
      title: "The Glittering Caves",
      trigger: 'act3_start',
      location: "Helm's Deep",
      introduction: "After the battle, you explored the caves behind Helm's Deep. What you found there changed you forever - beauty beyond imagining, crystalline formations that sing with the earth's voice.",
      choices: [
        {
          id: 'swear_protect',
          text: "\"I swear to protect this place. None shall despoil its beauty.\"",
          response: "You have found your purpose beyond war. When this is over, you will return as guardian and craftsman.",
          effect: { addRelic: 'glittering_oath', block: 30 },
          outcome: "Gained Relic: Oath of Aglarond, +30 Block",
          storyFlag: 'swore_to_protect'
        },
        {
          id: 'share_legolas',
          text: "\"Legolas must see this. He promised to walk in Fangorn with me.\"",
          response: "The Elf agrees - and marvels. 'I was wrong about Dwarves,' he admits. Your friendship deepens.",
          effect: { dexterity: 2, strength: 2, addCard: 'shared_wonder' },
          outcome: "+2 DEX, +2 STR, Gained: Shared Wonder",
          storyFlag: 'shared_with_legolas'
        },
        {
          id: 'claim_lordship',
          text: "\"When the war ends, I will be Lord of these caves.\" [Claim them for yourself]",
          response: "Aragorn, once king, will grant you this boon. You will found a colony here - Dwarves living in beauty, not just digging for gold.",
          effect: { addRelic: 'lord_of_caves', gold: 100, addCard: 'dwarven_ambition' },
          outcome: "Gained Relic: Lord of Caves, +100 Gold, Gained: Dwarven Ambition",
          storyFlag: 'claimed_caves'
        }
      ]
    }
  ],
  
  gandalf: [
    {
      id: 'gandalf_saruman',
      title: "The Betrayal",
      trigger: 'act1_start',
      location: "Orthanc",
      introduction: "Saruman's words still echo: 'A new power is rising. Against it the old allies and policies will not avail us.' You barely escaped with your life.",
      choices: [
        {
          id: 'anger',
          text: "\"He will pay for this treachery.\" [Let anger fuel you]",
          response: "Saruman was your friend. His betrayal cuts deeper than any blade. That wound becomes a weapon.",
          effect: { strength: 3, addCard: 'righteous_fury' },
          outcome: "+3 Strength, Gained: Righteous Fury",
          storyFlag: 'angry_at_saruman'
        },
        {
          id: 'pity',
          text: "\"I pity him. He has chosen fear over hope.\" [Find compassion]",
          response: "Even for a betrayer, you find mercy in your heart. This is the wisdom that makes you Gandalf.",
          effect: { corruptionResist: 20, heal: 20, addCard: 'wizards_mercy' },
          outcome: "+20% Corruption Resistance, +20 HP, Gained: Wizard's Mercy",
          storyFlag: 'pitied_saruman'
        },
        {
          id: 'focus_mission',
          text: "\"Saruman is lost. The Ring is what matters.\" [Stay focused]",
          response: "You cannot save everyone. The world hangs on Frodo's success - everything else is secondary.",
          effect: { dexterity: 2, addRelic: 'single_purpose' },
          outcome: "+2 Dexterity, Gained Relic: Single Purpose",
          storyFlag: 'stayed_focused'
        }
      ]
    },
    {
      id: 'gandalf_balrog',
      title: "You Shall Not Pass",
      trigger: 'act1_preboss',
      location: "Bridge of Khazad-dÃ»m",
      introduction: "The Balrog approaches. Durin's Bane - a demon of the ancient world. The Fellowship must escape. But someone must hold the bridge.",
      choices: [
        {
          id: 'servant_fire',
          text: "\"I am a servant of the Secret Fire!\" [Invoke your true power]",
          response: "You reveal what you truly are - OlÃ³rin, a Maia of Valinor. The Balrog hesitates. It recognizes a peer.",
          effect: { strength: 4, addCard: 'secret_fire' },
          outcome: "+4 Strength, Gained: Secret Fire",
          storyFlag: 'invoked_fire'
        },
        {
          id: 'for_fellowship',
          text: "\"For the Fellowship!\" [Focus on protecting the others]",
          response: "You think not of yourself, but of them - Frodo, Sam, the others. Your staff shines brighter for it.",
          effect: { block: 40, addCard: 'shepherds_sacrifice' },
          outcome: "+40 Block, Gained: Shepherd's Sacrifice",
          storyFlag: 'protected_fellowship'
        },
        {
          id: 'face_death',
          text: "\"If this is my end, so be it.\" [Accept your fate]",
          response: "Fear has no hold on you. You have lived long enough. What matters is what you die for.",
          effect: { maxHp: 20, corruptionResist: 30, addCard: 'fearless_end' },
          outcome: "+20 Max HP, +30% Corruption Resistance, Gained: Fearless End",
          storyFlag: 'accepted_death'
        }
      ]
    },
    {
      id: 'gandalf_return',
      title: "Gandalf the White",
      trigger: 'act2_opening',
      location: "Fangorn Forest",
      introduction: "You have returned - sent back until your task is done. Death... death was just the beginning. You are no longer Gandalf the Grey.",
      choices: [
        {
          id: 'embrace_power',
          text: "\"I am changed. I am become what Saruman should have been.\"",
          response: "White robes. Greater power. You take up the mantle the traitor discarded.",
          effect: { strength: 3, dexterity: 3, addCard: 'white_council' },
          outcome: "+3 STR, +3 DEX, Gained: White Council",
          storyFlag: 'embraced_power'
        },
        {
          id: 'remain_gandalf',
          text: "\"I am still Gandalf. The color of my robes changes nothing.\"",
          response: "The hobbits will still call you Gandalf. The power is greater, but you are still you.",
          effect: { heal: 999, maxHp: 15, addCard: 'unchanged_heart' },
          outcome: "Full heal, +15 Max HP, Gained: Unchanged Heart",
          storyFlag: 'remained_gandalf'
        },
        {
          id: 'burden_knowledge',
          text: "\"I have seen beyond the circles of the world. It is... a lot to bear.\"",
          response: "Death showed you things mortals cannot comprehend. The knowledge weighs heavy, but also illuminates.",
          effect: { addRelic: 'beyond_death', addCard: 'glimpse_beyond' },
          outcome: "Gained Relic: Beyond Death, Gained: Glimpse Beyond",
          storyFlag: 'burdened_knowledge'
        }
      ]
    }
  ]
};

// Corruption-based endings
const CORRUPTION_ENDINGS = {
  pure: {
    threshold: [0, 24],
    title: "The Light Prevails",
    description: "You resisted the shadow's corruption completely. Your spirit remains untouched by darkness.",
    bonusTitle: "Incorruptible"
  },
  tempted: {
    threshold: [25, 49],
    title: "Scarred but Standing",
    description: "The shadow touched you, but did not claim you. Scars remain, but so does your will.",
    bonusTitle: "Resilient Soul"
  },
  struggling: {
    threshold: [50, 74],
    title: "On the Knife's Edge",
    description: "The darkness nearly consumed you. You survived, but the experience has changed you forever.",
    bonusTitle: "Shadow-Touched"
  },
  corrupted: {
    threshold: [75, 99],
    title: "Tainted Victory",
    description: "You won, but at terrible cost. The Ring's influence has left permanent marks upon your soul.",
    bonusTitle: "Ring-Scarred"
  },
  fallen: {
    threshold: [100, 100],
    title: "Claimed by Shadow",
    description: "The shadow won. Though your body may persist, your soul belongs to the darkness now.",
    bonusTitle: "Lost Soul",
    isDefeat: true
  }
};

// Character-specific epilogues
const CHARACTER_EPILOGUES = {
  aragorn: {
    default: {
      title: "King Elessar",
      text: "You took your rightful place as King of the Reunited Kingdom. Gondor and Arnor flourished under your rule for 120 years. Arwen UndÃ³miel became your queen, and the bloodline of Elendil continued. At the end, you chose your time, laying down your life peacefully. Your legacy would endure for ages of Men.",
      image: "throne"
    },
    accepted_crown: {
      title: "The Willing King",
      text: "Having embraced your destiny fully, you became not just a ruler, but a symbol. Kings for generations hence would measure themselves against Elessar - and find themselves wanting. Your descendants ruled with the same certainty, the same unwavering purpose.",
      bonus: { unlockCard: 'crown_of_gondor' }
    },
    doubted_crown: {
      title: "The Humble King",
      text: "Your doubt made you wise. You ruled not as one born to command, but as one who earned the right daily. The people loved you not for your lineage, but for your service. Some say you were the greatest king precisely because you never believed you deserved to be.",
      bonus: { unlockCard: 'peoples_king' }
    },
    chose_love: {
      title: "Arwen's King",
      text: "For Arwen, you would have stormed Mordor alone. Your love story became legend - the mortal king and the immortal queen who chose death to be with him. When you passed, she walked alone to LothlÃ³rien, and there on Cerin Amroth, she laid herself down to rest.",
      bonus: { unlockCard: 'love_eternal' }
    }
  },
  
  legolas: {
    default: {
      title: "The Last Ship",
      text: "After King Elessar's death, you felt there was no more holding you to Middle-earth. You built a grey ship in Ithilien, and sailed West to the Undying Lands - taking Gimli with you, the only Dwarf ever to be so honored. Your friendship became legend among all the Free Peoples.",
      image: "ship"
    },
    called_friend: {
      title: "Brothers of the Heart",
      text: "Your friendship with Gimli transcended all boundaries of race and history. When you sailed West, he was beside you. The Valar themselves marveled - for in your bond, they saw what was best in all the Children of IlÃºvatar.",
      bonus: { unlockCard: 'unbreakable_bond' }
    },
    final_competition: {
      title: "The Eternal Contest",
      text: "Even in Valinor, the competition continued. Gimli would claim, until the end of days, that he won the final count at the Black Gate. You would claim otherwise. Neither of you actually remembered the tally. Neither of you cared.",
      bonus: { unlockCard: 'friendly_rivals' }
    },
    promised_ship: {
      title: "The Last Adventure",
      text: "Your promise to Gimli was kept. When the grey ship sailed, the Dwarf stood at the prow, weeping unashamedly at the beauty of the Western shores. 'You were right, Elf,' he said. 'About everything.' You smiled. 'Not about everything, Dwarf. But about the important things.'",
      bonus: { unlockCard: 'kept_promise' }
    }
  },
  
  gimli: {
    default: {
      title: "Lord of Aglarond",
      text: "You became Lord of the Glittering Caves, founding a Dwarven colony in Helm's Deep. Your craftsmen created works of beauty that rivaled the treasures of Khazad-dÃ»m in its prime. You proved that Dwarves could create for beauty's sake alone.",
      image: "caves"
    },
    asked_for_hair: {
      title: "Guardian of Light",
      text: "Galadriel's three hairs became your most treasured possession. You set them in crystal and mithril, and they became the light of the Glittering Caves - a reminder that beauty transcends all boundaries, even those between Dwarf and Elf.",
      bonus: { unlockCard: 'light_of_galadriel' }
    },
    swore_to_protect: {
      title: "The Eternal Guardian",
      text: "Your oath to the Glittering Caves never wavered. When the time came to sail West, you hesitated - but the caves themselves seemed to release you. 'Go,' whispered the stones. 'You have kept faith. Now find your friend.'",
      bonus: { unlockCard: 'oathkeeper' }
    },
    claimed_caves: {
      title: "The Wealthy Lord",
      text: "The Glittering Caves made you wealthy beyond measure - but wealth meant little to you now. You used your riches to rebuild, to create, to prove that Dwarves were more than miners and warriors. Your colony became a wonder of the Fourth Age.",
      bonus: { unlockCard: 'dwarven_renaissance' }
    }
  },
  
  gandalf: {
    default: {
      title: "Return to Valinor",
      text: "Your task complete, you sailed West with Frodo, Bilbo, and the last of the Ring-bearers. In Valinor, you shed the guise of Gandalf and became OlÃ³rin once more. But you would always remember the little people who taught you that even the smallest person can change the course of the future.",
      image: "haven"
    },
    embraced_power: {
      title: "The White Council Restored",
      text: "As Gandalf the White, you had become what Saruman failed to be. Before departing Middle-earth, you ensured the Istari's wisdom would not be entirely lost, teaching what you could to the wise among Men and Elves.",
      bonus: { unlockCard: 'legacy_of_wisdom' }
    },
    remained_gandalf: {
      title: "The Hobbits' Friend",
      text: "Power and titles meant nothing. You were Gandalf - fireworks maker, pipe smoker, friend to hobbits. When Frodo asked what he should call you in Valinor, you smiled and said, 'Gandalf will do quite nicely.'",
      bonus: { unlockCard: 'simple_wizard' }
    },
    pitied_saruman: {
      title: "The Merciful",
      text: "Your pity for Saruman showed the true measure of your wisdom. Even at the end, you offered him redemption. He refused - but the offer itself was recorded in the histories, a testament to what the Istari should have been.",
      bonus: { unlockCard: 'boundless_mercy' }
    }
  }
};

// Get character's current story beat based on encounter
const getCharacterStoryBeat = (characterKey, encounterIndex, act) => {
  const journey = CHARACTER_STORY_JOURNEYS[characterKey];
  if (!journey) return null;
  
  const actStory = journey.acts[act];
  if (!actStory) return null;
  
  const beat = actStory.storyBeats.find(b => b.encounter === encounterIndex);
  return beat ? { ...beat, actTitle: actStory.title, actDescription: actStory.description } : null;
};

// Get available branching dialogue for character
const getCharacterBranchingDialogue = (characterKey, trigger, storyChoices = {}) => {
  const dialogues = CHARACTER_BRANCHING_DIALOGUES[characterKey];
  if (!dialogues) return null;
  
  // Find dialogue matching trigger that hasn't been completed
  const available = dialogues.find(d => 
    d.trigger === trigger && 
    !storyChoices[d.id + '_completed']
  );
  
  return available;
};

// Get corruption ending based on level
const getCorruptionEnding = (corruptionLevel) => {
  for (const [key, ending] of Object.entries(CORRUPTION_ENDINGS)) {
    if (corruptionLevel >= ending.threshold[0] && corruptionLevel <= ending.threshold[1]) {
      return { ...ending, key };
    }
  }
  return CORRUPTION_ENDINGS.pure;
};

// Get character epilogue based on story choices
const getCharacterEpilogue = (characterKey, storyChoices = {}) => {
  const epilogues = CHARACTER_EPILOGUES[characterKey];
  if (!epilogues) return null;
  
  // Check for special epilogues based on story flags
  for (const [flagKey, epilogue] of Object.entries(epilogues)) {
    if (flagKey !== 'default' && storyChoices[flagKey]) {
      return epilogue;
    }
  }
  
  return epilogues.default;
};

// Lore-accurate Middle-earth Location Backgrounds
const BATTLE_LOCATIONS = {
  // Act 1 Locations
  shire: {
    name: "The Shire",
    description: "Rolling green hills and peaceful farmland",
    atmosphere: "peaceful_corrupted",
    gradient: "linear-gradient(180deg, #87CEEB 0%, #90EE90 50%, #228B22 100%)",
    overlayColor: "rgba(139, 69, 19, 0.1)",
    enemyTypes: ['goblin'],
    quote: "\"In a hole in the ground there lived a hobbit.\""
  },
  bree: {
    name: "The Village of Bree",
    description: "A crossroads town where strange folk gather",
    atmosphere: "suspicious",
    gradient: "linear-gradient(180deg, #2F4F4F 0%, #4A4A4A 50%, #2C1810 100%)",
    overlayColor: "rgba(139, 90, 43, 0.2)",
    enemyTypes: ['goblin', 'orc'],
    quote: "\"What's that? A Ranger! Dangerous folk they are.\""
  },
  weathertop: {
    name: "Amon SÃ»l - Weathertop",
    description: "Ancient watchtower, now a ruin haunted by shadows",
    atmosphere: "ominous",
    gradient: "linear-gradient(180deg, #1a1a2e 0%, #4a4a5a 50%, #2d2d3d 100%)",
    overlayColor: "rgba(100, 0, 100, 0.15)",
    enemyTypes: ['nazgul'],
    quote: "\"They were once Men. Great kings of Men. Then Sauron gave them Nine Rings.\""
  },
  misty_mountains: {
    name: "The Misty Mountains",
    description: "Treacherous peaks where goblins dwell",
    atmosphere: "dangerous",
    gradient: "linear-gradient(180deg, #4A5568 0%, #718096 30%, #2D3748 70%, #1A202C 100%)",
    overlayColor: "rgba(100, 100, 120, 0.2)",
    enemyTypes: ['goblin', 'orc', 'warg'],
    quote: "\"The mountains are treacherous. Even their paths are deceiving.\""
  },
  rivendell: {
    name: "Rivendell - The Last Homely House",
    description: "Elrond's sanctuary, where weary travelers find rest",
    atmosphere: "sanctuary",
    gradient: "linear-gradient(180deg, #E6F3FF 0%, #B8D4E8 30%, #7BA3C4 70%, #3D6B8C 100%)",
    overlayColor: "rgba(212, 175, 55, 0.1)",
    enemyTypes: [],
    quote: "\"His house was perfect, whether you liked food, or sleep, or work.\""
  },
  moria_gates: {
    name: "The Doors of Durin",
    description: "Ancient Dwarf gates concealing darkness within",
    atmosphere: "foreboding",
    gradient: "linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 50%, #0a0a0a 100%)",
    overlayColor: "rgba(50, 50, 80, 0.3)",
    enemyTypes: ['goblin', 'orc', 'caveTroll'],
    quote: "\"Speak, friend, and enter.\""
  },
  moria_depths: {
    name: "The Mines of Moria",
    description: "Endless dark halls, filled with the drums of the deep",
    atmosphere: "oppressive",
    gradient: "linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 50%, #0a0505 100%)",
    overlayColor: "rgba(255, 50, 0, 0.1)",
    enemyTypes: ['goblin', 'orc', 'caveTroll'],
    quote: "\"They are coming. We cannot get out.\""
  },
  bridge_khazad_dum: {
    name: "The Bridge of Khazad-dÃ»m",
    description: "A narrow span over bottomless darkness",
    atmosphere: "apocalyptic",
    gradient: "linear-gradient(180deg, #1a0a00 0%, #3a1a0a 30%, #5a2a0a 60%, #1a0a00 100%)",
    overlayColor: "rgba(255, 100, 0, 0.2)",
    enemyTypes: ['balrog'],
    quote: "\"I am a servant of the Secret Fire, wielder of the flame of Anor!\""
  },
  
  // Act 2 Locations
  lothlorien: {
    name: "LothlÃ³rien - The Golden Wood",
    description: "Enchanted forest of the Lady Galadriel",
    atmosphere: "mystical",
    gradient: "linear-gradient(180deg, #F4E4BC 0%, #D4AF37 30%, #90EE90 70%, #228B22 100%)",
    overlayColor: "rgba(255, 215, 0, 0.1)",
    enemyTypes: [],
    quote: "\"The Lady of the Wood is no witch! She wears a ring, yes, but...\""
  },
  fangorn: {
    name: "Fangorn Forest",
    description: "Ancient woods where the trees themselves walk",
    atmosphere: "ancient",
    gradient: "linear-gradient(180deg, #1a2f0a 0%, #2d4a1a 50%, #0a1a05 100%)",
    overlayColor: "rgba(0, 100, 0, 0.2)",
    enemyTypes: ['orc', 'urukhai'],
    quote: "\"A wizard should know better!\""
  },
  edoras: {
    name: "Edoras - Hall of the Kings",
    description: "Golden hall of the Rohirrim, atop a great hill",
    atmosphere: "proud",
    gradient: "linear-gradient(180deg, #87CEEB 0%, #D4AF37 40%, #8B7355 70%, #4A3728 100%)",
    overlayColor: "rgba(212, 175, 55, 0.15)",
    enemyTypes: ['urukhai', 'wildMan'],
    quote: "\"Hail, ThÃ©oden King!\""
  },
  helms_deep: {
    name: "Helm's Deep",
    description: "The great fortress of Rohan, besieged by Saruman's army",
    atmosphere: "desperate",
    gradient: "linear-gradient(180deg, #1a1a2a 0%, #3a3a4a 30%, #4a4a5a 60%, #2a2a3a 100%)",
    overlayColor: "rgba(100, 100, 150, 0.2)",
    enemyTypes: ['urukhai', 'berserkerOrc'],
    quote: "\"So it begins.\""
  },
  isengard_flooded: {
    name: "Isengard",
    description: "Saruman's fortress, now flooded by the Ents",
    atmosphere: "ruined",
    gradient: "linear-gradient(180deg, #2F4F4F 0%, #4A6A6A 40%, #3D5C5C 70%, #1A2F2F 100%)",
    overlayColor: "rgba(0, 100, 100, 0.15)",
    enemyTypes: ['urukhai'],
    quote: "\"A wizard should know better than to keep such company.\""
  },
  orthanc: {
    name: "Orthanc - Tower of the Hand",
    description: "Saruman's black tower of unbreakable stone",
    atmosphere: "corrupted",
    gradient: "linear-gradient(180deg, #0a0a0a 0%, #2a2a2a 50%, #1a1a1a 100%)",
    overlayColor: "rgba(150, 150, 150, 0.1)",
    enemyTypes: ['saruman'],
    quote: "\"There was a time when Saruman would walk in my woods.\""
  },
  
  // Act 3 Locations
  minas_tirith: {
    name: "Minas Tirith - The White City",
    description: "Capital of Gondor, city of seven levels",
    atmosphere: "majestic",
    gradient: "linear-gradient(180deg, #E8E8E8 0%, #C0C0C0 30%, #808080 60%, #404040 100%)",
    overlayColor: "rgba(255, 255, 255, 0.1)",
    enemyTypes: [],
    quote: "\"The Tree! It has flowered!\""
  },
  pelennor_fields: {
    name: "The Pelennor Fields",
    description: "The great plain before Minas Tirith, site of the decisive battle",
    atmosphere: "epic",
    gradient: "linear-gradient(180deg, #4A3728 0%, #6B4423 30%, #8B5A2B 50%, #4A3728 100%)",
    overlayColor: "rgba(200, 100, 50, 0.15)",
    enemyTypes: ['mordorOrc', 'haradrim', 'nazgul'],
    quote: "\"Ride now! Ride for ruin and the world's ending!\""
  },
  minas_morgul: {
    name: "Minas Morgul - Tower of Sorcery",
    description: "The haunted city of the Witch-king, glowing with pale evil light",
    atmosphere: "dreadful",
    gradient: "linear-gradient(180deg, #1a3a2a 0%, #0a4a3a 50%, #002a1a 100%)",
    overlayColor: "rgba(0, 255, 100, 0.1)",
    enemyTypes: ['nazgul', 'witchKing'],
    quote: "\"They've taken the bridge and the second hall.\""
  },
  cirith_ungol: {
    name: "Cirith Ungol - The Spider's Pass",
    description: "Dark tunnel lair of the ancient spider Shelob",
    atmosphere: "horrific",
    gradient: "linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 50%, #050505 100%)",
    overlayColor: "rgba(100, 0, 100, 0.2)",
    enemyTypes: ['shelob', 'mordorOrc'],
    quote: "\"She's always hungry.\""
  },
  black_gate: {
    name: "The Black Gate of Mordor",
    description: "Morannonâthe impenetrable gates of the Dark Land",
    atmosphere: "final",
    gradient: "linear-gradient(180deg, #1a0a0a 0%, #3a1a0a 30%, #2a0a05 60%, #0a0505 100%)",
    overlayColor: "rgba(255, 50, 0, 0.15)",
    enemyTypes: ['mordorOrc', 'mouthofsauron', 'sauron'],
    quote: "\"Let the Lord of the Black Land come forth!\""
  },
  mount_doom: {
    name: "Mount Doom - Orodruin",
    description: "The fiery mountain where the One Ring must be destroyed",
    atmosphere: "climactic",
    gradient: "linear-gradient(180deg, #3a0a00 0%, #8a2a00 30%, #ca4a00 50%, #5a1a00 80%, #1a0a00 100%)",
    overlayColor: "rgba(255, 150, 0, 0.2)",
    enemyTypes: ['sauron'],
    quote: "\"Cast it into the fire! Destroy it!\""
  },
  barad_dur: {
    name: "Barad-dÃ»r - The Dark Tower",
    description: "Sauron's fortress, crowned with the lidless Eye",
    atmosphere: "ultimate_evil",
    gradient: "linear-gradient(180deg, #0a0505 0%, #1a0a0a 30%, #2a1a0a 50%, #0a0505 100%)",
    overlayColor: "rgba(255, 100, 0, 0.1)",
    enemyTypes: ['sauron'],
    quote: "\"I see you.\""
  }
};

// Map encounters to locations
const ENCOUNTER_LOCATIONS = {
  // Act 1
  goblin: 'misty_mountains',
  goblinArcher: 'misty_mountains',
  orc: 'moria_gates',
  warg: 'bree',
  wargRider: 'weathertop',
  caveTroll: 'moria_depths',
  balrog: 'bridge_khazad_dum',
  
  // Act 2
  urukhai: 'helms_deep',
  urukhaiBerserker: 'helms_deep',
  urukScout: 'fangorn',
  urukShieldbearer: 'helms_deep',
  wildMan: 'edoras',
  berserkerOrc: 'helms_deep',
  spikedTroll: 'isengard_flooded',
  wargChieftain: 'fangorn',
  urukCaptain: 'helms_deep',
  saruman: 'orthanc',
  
  // Act 3
  mordorOrc: 'black_gate',
  haradrim: 'pelennor_fields',
  nazgul: 'minas_morgul',
  orcChampion: 'pelennor_fields',
  shelob: 'cirith_ungol',
  gothmog: 'pelennor_fields',
  mouthofsauron: 'black_gate',
  witchKing: 'minas_morgul',
  sauron: 'barad_dur'
};

// Helper function to get location for current enemy
const getBattleLocation = (enemyType) => {
  const locationKey = ENCOUNTER_LOCATIONS[enemyType] || 'misty_mountains';
  return BATTLE_LOCATIONS[locationKey] || BATTLE_LOCATIONS.misty_mountains;
};

// Helper to check for story beat triggers
const checkStoryBeat = (currentState) => {
  const { act, encounterIndex, trigger, bossDefeated } = currentState;
  
  for (const [beatId, beat] of Object.entries(STORY_BEATS)) {
    if (beat.act !== act) continue;
    
    if (beat.trigger === trigger) {
      if (beat.trigger === 'encounter' && beat.encounterIndex === encounterIndex) {
        return { beatId, beat };
      }
      if (beat.trigger === 'act_start' || beat.trigger === 'boss_defeated') {
        return { beatId, beat };
      }
    }
  }
  return null;
};

// Helper to get unlocked backstory reveals
const getUnlockedBackstories = (characterKey, milestones) => {
  const characterBackstory = CHARACTER_BACKSTORIES[characterKey];
  if (!characterBackstory) return [];
  
  return characterBackstory.reveals.filter(reveal => 
    milestones.includes(reveal.milestone)
  );
};

// Helper to check backstory milestone triggers
const checkBackstoryMilestone = (characterKey, milestones, newMilestone) => {
  const characterBackstory = CHARACTER_BACKSTORIES[characterKey];
  if (!characterBackstory || milestones.includes(newMilestone)) return null;
  
  const reveal = characterBackstory.reveals.find(r => r.milestone === newMilestone);
  return reveal || null;
};

// Get available fellowship dialogue based on game state
const getAvailableDialogue = (triggerType, gameState) => {
  const dialogues = [];
  
  for (const [dialogueId, dialogue] of Object.entries(FELLOWSHIP_DIALOGUES)) {
    if (dialogue.trigger !== triggerType) continue;
    if (!dialogue.actAvailable.includes(gameState.currentAct)) continue;
    
    // Check specific conditions
    if (dialogue.trigger === 'low_hp' && gameState.hpPercent > dialogue.hpThreshold) continue;
    
    dialogues.push({ dialogueId, dialogue });
  }
  
  return dialogues.length > 0 ? dialogues[Math.floor(Math.random() * dialogues.length)] : null;
};

// Act 1: Fellowship of the Ring - 13 encounters
const ACT_1_ENCOUNTERS = [
  { type: 'combat', enemyTier: 1, tier: 'regular', reward: { gold: 15, cardChoices: 3 } },
  { type: 'combat', multiEnemy: 'goblinAmbush', tier: 'regular', reward: { gold: 20, cardChoices: 3 } }, // US-001: Multi-enemy
  { type: 'event', event: 'bree' },
  { type: 'combat', enemyTier: 1, tier: 'regular', reward: { gold: 20, cardChoices: 3 } },
  { type: 'rest' },
  { type: 'combat', enemyTier: 2, tier: 'regular', reward: { gold: 20, cardChoices: 3 } },
  { type: 'combat', multiEnemy: 'archerDuo', tier: 'regular', reward: { gold: 22, cardChoices: 3 } }, // US-001: Multi-enemy
  { type: 'shop' },
  { type: 'combat', enemyTier: 1, tier: 'elite', reward: { gold: 65, cardChoices: 3, relic: true } },
  { type: 'event', event: 'rivendell' },
  { type: 'combat', enemyTier: 2, tier: 'regular', reward: { gold: 22, cardChoices: 3 } },
  { type: 'rest' },
  { type: 'combat', enemyTier: 2, tier: 'elite', reward: { gold: 75, cardChoices: 3, relic: true } },
  { type: 'shop' },
  { type: 'combat', enemy: 'balrog', tier: 'boss', reward: { gold: 100, cardChoices: 3, relic: true } }
];

// Act 2: The Two Towers - 14 encounters
const ACT_2_ENCOUNTERS = [
  { type: 'combat', enemyTier: 3, tier: 'regular', reward: { gold: 25, cardChoices: 3 } },
  { type: 'combat', multiEnemy: 'orcRaiders', tier: 'regular', reward: { gold: 28, cardChoices: 3 } }, // US-001
  { type: 'event', event: 'lothlorien' },
  { type: 'combat', enemyTier: 3, tier: 'regular', reward: { gold: 24, cardChoices: 3 } },
  { type: 'rest' },
  { type: 'combat', multiEnemy: 'wargPack', tier: 'regular', reward: { gold: 30, cardChoices: 3 } }, // US-001
  { type: 'shop' },
  { type: 'combat', multiEnemy: 'urukPatrol', tier: 'elite', reward: { gold: 85, cardChoices: 3, relic: true } }, // US-001
  { type: 'event', event: 'edoras' },
  { type: 'combat', enemyTier: 4, tier: 'regular', reward: { gold: 28, cardChoices: 3 } },
  { type: 'combat', enemyTier: 4, tier: 'regular', reward: { gold: 30, cardChoices: 3 } },
  { type: 'rest' },
  { type: 'combat', enemyTier: 4, tier: 'elite', reward: { gold: 85, cardChoices: 3, relic: true } },
  { type: 'shop' },
  { type: 'rest' },
  { type: 'combat', enemy: 'saruman', tier: 'boss', reward: { gold: 100, cardChoices: 3, relic: true } }
];

// Act 3: Return of the King - 15 encounters
const ACT_3_ENCOUNTERS = [
  { type: 'combat', enemyTier: 5, tier: 'regular', reward: { gold: 30, cardChoices: 3 } },
  { type: 'combat', multiEnemy: 'mordorSquad', tier: 'regular', reward: { gold: 38, cardChoices: 3 } }, // US-001
  { type: 'event', event: 'minasTirith' },
  { type: 'combat', enemyTier: 6, tier: 'regular', reward: { gold: 35, cardChoices: 3 } },
  { type: 'rest' },
  { type: 'combat', multiEnemy: 'haradrimArchers', tier: 'regular', reward: { gold: 40, cardChoices: 3 } }, // US-001
  { type: 'shop' },
  { type: 'combat', multiEnemy: 'nazgulPair', tier: 'elite', reward: { gold: 100, cardChoices: 3, relic: true } }, // US-001
  { type: 'combat', enemyTier: 5, tier: 'regular', reward: { gold: 32, cardChoices: 3 } },
  { type: 'combat', enemyTier: 5, tier: 'regular', reward: { gold: 34, cardChoices: 3 } },
  { type: 'rest' },
  { type: 'combat', enemyTier: 5, tier: 'elite', reward: { gold: 90, cardChoices: 3, relic: true } },
  { type: 'combat', multiEnemy: 'finalHorde', tier: 'elite', reward: { gold: 110, cardChoices: 3, relic: true } }, // US-001
  { type: 'shop' },
  { type: 'combat', enemyTier: 6, tier: 'elite', reward: { gold: 100, cardChoices: 3, relic: true } },
  { type: 'combat', enemy: 'sauron', tier: 'boss', reward: { gold: 100, cardChoices: 3, relic: true } }
];

// Combined encounters with act markers
const ENCOUNTERS = [
  // Act 1
  ...ACT_1_ENCOUNTERS.map((e, i) => ({ ...e, act: 1, actIndex: i })),
  // Act 2
  ...ACT_2_ENCOUNTERS.map((e, i) => ({ ...e, act: 2, actIndex: i })),
  // Act 3
  ...ACT_3_ENCOUNTERS.map((e, i) => ({ ...e, act: 3, actIndex: i }))
];

// Helper to get current act
const getCurrentAct = (encounterIndex) => {
  const act1End = ACT_1_ENCOUNTERS.length;
  const act2End = act1End + ACT_2_ENCOUNTERS.length;
  
  if (encounterIndex < act1End) return 1;
  if (encounterIndex < act2End) return 2;
  return 3;
};

// Get character-specific encounter override
const getCharacterEncounter = (encounterIndex, characterKey, baseEncounter) => {
  // Index 2 is the first event (Bree for Aragorn, others have different locations)
  const startingEventIndex = 2;
  
  // Swap starting location based on character
  if (encounterIndex === startingEventIndex && baseEncounter.type === 'event' && baseEncounter.event === 'bree') {
    if (characterKey === 'gandalf') {
      return { ...baseEncounter, event: 'isengard' };
    }
    if (characterKey === 'gimli') {
      return { ...baseEncounter, event: 'erebor' };
    }
    if (characterKey === 'legolas') {
      return { ...baseEncounter, event: 'mirkwood' };
    }
    // Aragorn keeps Bree
  }
  
  // Index 8 is the elite combat before Rivendell (encounter 9 is Rivendell)
  const weathertopIndex = 8;
  
  if (encounterIndex === weathertopIndex && characterKey === 'aragorn') {
    // Aragorn faces Weathertop - 2 NazgÃ»l, only need to defeat one
    return {
      ...baseEncounter,
      type: 'combat',
      multiEnemy: 'weathertop',
      tier: 'elite',
      reward: { gold: 65, cardChoices: 3, relic: true }
    };
  }
  
  // Gandalf faces nerfed Saruman before Rivendell
  if (encounterIndex === weathertopIndex && characterKey === 'gandalf') {
    return {
      ...baseEncounter,
      type: 'combat',
      enemy: 'sarumanNerfed',
      tier: 'elite',
      reward: { gold: 65, cardChoices: 3, relic: true }
    };
  }
  
  return baseEncounter;
};

// Helper to get act start index
const getActStartIndex = (act) => {
  if (act === 1) return 0;
  if (act === 2) return ACT_1_ENCOUNTERS.length;
  return ACT_1_ENCOUNTERS.length + ACT_2_ENCOUNTERS.length;
};

// Check if encounter is an act boss
const isActBoss = (encounterIndex) => {
  const act1BossIndex = ACT_1_ENCOUNTERS.length - 1;
  const act2BossIndex = ACT_1_ENCOUNTERS.length + ACT_2_ENCOUNTERS.length - 1;
  const act3BossIndex = ENCOUNTERS.length - 1;
  
  return encounterIndex === act1BossIndex || 
         encounterIndex === act2BossIndex || 
         encounterIndex === act3BossIndex;
};

const ENCOUNTERS_OLD = [
  { enemy: 'goblin', reward: { gold: 20, cardChoices: 3 } },
  { enemy: 'orc', reward: { gold: 25, cardChoices: 3 } },
  { enemy: 'urukhai', reward: { gold: 35, cardChoices: 3 } },
  { enemy: 'gothmog', reward: { gold: 40, cardChoices: 3 } },
  { enemy: 'mouthofsauron', reward: { gold: 45, cardChoices: 3 } },
  { enemy: 'nazgul', reward: { gold: 50, cardChoices: 3 } },
  { enemy: 'saruman', reward: { gold: 60, cardChoices: 3 } },
  { enemy: 'balrog', reward: { gold: 100, cardChoices: 3 } }
];



// ============================================
// CARD UPGRADE DEFINITIONS
// ============================================


// ============================================
// RELICS SYSTEM
// ============================================
const RELICS = {
  // === STARTER RELICS (Character-specific starting choices) ===
  // Aragorn starter relics
  burning_blood: {
    name: 'Burning Blood',
    description: 'At the start of combat, gain 2 Strength',
    icon: 'ð©¸',
    rarity: 'starter',
    effect: { startStrength: 2 }
  },
  rangers_mark: {
    name: "Ranger's Mark",
    description: 'Enemies start with 1 Vulnerable',
    icon: 'ð¯',
    rarity: 'starter',
    effect: { enemyStartVulnerable: 1 }
  },
  dunedain_sigil: {
    name: 'DÃºnedain Sigil',
    description: 'Gain 10 Block at the start of combat',
    icon: 'ð¡ï¸',
    rarity: 'starter',
    effect: { startBlock: 10 }
  },
  // Legolas starter relics
  snecko_eye: {
    name: 'Snecko Eye',
    description: 'Draw 2 additional cards each turn. Cards cost random 0-3.',
    icon: 'ð',
    rarity: 'starter',
    effect: { bonusDraw: 2, randomizeCosts: true }
  },
  mirkwood_bow: {
    name: 'Mirkwood Bow',
    description: '+3 damage to all attacks',
    icon: 'ð¹',
    rarity: 'starter',
    effect: { bonusDamage: 3 }
  },
  elven_boots: {
    name: 'Elven Boots',
    description: 'At the start of combat, gain 2 Dexterity',
    icon: 'ð',
    rarity: 'starter',
    effect: { startDexterity: 2 }
  },
  // Gandalf starter relics
  volcanic_egg: {
    name: 'Volcanic Egg',
    description: 'All attacks apply 3 Burn',
    icon: 'ð¥',
    rarity: 'starter',
    effect: { attackBurn: 3 }
  },
  ancient_tome: {
    name: 'Ancient Tome',
    description: 'Draw 1 additional card each turn',
    icon: 'ð',
    rarity: 'starter',
    effect: { bonusDraw: 1 }
  },
  narya_spark: {
    name: 'Spark of Narya',
    description: 'Gain 1 additional Energy each turn',
    icon: 'ð¥',
    rarity: 'starter',
    effect: { bonusEnergy: 1 }
  },
  // Gimli starter relics
  red_skull: {
    name: 'Red Skull',
    description: 'Deal 6 damage at the start of combat. Gain 1 Strength.',
    icon: 'ð',
    rarity: 'starter',
    effect: { startDamage: 6, startStrength: 1 }
  },
  paper_crane: {
    name: 'Paper Crane',
    description: 'Gain 5 Block and 5 HP at the end of each combat',
    icon: 'ð¦¢',
    rarity: 'starter',
    effect: { combatHeal: 5, combatBlock: 5 }
  },
  golden_idol: {
    name: 'Golden Idol',
    description: 'Gain 25% more gold from all sources',
    icon: 'ð¿',
    rarity: 'starter',
    effect: { goldMultiplier: 1.25 }
  },
  // === COMMON (15) ===
  evenstar: {
    name: 'Evenstar',
    description: 'Start each combat with 5 block',
    icon: 'ð',
    rarity: 'common',
    effect: { startBlock: 5 }
  },
  sting: {
    name: 'Sting',
    description: '+2 damage to all attacks',
    icon: 'ð¡ï¸',
    rarity: 'common',
    effect: { bonusDamage: 2 }
  },
  mithril: {
    name: 'Mithril Coat',
    description: 'Take 1 less damage from all attacks',
    icon: 'ð¡ï¸',
    rarity: 'common',
    effect: { damageReduction: 1 }
  },
  elven_bread: {
    name: 'Elven Bread',
    description: 'Heal 3 HP at the end of each combat',
    icon: 'ð',
    rarity: 'common',
    effect: { combatHeal: 3 }
  },
  dwarf_ring: {
    name: 'Dwarf Ring',
    description: '+5 max HP',
    icon: 'ð',
    rarity: 'common',
    effect: { bonusMaxHp: 5 }
  },
  pipe: {
    name: "Bilbo's Pipe",
    description: 'Draw 1 additional card on turn 1',
    icon: 'ð¬',
    rarity: 'common',
    effect: { firstTurnDraw: 1 }
  },
  walking_stick: {
    name: 'Walking Stick',
    description: 'Gain 1 energy on turn 1',
    icon: 'ð¦¯',
    rarity: 'common',
    effect: { firstTurnEnergy: 1 }
  },
  ranger_cloak: {
    name: 'Ranger Cloak',
    description: 'Start combat with 3 block',
    icon: 'ð§¥',
    rarity: 'common',
    effect: { startBlock: 3 }
  },
  hobbit_feet: {
    name: 'Hobbit Feet',
    description: '+1 dexterity at the start of combat',
    icon: 'ð¦¶',
    rarity: 'common',
    effect: { startDexterity: 1 }
  },
  rohan_helm: {
    name: 'Rohan Helm',
    description: 'Reduce damage from first attack each combat by 5',
    icon: 'âï¸',
    rarity: 'common',
    effect: { firstHitReduction: 5 }
  },
  gondor_banner: {
    name: 'Gondor Banner',
    description: '+1 strength at the start of combat',
    icon: 'ð´',
    rarity: 'common',
    effect: { startStrength: 1 }
  },
  silver_penny: {
    name: 'Silver Penny',
    description: 'Gain 15 extra gold after each combat',
    icon: 'ðª',
    rarity: 'common',
    effect: { bonusGold: 15 }
  },
  traveler_map: {
    name: "Traveler's Map",
    description: 'Start each combat with 4 block',
    icon: 'ðºï¸',
    rarity: 'common',
    effect: { startBlock: 4 }
  },
  elven_brooch: {
    name: 'Elven Brooch',
    description: 'Heal 2 HP at the end of each combat',
    icon: 'ð¿',
    rarity: 'common',
    effect: { combatHeal: 2 }
  },
  torch: {
    name: 'Moria Torch',
    description: 'Deal 3 damage at the start of combat',
    icon: 'ð¦',
    rarity: 'common',
    effect: { startDamage: 3 }
  },
  
  // === UNCOMMON (10) ===
  phial: {
    name: 'Phial of Galadriel',
    description: 'Draw 1 extra card each turn',
    icon: 'â¨',
    rarity: 'uncommon',
    effect: { bonusDraw: 1 }
  },
  ring_barahir: {
    name: 'Ring of Barahir',
    description: '+1 energy each turn',
    icon: 'ð',
    rarity: 'uncommon',
    effect: { bonusEnergy: 1 }
  },
  elven_cloak: {
    name: 'Elven Cloak',
    description: '+2 dexterity at the start of each combat',
    icon: 'ð§£',
    rarity: 'uncommon',
    effect: { startDexterity: 2 }
  },
  palantir: {
    name: 'PalantÃ­r',
    description: 'See enemy intents 2 turns ahead',
    icon: 'ð®',
    rarity: 'uncommon',
    effect: { foresight: true }
  },
  horn_gondor: {
    name: 'Horn of Gondor',
    description: 'Gain 3 strength at the start of each combat',
    icon: 'ð¯',
    rarity: 'uncommon',
    effect: { startStrength: 3 }
  },
  miruvor: {
    name: 'Miruvor',
    description: 'Heal 5 HP at the end of each combat',
    icon: 'ð§ª',
    rarity: 'uncommon',
    effect: { combatHeal: 5 }
  },
  ent_draught_relic: {
    name: 'Ent Draught',
    description: '+10 max HP',
    icon: 'ð¥¤',
    rarity: 'uncommon',
    effect: { bonusMaxHp: 10 }
  },
  galadriels_gift: {
    name: "Galadriel's Gift",
    description: 'Start each combat with 8 block',
    icon: 'ð',
    rarity: 'uncommon',
    effect: { startBlock: 8 }
  },
  gimlis_axe: {
    name: "Gimli's Axe",
    description: '+3 damage to all attacks',
    icon: 'ðª',
    rarity: 'uncommon',
    effect: { bonusDamage: 3 }
  },
  arwen_grace: {
    name: "Arwen's Grace",
    description: 'Heal 10 HP when entering a rest site',
    icon: 'ð¸',
    rarity: 'uncommon',
    effect: { restHeal: 10 }
  },
  
  // === RARE (5) ===
  narya: {
    name: 'Narya, Ring of Fire',
    description: 'Deal 5 fire damage at the start of each turn',
    icon: 'ð¥',
    rarity: 'rare',
    effect: { turnBurn: 5 }
  },
  nenya: {
    name: 'Nenya, Ring of Water',
    description: 'Gain 5 block at the start of each turn',
    icon: 'ð§',
    rarity: 'rare',
    effect: { turnBlock: 5 }
  },
  vilya: {
    name: 'Vilya, Ring of Air',
    description: 'Draw 1 extra card each turn, +1 energy on turn 1',
    icon: 'ð¨',
    rarity: 'rare',
    effect: { bonusDraw: 1, firstTurnEnergy: 1 }
  },
  white_tree: {
    name: 'White Tree Sapling',
    description: '+20 max HP, heal 5 HP each combat',
    icon: 'ð³',
    rarity: 'rare',
    effect: { bonusMaxHp: 20, combatHeal: 5 }
  },
  silmaril_shard: {
    name: 'Silmaril Shard',
    description: '+5 damage, +5 block, +1 draw each turn',
    icon: 'ð',
    rarity: 'rare',
    effect: { bonusDamage: 5, startBlock: 5, bonusDraw: 1 }
  },
  
  // === LEGENDARY - THE ONE RING ===
  one_ring: {
    name: 'The One Ring',
    description: 'Click to wear: +3 STR, +3 DEX, 25% enemy miss chance. Costs 15 corruption per use. At 100 corruption, you are claimed by shadow.',
    icon: 'ð',
    rarity: 'legendary',
    isOneRing: true,
    activatable: true,
    effect: { 
      onActivate: {
        tempStrength: 3,
        tempDexterity: 3,
        invisibility: true,
        missChance: 25,
        corruptionCost: 15
      }
    }
  },
  
  // === EXPENSIVE SHOP RELICS (Late-game gold sinks) ===
  valinor_blessing: {
    name: 'Blessing of the Valar',
    description: '+2 energy per turn, +30 max HP, heal 10 HP each combat',
    icon: 'ð',
    rarity: 'legendary',
    shopCost: 350,
    effect: { bonusEnergy: 2, bonusMaxHp: 30, combatHeal: 10 }
  },
  numenorean_crown: {
    name: 'Crown of NÃºmenor',
    description: '+3 strength, +3 dexterity, +2 draw per turn',
    icon: 'ð',
    rarity: 'legendary',
    shopCost: 400,
    effect: { startStrength: 3, startDexterity: 3, bonusDraw: 2 }
  },
  flame_anor: {
    name: 'Flame of Anor',
    description: 'All attacks deal +10 damage and apply 5 burn',
    icon: 'ð¥',
    rarity: 'legendary',
    shopCost: 375,
    effect: { bonusDamage: 10, attackBurn: 5 }
  },
  elven_immortality: {
    name: 'Elven Immortality',
    description: 'Once per combat, when you would die, heal to 50% HP instead',
    icon: 'â¨',
    rarity: 'legendary',
    shopCost: 500,
    effect: { deathSave: true, deathSaveHealPercent: 50 }
  },
  light_of_earendil: {
    name: 'Light of EÃ¤rendil',
    description: 'Enemies start with 3 weak and 3 vulnerable. Immune to corruption.',
    icon: 'â­',
    rarity: 'legendary',
    shopCost: 425,
    effect: { enemyStartWeak: 3, enemyStartVulnerable: 3, corruptionImmune: true }
  }
};

// Expensive relics available in Act 2+ shops
const LEGENDARY_SHOP_RELICS = ['valinor_blessing', 'numenorean_crown', 'flame_anor', 'elven_immortality', 'light_of_earendil'];

// ============================================
// US-001: STORY-SPECIFIC RELICS
// Earned through branching dialogue choices
// ============================================
const STORY_RELICS = {
  // Aragorn's story relics
  army_of_dead: {
    name: 'Army of the Dead',
    description: 'Deal 10 damage to all enemies at combat start',
    icon: 'ð»',
    rarity: 'legendary',
    effect: { combatStartAoeDamage: 10 }
  },
  oathbreakers_peace: {
    name: "Oathbreaker's Peace",
    description: '+10% corruption resistance, heal 3 HP per turn',
    icon: 'ðï¸',
    rarity: 'rare',
    effect: { corruptionResist: 10, healPerTurn: 3 }
  },
  
  // Legolas's story relics
  bow_of_galadriel: {
    name: 'Bow of the Galadhrim',
    description: '+4 damage, attacks have 20% chance to hit twice',
    icon: 'ð¹',
    rarity: 'legendary',
    effect: { bonusDamage: 4, doubleHitChance: 20 }
  },
  elven_foresight: {
    name: 'Elven Foresight',
    description: 'See enemy intents for 2 turns ahead, +1 dexterity',
    icon: 'ðï¸',
    rarity: 'rare',
    effect: { startDexterity: 1, foresight: true }
  },
  promise_of_valinor: {
    name: 'Promise of Valinor',
    description: '+20% corruption resistance, immune to fear effects',
    icon: 'âµ',
    rarity: 'rare',
    effect: { corruptionResist: 20, fearImmune: true }
  },
  
  // Gimli's story relics
  galadriel_hair: {
    name: "Galadriel's Hair",
    description: 'Start combat with 15 block, +10% corruption resistance',
    icon: 'â¨',
    rarity: 'legendary',
    effect: { startBlock: 15, corruptionResist: 10 }
  },
  lorien_axe: {
    name: 'Axe of LÃ³rien',
    description: '+3 damage, attacks ignore 5 enemy block',
    icon: 'ðª',
    rarity: 'rare',
    effect: { bonusDamage: 3, ignoreBlock: 5 }
  },
  glittering_oath: {
    name: 'Oath of Aglarond',
    description: '+20 block at combat start, +5 max HP',
    icon: 'ð',
    rarity: 'rare',
    effect: { startBlock: 20, bonusMaxHp: 5 }
  },
  lord_of_caves: {
    name: 'Lord of the Caves',
    description: 'Gain 5 gold per combat, +2 strength',
    icon: 'ð',
    rarity: 'rare',
    effect: { combatGold: 5, startStrength: 2 }
  },
  
  // Gandalf's story relics
  single_purpose: {
    name: 'Single Purpose',
    description: '+3 energy on first turn, +2 card draw on first turn',
    icon: 'ð¯',
    rarity: 'rare',
    effect: { firstTurnEnergy: 3, firstTurnDraw: 2 }
  },
  beyond_death: {
    name: 'Beyond Death',
    description: 'When HP drops below 10, heal 20 HP (once per combat)',
    icon: 'âï¸',
    rarity: 'legendary',
    effect: { deathSave: true, deathSaveHeal: 20 }
  }
};

// ============================================
// US-001: STORY-SPECIFIC CARDS
// Earned through branching dialogue choices
// ============================================
const STORY_CARDS = {
  // Aragorn's story cards
  kings_authority: {
    id: 'kings_authority',
    name: "King's Authority",
    cost: 2,
    damage: 15,
    vulnerable: 2,
    type: 'attack',
    rarity: 'rare',
    description: 'Deal 15 damage. Apply 2 Vulnerable. (Earned by accepting your destiny)'
  },
  rangers_caution: {
    id: 'rangers_caution',
    name: "Ranger's Caution",
    cost: 1,
    block: 10,
    draw: 1,
    type: 'skill',
    rarity: 'rare',
    description: 'Gain 10 Block. Draw 1 card. (Earned through wisdom of doubt)'
  },
  evenstar_blessing: {
    id: 'evenstar_blessing',
    name: "Evenstar's Blessing",
    cost: 1,
    heal: 10,
    block: 8,
    type: 'skill',
    rarity: 'rare',
    description: 'Heal 10 HP. Gain 8 Block. (Earned by choosing love)'
  },
  defiance_of_kings: {
    id: 'defiance_of_kings',
    name: 'Defiance of Kings',
    cost: 3,
    damage: 30,
    exhaust: true,
    type: 'attack',
    rarity: 'legendary',
    description: 'Deal 30 damage. Exhaust. (Earned by defying Sauron)'
  },
  
  // Legolas's story cards
  memory_of_ages: {
    id: 'memory_of_ages',
    name: 'Memory of Ages',
    cost: 1,
    strength: 1,
    dexterity: 1,
    type: 'skill',
    rarity: 'rare',
    description: 'Gain 1 Strength and 1 Dexterity. (Earned by honoring the past)'
  },
  elven_pride: {
    id: 'elven_pride',
    name: 'Elven Pride',
    cost: 1,
    damage: 8,
    dexterity: 1,
    type: 'attack',
    rarity: 'rare',
    description: 'Deal 8 damage. Gain 1 Dexterity. (Earned through Elven superiority)'
  },
  galad_shot: {
    id: 'galad_shot',
    name: 'Galad Shot',
    cost: 2,
    damage: 18,
    type: 'attack',
    rarity: 'legendary',
    description: 'Deal 18 damage. Ignores Block. (From the Bow of Galadriel)'
  },
  sea_longing: {
    id: 'sea_longing',
    name: 'Sea-Longing',
    cost: 0,
    heal: 5,
    draw: 2,
    exhaust: true,
    type: 'skill',
    rarity: 'rare',
    description: 'Heal 5 HP. Draw 2 cards. Exhaust. (The call of Valinor)'
  },
  bond_of_fellowship: {
    id: 'bond_of_fellowship',
    name: 'Bond of Fellowship',
    cost: 2,
    damage: 12,
    block: 12,
    type: 'attack',
    rarity: 'legendary',
    description: 'Deal 12 damage. Gain 12 Block. (Earned through true friendship)'
  },
  competitive_spirit: {
    id: 'competitive_spirit',
    name: 'Competitive Spirit',
    cost: 1,
    damage: 6,
    hits: 2,
    type: 'attack',
    rarity: 'rare',
    description: 'Deal 6 damage twice. (Counting kills with Gimli)'
  },
  
  // Gimli's story cards
  dwarven_fury: {
    id: 'dwarven_fury',
    name: 'Dwarven Fury',
    cost: 2,
    damage: 20,
    strength: 1,
    type: 'attack',
    rarity: 'legendary',
    description: 'Deal 20 damage. Gain 1 Strength. (Fueled by rage)'
  },
  grief_into_strength: {
    id: 'grief_into_strength',
    name: 'Grief Into Strength',
    cost: 1,
    block: 8,
    strength: 1,
    type: 'skill',
    rarity: 'rare',
    description: 'Gain 8 Block and 1 Strength. (Mourning becomes power)'
  },
  dwarven_resilience: {
    id: 'dwarven_resilience',
    name: 'Dwarven Resilience',
    cost: 1,
    block: 12,
    type: 'skill',
    rarity: 'rare',
    description: 'Gain 12 Block. (Dwarves endure)'
  },
  ladys_blessing: {
    id: 'ladys_blessing',
    name: "Lady's Blessing",
    cost: 1,
    heal: 8,
    block: 8,
    type: 'skill',
    rarity: 'legendary',
    description: 'Heal 8 HP. Gain 8 Block. (Galadriel\'s favor)'
  },
  shared_wonder: {
    id: 'shared_wonder',
    name: 'Shared Wonder',
    cost: 1,
    strength: 1,
    dexterity: 1,
    draw: 1,
    type: 'skill',
    rarity: 'rare',
    description: 'Gain 1 STR, 1 DEX. Draw 1. (Beauty shared with a friend)'
  },
  dwarven_ambition: {
    id: 'dwarven_ambition',
    name: 'Dwarven Ambition',
    cost: 2,
    damage: 15,
    block: 10,
    type: 'attack',
    rarity: 'rare',
    description: 'Deal 15 damage. Gain 10 Block. (Building for the future)'
  },
  
  // Gandalf's story cards
  righteous_fury: {
    id: 'righteous_fury',
    name: 'Righteous Fury',
    cost: 2,
    damage: 18,
    burn: 3,
    type: 'attack',
    rarity: 'rare',
    description: 'Deal 18 damage. Apply 3 Burn. (Anger at betrayal)'
  },
  wizards_mercy: {
    id: 'wizards_mercy',
    name: "Wizard's Mercy",
    cost: 1,
    heal: 10,
    weak: 2,
    type: 'skill',
    rarity: 'rare',
    description: 'Heal 10 HP. Apply 2 Weak. (Compassion disarms)'
  },
  secret_fire: {
    id: 'secret_fire',
    name: 'Secret Fire',
    cost: 3,
    damage: 25,
    burn: 5,
    type: 'attack',
    rarity: 'legendary',
    description: 'Deal 25 damage. Apply 5 Burn. (The flame of Anor)'
  },
  shepherds_sacrifice: {
    id: 'shepherds_sacrifice',
    name: "Shepherd's Sacrifice",
    cost: 2,
    block: 25,
    type: 'skill',
    rarity: 'rare',
    description: 'Gain 25 Block. (Protecting those in your care)'
  },
  fearless_end: {
    id: 'fearless_end',
    name: 'Fearless End',
    cost: 2,
    damage: 15,
    block: 15,
    type: 'attack',
    rarity: 'rare',
    description: 'Deal 15 damage. Gain 15 Block. (No fear of death)'
  },
  white_council: {
    id: 'white_council',
    name: 'White Council',
    cost: 3,
    damage: 20,
    vulnerable: 3,
    type: 'attack',
    rarity: 'legendary',
    description: 'Deal 20 damage. Apply 3 Vulnerable. (Power of the White)'
  },
  unchanged_heart: {
    id: 'unchanged_heart',
    name: 'Unchanged Heart',
    cost: 1,
    heal: 12,
    draw: 1,
    type: 'skill',
    rarity: 'rare',
    description: 'Heal 12 HP. Draw 1 card. (Still Gandalf)'
  },
  glimpse_beyond: {
    id: 'glimpse_beyond',
    name: 'Glimpse Beyond',
    cost: 0,
    draw: 3,
    exhaust: true,
    type: 'skill',
    rarity: 'legendary',
    description: 'Draw 3 cards. Exhaust. (Knowledge from beyond death)'
  }
};

// Function to get story card data
const getStoryCard = (cardId) => {
  return STORY_CARDS[cardId] || null;
};

// Function to get story relic data
const getStoryRelic = (relicId) => {
  return STORY_RELICS[relicId] || null;
};

// ============================================
// BOSS RELICS (10 total)
// ============================================
const BOSS_RELICS = {
  // === COMMON (4) ===
  balrog_ember: {
    name: "Balrog's Ember",
    description: 'All attacks apply 2 burn',
    icon: 'ð¥',
    rarity: 'common',
    tier: 'boss',
    effect: { attackBurn: 2 }
  },
  saruman_staff_piece: {
    name: "Saruman's Staff Fragment",
    description: '+2 energy on turn 1',
    icon: 'ðª',
    rarity: 'common',
    tier: 'boss',
    effect: { firstTurnEnergy: 2 }
  },
  morgul_blade_shard: {
    name: 'Morgul Blade Shard',
    description: 'All attacks apply 1 vulnerable',
    icon: 'ð¡ï¸',
    rarity: 'common',
    tier: 'boss',
    effect: { attackVulnerable: 1 }
  },
  enemy_helm: {
    name: 'Conquered Helm',
    description: '+3 strength, +2 dexterity at combat start',
    icon: 'âï¸',
    rarity: 'common',
    tier: 'boss',
    effect: { startStrength: 3, startDexterity: 2 }
  },
  
  // === UNCOMMON (3) ===
  shelob_silk: {
    name: "Shelob's Silk",
    description: 'All attacks apply 3 poison',
    icon: 'ð¸ï¸',
    rarity: 'uncommon',
    tier: 'boss',
    effect: { attackPoison: 3 }
  },
  witch_king_crown: {
    name: "Witch King's Crown",
    description: '+2 energy each turn',
    icon: 'ð',
    rarity: 'uncommon',
    tier: 'boss',
    effect: { bonusEnergy: 2 }
  },
  gothmog_mace: {
    name: "Gothmog's Mace",
    description: '+5 damage to all attacks, +10 max HP',
    icon: 'ð¨',
    rarity: 'uncommon',
    tier: 'boss',
    effect: { bonusDamage: 5, bonusMaxHp: 10 }
  },
  
  // === RARE (2) ===
  grond_hammer: {
    name: 'Grond, Hammer of the Underworld',
    description: '+8 damage to all attacks, enemies start vulnerable',
    icon: 'âï¸',
    rarity: 'rare',
    tier: 'boss',
    effect: { bonusDamage: 8, enemyStartVulnerable: 2 }
  },
  mouth_of_sauron_tongue: {
    name: "Mouth's Silver Tongue",
    description: 'Enemies start with 2 weak and 2 vulnerable',
    icon: 'ð',
    rarity: 'rare',
    tier: 'boss',
    effect: { enemyStartWeak: 2, enemyStartVulnerable: 2 }
  },
  
  // === ULTRA RARE (1) ===
  one_ring: {
    name: 'The One Ring',
    description: '+2 energy per turn, +1 draw per turn, but take 5 damage each turn',
    icon: 'ð',
    rarity: 'ultra_rare',
    tier: 'boss',
    effect: { bonusEnergy: 2, bonusDraw: 1, turnDamage: 5 }
  }
};

// Potions System
const POTIONS = {
  health: {
    name: 'Health Potion',
    description: 'Heal 20 HP',
    icon: 'â¤ï¸',
    effect: { heal: 20 }
  },
  strength: {
    name: 'Strength Potion',
    description: 'Gain 3 Strength for this combat',
    icon: 'ðª',
    effect: { strength: 3 }
  },
  block: {
    name: 'Block Potion',
    description: 'Gain 15 Block',
    icon: 'ð¡ï¸',
    effect: { block: 15 }
  },
  energy: {
    name: 'Energy Potion',
    description: 'Gain 2 Energy',
    icon: 'â¡',
    effect: { energy: 2 }
  },
  fire: {
    name: 'Fire Potion',
    description: 'Deal 20 damage to enemy',
    icon: 'ð¥',
    effect: { damage: 20 }
  },
  dexterity: {
    name: 'Dexterity Potion',
    description: 'Gain 3 Dexterity for this combat',
    icon: 'ð',
    effect: { dexterity: 3 }
  }
};

const getRandomPotion = () => {
  const potionKeys = Object.keys(POTIONS);
  return potionKeys[Math.floor(Math.random() * potionKeys.length)];
};

// ============================================
// EVENT LOCATIONS - Act-specific random events
// ============================================
const EVENT_LOCATIONS = {
  // Act 1 Locations
  bree: {
    name: 'The Prancing Pony - Bree',
    icon: 'ðº',
    act: 1,
    description: 'A cozy inn at the crossroads. Strange folk gather here...',
    events: {
      bad: {
        name: 'Robbed in the Night',
        description: 'Thieves steal from you while you sleep!',
        effect: { gold: -25 },
        message: 'You wake to find 25 gold missing from your pouch!'
      },
      good: {
        name: 'Friendly Traveler',
        description: 'A traveler shares supplies and stories.',
        effect: { heal: 15, gold: 15 },
        message: 'You share a meal and gain 15 HP and 15 gold.'
      },
      great: {
        name: 'Ranger\'s Cache',
        description: 'You discover a hidden ranger supply cache!',
        effect: { heal: 20, gold: 30, relic: true },
        message: 'You find healing supplies, gold, and a mysterious artifact!'
      }
    }
  },
  
  // Gandalf's starting location
  isengard: {
    name: 'Isengard - Tower of Orthanc',
    icon: 'ð¼',
    act: 1,
    description: 'The black tower rises amid the ring of stone. Saruman awaits within...',
    events: {
      bad: {
        name: 'Saruman\'s Deception',
        description: 'The White Wizard\'s words cloud your mind...',
        effect: { gold: -20, damage: 5 },
        message: 'Saruman\'s honeyed words cost you dearly.'
      },
      good: {
        name: 'Library of Orthanc',
        description: 'Ancient lore fills the tower\'s archives.',
        effect: { heal: 10, upgradeRandom: true },
        message: 'You discover useful knowledge in the ancient texts!'
      },
      great: {
        name: 'PalantÃ­r Glimpse',
        description: 'You glimpse through the seeing-stone before Saruman notices!',
        effect: { heal: 25, strength: 1, gold: 25 },
        message: 'The vision reveals enemy weaknesses!'
      }
    }
  },
  
  // Gimli's starting location
  erebor: {
    name: 'Erebor - The Lonely Mountain',
    icon: 'â°ï¸',
    act: 1,
    description: 'Your homeland, reclaimed by your kin. Its forges burn bright.',
    events: {
      bad: {
        name: 'Old Wounds',
        description: 'Memories of the dragon haunt you...',
        effect: { maxHp: -5 },
        message: 'The weight of the past burdens you. Max HP -5.'
      },
      good: {
        name: 'Dwarven Smithy',
        description: 'The forges provide excellent equipment.',
        effect: { heal: 20, gold: 20 },
        message: 'Your kin outfit you well for the journey ahead!'
      },
      great: {
        name: 'ThrÃ³r\'s Armory',
        description: 'You find treasures from the old kingdom!',
        effect: { heal: 30, relic: true, strength: 1 },
        message: 'Ancient dwarven artifacts bolster your strength!'
      }
    }
  },
  
  // Legolas's starting location
  mirkwood: {
    name: 'Mirkwood - Realm of the Wood Elves',
    icon: 'ð²',
    act: 1,
    description: 'The dark forest where your people keep watch against shadow.',
    events: {
      bad: {
        name: 'Spider Venom',
        description: 'Mirkwood\'s creatures leave their mark...',
        effect: { damage: 10 },
        message: 'Giant spider venom burns through you. Take 10 damage.'
      },
      good: {
        name: 'Father\'s Blessing',
        description: 'King Thranduil provides elven provisions.',
        effect: { heal: 20, dexterity: 1 },
        message: 'Your father\'s blessing grants agility and healing!'
      },
      great: {
        name: 'Silvan Armory',
        description: 'The finest elven craftsmanship is yours!',
        effect: { heal: 25, relic: true, dexterity: 1 },
        message: 'Legendary elven equipment enhances your abilities!'
      }
    }
  },
  
  rivendell: {
    name: 'Rivendell - Last Homely House',
    icon: 'ðï¸',
    act: 1,
    description: 'The elven sanctuary offers respite to weary travelers.',
    events: {
      bad: {
        name: 'Dark Visions',
        description: 'Elrond\'s mirror shows troubling futures...',
        effect: { maxHp: -5 },
        message: 'The visions weaken your resolve. Max HP reduced by 5.'
      },
      good: {
        name: 'Elven Healing',
        description: 'The elves tend to your wounds.',
        effect: { heal: 30 },
        message: 'Elven medicine restores 30 HP.'
      },
      great: {
        name: 'Council of Elrond',
        description: 'You are granted elven wisdom and gifts.',
        effect: { heal: 999, upgradeRandom: true, gold: 50 },
        message: 'Full healing, a card upgrade, and 50 gold!'
      }
    }
  },
  // Act 2 Locations
  lothlorien: {
    name: 'LothlÃ³rien - Golden Wood',
    icon: 'ð³',
    act: 2,
    description: 'The enchanted forest of Galadriel holds many secrets.',
    events: {
      bad: {
        name: 'Lost in the Wood',
        description: 'You wander lost, exhausting yourself.',
        effect: { damage: 10 },
        message: 'You take 10 damage from exhaustion before finding your way.'
      },
      good: {
        name: 'Galadriel\'s Blessing',
        description: 'The Lady of Light bestows her favor.',
        effect: { heal: 25, strength: 1 },
        message: 'Gain 25 HP and +1 permanent strength!'
      },
      great: {
        name: 'Mirror of Galadriel',
        description: 'The mirror reveals paths to power.',
        effect: { heal: 999, removeCard: true, relic: true },
        message: 'Full healing, remove a card, and receive a gift!'
      }
    }
  },
  edoras: {
    name: 'Edoras - Hall of Meduseld',
    icon: 'ð°',
    act: 2,
    description: 'The golden hall of Rohan\'s kings stands proud.',
    events: {
      bad: {
        name: 'Wormtongue\'s Poison',
        description: 'Dark whispers weaken your resolve.',
        effect: { maxHp: -8, gold: -20 },
        message: 'Lose 8 max HP and 20 gold to Wormtongue\'s schemes.'
      },
      good: {
        name: 'Rohirrim Training',
        description: 'The horse-lords teach you their ways.',
        effect: { dexterity: 1, gold: 25 },
        message: 'Gain +1 permanent dexterity and 25 gold!'
      },
      great: {
        name: 'ThÃ©oden\'s Armory',
        description: 'The king opens his armory to you.',
        effect: { heal: 20, relic: true, gold: 40 },
        message: 'Gain 20 HP, 40 gold, and a powerful relic!'
      }
    }
  },
  
  // Special Event - The One Ring
  deadMarshes: {
    name: 'The Dead Marshes',
    icon: 'ð',
    act: 2,
    description: 'Treacherous swamps where ancient spirits dwell. Something glimmers beneath the murky water...',
    events: {
      bad: {
        name: 'Gollum\'s Treachery',
        description: 'The creature leads you astray into deeper waters!',
        effect: { damage: 20, maxHp: -5 },
        message: 'You nearly drown in the cursed waters. Take 20 damage and lose 5 max HP!'
      },
      good: {
        name: 'Spirit\'s Warning',
        description: 'A ghostly light guides you safely through.',
        effect: { heal: 15, corruption: -10 },
        message: 'Gain 15 HP and cleanse 10 corruption as ancient spirits guide you.'
      },
      great: {
        name: 'The Precious',
        description: 'In the muck, something golden gleams. A ring of terrible power calls to you...',
        effect: { specificRelic: 'one_ring', corruption: 25 },
        message: 'ð You found THE ONE RING! Its power is immense... but at what cost? (+25 corruption)'
      }
    }
  },
  
  // Act 3 Locations
  minasTirith: {
    name: 'Minas Tirith - White City',
    icon: 'ðï¸',
    act: 3,
    description: 'The great citadel of Gondor prepares for war.',
    events: {
      bad: {
        name: 'Denethor\'s Despair',
        description: 'The Steward\'s madness spreads doubt.',
        effect: { maxHp: -10, damage: 15 },
        message: 'Lose 10 max HP and take 15 damage from the chaos.'
      },
      good: {
        name: 'Gondorian Allies',
        description: 'The soldiers of Gondor rally to your cause.',
        effect: { heal: 30, strength: 1, dexterity: 1 },
        message: 'Gain 30 HP, +1 strength, and +1 dexterity!'
      },
      great: {
        name: 'Blessing of the White Tree',
        description: 'The White Tree blooms in your presence!',
        effect: { heal: 999, maxHp: 15, relic: true, gold: 75 },
        message: 'Full heal, +15 max HP, 75 gold, and a legendary relic!'
      }
    }
  }
};

// Get random event outcome: 20% bad, 55% good, 25% great
const getRandomEventOutcome = () => {
  const roll = Math.random();
  if (roll < 0.20) return 'bad';
  if (roll < 0.75) return 'good';
  return 'great';
};


const hasRelic = (player, relicId) => player?.relics?.includes(relicId);

const getRelicBonus = (player, bonusType) => {
  if (!player?.relics) return 0;
  let bonus = 0;
  player.relics.forEach(relicId => {
    const relic = RELICS[relicId] || BOSS_RELICS[relicId];
    if (relic?.effect?.[bonusType]) {
      bonus += relic.effect[bonusType];
    }
  });
  return bonus;
};

const getRelicRewards = (count = 3, excludeRelics = []) => {
  const relicKeys = Object.keys(RELICS).filter(r => !excludeRelics.includes(r));
  const shuffled = relicKeys.sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
};

const getBossRelicRewards = (count = 3, excludeRelics = []) => {
  const relicKeys = Object.keys(BOSS_RELICS).filter(r => !excludeRelics.includes(r));
  const shuffled = relicKeys.sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
};

// Helper to get relic from either regular or boss relics
const getRelic = (relicId) => RELICS[relicId] || BOSS_RELICS[relicId];

// Helper to calculate corruption gain with resistance (Mithril reduces incoming corruption)
const getCorruptionWithResistance = (amount, player) => {
  if (!player) return amount;
  const mithrilResistance = hasRelic(player, 'mithril') ? CORRUPTION_RESISTANCE_RELICS.mithril.resistance : 0;
  return Math.max(0, amount - mithrilResistance);
};

// ============================================
// R002 - ENHANCED COMBAT MECHANICS
// ============================================

// Elemental Affinities System
// Fire > Nature > Shadow > Light > Fire (rock-paper-scissors)
// Poison is neutral but has synergy with Nature
const ELEMENTS = {
  fire: { name: 'Fire', icon: 'ð¥', strong: 'nature', weak: 'light', color: '#ff6b35' },
  nature: { name: 'Nature', icon: 'ð¿', strong: 'shadow', weak: 'fire', color: '#4a9c2d' },
  shadow: { name: 'Shadow', icon: 'ð', strong: 'light', weak: 'nature', color: '#4a0080' },
  light: { name: 'Light', icon: 'â¨', strong: 'fire', weak: 'shadow', color: '#ffd700' },
  poison: { name: 'Poison', icon: 'â ï¸', strong: null, weak: null, color: '#9932cc' }
};

// Element assignments for cards (added to relevant cards)
const CARD_ELEMENTS = {
  // Fire cards (Gandalf primarily)
  fireball: 'fire', flame_wave: 'fire', inferno: 'fire', fire_spark: 'fire',
  flame_touch: 'fire', flame_burst: 'fire', flame_jet: 'fire', fire_bolt: 'fire',
  heat_wave: 'fire', secret_fire: 'fire', flame_of_anor: 'fire', meteor: 'fire',
  conflagration: 'fire', flame_wall: 'fire', you_shall_not_pass: 'fire',
  flame_of_arnor: 'fire', balrog_ember: 'fire',
  // Nature cards (Legolas primarily)
  woodland_stealth: 'nature', woodland_step: 'nature', forest_defense: 'nature',
  silvan_guard: 'nature', woodland_reflexes: 'nature', woodland_ward: 'nature',
  greenwood_shot: 'nature', sylvan_step: 'nature', silvan_shot: 'nature',
  leaf_shield: 'nature', tree_runner: 'nature', lothlorien_blessing: 'nature',
  ent_draught: 'nature', fangorn_strength: 'nature', treebeard_march: 'nature',
  // Shadow cards (Enemy-themed or dark)
  dead_marshes: 'shadow', vanish: 'shadow', shadow_step: 'shadow',
  gollum_trick: 'shadow', one_ring_power: 'shadow',
  // Light cards (Aragorn/Gandalf holy cards)
  white_light: 'light', illuminate: 'light', gandalf_light: 'light',
  blinding_light: 'light', gandalf_white: 'light', gandalf_ascended: 'light',
  valinor_blessing: 'light', evenstar: 'light', phial: 'light',
  kings_return: 'light', heir_of_isildur: 'light', king_elessar: 'light',
  // Poison cards (Legolas)
  poison_shot: 'poison', mirkwood_poison: 'poison', barbed_arrow: 'poison',
  venomous_blade: 'poison', toxic_rain: 'poison'
};

// Enemy element assignments
const ENEMY_ELEMENTS = {
  goblin: 'shadow', orc: 'shadow', warg: 'nature', wargRider: 'nature',
  trollShaman: 'nature', caveTroll: 'nature', spikedTroll: 'nature',
  balrog: 'fire', urukhai: 'shadow', berserkerOrc: 'shadow', wildMan: 'nature',
  wargChieftain: 'nature', urukCaptain: 'shadow', saruman: 'shadow',
  mordorOrc: 'shadow', orcArcher: 'shadow', haradrim: 'fire', oliphaunt: 'nature',
  nazgul: 'shadow', shelob: 'poison', gothmog: 'fire', mouthofsauron: 'shadow',
  witchKing: 'shadow', sauron: 'shadow'
};

// Calculate elemental damage modifier
const getElementalModifier = (cardElement, enemyElement) => {
  if (!cardElement || !enemyElement) return 1.0;
  const element = ELEMENTS[cardElement];
  if (!element) return 1.0;
  
  if (element.strong === enemyElement) return 1.5; // 50% bonus damage
  if (element.weak === enemyElement) return 0.75; // 25% less damage
  return 1.0;
};

// Corruption System
const CORRUPTION_THRESHOLDS = {
  safe: { max: 25, effect: 'none', description: 'You resist the darkness' },
  tempted: { max: 50, effect: 'minor', description: 'The shadow whispers to you' },
  corrupted: { max: 75, effect: 'moderate', description: 'Darkness clouds your mind' },
  consumed: { max: 100, effect: 'severe', description: 'The Eye of Sauron turns upon you' }
};

const getCorruptionLevel = (corruption) => {
  if (corruption <= 25) return 'safe';
  if (corruption <= 50) return 'tempted';
  if (corruption <= 75) return 'corrupted';
  return 'consumed';
};

const getCorruptionEffect = (level) => {
  switch(level) {
    case 'tempted': return { strengthPenalty: 0, maxHpPenalty: 0, drawPenalty: 1, enemyBonusDamage: 2, description: 'Whispers cloud your mind (-1 draw, enemies +2 damage)' };
    case 'corrupted': return { strengthPenalty: 1, maxHpPenalty: 5, drawPenalty: 1, enemyBonusDamage: 3, description: 'Strength wanes (-1 str, -5 HP, -1 draw, enemies +3 damage)' };
    case 'consumed': return { strengthPenalty: 2, maxHpPenalty: 10, drawPenalty: 2, enemyBonusDamage: 5, description: 'Nearly lost to shadow (-2 str, -10 HP, -2 draw, enemies +5 damage)' };
    default: return { strengthPenalty: 0, maxHpPenalty: 0, drawPenalty: 0, enemyBonusDamage: 0, description: '' };
  }
};

// Corruption sources
const CORRUPTION_SOURCES = {
  elite_defeated: 5,    // Defeating elites corrupts slightly
  boss_defeated: 10,    // Defeating bosses corrupts more
  one_ring_used: 3,     // Using One Ring cards
  shadow_card: 1,       // Playing shadow element cards
  dark_relic: 5,        // Certain relics
  encounter_progress: 1, // Passive corruption as time passes (Frodo's burden grows)
  turn_passed: 0.5      // Small corruption per turn in combat (the Ring weighs heavily)
};

// Corruption removal sources
const CORRUPTION_REMOVAL = {
  rest_site: 10,        // Resting at campfire purifies the spirit
  light_card: 2,        // Playing light element cards cleanses corruption
  healing_event: 15,    // Certain events can cleanse corruption
  pure_relic: 5,        // Relics like Evenstar reduce corruption
  athelas: 5,           // Athelas card has cleansing properties
  lothlorien: 20,       // Lothlorien blessing deeply cleanses
  rivendell: 15         // Rivendell rest provides healing
};

// Cards that cleanse corruption when played
const CORRUPTION_CLEANSING_CARDS = [
  'athelas', 'white_light', 'gandalf_light', 'illuminate', 'blinding_light',
  'gandalf_white', 'gandalf_ascended', 'valinor_blessing', 'lothlorien_blessing',
  'rivendell_rest', 'healing_hands', 'samwise_courage', 'fellowship_bond'
];

// Relics that reduce corruption over time or on acquisition
const CORRUPTION_RESISTANCE_RELICS = {
  evenstar: { reduction: 5, description: 'The light of the Evenstar purifies' },
  phial: { reduction: 3, perCombat: true, description: 'Galadriel\'s light cleanses darkness' },
  mithril: { resistance: 2, description: 'Mithril resists shadow' }
};

// Card Combo System
const CARD_COMBOS = {
  // === MINI-COMBOS (Common cards, easier to achieve) ===
  // Aragorn mini-combos
  ranger_assault: {
    name: 'Ranger Assault',
    cards: ['strike', 'bash'],
    effect: { bonusDamage: 5, vulnerable: 1 },
    description: 'A coordinated attack!'
  },
  defensive_counter: {
    name: 'Defensive Counter',
    cards: ['defend', 'courage'],
    effect: { bonusBlock: 5, strength: 1 },
    description: 'Defense becomes offense!'
  },
  // Legolas mini-combos
  elven_barrage: {
    name: 'Elven Barrage',
    cards: ['arrow', 'multishot'],
    effect: { bonusDamage: 6, bonusHits: 1 },
    description: 'A flurry of arrows!'
  },
  nimble_striker: {
    name: 'Nimble Striker',
    cards: ['dodge', 'quick_shot'],
    effect: { dexterity: 1, draw: 1 },
    description: 'Grace and speed combined!'
  },
  // Gandalf mini-combos
  spark_storm: {
    name: 'Spark Storm',
    cards: ['spark', 'fireball'],
    effect: { bonusDamage: 8, burn: 2 },
    description: 'Magic builds upon magic!'
  },
  wizard_ward: {
    name: 'Wizard Ward',
    cards: ['magic_barrier', 'illuminate'],
    effect: { bonusBlock: 8, draw: 1 },
    description: 'Light shields the wise!'
  },
  // Gimli mini-combos
  dwarven_onslaught: {
    name: 'Dwarven Onslaught',
    cards: ['axe_strike', 'reckless_swing'],
    effect: { bonusDamage: 8, strength: 1 },
    description: 'Axes fly with fury!'
  },
  mountain_wall: {
    name: 'Mountain Wall',
    cards: ['dwarf_guard', 'dwarven_resilience'],
    effect: { bonusBlock: 6, strength: 1 },
    description: 'Sturdy as the mountains!'
  },
  
  // === ADVANCED COMBOS (Rare cards, powerful effects) ===
  // Aragorn combos
  kings_fury: {
    name: "King's Fury",
    cards: ['anduril', 'courage'],
    effect: { bonusDamage: 15, bonusStrength: 2 },
    description: 'AndÃºril blazes with kingly might!'
  },
  dunedain_legacy: {
    name: 'Dunedain Legacy',
    cards: ['rangers_ambush', 'athelas'],
    effect: { heal: 10, vulnerable: 2 },
    description: 'The healing arts of the Dunedain!'
  },
  return_of_king: {
    name: 'Return of the King',
    cards: ['kings_return', 'heir_of_isildur'],
    effect: { bonusBlock: 20, heal: 15 },
    description: 'The true king returns!'
  },
  // Legolas combos
  elven_storm: {
    name: 'Elven Storm',
    cards: ['arrows_rain', 'elven_bow'],
    effect: { bonusDamage: 20, bonusHits: 2 },
    description: 'A storm of elven arrows!'
  },
  mirkwood_hunter: {
    name: 'Mirkwood Hunter',
    cards: ['poison_shot', 'deadly_shot'],
    effect: { bonusDamage: 15, poison: 5 },
    description: 'The deadly precision of Mirkwood!'
  },
  woodland_grace: {
    name: 'Woodland Grace',
    cards: ['woodland_stealth', 'blur'],
    effect: { bonusBlock: 15, dexterity: 3 },
    description: 'Move like the wind through trees!'
  },
  // Gandalf combos
  flame_imperishable: {
    name: 'Flame Imperishable',
    cards: ['fireball', 'you_shall_not_pass'],
    effect: { bonusDamage: 30, burn: 10 },
    description: 'The secret fire of IlÃºvatar!'
  },
  white_council: {
    name: 'White Council',
    cards: ['wizard_staff', 'illuminate'],
    effect: { draw: 3, energy: 2, strength: 2 },
    description: 'The wisdom of the Istari!'
  },
  balrog_slayer: {
    name: 'Balrog Slayer',
    cards: ['you_shall_not_pass', 'white_light'],
    effect: { bonusDamage: 40, heal: 20 },
    description: 'From the lowest dungeon to the highest peak!'
  },
  // Gimli combos
  durin_wrath: {
    name: "Durin's Wrath",
    cards: ['khazad_dum', 'baruk_khazad'],
    effect: { bonusDamage: 25, strength: 3 },
    description: 'The fury of the dwarves!'
  },
  mithril_fortress: {
    name: 'Mithril Fortress',
    cards: ['mithril_armor', 'iron_skin'],
    effect: { bonusBlock: 30, damageReduction: 3 },
    description: 'Impenetrable dwarven defense!'
  },
  orc_bane: {
    name: 'Orc Bane',
    cards: ['orc_slayer', 'battle_fury'],
    effect: { bonusDamage: 20, bonusHits: 3 },
    description: 'Death to all orcs!'
  },
  // Cross-character combos (colorless)
  fellowship_united: {
    name: 'Fellowship United',
    cards: ['fellowship_bond', 'samwise_courage'],
    effect: { strength: 3, dexterity: 3, heal: 15 },
    description: 'The bonds of fellowship strengthen all!'
  },
  eagles_rescue: {
    name: "Eagles' Rescue",
    cards: ['eagles_coming', 'ride_of_rohirrim'],
    effect: { bonusDamage: 30, heal: 20 },
    description: 'Aid comes from unexpected places!'
  }
};

// Track played cards this turn for combo detection
const detectCombos = (playedCardsThisTurn) => {
  const playedIds = playedCardsThisTurn.map(c => c.id);
  const triggeredCombos = [];
  
  Object.entries(CARD_COMBOS).forEach(([comboId, combo]) => {
    const hasAllCards = combo.cards.every(cardId => playedIds.includes(cardId));
    if (hasAllCards) {
      triggeredCombos.push({ id: comboId, ...combo });
    }
  });
  
  return triggeredCombos;
};

// Detect potential combos based on cards in hand and deck
const detectPotentialCombos = (hand, deck, playedCardsThisTurn) => {
  const handIds = hand.map(c => c.id);
  const deckIds = deck.map(c => c.id);
  const playedIds = playedCardsThisTurn.map(c => c.id);
  const allAvailableIds = [...handIds, ...deckIds, ...playedIds];
  
  const potentialCombos = [];
  
  Object.entries(CARD_COMBOS).forEach(([comboId, combo]) => {
    const cardsNeeded = combo.cards;
    const cardsInHand = cardsNeeded.filter(cardId => handIds.includes(cardId));
    const cardsPlayed = cardsNeeded.filter(cardId => playedIds.includes(cardId));
    const cardsInDeck = cardsNeeded.filter(cardId => deckIds.includes(cardId));
    const totalFound = cardsNeeded.filter(cardId => allAvailableIds.includes(cardId));
    
    // Only show combos where we have at least one card
    if (totalFound.length > 0) {
      potentialCombos.push({
        id: comboId,
        name: combo.name,
        description: combo.description,
        cardsNeeded: cardsNeeded,
        cardsInHand: cardsInHand,
        cardsPlayed: cardsPlayed,
        cardsInDeck: cardsInDeck,
        progress: (cardsInHand.length + cardsPlayed.length) + '/' + cardsNeeded.length,
        isComplete: cardsInHand.length + cardsPlayed.length >= cardsNeeded.length,
        canCompleteThisTurn: cardsNeeded.every(cardId => 
          handIds.includes(cardId) || playedIds.includes(cardId)
        )
      });
    }
  });
  
  // Sort by progress (most complete first)
  return potentialCombos.sort((a, b) => {
    const aProgress = a.cardsInHand.length + a.cardsPlayed.length;
    const bProgress = b.cardsInHand.length + b.cardsPlayed.length;
    return bProgress - aProgress;
  }).slice(0, 3); // Show top 3 potential combos
};

// Combo Tracker UI Component
const ComboTracker = memo(({ hand, deck, playedCardsThisTurn }) => {
  const potentialCombos = useMemo(() => 
    detectPotentialCombos(hand || [], deck || [], playedCardsThisTurn || []),
    [hand, deck, playedCardsThisTurn]
  );
  
  if (potentialCombos.length === 0) return null;
  
  return (
    <div style={{
      position: 'absolute',
      top: '10px',
      right: '10px',
      background: 'rgba(0, 0, 0, 0.85)',
      border: '2px solid #ffd700',
      borderRadius: '8px',
      padding: '10px',
      maxWidth: '220px',
      zIndex: 100,
      fontSize: '11px'
    }}>
      <div style={{ 
        color: '#ffd700', 
        fontWeight: 'bold', 
        marginBottom: '8px',
        borderBottom: '1px solid #ffd700',
        paddingBottom: '4px'
      }}>
        âï¸ Combo Tracker
      </div>
      {potentialCombos.map((combo, index) => (
        <div key={combo.id} style={{
          marginBottom: index < potentialCombos.length - 1 ? '8px' : 0,
          padding: '6px',
          background: combo.canCompleteThisTurn ? 'rgba(255, 215, 0, 0.2)' : 'rgba(255, 255, 255, 0.05)',
          borderRadius: '4px',
          border: combo.canCompleteThisTurn ? '1px solid #ffd700' : '1px solid #444'
        }}>
          <div style={{ 
            color: combo.canCompleteThisTurn ? '#ffd700' : '#fff',
            fontWeight: 'bold',
            marginBottom: '2px'
          }}>
            {combo.name} [{combo.progress}]
          </div>
          <div style={{ color: '#aaa', fontSize: '10px', marginBottom: '4px' }}>
            {combo.description}
          </div>
          <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
            {combo.cardsNeeded.map((cardId, idx) => {
              const inHand = combo.cardsInHand.includes(cardId);
              const played = combo.cardsPlayed.includes(cardId);
              const inDeck = combo.cardsInDeck.includes(cardId);
              return (
                <span key={idx} style={{
                  padding: '2px 6px',
                  borderRadius: '3px',
                  fontSize: '9px',
                  background: played ? '#228b22' : inHand ? '#4169e1' : inDeck ? '#555' : '#333',
                  color: played || inHand ? '#fff' : '#888',
                  border: played ? '1px solid #32cd32' : inHand ? '1px solid #6495ed' : '1px solid #666'
                }}>
                  {cardId.replace(/_/g, ' ')}
                  {played && ' â'}
                  {inHand && !played && ' ð'}
                </span>
              );
            })}
          </div>
          {combo.canCompleteThisTurn && (
            <div style={{ 
              color: '#32cd32', 
              fontSize: '10px', 
              marginTop: '4px',
              fontWeight: 'bold'
            }}>
              â¨ Can complete this turn!
            </div>
          )}
        </div>
      ))}
    </div>
  );
});

// Critical Hit System
const CRIT_CHANCE_BASE = 5; // 5% base crit chance
const CRIT_DAMAGE_MULTIPLIER = 1.5; // 50% bonus damage on crit

const calculateCritChance = (card, player, playedCardsThisTurn) => {
  let critChance = CRIT_CHANCE_BASE;
  
  // Bonus crit chance for upgraded cards
  if (card.upgraded) critChance += 5;
  
  // Bonus crit chance from skills
  const skillCritBonus = player.skillBonuses?.critBonus || 0;
  critChance += skillCritBonus;
  
  // Bonus crit chance for same-type card synergy
  const sameTypeCards = playedCardsThisTurn.filter(c => c.type === card.type).length;
  critChance += sameTypeCards * 3;
  
  // Bonus crit chance for elemental synergy
  const cardElement = CARD_ELEMENTS[card.id];
  if (cardElement) {
    const sameElementCards = playedCardsThisTurn.filter(c => CARD_ELEMENTS[c.id] === cardElement).length;
    critChance += sameElementCards * 5;
  }
  
  // Bonus from dexterity
  critChance += (player.dexterity || 0) * 2;
  
  return Math.min(critChance, 50); // Cap at 50%
};

const rollCrit = (critChance) => Math.random() * 100 < critChance;

// Multi-phase boss system
const BOSS_PHASES = {
  balrog: [
    { 
      name: 'Balrog of Morgoth', 
      phase: 1, 
      hpPercent: 100,
      ability: { name: 'Flame Aura', type: 'passive', damageOnHit: 3 },
      intents: [
        { name: 'Flame Whip', type: 'attack', damage: 18 },
        { name: 'Shadow Strike', type: 'attack', damage: 22 },
        { name: 'Infernal Roar', type: 'buff', strength: 3 }
      ]
    },
    { 
      name: 'Balrog Enraged', 
      phase: 2, 
      hpPercent: 50,
      ability: { name: 'Burning Rage', type: 'passive', damageOnHit: 5, bonusDamage: 5 },
      intents: [
        { name: 'Flame Storm', type: 'attack', damage: 25 },
        { name: 'Wing Buffet', type: 'attack', damage: 20, block: 10 },
        { name: 'Summon Fire', type: 'buff', strength: 5 }
      ],
      phaseMessage: 'The Balrog\'s flames burn brighter with rage!'
    }
  ],
  saruman: [
    {
      name: 'Saruman the White',
      phase: 1,
      hpPercent: 100,
      ability: { name: 'Voice of Command', type: 'startTurn', weakPlayer: 1 },
      intents: [
        { name: 'Staff Strike', type: 'attack', damage: 12 },
        { name: 'Dark Speech', type: 'debuff', vulnerable: 2, weak: 2 },
        { name: 'Palantir Gaze', type: 'buff', strength: 2 }
      ]
    },
    {
      name: 'Saruman of Many Colors',
      phase: 2,
      hpPercent: 60,
      ability: { name: 'Sorcery', type: 'passive', reflectDamage: 3 },
      intents: [
        { name: 'Rainbow Blast', type: 'attack', damage: 18 },
        { name: 'Orthanc Fire', type: 'attack', damage: 15, burn: 5 },
        { name: 'Dark Pact', type: 'buff', strength: 4, block: 15 }
      ],
      phaseMessage: 'Saruman reveals his true colors!'
    }
  ],
  witchKing: [
    {
      name: 'Witch-king of Angmar',
      phase: 1,
      hpPercent: 100,
      ability: { name: 'No Man Can Kill Me', type: 'passive', damageReduction: 3 },
      intents: [
        { name: 'Morgul Blade', type: 'attack', damage: 16, corruption: 3 },
        { name: 'Fell Beast Strike', type: 'attack', damage: 20 },
        { name: 'Black Breath', type: 'debuff', weak: 3, vulnerable: 2 }
      ]
    },
    {
      name: 'Lord of the Nazgul',
      phase: 2,
      hpPercent: 40,
      ability: { name: 'Despair', type: 'startTurn', weakPlayer: 2 },
      intents: [
        { name: 'Flaming Sword', type: 'attack', damage: 25, burn: 3 },
        { name: 'Terror', type: 'attack', damage: 18, corruption: 4 },
        { name: 'Dark Command', type: 'buff', strength: 5 }
      ],
      phaseMessage: 'You face the Lord of the Nazgul!'
    }
  ],
  sauron: [
    {
      name: 'The Eye of Sauron',
      phase: 1,
      hpPercent: 100,
      ability: { name: 'All-Seeing Eye', type: 'startTurn', weakPlayer: 1, vulnerablePlayer: 1 },
      intents: [
        { name: 'Gaze of Doom', type: 'attack', damage: 20, corruption: 5 },
        { name: 'Dark Will', type: 'buff', strength: 3 },
        { name: 'Shadow Tendrils', type: 'attack', damage: 15, weak: 2 }
      ]
    },
    {
      name: 'Sauron the Deceiver',
      phase: 2,
      hpPercent: 65,
      ability: { name: 'Malice', type: 'passive', damageOnHit: 5 },
      intents: [
        { name: 'Ring of Power', type: 'attack', damage: 25, corruption: 6 },
        { name: 'Dominate', type: 'debuff', weak: 3, vulnerable: 3, corruption: 3 },
        { name: 'Summon Darkness', type: 'buff', strength: 5, block: 20 }
      ],
      phaseMessage: 'Sauron\'s true form emerges!'
    },
    {
      name: 'The Dark Lord',
      phase: 3,
      hpPercent: 30,
      ability: { name: 'One Ring', type: 'passive', damageOnHit: 8, corruptionPerTurn: 3 },
      intents: [
        { name: 'Annihilation', type: 'attack', damage: 35, corruption: 8 },
        { name: 'Absolute Darkness', type: 'attack', damage: 28, weak: 4, vulnerable: 4 },
        { name: 'Final Form', type: 'buff', strength: 8, block: 30 }
      ],
      phaseMessage: 'THE DARK LORD RISES IN HIS FULL MIGHT!'
    }
  ]
};

// Get current boss phase based on HP percentage
const getBossPhase = (bossType, currentHp, maxHp) => {
  const phases = BOSS_PHASES[bossType];
  if (!phases) return null;
  
  const hpPercent = (currentHp / maxHp) * 100;
  
  // Find the appropriate phase (phases are ordered by hpPercent descending)
  for (let i = phases.length - 1; i >= 0; i--) {
    if (hpPercent <= phases[i].hpPercent) {
      return phases[i];
    }
  }
  return phases[0];
};

// Check if boss should transition to new phase after taking damage
const checkBossPhaseTransition = (enemy, previousHp, currentHp, currentBossPhase) => {
  if (enemy.tier !== 'boss') return null;
  
  // Determine boss type from name
  const bossType = 
    enemy.name?.toLowerCase().includes('balrog') ? 'balrog' :
    enemy.name?.toLowerCase().includes('saruman') ? 'saruman' :
    enemy.name?.toLowerCase().includes('witch') ? 'witchKing' :
    enemy.name?.toLowerCase().includes('sauron') || enemy.name?.toLowerCase().includes('eye') ? 'sauron' : null;
  
  if (!bossType || !BOSS_PHASES[bossType]) return null;
  
  const phases = BOSS_PHASES[bossType];
  const hpPercent = (currentHp / enemy.maxHp) * 100;
  
  // Find which phase we should be in
  let targetPhase = phases[0];
  for (let i = phases.length - 1; i >= 0; i--) {
    if (hpPercent <= phases[i].hpPercent) {
      targetPhase = phases[i];
      break;
    }
  }
  
  // Check if we crossed into a new phase
  if (targetPhase.phase > currentBossPhase) {
    return {
      newPhaseNumber: targetPhase.phase,
      phaseName: targetPhase.name,
      phaseMessage: targetPhase.phaseMessage,
      newAbility: targetPhase.ability,
      newIntents: targetPhase.intents
    };
  }
  
  return null;
};

// Apply new phase data to enemy
const applyBossPhase = (enemy, phaseData) => {
  if (!phaseData) return enemy;
  return {
    ...enemy,
    name: phaseData.phaseName,
    ability: phaseData.newAbility,
    actions: phaseData.newIntents,
    currentPhase: phaseData.newPhaseNumber,
    intent: phaseData.newIntents?.[Math.floor(Math.random() * phaseData.newIntents.length)]
  };
};

// ============================================
// R003 - CHARACTER PROGRESSION SYSTEM
// ============================================

// XP requirements for each level (exponential growth)
const XP_PER_LEVEL = [
  0,      // Level 1 (starting)
  100,    // Level 2
  250,    // Level 3
  450,    // Level 4
  700,    // Level 5
  1000,   // Level 6
  1400,   // Level 7
  1900,   // Level 8
  2500,   // Level 9
  3200    // Level 10 (max)
];

// XP rewards for different actions
const XP_REWARDS = {
  enemy_defeated: 15,
  elite_defeated: 40,
  boss_defeated: 100,
  card_played: 1,
  combo_triggered: 25,
  critical_hit: 5,
  perfect_combat: 50,  // Win without taking damage
  act_completed: 75
};

// Get level from total XP - BULLETPROOF VERSION with inline thresholds
const getLevelFromXP = (totalXP) => {
  // Ensure totalXP is a valid number
  const xp = Math.max(0, Number(totalXP) || 0);
  
  // Debug logging to track the issue
  console.log('[getLevelFromXP] Input:', totalXP, 'Type:', typeof totalXP, 'Normalized XP:', xp);
  
  // Inline thresholds to prevent any array reference issues
  // Level 1: 0 XP, Level 2: 100 XP, Level 3: 250 XP, etc.
  let level;
  if (xp >= 3200) level = 10;
  else if (xp >= 2500) level = 9;
  else if (xp >= 1900) level = 8;
  else if (xp >= 1400) level = 7;
  else if (xp >= 1000) level = 6;
  else if (xp >= 700) level = 5;
  else if (xp >= 450) level = 4;
  else if (xp >= 250) level = 3;
  else if (xp >= 100) level = 2;
  else level = 1;
  
  console.log('[getLevelFromXP] Result: Level', level);
  
  return level;
};

// Get XP needed for next level
const getXPForNextLevel = (currentLevel) => {
  const level = Math.max(1, Math.min(10, Number(currentLevel) || 1));
  if (level >= 10) return 0;
  return XP_PER_LEVEL[level];
};

// Get XP progress percentage to next level
const getXPProgress = (totalXP, currentLevel) => {
  // Ensure inputs are valid numbers
  const xp = Math.max(0, Number(totalXP) || 0);
  const level = Math.max(1, Math.min(10, Number(currentLevel) || 1));
  
  if (level >= 10) return 100;
  const currentLevelXP = XP_PER_LEVEL[level - 1] || 0;
  const nextLevelXP = XP_PER_LEVEL[level] || XP_PER_LEVEL[XP_PER_LEVEL.length - 1];
  const progressXP = xp - currentLevelXP;
  const neededXP = nextLevelXP - currentLevelXP;
  
  if (neededXP <= 0) return 100;
  return Math.max(0, Math.min(100, Math.floor((progressXP / neededXP) * 100)));
};

// Level up bonuses
const LEVEL_BONUSES = {
  2: { maxHp: 3, description: '+3 Max HP' },
  3: { skillPoint: 1, description: 'Skill Point unlocked!' },
  4: { maxHp: 3, startingGold: 25, description: '+3 Max HP, +25 starting gold' },
  5: { skillPoint: 1, legendaryUnlock: true, description: 'Skill Point + Legendary card unlocked!' },
  6: { maxHp: 5, description: '+5 Max HP' },
  7: { skillPoint: 1, description: 'Skill Point unlocked!' },
  8: { maxHp: 5, maxEnergy: 1, startingGold: 50, description: '+5 Max HP, +1 Max Energy, +50 starting gold' },
  9: { skillPoint: 1, legendaryUnlock: true, description: 'Skill Point + Legendary card unlocked!' },
  10: { maxHp: 8, maxEnergy: 1, prestigeUnlock: true, description: 'Max Level! +8 HP, +1 Energy, Prestige mode unlocked!' }
};

// Character-specific legendary cards (unlocked through progression)
const LEGENDARY_CARDS = {
  aragorn: [
    {
      id: 'flame_of_the_west',
      name: 'Flame of the West',
      cost: 4,
      damage: 35,
      strength: 3,
      heal: 15,
      type: 'attack',
      rarity: 'legendary',
      description: 'Deal 35 damage, gain 3 strength, heal 15 HP',
      unlockLevel: 5
    },
    {
      id: 'king_of_gondor',
      name: 'King of Gondor',
      cost: 3,
      block: 25,
      strength: 2,
      dexterity: 2,
      draw: 2,
      type: 'power',
      rarity: 'legendary',
      description: 'Gain 25 block, +2 strength, +2 dexterity, draw 2',
      unlockLevel: 9
    }
  ],
  legolas: [
    {
      id: 'prince_of_greenwood',
      name: 'Prince of Greenwood',
      cost: 3,
      damage: 8,
      hits: 5,
      dexterity: 2,
      type: 'attack',
      rarity: 'legendary',
      description: 'Fire 5 arrows for 8 damage each, gain 2 dexterity',
      unlockLevel: 5
    },
    {
      id: 'eyes_of_the_eldar',
      name: 'Eyes of the Eldar',
      cost: 2,
      draw: 4,
      dexterity: 3,
      vulnerable: 3,
      type: 'skill',
      rarity: 'legendary',
      description: 'Draw 4, gain 3 dexterity, apply 3 vulnerable',
      unlockLevel: 9
    }
  ],
  gandalf: [
    {
      id: 'servant_of_secret_fire',
      name: 'Servant of the Secret Fire',
      cost: 4,
      damage: 40,
      burn: 15,
      energy: 2,
      type: 'attack',
      rarity: 'legendary',
      description: 'Deal 40 damage, apply 15 burn, gain 2 energy',
      unlockLevel: 5
    },
    {
      id: 'wielder_of_narya',
      name: 'Wielder of Narya',
      cost: 3,
      strength: 4,
      heal: 20,
      draw: 3,
      type: 'power',
      rarity: 'legendary',
      description: 'Gain 4 strength, heal 20, draw 3 cards',
      unlockLevel: 9
    }
  ],
  gimli: [
    {
      id: 'lord_of_aglarond',
      name: 'Lord of Aglarond',
      cost: 3,
      damage: 15,
      hits: 3,
      strength: 2,
      type: 'attack',
      rarity: 'legendary',
      description: 'Strike 3 times for 15 damage, gain 2 strength',
      unlockLevel: 5
    },
    {
      id: 'dwarven_warmaster',
      name: 'Dwarven Warmaster',
      cost: 4,
      block: 40,
      strength: 3,
      thorns: 5,
      type: 'skill',
      rarity: 'legendary',
      description: 'Gain 40 block, 3 strength, enemies take 5 damage when attacking',
      unlockLevel: 9
    }
  ]
};

// Skill Trees for each character
const SKILL_TREES = {
  aragorn: {
    name: "Ranger's Path",
    branches: {
      warrior: {
        name: 'Warrior King',
        icon: 'âï¸',
        description: 'Focus on offense and leadership',
        skills: [
          { id: 'ar_w1', name: 'Battle Hardened', cost: 1, effect: { bonusDamage: 2 }, description: '+2 damage to all attacks' },
          { id: 'ar_w2', name: 'Inspiring Presence', cost: 1, effect: { allyStrength: 1 }, description: '+1 strength at combat start', requires: 'ar_w1' },
          { id: 'ar_w3', name: 'AndÃºril Mastery', cost: 2, effect: { critBonus: 10 }, description: '+10% crit chance', requires: 'ar_w2' },
          { id: 'ar_w4', name: 'King\'s Fury', cost: 2, effect: { bonusDamage: 3, comboBonus: true }, description: '+3 damage, enhanced combos', requires: 'ar_w3' }
        ]
      },
      ranger: {
        name: 'Dunedain Ranger',
        icon: 'ð¹',
        description: 'Focus on survival and tactics',
        skills: [
          { id: 'ar_r1', name: 'Wilderness Lore', cost: 1, effect: { healPerCombat: 3 }, description: 'Heal 3 HP after each combat' },
          { id: 'ar_r2', name: 'Athelas Knowledge', cost: 1, effect: { corruptionResist: 2 }, description: '-2 corruption per rest', requires: 'ar_r1' },
          { id: 'ar_r3', name: 'Strider\'s Endurance', cost: 2, effect: { bonusHp: 15 }, description: '+15 max HP', requires: 'ar_r2' },
          { id: 'ar_r4', name: 'Heir of Isildur', cost: 2, effect: { startingBlock: 10, startingStrength: 1 }, description: 'Start combats with 10 block and 1 strength', requires: 'ar_r3' }
        ]
      }
    }
  },
  legolas: {
    name: "Elven Ways",
    branches: {
      archer: {
        name: 'Master Archer',
        icon: 'ð¯',
        description: 'Focus on precision and multi-attacks',
        skills: [
          { id: 'le_a1', name: 'Quick Draw', cost: 1, effect: { extraDraw: 1 }, description: '+1 card draw per turn' },
          { id: 'le_a2', name: 'Precise Shot', cost: 1, effect: { bonusDamage: 1, vulnerable: 1 }, description: '+1 damage, attacks apply 1 vulnerable', requires: 'le_a1' },
          { id: 'le_a3', name: 'Rapid Fire', cost: 2, effect: { bonusHits: 1 }, description: '+1 hit on multi-hit attacks', requires: 'le_a2' },
          { id: 'le_a4', name: 'Eagle Eye', cost: 2, effect: { critBonus: 15, critDamage: 0.5 }, description: '+15% crit, +50% crit damage', requires: 'le_a3' }
        ]
      },
      shadow: {
        name: 'Wood-elf Shadow',
        icon: 'ð',
        description: 'Focus on evasion and poison',
        skills: [
          { id: 'le_s1', name: 'Elven Grace', cost: 1, effect: { bonusDexterity: 1 }, description: '+1 dexterity at combat start' },
          { id: 'le_s2', name: 'Mirkwood Toxins', cost: 1, effect: { poisonBonus: 2 }, description: '+2 poison on poison attacks', requires: 'le_s1' },
          { id: 'le_s3', name: 'Vanishing Step', cost: 2, effect: { dodgeChance: 15 }, description: '15% chance to dodge attacks', requires: 'le_s2' },
          { id: 'le_s4', name: 'Woodland Phantom', cost: 2, effect: { retainBlock: 50 }, description: 'Retain 50% block between turns', requires: 'le_s3' }
        ]
      }
    }
  },
  gandalf: {
    name: "Wizard's Craft",
    branches: {
      fire: {
        name: 'Flame of Anor',
        icon: 'ð¥',
        description: 'Focus on fire magic and damage',
        skills: [
          { id: 'ga_f1', name: 'Inner Fire', cost: 1, effect: { burnBonus: 2 }, description: '+2 burn on fire attacks' },
          { id: 'ga_f2', name: 'Conflagration', cost: 1, effect: { burnDamage: 1 }, description: 'Burn deals +1 damage per stack', requires: 'ga_f1' },
          { id: 'ga_f3', name: 'Flame Wall', cost: 2, effect: { fireReturnDamage: 3 }, description: 'Attackers take 3 fire damage', requires: 'ga_f2' },
          { id: 'ga_f4', name: 'Secret Fire', cost: 2, effect: { bonusDamage: 5, fireImmunity: true }, description: '+5 fire damage, immune to burn', requires: 'ga_f3' }
        ]
      },
      light: {
        name: 'White Light',
        icon: 'â¨',
        description: 'Focus on support and anti-corruption',
        skills: [
          { id: 'ga_l1', name: 'Illumination', cost: 1, effect: { bonusEnergy: 1 }, description: '+1 energy on turn 1' },
          { id: 'ga_l2', name: 'Purifying Light', cost: 1, effect: { corruptionCleanse: 3 }, description: 'Cleanse 3 corruption per combat', requires: 'ga_l1' },
          { id: 'ga_l3', name: 'Maia Blessing', cost: 2, effect: { healPerTurn: 2 }, description: 'Heal 2 HP per turn', requires: 'ga_l2' },
          { id: 'ga_l4', name: 'Gandalf the White', cost: 2, effect: { allStats: 1, lightDamage: 10 }, description: '+1 all stats, light cards deal +10 damage', requires: 'ga_l3' }
        ]
      }
    }
  },
  gimli: {
    name: "Dwarven Arts",
    branches: {
      berserker: {
        name: 'Berserker',
        icon: 'ðª',
        description: 'Focus on raw damage and fury',
        skills: [
          { id: 'gi_b1', name: 'Reckless Fury', cost: 1, effect: { bonusDamage: 3 }, description: '+3 damage to all attacks' },
          { id: 'gi_b2', name: 'Blood Rage', cost: 1, effect: { lowHpDamage: 5 }, description: '+5 damage when below 50% HP', requires: 'gi_b1' },
          { id: 'gi_b3', name: 'Orc Hatred', cost: 2, effect: { shadowDamage: 8 }, description: '+8 damage vs shadow enemies', requires: 'gi_b2' },
          { id: 'gi_b4', name: 'Durin\'s Wrath', cost: 2, effect: { strengthOnKill: 2, noBlock: 5 }, description: '+2 strength per kill, +5 damage if no block', requires: 'gi_b3' }
        ]
      },
      guardian: {
        name: 'Stone Guardian',
        icon: 'ð¡ï¸',
        description: 'Focus on defense and endurance',
        skills: [
          { id: 'gi_g1', name: 'Mithril Skin', cost: 1, effect: { damageReduction: 2 }, description: 'Take 2 less damage from attacks' },
          { id: 'gi_g2', name: 'Dwarven Fortitude', cost: 1, effect: { bonusBlock: 3 }, description: '+3 block from block cards', requires: 'gi_g1' },
          { id: 'gi_g3', name: 'Mountain\'s Resolve', cost: 2, effect: { bonusHp: 20 }, description: '+20 max HP', requires: 'gi_g2' },
          { id: 'gi_g4', name: 'Erebor\'s Shield', cost: 2, effect: { thorns: 4, startingBlock: 15 }, description: 'Start with 15 block, reflect 4 damage', requires: 'gi_g3' }
        ]
      }
    }
  }
};

// Prestige System
const PRESTIGE_LEVELS = [
  { level: 0, name: 'Adventurer', icon: 'ð¡ï¸', bonuses: {} },
  { level: 1, name: 'Hero', icon: 'â­', bonuses: { startingGold: 25, xpMultiplier: 1.1 } },
  { level: 2, name: 'Champion', icon: 'ð', bonuses: { startingGold: 50, xpMultiplier: 1.2, startingRelic: true } },
  { level: 3, name: 'Legend', icon: 'ð', bonuses: { startingGold: 75, xpMultiplier: 1.3, startingRelic: true, bonusCard: true } },
  { level: 4, name: 'Mythic', icon: 'ð', bonuses: { startingGold: 100, xpMultiplier: 1.5, startingRelic: true, bonusCard: true, bonusHp: 10 } },
  { level: 5, name: 'Eternal', icon: 'ð', bonuses: { startingGold: 150, xpMultiplier: 2.0, startingRelic: true, bonusCard: true, bonusHp: 20, startingEnergy: 1 } }
];

// Get prestige level data
const getPrestigeData = (prestigeLevel) => {
  return PRESTIGE_LEVELS[Math.min(prestigeLevel, PRESTIGE_LEVELS.length - 1)];
};

// Calculate prestige requirements (need to complete game at max level)
const canPrestige = (playerData) => {
  return playerData.level >= 10 && playerData.gamesCompleted > 0;
};

// Persistent player data structure (saved to localStorage)
const DEFAULT_PLAYER_PROGRESS = {
  aragorn: { xp: 0, level: 1, skillPoints: 0, unlockedSkills: [], prestigeLevel: 0, gamesCompleted: 0, totalXP: 0 },
  legolas: { xp: 0, level: 1, skillPoints: 0, unlockedSkills: [], prestigeLevel: 0, gamesCompleted: 0, totalXP: 0 },
  gandalf: { xp: 0, level: 1, skillPoints: 0, unlockedSkills: [], prestigeLevel: 0, gamesCompleted: 0, totalXP: 0 },
  gimli: { xp: 0, level: 1, skillPoints: 0, unlockedSkills: [], prestigeLevel: 0, gamesCompleted: 0, totalXP: 0 }
};

// Load/Save player progress (persists across runs)
const loadPlayerProgress = () => {
  try {
    const saved = localStorage.getItem('lotr_deckbuilder_progress');
    if (saved) {
      const parsed = JSON.parse(saved);
      console.log('[loadPlayerProgress] Loaded from localStorage:', parsed);
      // Validate and fix any corrupted data
      const validated = { ...DEFAULT_PLAYER_PROGRESS };
      for (const char of Object.keys(DEFAULT_PLAYER_PROGRESS)) {
        if (parsed[char]) {
          // First, get the XP value - cap at reasonable max (10000 XP is more than enough for level 10)
          let xp = Math.max(0, Number(parsed[char].xp) || 0);
          
          // CORRUPTION CHECK: If XP is impossibly high, reset it
          if (xp > 10000) {
            console.warn(`[loadPlayerProgress] ${char}: XP ${xp} is impossibly high! Resetting to 0.`);
            xp = 0;
          }
          
          // ALWAYS calculate level from XP - never trust stored level
          const level = getLevelFromXP(xp);
          
          console.log(`[loadPlayerProgress] ${char}: stored xp=${parsed[char].xp}, validated xp=${xp}, calculated level=${level}`);
          
          validated[char] = {
            ...DEFAULT_PLAYER_PROGRESS[char],
            ...parsed[char],
            // Override with calculated values
            level: level,
            xp: xp,
            totalXP: Math.max(0, Math.min(50000, Number(parsed[char].totalXP) || 0)),
            skillPoints: Math.max(0, Math.min(20, Number(parsed[char].skillPoints) || 0)),
            prestigeLevel: Math.max(0, Math.min(5, Number(parsed[char].prestigeLevel) || 0)),
            gamesCompleted: Math.max(0, Math.min(1000, Number(parsed[char].gamesCompleted) || 0)),
            unlockedSkills: Array.isArray(parsed[char].unlockedSkills) ? parsed[char].unlockedSkills : []
          };
        }
      }
      return validated;
    }
  } catch (e) {
    console.warn('Could not load player progress, resetting:', e);
    // Clear corrupted data
    try { localStorage.removeItem('lotr_deckbuilder_progress'); } catch (e2) {}
  }
  return { ...DEFAULT_PLAYER_PROGRESS };
};

const savePlayerProgress = (progress) => {
  try {
    localStorage.setItem('lotr_deckbuilder_progress', JSON.stringify(progress));
  } catch (e) {
    console.warn('Could not save player progress:', e);
  }
};

// Get skill tree bonuses for a character
const getSkillBonuses = (characterKey, unlockedSkills) => {
  const bonuses = {
    bonusDamage: 0,
    bonusBlock: 0,
    bonusHp: 0,
    bonusDexterity: 0,
    bonusEnergy: 0,
    healPerCombat: 0,
    healPerTurn: 0,
    extraDraw: 0,
    critBonus: 0,
    critDamage: 0,
    burnBonus: 0,
    poisonBonus: 0,
    damageReduction: 0,
    corruptionResist: 0,
    startingBlock: 0,
    startingStrength: 0
  };
  
  const tree = SKILL_TREES[characterKey];
  if (!tree) return bonuses;
  
  Object.values(tree.branches).forEach(branch => {
    branch.skills.forEach(skill => {
      if (unlockedSkills.includes(skill.id)) {
        Object.entries(skill.effect).forEach(([key, value]) => {
          if (typeof value === 'number' && bonuses.hasOwnProperty(key)) {
            bonuses[key] += value;
          } else if (typeof value === 'number') {
            bonuses[key] = value;
          } else {
            bonuses[key] = value;
          }
        });
      }
    });
  });
  
  return bonuses;
};

// Check if a skill can be unlocked
const canUnlockSkill = (skill, unlockedSkills, skillPoints) => {
  if (unlockedSkills.includes(skill.id)) return false;
  if (skillPoints < skill.cost) return false;
  if (skill.requires && !unlockedSkills.includes(skill.requires)) return false;
  return true;
};

// Get card rewards with rarity weighting and colorless inclusion
const getCardRewards = (character, count = 3, includeColorless = true) => {
  const characterCards = CARD_POOL[character] || [];
  const colorlessCards = includeColorless ? CARD_POOL.colorless || [] : [];
  
  // Weight by rarity: common 60%, uncommon 30%, rare 9%, ultra_rare 1%
  const weightedPool = [];
  [...characterCards, ...colorlessCards].forEach(card => {
    const weight = card.rarity === 'ultra_rare' ? 1 : 
                   card.rarity === 'rare' ? 9 : 
                   card.rarity === 'uncommon' ? 30 : 60;
    for (let i = 0; i < weight; i++) {
      weightedPool.push(card);
    }
  });
  
  const selected = [];
  const usedIds = new Set();
  
  while (selected.length < count && weightedPool.length > 0) {
    const idx = Math.floor(Math.random() * weightedPool.length);
    const card = weightedPool[idx];
    if (!usedIds.has(card.id)) {
      selected.push({ ...card, uid: `${card.id}_${Date.now()}_${Math.random()}` });
      usedIds.add(card.id);
    }
    // Remove all instances of this card to avoid duplicates
    for (let i = weightedPool.length - 1; i >= 0; i--) {
      if (weightedPool[i].id === card.id) weightedPool.splice(i, 1);
    }
  }
  
  return selected;
};

const CARD_UPGRADES = {
  // ============================================
  // ARAGORN CARDS
  // ============================================
  // Common
  strike: { name: 'Sword Strike+', damage: 9 },
  defend: { name: 'Shield Block+', block: 8 },
  heavy_strike: { name: 'Heavy Strike+', damage: 16 },
  pommel_strike: { name: 'Pommel Strike+', damage: 12, draw: 1 },
  iron_wave: { name: 'Iron Wave+', damage: 7, block: 7 },
  shrug_off: { name: 'Shrug It Off+', block: 11, draw: 1 },
  true_grit: { name: 'True Grit+', block: 10 },
  wild_swing: { name: 'Wild Swing+', damage: 14 },
  shoulder_bash: { name: 'Shoulder Bash+', damage: 8, block: 5 },
  sword_guard: { name: 'Sword Guard+', block: 9 },
  riposte: { name: 'Riposte+', block: 6, damage: 6 },
  quick_slash: { name: 'Quick Slash+', damage: 7 },
  defensive_stance: { name: 'Defensive Stance+', block: 12 },
  combat_ready: { name: 'Combat Ready+', block: 5, draw: 2 },
  weathered_blow: { name: 'Weathered Blow+', damage: 10 },
  ranger_training: { name: 'Ranger Training+', block: 7, strength: 1 },
  numenorean_steel: { name: 'Numenorean Steel+', damage: 12 },
  shield_wall: { name: 'Shield Wall+', block: 16 },
  battle_cry: { name: 'Battle Cry+', strength: 2 },
  dunedain_resolve: { name: 'Dunedain Resolve+', block: 9, heal: 4 },
  twin_strike: { name: 'Twin Strike+', damage: 5, hits: 3 },
  parry: { name: 'Parry+', block: 10 },
  counter_attack: { name: 'Counter Attack+', damage: 9, block: 5 },
  steady_hand: { name: 'Steady Hand+', dexterity: 2 },
  sword_dance: { name: 'Sword Dance+', damage: 7, block: 6 },
  steel_resolve: { name: 'Steel Resolve+', block: 13 },
  battle_stance: { name: 'Battle Stance+', strength: 2, block: 6 },
  fierce_blow: { name: 'Fierce Blow+', damage: 12 },
  arnor_guard: { name: 'Arnor Guard+', block: 9 },
  northern_strike: { name: 'Northern Strike+', damage: 10 },
  ranger_reflexes: { name: 'Ranger Reflexes+', block: 7 },
  blade_flurry: { name: 'Blade Flurry+', damage: 5, hits: 4 },
  kings_guard: { name: "King's Guard+", block: 10 },
  dunedain_strike: { name: 'Dunedain Strike+', damage: 10 },
  ancestral_block: { name: 'Ancestral Block+', block: 12 },
  wilderness_survival: { name: 'Wilderness Survival+', heal: 6, block: 5 },
  longsword_slash: { name: 'Longsword Slash+', damage: 12 },
  shield_bash_basic: { name: 'Shield Bash+', damage: 8, block: 6 },
  northern_fortitude: { name: 'Northern Fortitude+', block: 10 },
  heirloom_blade: { name: 'Heirloom Blade+', damage: 9 },
  battle_hardened: { name: 'Battle Hardened+', block: 6 },
  gondor_training: { name: 'Gondor Training+', damage: 8, dexterity: 1 },
  swift_blade: { name: 'Swift Blade+', damage: 8 },
  prepared_defense: { name: 'Prepared Defense+', block: 9, draw: 1 },
  veteran_stance: { name: 'Veteran Stance+', block: 8, strength: 1 },
  charging_strike: { name: 'Charging Strike+', damage: 13 },
  endure: { name: 'Endure+', block: 14 },
  focused_strike: { name: 'Focused Strike+', damage: 10 },
  shield_stance: { name: 'Shield Stance+', block: 10, dexterity: 1 },
  warrior_instinct: { name: 'Warrior Instinct+', damage: 5, draw: 2 },
  // Uncommon
  cleave: { name: 'Cleave+', damage: 12 },
  clothesline: { name: 'Clothesline+', damage: 16, weak: 3 },
  flex: { name: 'Flex+', strength: 3 },
  rage: { name: 'Rage+', energy: 3 },
  seeing_red: { name: 'Seeing Red+', energy: 3 },
  athelas: { name: 'Athelas+', heal: 12, draw: 2 },
  rangers_ambush: { name: "Ranger's Ambush+", damage: 12, vulnerable: 4, weak: 3 },
  last_stand: { name: 'Last Stand+', damage: 26, block: 14, exhaust: true },
  elessar_stone: { name: 'Elessar Stone+', heal: 10, strength: 2 },
  kings_authority: { name: "King's Authority+", vulnerable: 4, weak: 4 },
  narsil_shard: { name: 'Narsil Shard+', damage: 14, vulnerable: 2 },
  dunedain_heritage: { name: 'Dunedain Heritage+', strength: 3, dexterity: 2 },
  flame_of_arnor: { name: 'Flame of Arnor+', damage: 18, burn: 3 },
  royal_command: { name: 'Royal Command+', strength: 2, draw: 2 },
  weathertop_stand: { name: 'Weathertop Stand+', block: 20 },
  blade_mastery: { name: 'Blade Mastery+', damage: 10, strength: 2 },
  gondorian_valor: { name: 'Gondorian Valor+', damage: 14, block: 11 },
  healing_hands: { name: 'Healing Hands+', heal: 15 },
  wrath_of_the_north: { name: 'Wrath of the North+', damage: 20 },
  elendil_legacy: { name: "Elendil's Legacy+", block: 12, strength: 2 },
  // Rare
  bash: { name: 'Crushing Bash+', damage: 12, vulnerable: 3 },
  courage: { name: 'Kingly Courage+', strength: 3 },
  anduril: { name: 'AndÃºril+', damage: 28, strength: 3 },
  kings_return: { name: 'Return of the King+', block: 20, heal: 8 },
  elendils_oath: { name: "Elendil's Oath+", strength: 2, dexterity: 2 },
  oathbreaker: { name: 'Summon Oathbreakers+', damage: 20, vulnerable: 3, exhaust: true },
  army_of_dead: { name: 'Army of the Dead+', damage: 10, hits: 5, exhaust: true },
  heir_of_isildur: { name: 'Heir of Isildur+', strength: 4, heal: 12 },
  reforged_blade: { name: 'Reforged Blade+', damage: 24, strength: 2 },
  king_elessar: { name: 'King Elessar+', strength: 3, dexterity: 3, draw: 3 },
  // Ultra Rare
  aragorn_crowned: { name: 'Coronation of the King+', strength: 5, dexterity: 4, heal: 20, draw: 4 },

  // ============================================
  // LEGOLAS CARDS
  // ============================================
  // Common
  arrow: { name: 'Precise Shot+', damage: 8 },
  dodge: { name: 'Elven Grace+', block: 6, dexterity: 2 },
  quick_shot: { name: 'Quick Shot+', damage: 11, draw: 1 },
  piercing_shot: { name: 'Piercing Shot+', damage: 9 },
  retreat: { name: 'Retreat+', block: 8, draw: 2 },
  backflip: { name: 'Backflip+', block: 8, draw: 2 },
  acrobatics: { name: 'Acrobatics+', draw: 4 },
  swift_arrow: { name: 'Swift Arrow+', damage: 7 },
  elven_dodge: { name: 'Elven Dodge+', block: 9 },
  steady_aim: { name: 'Steady Aim+', damage: 5, vulnerable: 2 },
  woodland_step: { name: 'Woodland Step+', block: 7, draw: 2 },
  arrow_volley: { name: 'Arrow Volley+', damage: 4, hits: 3 },
  nimble_feet: { name: 'Nimble Feet+', dexterity: 2 },
  elven_reflexes: { name: 'Elven Reflexes+', block: 10 },
  mirkwood_shot: { name: 'Mirkwood Shot+', damage: 10 },
  quick_draw: { name: 'Quick Draw+', draw: 2, damage: 3 },
  forest_defense: { name: 'Forest Defense+', block: 9 },
  precise_aim: { name: 'Precise Aim+', damage: 12 },
  elven_agility: { name: 'Elven Agility+', block: 6, dexterity: 2 },
  sindar_arrow: { name: 'Sindar Arrow+', damage: 9 },
  light_step: { name: 'Light Step+', block: 5, draw: 2 },
  bow_strike: { name: 'Bow Strike+', damage: 8, block: 5 },
  silvan_guard: { name: 'Silvan Guard+', block: 10 },
  tracker_shot: { name: 'Tracker Shot+', damage: 9, vulnerable: 2 },
  evasion: { name: 'Evasion+', block: 12 },
  fleet_footed: { name: 'Fleet Footed+', block: 7 },
  twin_arrows: { name: 'Twin Arrows+', damage: 5, hits: 3 },
  woodland_reflexes: { name: 'Woodland Reflexes+', block: 7, dexterity: 2 },
  sniper_shot: { name: 'Sniper Shot+', damage: 13 },
  elven_grace_2: { name: 'Elven Poise+', block: 9 },
  arrow_strike: { name: 'Arrow Strike+', damage: 10 },
  shadow_step: { name: 'Shadow Step+', block: 7, draw: 2 },
  greenwood_shot: { name: 'Greenwood Shot+', damage: 9 },
  feint: { name: 'Feint+', block: 7 },
  rapid_fire: { name: 'Rapid Fire+', damage: 4, hits: 4 },
  woodland_ward: { name: 'Woodland Ward+', block: 10 },
  aimed_shot: { name: 'Aimed Shot+', damage: 12 },
  sylvan_step: { name: 'Sylvan Step+', block: 9 },
  bow_mastery: { name: 'Bow Mastery+', dexterity: 2, draw: 1 },
  keen_eye_basic: { name: 'Keen Sight+', damage: 9, draw: 1 },
  elvish_defense: { name: 'Elvish Defense+', block: 12 },
  hunters_arrow: { name: "Hunter's Arrow+", damage: 10 },
  graceful_dodge: { name: 'Graceful Dodge+', block: 9 },
  barbed_arrow: { name: 'Barbed Arrow+', damage: 7, poison: 3 },
  tree_runner: { name: 'Tree Runner+', block: 5, draw: 2 },
  silvan_shot: { name: 'Silvan Shot+', damage: 9 },
  leaf_shield: { name: 'Leaf Shield+', block: 10 },
  elven_speed: { name: 'Elven Speed+', dexterity: 2 },
  bulls_eye: { name: "Bull's Eye+", damage: 12 },
  wind_arrow: { name: 'Wind Arrow+', damage: 8, draw: 1 },
  // Uncommon
  poison_shot: { name: 'Poison Shot+', damage: 6, poison: 6 },
  deadly_shot: { name: 'Deadly Shot+', damage: 32 },
  blur: { name: 'Blur+', block: 12, dodge: true },
  dodge_roll: { name: 'Dodge and Roll+', block: 6, energy: 3 },
  prepared: { name: 'Prepared+', draw: 2 },
  lembas: { name: 'Lembas Bread+', heal: 15, energy: 2 },
  elven_sight: { name: 'Elven Sight+', draw: 3, vulnerable: 2 },
  vanish: { name: 'Vanish+', block: 28, draw: 2, exhaust: true },
  triple_shot: { name: 'Triple Shot+', damage: 6, hits: 4 },
  mirkwood_poison: { name: 'Mirkwood Poison+', poison: 9 },
  elvish_cunning: { name: 'Elvish Cunning+', draw: 3, dexterity: 1 },
  crippling_shot: { name: 'Crippling Shot+', damage: 9, weak: 3 },
  silvan_mastery: { name: 'Silvan Mastery+', dexterity: 3 },
  arrow_storm: { name: 'Arrow Storm+', damage: 5, hits: 5 },
  lothlorien_blessing: { name: 'Lothlorien Blessing+', heal: 10, draw: 3 },
  phantom_step: { name: 'Phantom Step+', block: 14, dexterity: 2 },
  heartseeker: { name: 'Heartseeker+', damage: 24, vulnerable: 3 },
  elven_cloak_card: { name: 'Elven Cloak+', block: 16 },
  precision: { name: 'Precision+', damage: 14, vulnerable: 2 },
  nocking_arrow: { name: 'Nocking Arrow+', damage: 6, draw: 2 },
  venomous_blade: { name: 'Venomous Blade+', damage: 6, poison: 6, poisonSynergy: true },
  toxic_rain: { name: 'Toxic Rain+', damage: 3, hits: 4, poison: 3 },
  // Rare
  multishot: { name: 'Multi Shot+', damage: 7, hits: 3 },
  focus: { name: 'Elven Focus+', draw: 3 },
  keen: { name: 'Keen Eye+', damage: 16 },
  elven_bow: { name: 'Bow of the Galadhrim+', damage: 18, hits: 3 },
  woodland_stealth: { name: 'Woodland Stealth+', block: 16, dexterity: 3 },
  arrows_rain: { name: 'Rain of Arrows+', damage: 7, hits: 5 },
  headshot: { name: 'Headshot+', damage: 40, exhaust: true },
  mirkwood_prince: { name: 'Prince of Mirkwood+', dexterity: 4, draw: 3 },
  legolas_fury: { name: "Legolas' Fury+", damage: 10, hits: 5 },
  thranduils_gift: { name: "Thranduil's Gift+", dexterity: 3, block: 20 },
  // Ultra Rare
  legolas_mastery: { name: 'Master Archer+', damage: 12, hits: 6, dexterity: 3 },

  // ============================================
  // GANDALF CARDS
  // ============================================
  // Common
  staff_strike: { name: 'Staff Strike+', damage: 8 },
  magic_barrier: { name: 'Magic Barrier+', block: 10 },
  spark: { name: 'Spark+', damage: 5, draw: 2 },
  lightning: { name: 'Lightning Bolt+', damage: 18 },
  flame_wave: { name: 'Flame Wave+', damage: 12, burn: 6 },
  arcane_shield: { name: 'Arcane Shield+', block: 12 },
  meditation: { name: 'Meditation+', draw: 3, block: 6 },
  channel: { name: 'Channel+', energy: 3 },
  minor_heal: { name: 'Minor Heal+', heal: 8 },
  arcane_bolt: { name: 'Arcane Bolt+', damage: 10 },
  shield_charm: { name: 'Shield Charm+', block: 10 },
  fire_spark: { name: 'Fire Spark+', damage: 6, burn: 2 },
  mystic_ward: { name: 'Mystic Ward+', block: 9 },
  power_word: { name: 'Power Word+', strength: 2 },
  flame_touch: { name: 'Flame Touch+', damage: 9, burn: 3 },
  mana_shield: { name: 'Mana Shield+', block: 12 },
  energy_tap: { name: 'Energy Tap+', energy: 1, draw: 2 },
  frost_touch: { name: 'Frost Touch+', damage: 8, weak: 2 },
  barrier: { name: 'Barrier+', block: 10 },
  staff_sweep: { name: 'Staff Sweep+', damage: 9 },
  light_ward: { name: 'Light Ward+', block: 9, draw: 1 },
  magic_missile: { name: 'Magic Missile+', damage: 4, hits: 3 },
  wizards_guard: { name: "Wizard's Guard+", block: 10 },
  cantrip: { name: 'Cantrip+', damage: 4, draw: 2 },
  arcane_ward: { name: 'Arcane Ward+', block: 12 },
  ember: { name: 'Ember+', damage: 7 },
  protection_spell: { name: 'Protection Spell+', block: 9 },
  minor_lightning: { name: 'Minor Lightning+', damage: 12 },
  focus_mind: { name: 'Focus Mind+', draw: 2 },
  flame_burst: { name: 'Flame Burst+', damage: 10, burn: 2 },
  mystic_shield: { name: 'Mystic Shield+', block: 10 },
  zap: { name: 'Zap+', damage: 8 },
  ward: { name: 'Ward+', block: 9 },
  staff_bash: { name: 'Staff Bash+', damage: 9, block: 5 },
  magical_defense: { name: 'Magical Defense+', block: 12 },
  fire_bolt: { name: 'Fire Bolt+', damage: 12 },
  energy_shield: { name: 'Energy Shield+', block: 10 },
  shock: { name: 'Shock+', damage: 9, vulnerable: 2 },
  spell_barrier: { name: 'Spell Barrier+', block: 13 },
  heat_wave: { name: 'Heat Wave+', damage: 8, burn: 3 },
  wisdom: { name: 'Wisdom+', draw: 3, exhaust: true },
  istar_strike: { name: 'Istar Strike+', damage: 10 },
  light_barrier: { name: 'Light Barrier+', block: 9 },
  quick_spell: { name: 'Quick Spell+', damage: 7 },
  mage_armor: { name: 'Mage Armor+', block: 10 },
  flame_jet: { name: 'Flame Jet+', damage: 9, burn: 3 },
  concentration: { name: 'Concentration+', draw: 2, energy: 1 },
  thunder_touch: { name: 'Thunder Touch+', damage: 10 },
  circle_protection: { name: 'Circle of Protection+', block: 12 },
  bolt: { name: 'Bolt+', damage: 13 },
  // Uncommon
  inferno: { name: 'Inferno+', damage: 16, burn: 8 },
  frost_nova: { name: 'Frost Nova+', damage: 10, weak: 3, vulnerable: 3 },
  mana_surge: { name: 'Mana Surge+', energy: 4, exhaust: true },
  arcane_intellect: { name: 'Arcane Intellect+', draw: 4 },
  counterspell: { name: 'Counterspell+', block: 20, dexterity: 2 },
  gandalf_light: { name: "Gandalf's Light+", weak: 3, block: 12 },
  secret_fire: { name: 'Secret Fire+', damage: 16, burn: 6 },
  grey_wanderer: { name: 'Grey Wanderer+', draw: 3, heal: 6 },
  maia_power: { name: 'Maia Power+', strength: 3, energy: 2 },
  flame_of_anor: { name: 'Flame of Anor+', damage: 22 },
  glamdring: { name: 'Glamdring Strike+', damage: 18, vulnerable: 2 },
  smoke_ring: { name: 'Smoke Ring+', block: 14, draw: 2 },
  chain_lightning: { name: 'Chain Lightning+', damage: 7, hits: 4 },
  spell_mastery: { name: 'Spell Mastery+', strength: 2, dexterity: 2 },
  blinding_light: { name: 'Blinding Light+', weak: 4 },
  mithrandir: { name: 'Mithrandir+', damage: 14, block: 14 },
  dispel: { name: 'Dispel+', vulnerable: 3, weak: 3 },
  arcane_explosion: { name: 'Arcane Explosion+', damage: 20 },
  radagast_aid: { name: "Radagast's Aid+", heal: 12, draw: 2 },
  word_of_command: { name: 'Word of Command+', draw: 3, energy: 2 },
  conflagration: { name: 'Conflagration+', burnSynergy: true, burnMultiplier: 4 },
  flame_wall: { name: 'Flame Wall+', block: 12, burn: 6 },
  // Rare
  fireball: { name: 'Fireball+', damage: 14, burn: 5 },
  illuminate: { name: 'Illuminate+', draw: 3, energy: 2 },
  you_shall_not_pass: { name: 'You Shall Not Pass!+', damage: 45, block: 25, exhaust: true },
  white_light: { name: 'White Light+', damage: 15, heal: 15 },
  wizard_staff: { name: 'Staff of Power+', strength: 4, dexterity: 3 },
  time_warp: { name: 'Time Warp+', draw: 5, energy: 3, exhaust: true },
  meteor: { name: 'Meteor+', damage: 32, burn: 10, vulnerable: 3 },
  gandalf_white: { name: 'Gandalf the White+', strength: 3, heal: 20, draw: 3 },
  valinor_blessing: { name: 'Blessing of Valinor+', heal: 16, block: 16 },
  istari_wisdom: { name: 'Istari Wisdom+', draw: 4, energy: 3 },
  // Ultra Rare
  gandalf_ascended: { name: 'The White Rider+', damage: 50, heal: 25, strength: 4, dexterity: 3 },

  // ============================================
  // GIMLI CARDS
  // ============================================
  // Common
  axe_strike: { name: 'Axe Strike+', damage: 10 },
  dwarf_guard: { name: 'Dwarf Guard+', block: 9 },
  heavy_axe: { name: 'Heavy Axe+', damage: 18 },
  iron_skin: { name: 'Iron Skin+', block: 12 },
  cleaving_blow: { name: 'Cleaving Blow+', damage: 6, hits: 3 },
  moria_stance: { name: 'Moria Stance+', block: 8, strength: 1 },
  battle_axe: { name: 'Battle Axe+', damage: 12 },
  stone_wall: { name: 'Stone Wall+', block: 16 },
  quick_chop: { name: 'Quick Chop+', damage: 7 },
  dwarven_mail: { name: 'Dwarven Mail+', block: 10 },
  reckless_swing: { name: 'Reckless Swing+', damage: 16 },
  mountain_endurance: { name: 'Mountain Endurance+', block: 9, heal: 4 },
  throwing_axe: { name: 'Throwing Axe+', damage: 9 },
  khazad_guard: { name: 'Khazad Guard+', block: 10 },
  savage_cut: { name: 'Savage Cut+', damage: 13 },
  dwarven_resilience: { name: 'Dwarven Resilience+', block: 6, strength: 2 },
  beard_bash: { name: 'Beard Bash+', damage: 9, block: 5 },
  erebor_shield: { name: 'Erebor Shield+', block: 12 },
  fury_strike: { name: 'Fury Strike+', damage: 14 },
  cave_knowledge: { name: 'Cave Knowledge+', block: 5, draw: 2 },
  double_axe: { name: 'Double Axe+', damage: 5, hits: 3 },
  iron_resolve: { name: 'Iron Resolve+', block: 13 },
  miner_strike: { name: 'Miner Strike+', damage: 10 },
  stone_skin: { name: 'Stone Skin+', block: 9 },
  berserker_chop: { name: 'Berserker Chop+', damage: 12 },
  durin_blessing: { name: "Durin's Blessing+", block: 7 },
  hammer_blow: { name: 'Hammer Blow+', damage: 10, vulnerable: 2 },
  mountain_guard: { name: 'Mountain Guard+', block: 10 },
  grudge_strike: { name: 'Grudge Strike+', damage: 12 },
  ancestral_armor: { name: 'Ancestral Armor+', block: 9 },
  pickaxe_swing: { name: 'Pickaxe Swing+', damage: 9 },
  steady_stance: { name: 'Steady Stance+', block: 8, dexterity: 1 },
  rage_blow: { name: 'Rage Blow+', damage: 15 },
  blue_mountain_guard: { name: 'Blue Mountain Guard+', block: 10 },
  tunnel_fighter: { name: 'Tunnel Fighter+', damage: 8 },
  forge_hardened: { name: 'Forge Hardened+', block: 9 },
  wrath_chop: { name: 'Wrath Chop+', damage: 13 },
  dwarven_stoicism: { name: 'Dwarven Stoicism+', block: 12 },
  underground_assault: { name: 'Underground Assault+', damage: 10 },
  gold_greed: { name: 'Gold Greed+', strength: 2 },
  axe_flurry: { name: 'Axe Flurry+', damage: 4, hits: 4 },
  stone_heart: { name: 'Stone Heart+', block: 9 },
  gloin_strike: { name: "Gloin's Strike+", damage: 12 },
  deep_roots: { name: 'Deep Roots+', block: 8, heal: 5 },
  dwarven_fury: { name: 'Dwarven Fury+', damage: 14 },
  mountain_resolve: { name: 'Mountain Resolve+', block: 13 },
  veteran_chop: { name: 'Veteran Chop+', damage: 10 },
  erebor_stance: { name: 'Erebor Stance+', block: 9, strength: 1 },
  grudge_bearer: { name: 'Grudge Bearer+', damage: 6, draw: 2 },
  iron_fortress: { name: 'Iron Fortress+', block: 14 },
  // NEW: Additional strength scaling cards
  dwarven_warcry: { name: 'Dwarven Warcry+', strength: 3 },
  grudge_fuel: { name: 'Grudge Fuel+', strength: 2 },
  ancestral_fury: { name: 'Ancestral Fury+', strength: 2, damage: 8 },
  // Uncommon
  baruk_khazad: { name: 'Baruk KhazÃ¢d!+', damage: 20 },
  mithril_armor: { name: 'Mithril Armor+', block: 24 },
  counter_strike: { name: 'Counter Strike+', damage: 11, block: 9 },
  dwarven_rage: { name: 'Dwarven Rage+', strength: 3 },
  orc_slayer: { name: 'Orc Slayer+', damage: 12, hits: 3 },
  stone_fortress: { name: 'Stone Fortress+', block: 20 },
  berserk: { name: 'Berserk+', energy: 3 },
  ancestral_wrath: { name: 'Ancestral Wrath+', damage: 24 },
  mountain_king: { name: 'Mountain King+', strength: 3, block: 12 },
  cave_in: { name: 'Cave In+', damage: 16, vulnerable: 3 },
  thorin_legacy: { name: "Thorin's Legacy+", strength: 2, draw: 3 },
  durin_vengeance: { name: "Durin's Vengeance+", damage: 28, exhaust: true },
  iron_will: { name: 'Iron Will+', block: 14, draw: 2 },
  execution: { name: 'Execution+', damage: 18, vulnerable: 2 },
  deep_delving: { name: 'Deep Delving+', heal: 12, block: 8 },
  whirlwind_axe: { name: 'Whirlwind Axe+', damage: 8, hits: 4 },
  dwarven_fortitude: { name: 'Dwarven Fortitude+', dexterity: 3, strength: 2 },
  gold_fever: { name: 'Gold Fever+', damage: 16 },
  erebor_heritage: { name: 'Erebor Heritage+', block: 12, heal: 6 },
  grudge_keeper: { name: 'Grudge Keeper+', damage: 14, strength: 2 },
  // Rare
  khazad_dum: { name: 'Khazad-dÃ»m+', damage: 32 },
  durin_crown: { name: "Durin's Crown+", strength: 4 },
  battle_fury: { name: 'Battle Fury+', damage: 10, hits: 4 },
  mithril_coat_card: { name: 'Mithril Coat+', block: 32 },
  erebor_king: { name: 'King Under the Mountain+', strength: 3, dexterity: 3, draw: 3 },
  axe_master: { name: 'Axe Master+', damage: 15, hits: 3 },
  dwarven_last_stand: { name: 'Dwarven Last Stand+', damage: 40, block: 20, exhaust: true },
  stone_giant: { name: 'Stone Giant+', block: 40, strength: 2 },
  ancestors_might: { name: "Ancestors' Might+", strength: 3, heal: 15 },
  champion_of_erebor: { name: 'Champion of Erebor+', damage: 26, vulnerable: 3 },
  // Ultra Rare
  son_of_gloin: { name: 'Son of GlÃ³in+', strength: 5, dexterity: 4, damage: 20, heal: 20 },

  // ============================================
  // COLORLESS CARDS
  // ============================================
  // Common
  second_wind: { name: 'Second Wind+', heal: 10 },
  quick_thinking: { name: 'Quick Thinking+', draw: 2 },
  determination: { name: 'Determination+', block: 9 },
  swift_strike: { name: 'Swift Strike+', damage: 9 },
  brace: { name: 'Brace+', block: 10 },
  hobbit_courage: { name: 'Hobbit Courage+', strength: 2 },
  shire_luck: { name: 'Shire Luck+', draw: 2, block: 4 },
  road_goes_ever: { name: 'Road Goes Ever On+', draw: 3 },
  elvish_rope: { name: 'Elvish Rope+', block: 8, draw: 1 },
  stew_pot: { name: "Sam's Stew+", heal: 7, block: 7 },
  pipe_weed: { name: 'Pipe Weed+', draw: 2 },
  old_toby: { name: 'Old Toby+', heal: 5, draw: 2 },
  elvish_waybread: { name: 'Elvish Waybread+', heal: 8, energy: 1 },
  rivendell_rest: { name: 'Rivendell Rest+', heal: 10 },
  gondor_shield: { name: 'Gondor Shield+', block: 12 },
  rohan_charge: { name: 'Rohan Charge+', damage: 10 },
  mordor_survivor: { name: 'Mordor Survivor+', block: 7 },
  helm_deep_stand: { name: "Helm's Deep Stand+", block: 9, strength: 1 },
  eagles_sight: { name: "Eagle's Sight+", draw: 2 },
  lorien_gift: { name: 'Gift of Lorien+', heal: 7, draw: 2 },
  minas_tirith: { name: 'Minas Tirith Guard+', block: 10 },
  isengard_strike: { name: 'Isengard Strike+', damage: 12 },
  dead_marshes: { name: 'Dead Marshes+', weak: 3 },
  fangorn_strength: { name: 'Fangorn Strength+', strength: 2, block: 5 },
  prancing_pony: { name: 'Prancing Pony Rest+', heal: 8 },
  // Uncommon
  fellowship_bond: { name: 'Fellowship Bond+', strength: 2, dexterity: 2 },
  eagles_coming: { name: 'The Eagles Are Coming+', damage: 16, heal: 12 },
  gollum_trick: { name: "Gollum's Trick+", draw: 3, weak: 2 },
  ent_draught: { name: 'Ent Draught+', heal: 18, strength: 2 },
  rohirrim_charge: { name: 'Rohirrim Charge+', damage: 20 },
  gondor_calls: { name: 'Gondor Calls for Aid+', block: 14, draw: 2 },
  tom_bombadil: { name: "Tom Bombadil's Song+", heal: 12, weak: 3 },
  beorns_rage: { name: "Beorn's Rage+", damage: 16, strength: 3 },
  grey_company: { name: 'Grey Company+', damage: 12, block: 12 },
  treebeard_march: { name: "Treebeard's March+", damage: 14, vulnerable: 3 },
  // Rare
  one_ring_power: { name: "The One Ring's Power+", draw: 4, energy: 3, exhaust: true },
  ride_of_rohirrim: { name: 'Ride of the Rohirrim+', damage: 26, block: 14 },
  death_or_glory: { name: 'Death or Glory+', damage: 35, exhaust: true },
  samwise_courage: { name: "Samwise's Courage+", strength: 3, dexterity: 3, heal: 15 },
  frodo_resolve: { name: "Frodo's Resolve+", block: 26, heal: 12 },
  // Ultra Rare
  destroying_ring: { name: 'Destroy the Ring+', damage: 65, heal: 35, exhaust: true }
};

const upgradeCard = (card) => {
  if (card.upgraded) return card;
  const upgrade = CARD_UPGRADES[card.id];
  if (!upgrade) return card;
  return { 
    ...card, 
    ...upgrade, 
    upgraded: true,
    uid: card.uid + '_upgraded'
  };
};

const CARD_POOL = {
  aragorn: [
    // === COMMON (50) ===
    { id: 'strike', name: 'Sword Strike', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'defend', name: 'Shield Block', cost: 1, block: 5, type: 'skill', rarity: 'common' },
    { id: 'heavy_strike', name: 'Heavy Strike', cost: 2, damage: 12, type: 'attack', rarity: 'common' },
    { id: 'pommel_strike', name: 'Pommel Strike', cost: 1, damage: 9, draw: 1, type: 'attack', rarity: 'common' },
    { id: 'iron_wave', name: 'Iron Wave', cost: 1, damage: 5, block: 5, type: 'attack', rarity: 'common' },
    { id: 'shrug_off', name: 'Shrug It Off', cost: 1, block: 8, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'true_grit', name: 'True Grit', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'wild_swing', name: 'Wild Swing', cost: 1, damage: 10, type: 'attack', rarity: 'common' },
    { id: 'shoulder_bash', name: 'Shoulder Bash', cost: 1, damage: 5, block: 3, type: 'attack', rarity: 'common' },
    { id: 'sword_guard', name: 'Sword Guard', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'riposte', name: 'Riposte', cost: 1, block: 4, damage: 4, type: 'skill', rarity: 'common' },
    { id: 'quick_slash', name: 'Quick Slash', cost: 0, damage: 4, type: 'attack', rarity: 'common' },
    { id: 'defensive_stance', name: 'Defensive Stance', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'combat_ready', name: 'Combat Ready', cost: 0, block: 3, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'weathered_blow', name: 'Weathered Blow', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'ranger_training', name: 'Ranger Training', cost: 1, block: 5, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'numenorean_steel', name: 'Numenorean Steel', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'shield_wall', name: 'Shield Wall', cost: 2, block: 12, type: 'skill', rarity: 'common' },
    { id: 'battle_cry', name: 'Battle Cry', cost: 0, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'dunedain_resolve', name: 'Dunedain Resolve', cost: 1, block: 6, heal: 2, type: 'skill', rarity: 'common' },
    { id: 'twin_strike', name: 'Twin Strike', cost: 1, damage: 4, hits: 2, type: 'attack', rarity: 'common' },
    { id: 'parry', name: 'Parry', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'counter_attack', name: 'Counter Attack', cost: 1, damage: 6, block: 3, type: 'attack', rarity: 'common' },
    { id: 'steady_hand', name: 'Steady Hand', cost: 0, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'sword_dance', name: 'Sword Dance', cost: 1, damage: 5, block: 4, type: 'attack', rarity: 'common' },
    { id: 'steel_resolve', name: 'Steel Resolve', cost: 1, block: 9, type: 'skill', rarity: 'common' },
    { id: 'battle_stance', name: 'Battle Stance', cost: 1, strength: 1, block: 4, type: 'skill', rarity: 'common' },
    { id: 'fierce_blow', name: 'Fierce Blow', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'arnor_guard', name: 'Arnor Guard', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'northern_strike', name: 'Northern Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'ranger_reflexes', name: 'Ranger Reflexes', cost: 0, block: 4, type: 'skill', rarity: 'common' },
    { id: 'blade_flurry', name: 'Blade Flurry', cost: 2, damage: 4, hits: 3, type: 'attack', rarity: 'common' },
    { id: 'kings_guard', name: "King's Guard", cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'dunedain_strike', name: 'Dunedain Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'ancestral_block', name: 'Ancestral Block', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'wilderness_survival', name: 'Wilderness Survival', cost: 1, heal: 4, block: 3, type: 'skill', rarity: 'common' },
    { id: 'longsword_slash', name: 'Longsword Slash', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'shield_bash_basic', name: 'Shield Bash', cost: 1, damage: 5, block: 4, type: 'attack', rarity: 'common' },
    { id: 'northern_fortitude', name: 'Northern Fortitude', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'heirloom_blade', name: 'Heirloom Blade', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'battle_hardened', name: 'Battle Hardened', cost: 0, block: 3, type: 'skill', rarity: 'common' },
    { id: 'gondor_training', name: 'Gondor Training', cost: 1, damage: 5, dexterity: 1, type: 'attack', rarity: 'common' },
    { id: 'swift_blade', name: 'Swift Blade', cost: 0, damage: 5, type: 'attack', rarity: 'common' },
    { id: 'prepared_defense', name: 'Prepared Defense', cost: 1, block: 6, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'veteran_stance', name: 'Veteran Stance', cost: 1, block: 5, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'charging_strike', name: 'Charging Strike', cost: 1, damage: 9, type: 'attack', rarity: 'common' },
    { id: 'endure', name: 'Endure', cost: 1, block: 10, type: 'skill', rarity: 'common' },
    { id: 'focused_strike', name: 'Focused Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'shield_stance', name: 'Shield Stance', cost: 1, block: 7, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'warrior_instinct', name: 'Warrior Instinct', cost: 0, damage: 3, draw: 1, type: 'attack', rarity: 'common' },
    // === UNCOMMON (20) ===
    { id: 'cleave', name: 'Cleave', cost: 1, damage: 8, type: 'attack', rarity: 'uncommon' },
    { id: 'clothesline', name: 'Clothesline', cost: 2, damage: 12, weak: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'flex', name: 'Flex', cost: 0, strength: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'rage', name: 'Rage', cost: 0, energy: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'seeing_red', name: 'Seeing Red', cost: 1, energy: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'athelas', name: 'Athelas', cost: 1, heal: 8, draw: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'rangers_ambush', name: "Ranger's Ambush", cost: 2, damage: 8, vulnerable: 3, weak: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'last_stand', name: 'Last Stand', cost: 1, damage: 20, block: 10, exhaust: true, type: 'attack', rarity: 'uncommon' },
    { id: 'elessar_stone', name: 'Elessar Stone', cost: 1, heal: 6, strength: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'kings_authority', name: "King's Authority", cost: 2, vulnerable: 3, weak: 3, type: 'skill', rarity: 'uncommon' },
    { id: 'narsil_shard', name: 'Narsil Shard', cost: 1, damage: 10, vulnerable: 1, type: 'attack', rarity: 'uncommon' },
    { id: 'dunedain_heritage', name: 'Dunedain Heritage', cost: 2, strength: 2, dexterity: 1, type: 'power', rarity: 'uncommon' },
    { id: 'flame_of_arnor', name: 'Flame of Arnor', cost: 2, damage: 14, burn: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'royal_command', name: 'Royal Command', cost: 1, strength: 1, draw: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'weathertop_stand', name: 'Weathertop Stand', cost: 2, block: 15, type: 'skill', rarity: 'uncommon' },
    { id: 'blade_mastery', name: 'Blade Mastery', cost: 1, damage: 7, strength: 1, type: 'attack', rarity: 'uncommon' },
    { id: 'gondorian_valor', name: 'Gondorian Valor', cost: 2, damage: 10, block: 8, type: 'attack', rarity: 'uncommon' },
    { id: 'healing_hands', name: 'Healing Hands', cost: 2, heal: 10, type: 'skill', rarity: 'uncommon' },
    { id: 'wrath_of_the_north', name: 'Wrath of the North', cost: 2, damage: 15, type: 'attack', rarity: 'uncommon' },
    { id: 'elendil_legacy', name: "Elendil's Legacy", cost: 1, block: 8, strength: 1, type: 'skill', rarity: 'uncommon' },
    // === RARE (10) ===
    { id: 'bash', name: 'Crushing Bash', cost: 2, damage: 8, vulnerable: 2, type: 'attack', rarity: 'rare' },
    { id: 'courage', name: 'Kingly Courage', cost: 1, strength: 2, type: 'power', rarity: 'rare' },
    { id: 'anduril', name: 'AndÃºril, Flame of the West', cost: 3, damage: 20, strength: 2, type: 'attack', rarity: 'rare' },
    { id: 'kings_return', name: 'Return of the King', cost: 2, block: 15, heal: 5, type: 'skill', rarity: 'rare' },
    { id: 'elendils_oath', name: "Elendil's Oath", cost: 0, strength: 1, dexterity: 1, type: 'power', rarity: 'rare' },
    { id: 'oathbreaker', name: 'Summon Oathbreakers', cost: 2, damage: 15, vulnerable: 2, exhaust: true, type: 'attack', rarity: 'rare' },
    { id: 'army_of_dead', name: 'Army of the Dead', cost: 3, damage: 8, hits: 4, exhaust: true, type: 'attack', rarity: 'rare' },
    { id: 'heir_of_isildur', name: 'Heir of Isildur', cost: 2, strength: 3, heal: 8, type: 'power', rarity: 'rare' },
    { id: 'reforged_blade', name: 'Reforged Blade', cost: 2, damage: 18, strength: 1, type: 'attack', rarity: 'rare' },
    { id: 'king_elessar', name: 'King Elessar', cost: 3, strength: 2, dexterity: 2, draw: 2, type: 'power', rarity: 'rare' },
    // === ULTRA RARE (1) ===
    { id: 'aragorn_crowned', name: 'Coronation of the King', cost: 4, strength: 4, dexterity: 3, heal: 15, draw: 3, type: 'power', rarity: 'ultra_rare' }
  ],
  legolas: [
    // === COMMON (50) ===
    { id: 'arrow', name: 'Precise Shot', cost: 1, damage: 5, type: 'attack', rarity: 'common' },
    { id: 'dodge', name: 'Elven Grace', cost: 1, block: 4, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'quick_shot', name: 'Quick Shot', cost: 1, damage: 8, draw: 1, type: 'attack', rarity: 'common' },
    { id: 'piercing_shot', name: 'Piercing Shot', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'retreat', name: 'Retreat', cost: 1, block: 5, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'backflip', name: 'Backflip', cost: 1, block: 5, draw: 2, type: 'skill', rarity: 'common' },
    { id: 'acrobatics', name: 'Acrobatics', cost: 1, draw: 3, type: 'skill', rarity: 'common' },
    { id: 'swift_arrow', name: 'Swift Arrow', cost: 0, damage: 4, type: 'attack', rarity: 'common' },
    { id: 'elven_dodge', name: 'Elven Dodge', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'steady_aim', name: 'Steady Aim', cost: 0, damage: 3, vulnerable: 1, type: 'attack', rarity: 'common' },
    { id: 'woodland_step', name: 'Woodland Step', cost: 1, block: 5, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'arrow_volley', name: 'Arrow Volley', cost: 1, damage: 3, hits: 2, type: 'attack', rarity: 'common' },
    { id: 'nimble_feet', name: 'Nimble Feet', cost: 0, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'elven_reflexes', name: 'Elven Reflexes', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'mirkwood_shot', name: 'Mirkwood Shot', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'quick_draw', name: 'Quick Draw', cost: 0, draw: 1, damage: 2, type: 'attack', rarity: 'common' },
    { id: 'forest_defense', name: 'Forest Defense', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'precise_aim', name: 'Precise Aim', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'elven_agility', name: 'Elven Agility', cost: 1, block: 4, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'sindar_arrow', name: 'Sindar Arrow', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'light_step', name: 'Light Step', cost: 0, block: 3, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'bow_strike', name: 'Bow Strike', cost: 1, damage: 5, block: 3, type: 'attack', rarity: 'common' },
    { id: 'silvan_guard', name: 'Silvan Guard', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'tracker_shot', name: 'Tracker Shot', cost: 1, damage: 6, vulnerable: 1, type: 'attack', rarity: 'common' },
    { id: 'evasion', name: 'Evasion', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'fleet_footed', name: 'Fleet Footed', cost: 0, block: 4, type: 'skill', rarity: 'common' },
    { id: 'twin_arrows', name: 'Twin Arrows', cost: 1, damage: 4, hits: 2, type: 'attack', rarity: 'common' },
    { id: 'woodland_reflexes', name: 'Woodland Reflexes', cost: 1, block: 5, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'sniper_shot', name: 'Sniper Shot', cost: 1, damage: 9, type: 'attack', rarity: 'common' },
    { id: 'elven_grace_2', name: 'Elven Poise', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'arrow_strike', name: 'Arrow Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'shadow_step', name: 'Shadow Step', cost: 1, block: 5, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'greenwood_shot', name: 'Greenwood Shot', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'feint', name: 'Feint', cost: 0, block: 4, type: 'skill', rarity: 'common' },
    { id: 'rapid_fire', name: 'Rapid Fire', cost: 2, damage: 3, hits: 3, type: 'attack', rarity: 'common' },
    { id: 'woodland_ward', name: 'Woodland Ward', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'aimed_shot', name: 'Aimed Shot', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'sylvan_step', name: 'Sylvan Step', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'bow_mastery', name: 'Bow Mastery', cost: 0, dexterity: 1, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'keen_eye_basic', name: 'Keen Sight', cost: 1, damage: 6, draw: 1, type: 'attack', rarity: 'common' },
    { id: 'elvish_defense', name: 'Elvish Defense', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'hunters_arrow', name: "Hunter's Arrow", cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'graceful_dodge', name: 'Graceful Dodge', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'barbed_arrow', name: 'Barbed Arrow', cost: 1, damage: 5, poison: 2, type: 'attack', rarity: 'common' },
    { id: 'tree_runner', name: 'Tree Runner', cost: 0, block: 3, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'silvan_shot', name: 'Silvan Shot', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'leaf_shield', name: 'Leaf Shield', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'elven_speed', name: 'Elven Speed', cost: 0, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'bulls_eye', name: "Bull's Eye", cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'wind_arrow', name: 'Wind Arrow', cost: 1, damage: 5, draw: 1, type: 'attack', rarity: 'common' },
    // === UNCOMMON (20) ===
    { id: 'poison_shot', name: 'Poison Shot', cost: 1, damage: 4, poison: 4, type: 'attack', rarity: 'uncommon' },
    { id: 'deadly_shot', name: 'Deadly Shot', cost: 2, damage: 25, type: 'attack', rarity: 'uncommon' },
    { id: 'blur', name: 'Blur', cost: 1, block: 8, dodge: true, type: 'skill', rarity: 'uncommon' },
    { id: 'dodge_roll', name: 'Dodge and Roll', cost: 1, block: 4, energy: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'prepared', name: 'Prepared', cost: 0, draw: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'lembas', name: 'Lembas Bread', cost: 1, heal: 10, energy: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'elven_sight', name: 'Elven Sight', cost: 1, draw: 2, vulnerable: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'vanish', name: 'Vanish', cost: 1, block: 20, draw: 1, exhaust: true, type: 'skill', rarity: 'uncommon' },
    { id: 'triple_shot', name: 'Triple Shot', cost: 2, damage: 5, hits: 3, type: 'attack', rarity: 'uncommon' },
    { id: 'mirkwood_poison', name: 'Mirkwood Poison', cost: 1, poison: 6, type: 'skill', rarity: 'uncommon' },
    { id: 'elvish_cunning', name: 'Elvish Cunning', cost: 1, draw: 2, dexterity: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'crippling_shot', name: 'Crippling Shot', cost: 1, damage: 6, weak: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'silvan_mastery', name: 'Silvan Mastery', cost: 2, dexterity: 2, type: 'power', rarity: 'uncommon' },
    { id: 'arrow_storm', name: 'Arrow Storm', cost: 2, damage: 4, hits: 4, type: 'attack', rarity: 'uncommon' },
    { id: 'lothlorien_blessing', name: 'Lothlorien Blessing', cost: 1, heal: 6, draw: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'phantom_step', name: 'Phantom Step', cost: 1, block: 10, dexterity: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'heartseeker', name: 'Heartseeker', cost: 2, damage: 18, vulnerable: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'elven_cloak_card', name: 'Elven Cloak', cost: 1, block: 12, type: 'skill', rarity: 'uncommon' },
    { id: 'precision', name: 'Precision', cost: 1, damage: 10, vulnerable: 1, type: 'attack', rarity: 'uncommon' },
    { id: 'nocking_arrow', name: 'Nocking Arrow', cost: 0, damage: 4, draw: 1, type: 'attack', rarity: 'uncommon' },
    { id: 'venomous_blade', name: 'Venomous Blade', cost: 1, damage: 4, poison: 4, poisonSynergy: true, type: 'attack', rarity: 'uncommon', description: 'Deal 4 damage. Apply 4 poison. Deal +1 damage per poison on enemy.' },
    { id: 'toxic_rain', name: 'Toxic Rain', cost: 2, damage: 2, hits: 3, poison: 2, type: 'attack', rarity: 'uncommon', description: 'Deal 2 damage 3 times. Apply 2 poison each hit.' },
    // === RARE (10) ===
    { id: 'multishot', name: 'Multi Shot', cost: 2, damage: 5, hits: 2, type: 'attack', rarity: 'rare' },
    { id: 'focus', name: 'Elven Focus', cost: 1, draw: 2, type: 'skill', rarity: 'rare' },
    { id: 'keen', name: 'Keen Eye', cost: 2, damage: 12, type: 'attack', rarity: 'rare' },
    { id: 'elven_bow', name: 'Bow of the Galadhrim', cost: 3, damage: 15, hits: 2, type: 'attack', rarity: 'rare' },
    { id: 'woodland_stealth', name: 'Woodland Stealth', cost: 2, block: 12, dexterity: 2, type: 'skill', rarity: 'rare' },
    { id: 'arrows_rain', name: 'Rain of Arrows', cost: 3, damage: 5, hits: 4, type: 'attack', rarity: 'rare' },
    { id: 'headshot', name: 'Headshot', cost: 2, damage: 30, exhaust: true, type: 'attack', rarity: 'rare' },
    { id: 'mirkwood_prince', name: 'Prince of Mirkwood', cost: 2, dexterity: 3, draw: 2, type: 'power', rarity: 'rare' },
    { id: 'legolas_fury', name: "Legolas' Fury", cost: 3, damage: 8, hits: 4, type: 'attack', rarity: 'rare' },
    { id: 'thranduils_gift', name: "Thranduil's Gift", cost: 2, dexterity: 2, block: 15, type: 'skill', rarity: 'rare' },
    // === ULTRA RARE (1) ===
    { id: 'legolas_mastery', name: 'Master Archer', cost: 3, damage: 10, hits: 5, dexterity: 2, type: 'attack', rarity: 'ultra_rare' }
  ],
  gandalf: [
    // === COMMON (50) ===
    { id: 'staff_strike', name: 'Staff Strike', cost: 1, damage: 5, type: 'attack', rarity: 'common' },
    { id: 'magic_barrier', name: 'Magic Barrier', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'spark', name: 'Spark', cost: 0, damage: 3, draw: 1, type: 'attack', rarity: 'common' },
    { id: 'lightning', name: 'Lightning Bolt', cost: 2, damage: 14, type: 'attack', rarity: 'common' },
    { id: 'flame_wave', name: 'Flame Wave', cost: 2, damage: 8, burn: 4, type: 'attack', rarity: 'common' },
    { id: 'arcane_shield', name: 'Arcane Shield', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'meditation', name: 'Meditation', cost: 1, draw: 2, block: 4, type: 'skill', rarity: 'common' },
    { id: 'channel', name: 'Channel', cost: 0, energy: 2, type: 'skill', rarity: 'common' },
    { id: 'minor_heal', name: 'Minor Heal', cost: 1, heal: 5, type: 'skill', rarity: 'common' },
    { id: 'arcane_bolt', name: 'Arcane Bolt', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'shield_charm', name: 'Shield Charm', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'fire_spark', name: 'Fire Spark', cost: 0, damage: 4, burn: 1, type: 'attack', rarity: 'common' },
    { id: 'mystic_ward', name: 'Mystic Ward', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'power_word', name: 'Power Word', cost: 0, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'flame_touch', name: 'Flame Touch', cost: 1, damage: 6, burn: 2, type: 'attack', rarity: 'common' },
    { id: 'mana_shield', name: 'Mana Shield', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'energy_tap', name: 'Energy Tap', cost: 0, energy: 1, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'frost_touch', name: 'Frost Touch', cost: 1, damage: 5, weak: 1, type: 'attack', rarity: 'common' },
    { id: 'barrier', name: 'Barrier', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'staff_sweep', name: 'Staff Sweep', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'light_ward', name: 'Light Ward', cost: 1, block: 6, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'magic_missile', name: 'Magic Missile', cost: 1, damage: 3, hits: 2, type: 'attack', rarity: 'common' },
    { id: 'wizards_guard', name: "Wizard's Guard", cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'cantrip', name: 'Cantrip', cost: 0, damage: 2, draw: 1, type: 'attack', rarity: 'common' },
    { id: 'arcane_ward', name: 'Arcane Ward', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'ember', name: 'Ember', cost: 0, damage: 4, type: 'attack', rarity: 'common' },
    { id: 'protection_spell', name: 'Protection Spell', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'minor_lightning', name: 'Minor Lightning', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'focus_mind', name: 'Focus Mind', cost: 0, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'flame_burst', name: 'Flame Burst', cost: 1, damage: 7, burn: 1, type: 'attack', rarity: 'common' },
    { id: 'mystic_shield', name: 'Mystic Shield', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'zap', name: 'Zap', cost: 0, damage: 5, type: 'attack', rarity: 'common' },
    { id: 'ward', name: 'Ward', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'staff_bash', name: 'Staff Bash', cost: 1, damage: 6, block: 3, type: 'attack', rarity: 'common' },
    { id: 'magical_defense', name: 'Magical Defense', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'fire_bolt', name: 'Fire Bolt', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'energy_shield', name: 'Energy Shield', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'shock', name: 'Shock', cost: 1, damage: 6, vulnerable: 1, type: 'attack', rarity: 'common' },
    { id: 'spell_barrier', name: 'Spell Barrier', cost: 1, block: 9, type: 'skill', rarity: 'common' },
    { id: 'heat_wave', name: 'Heat Wave', cost: 1, damage: 5, burn: 2, type: 'attack', rarity: 'common' },
    { id: 'wisdom', name: 'Wisdom', cost: 0, draw: 2, exhaust: true, type: 'skill', rarity: 'common' },
    { id: 'istar_strike', name: 'Istar Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'light_barrier', name: 'Light Barrier', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'quick_spell', name: 'Quick Spell', cost: 0, damage: 4, type: 'attack', rarity: 'common' },
    { id: 'mage_armor', name: 'Mage Armor', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'flame_jet', name: 'Flame Jet', cost: 1, damage: 6, burn: 2, type: 'attack', rarity: 'common' },
    { id: 'concentration', name: 'Concentration', cost: 0, draw: 1, energy: 1, type: 'skill', rarity: 'common' },
    { id: 'thunder_touch', name: 'Thunder Touch', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'circle_protection', name: 'Circle of Protection', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'bolt', name: 'Bolt', cost: 1, damage: 9, type: 'attack', rarity: 'common' },
    // === UNCOMMON (20) ===
    { id: 'inferno', name: 'Inferno', cost: 3, damage: 12, burn: 6, type: 'attack', rarity: 'uncommon' },
    { id: 'frost_nova', name: 'Frost Nova', cost: 2, damage: 6, weak: 2, vulnerable: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'mana_surge', name: 'Mana Surge', cost: 0, energy: 3, exhaust: true, type: 'skill', rarity: 'uncommon' },
    { id: 'arcane_intellect', name: 'Arcane Intellect', cost: 1, draw: 3, type: 'skill', rarity: 'uncommon' },
    { id: 'counterspell', name: 'Counterspell', cost: 2, block: 15, dexterity: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'gandalf_light', name: "Gandalf's Light", cost: 1, weak: 2, block: 8, type: 'skill', rarity: 'uncommon' },
    { id: 'secret_fire', name: 'Secret Fire', cost: 2, damage: 12, burn: 4, type: 'attack', rarity: 'uncommon' },
    { id: 'grey_wanderer', name: 'Grey Wanderer', cost: 1, draw: 2, heal: 4, type: 'skill', rarity: 'uncommon' },
    { id: 'maia_power', name: 'Maia Power', cost: 2, strength: 2, energy: 1, type: 'power', rarity: 'uncommon' },
    { id: 'flame_of_anor', name: 'Flame of Anor', cost: 2, damage: 16, type: 'attack', rarity: 'uncommon' },
    { id: 'glamdring', name: 'Glamdring Strike', cost: 2, damage: 14, vulnerable: 1, type: 'attack', rarity: 'uncommon' },
    { id: 'smoke_ring', name: 'Smoke Ring', cost: 1, block: 10, draw: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'chain_lightning', name: 'Chain Lightning', cost: 2, damage: 5, hits: 3, type: 'attack', rarity: 'uncommon' },
    { id: 'spell_mastery', name: 'Spell Mastery', cost: 1, strength: 1, dexterity: 1, type: 'power', rarity: 'uncommon' },
    { id: 'blinding_light', name: 'Blinding Light', cost: 1, weak: 3, type: 'skill', rarity: 'uncommon' },
    { id: 'mithrandir', name: 'Mithrandir', cost: 2, damage: 10, block: 10, type: 'attack', rarity: 'uncommon' },
    { id: 'dispel', name: 'Dispel', cost: 1, vulnerable: 2, weak: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'arcane_explosion', name: 'Arcane Explosion', cost: 2, damage: 15, type: 'attack', rarity: 'uncommon' },
    { id: 'radagast_aid', name: "Radagast's Aid", cost: 1, heal: 8, draw: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'word_of_command', name: 'Word of Command', cost: 1, draw: 2, energy: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'conflagration', name: 'Conflagration', cost: 2, burnSynergy: true, type: 'attack', rarity: 'uncommon', description: 'Deal damage equal to 3x the burn on enemy.' },
    { id: 'flame_wall', name: 'Flame Wall', cost: 2, block: 8, burn: 4, type: 'skill', rarity: 'uncommon', description: 'Gain 8 block. Apply 4 burn to enemy.' },
    // === RARE (10) ===
    { id: 'fireball', name: 'Fireball', cost: 2, damage: 10, burn: 3, type: 'attack', rarity: 'rare' },
    { id: 'illuminate', name: 'Illuminate', cost: 1, draw: 2, energy: 1, type: 'skill', rarity: 'rare' },
    { id: 'you_shall_not_pass', name: 'You Shall Not Pass!', cost: 4, damage: 35, block: 20, exhaust: true, type: 'attack', rarity: 'rare' },
    { id: 'white_light', name: 'White Light', cost: 2, damage: 10, heal: 10, type: 'attack', rarity: 'rare' },
    { id: 'wizard_staff', name: 'Staff of Power', cost: 3, strength: 3, dexterity: 2, type: 'power', rarity: 'rare' },
    { id: 'time_warp', name: 'Time Warp', cost: 2, draw: 4, energy: 2, exhaust: true, type: 'skill', rarity: 'rare' },
    { id: 'meteor', name: 'Meteor', cost: 4, damage: 25, burn: 8, vulnerable: 2, type: 'attack', rarity: 'rare' },
    { id: 'gandalf_white', name: 'Gandalf the White', cost: 3, strength: 2, heal: 15, draw: 2, type: 'power', rarity: 'rare' },
    { id: 'valinor_blessing', name: 'Blessing of Valinor', cost: 2, heal: 12, block: 12, type: 'skill', rarity: 'rare' },
    { id: 'istari_wisdom', name: 'Istari Wisdom', cost: 2, draw: 3, energy: 2, type: 'skill', rarity: 'rare' },
    // === ULTRA RARE (1) ===
    { id: 'gandalf_ascended', name: 'The White Rider', cost: 5, damage: 40, heal: 20, strength: 3, dexterity: 2, type: 'attack', rarity: 'ultra_rare' }
  ],
  // === COLORLESS CARDS (41) ===
  colorless: [
    // === COMMON (25) ===
    { id: 'second_wind', name: 'Second Wind', cost: 1, heal: 6, type: 'skill', rarity: 'common', colorless: true },
    { id: 'quick_thinking', name: 'Quick Thinking', cost: 0, draw: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'determination', name: 'Determination', cost: 1, block: 6, type: 'skill', rarity: 'common', colorless: true },
    { id: 'swift_strike', name: 'Swift Strike', cost: 1, damage: 6, type: 'attack', rarity: 'common', colorless: true },
    { id: 'brace', name: 'Brace', cost: 1, block: 7, type: 'skill', rarity: 'common', colorless: true },
    { id: 'hobbit_courage', name: 'Hobbit Courage', cost: 0, strength: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'shire_luck', name: 'Shire Luck', cost: 0, draw: 1, block: 2, type: 'skill', rarity: 'common', colorless: true },
    { id: 'road_goes_ever', name: 'Road Goes Ever On', cost: 1, draw: 2, type: 'skill', rarity: 'common', colorless: true },
    { id: 'elvish_rope', name: 'Elvish Rope', cost: 1, block: 5, draw: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'stew_pot', name: "Sam's Stew", cost: 1, heal: 4, block: 4, type: 'skill', rarity: 'common', colorless: true },
    { id: 'pipe_weed', name: 'Pipe Weed', cost: 0, draw: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'old_toby', name: 'Old Toby', cost: 1, heal: 3, draw: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'elvish_waybread', name: 'Elvish Waybread', cost: 1, heal: 5, energy: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'rivendell_rest', name: 'Rivendell Rest', cost: 1, heal: 6, type: 'skill', rarity: 'common', colorless: true },
    { id: 'gondor_shield', name: 'Gondor Shield', cost: 1, block: 8, type: 'skill', rarity: 'common', colorless: true },
    { id: 'rohan_charge', name: 'Rohan Charge', cost: 1, damage: 7, type: 'attack', rarity: 'common', colorless: true },
    { id: 'mordor_survivor', name: 'Mordor Survivor', cost: 0, block: 4, type: 'skill', rarity: 'common', colorless: true },
    { id: 'helm_deep_stand', name: "Helm's Deep Stand", cost: 1, block: 6, strength: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'eagles_sight', name: "Eagle's Sight", cost: 0, draw: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'lorien_gift', name: 'Gift of Lorien', cost: 1, heal: 4, draw: 1, type: 'skill', rarity: 'common', colorless: true },
    { id: 'minas_tirith', name: 'Minas Tirith Guard', cost: 1, block: 7, type: 'skill', rarity: 'common', colorless: true },
    { id: 'isengard_strike', name: 'Isengard Strike', cost: 1, damage: 8, type: 'attack', rarity: 'common', colorless: true },
    { id: 'dead_marshes', name: 'Dead Marshes', cost: 1, weak: 2, type: 'skill', rarity: 'common', colorless: true },
    { id: 'fangorn_strength', name: 'Fangorn Strength', cost: 1, strength: 1, block: 3, type: 'skill', rarity: 'common', colorless: true },
    { id: 'prancing_pony', name: 'Prancing Pony Rest', cost: 1, heal: 5, type: 'skill', rarity: 'common', colorless: true },
    // === UNCOMMON (10) ===
    { id: 'fellowship_bond', name: 'Fellowship Bond', cost: 1, strength: 1, dexterity: 1, type: 'skill', rarity: 'uncommon', colorless: true },
    { id: 'eagles_coming', name: 'The Eagles Are Coming', cost: 2, damage: 12, heal: 8, type: 'attack', rarity: 'uncommon', colorless: true },
    { id: 'gollum_trick', name: "Gollum's Trick", cost: 1, draw: 2, weak: 1, type: 'skill', rarity: 'uncommon', colorless: true },
    { id: 'ent_draught', name: 'Ent Draught', cost: 2, heal: 12, strength: 1, type: 'skill', rarity: 'uncommon', colorless: true },
    { id: 'rohirrim_charge', name: 'Rohirrim Charge', cost: 2, damage: 15, type: 'attack', rarity: 'uncommon', colorless: true },
    { id: 'gondor_calls', name: 'Gondor Calls for Aid', cost: 1, block: 10, draw: 1, type: 'skill', rarity: 'uncommon', colorless: true },
    { id: 'tom_bombadil', name: "Tom Bombadil's Song", cost: 1, heal: 8, weak: 2, type: 'skill', rarity: 'uncommon', colorless: true },
    { id: 'beorns_rage', name: "Beorn's Rage", cost: 2, damage: 12, strength: 2, type: 'attack', rarity: 'uncommon', colorless: true },
    { id: 'grey_company', name: 'Grey Company', cost: 2, damage: 8, block: 8, type: 'attack', rarity: 'uncommon', colorless: true },
    { id: 'treebeard_march', name: "Treebeard's March", cost: 2, damage: 10, vulnerable: 2, type: 'attack', rarity: 'uncommon', colorless: true },
    // === RARE (5) ===
    { id: 'one_ring_power', name: "The One Ring's Power", cost: 0, draw: 3, energy: 2, exhaust: true, type: 'skill', rarity: 'rare', colorless: true },
    { id: 'ride_of_rohirrim', name: 'Ride of the Rohirrim', cost: 3, damage: 20, block: 10, type: 'attack', rarity: 'rare', colorless: true },
    { id: 'death_or_glory', name: 'Death or Glory', cost: 2, damage: 25, exhaust: true, type: 'attack', rarity: 'rare', colorless: true },
    { id: 'samwise_courage', name: "Samwise's Courage", cost: 2, strength: 2, dexterity: 2, heal: 10, type: 'skill', rarity: 'rare', colorless: true },
    { id: 'frodo_resolve', name: "Frodo's Resolve", cost: 2, block: 20, heal: 8, type: 'skill', rarity: 'rare', colorless: true },
    // === ULTRA RARE (1) ===
    { id: 'destroying_ring', name: 'Destroy the Ring', cost: 4, damage: 50, heal: 25, exhaust: true, type: 'attack', rarity: 'ultra_rare', colorless: true }
  ],
  gimli: [
    // === COMMON (50) ===
    { id: 'axe_strike', name: 'Axe Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'dwarf_guard', name: 'Dwarf Guard', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'heavy_axe', name: 'Heavy Axe', cost: 2, damage: 14, type: 'attack', rarity: 'common' },
    { id: 'iron_skin', name: 'Iron Skin', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'cleaving_blow', name: 'Cleaving Blow', cost: 1, damage: 5, hits: 2, type: 'attack', rarity: 'common' },
    { id: 'moria_stance', name: 'Moria Stance', cost: 1, block: 5, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'battle_axe', name: 'Battle Axe', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'stone_wall', name: 'Stone Wall', cost: 2, block: 12, type: 'skill', rarity: 'common' },
    { id: 'quick_chop', name: 'Quick Chop', cost: 0, damage: 4, type: 'attack', rarity: 'common' },
    { id: 'dwarven_mail', name: 'Dwarven Mail', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'reckless_swing', name: 'Reckless Swing', cost: 2, damage: 12, type: 'attack', rarity: 'common' },
    { id: 'mountain_endurance', name: 'Mountain Endurance', cost: 1, block: 6, heal: 2, type: 'skill', rarity: 'common' },
    { id: 'throwing_axe', name: 'Throwing Axe', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'khazad_guard', name: 'Khazad Guard', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'savage_cut', name: 'Savage Cut', cost: 1, damage: 9, type: 'attack', rarity: 'common' },
    { id: 'dwarven_resilience', name: 'Dwarven Resilience', cost: 1, block: 4, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'beard_bash', name: 'Beard Bash', cost: 1, damage: 6, block: 3, type: 'attack', rarity: 'common' },
    { id: 'erebor_shield', name: 'Erebor Shield', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'fury_strike', name: 'Fury Strike', cost: 1, damage: 10, type: 'attack', rarity: 'common' },
    { id: 'cave_knowledge', name: 'Cave Knowledge', cost: 0, block: 3, draw: 1, type: 'skill', rarity: 'common' },
    { id: 'double_axe', name: 'Double Axe', cost: 1, damage: 4, hits: 2, type: 'attack', rarity: 'common' },
    { id: 'iron_resolve', name: 'Iron Resolve', cost: 1, block: 9, type: 'skill', rarity: 'common' },
    { id: 'miner_strike', name: 'Miner Strike', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'stone_skin', name: 'Stone Skin', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'berserker_chop', name: 'Berserker Chop', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'durin_blessing', name: "Durin's Blessing", cost: 0, block: 4, type: 'skill', rarity: 'common' },
    { id: 'hammer_blow', name: 'Hammer Blow', cost: 1, damage: 7, vulnerable: 1, type: 'attack', rarity: 'common' },
    { id: 'mountain_guard', name: 'Mountain Guard', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'grudge_strike', name: 'Grudge Strike', cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'ancestral_armor', name: 'Ancestral Armor', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'pickaxe_swing', name: 'Pickaxe Swing', cost: 1, damage: 6, type: 'attack', rarity: 'common' },
    { id: 'steady_stance', name: 'Steady Stance', cost: 1, block: 5, dexterity: 1, type: 'skill', rarity: 'common' },
    { id: 'rage_blow', name: 'Rage Blow', cost: 2, damage: 11, type: 'attack', rarity: 'common' },
    { id: 'blue_mountain_guard', name: 'Blue Mountain Guard', cost: 1, block: 7, type: 'skill', rarity: 'common' },
    { id: 'tunnel_fighter', name: 'Tunnel Fighter', cost: 0, damage: 5, type: 'attack', rarity: 'common' },
    { id: 'forge_hardened', name: 'Forge Hardened', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'wrath_chop', name: 'Wrath Chop', cost: 1, damage: 9, type: 'attack', rarity: 'common' },
    { id: 'dwarven_stoicism', name: 'Dwarven Stoicism', cost: 1, block: 8, type: 'skill', rarity: 'common' },
    { id: 'underground_assault', name: 'Underground Assault', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'gold_greed', name: 'Gold Greed', cost: 0, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'axe_flurry', name: 'Axe Flurry', cost: 2, damage: 3, hits: 3, type: 'attack', rarity: 'common' },
    { id: 'stone_heart', name: 'Stone Heart', cost: 1, block: 6, type: 'skill', rarity: 'common' },
    { id: 'gloin_strike', name: "Gloin's Strike", cost: 1, damage: 8, type: 'attack', rarity: 'common' },
    { id: 'deep_roots', name: 'Deep Roots', cost: 1, block: 5, heal: 3, type: 'skill', rarity: 'common' },
    { id: 'dwarven_fury', name: 'Dwarven Fury', cost: 1, damage: 10, type: 'attack', rarity: 'common' },
    { id: 'mountain_resolve', name: 'Mountain Resolve', cost: 1, block: 9, type: 'skill', rarity: 'common' },
    { id: 'veteran_chop', name: 'Veteran Chop', cost: 1, damage: 7, type: 'attack', rarity: 'common' },
    { id: 'erebor_stance', name: 'Erebor Stance', cost: 1, block: 6, strength: 1, type: 'skill', rarity: 'common' },
    { id: 'grudge_bearer', name: 'Grudge Bearer', cost: 0, damage: 4, draw: 1, type: 'attack', rarity: 'common' },
    { id: 'iron_fortress', name: 'Iron Fortress', cost: 2, block: 10, type: 'skill', rarity: 'common' },
    // NEW: Additional strength scaling cards for better Gimli progression
    { id: 'dwarven_warcry', name: 'Dwarven Warcry', cost: 1, strength: 2, type: 'skill', rarity: 'common', description: 'Gain 2 Strength. Let loose a battle cry!' },
    { id: 'grudge_fuel', name: 'Grudge Fuel', cost: 0, strength: 1, selfDamage: 3, type: 'skill', rarity: 'common', description: 'Take 3 damage. Gain 1 Strength. Pain fuels the fury.' },
    { id: 'ancestral_fury', name: 'Ancestral Fury', cost: 1, strength: 1, damage: 6, type: 'attack', rarity: 'common', description: 'Deal 6 damage. Gain 1 Strength.' },
    // === UNCOMMON (20) ===
    { id: 'baruk_khazad', name: 'Baruk KhazÃ¢d!', cost: 2, damage: 15, type: 'attack', rarity: 'uncommon' },
    { id: 'mithril_armor', name: 'Mithril Armor', cost: 2, block: 18, type: 'skill', rarity: 'uncommon' },
    { id: 'counter_strike', name: 'Counter Strike', cost: 1, damage: 8, block: 6, type: 'attack', rarity: 'uncommon' },
    { id: 'dwarven_rage', name: 'Dwarven Rage', cost: 0, strength: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'orc_slayer', name: 'Orc Slayer', cost: 2, damage: 10, hits: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'stone_fortress', name: 'Stone Fortress', cost: 2, block: 15, type: 'skill', rarity: 'uncommon' },
    { id: 'berserk', name: 'Berserk', cost: 0, energy: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'ancestral_wrath', name: 'Ancestral Wrath', cost: 2, damage: 18, type: 'attack', rarity: 'uncommon' },
    { id: 'mountain_king', name: 'Mountain King', cost: 2, strength: 2, block: 8, type: 'skill', rarity: 'uncommon' },
    { id: 'cave_in', name: 'Cave In', cost: 2, damage: 12, vulnerable: 2, type: 'attack', rarity: 'uncommon' },
    { id: 'thorin_legacy', name: "Thorin's Legacy", cost: 1, strength: 1, draw: 2, type: 'skill', rarity: 'uncommon' },
    { id: 'durin_vengeance', name: "Durin's Vengeance", cost: 2, damage: 20, exhaust: true, type: 'attack', rarity: 'uncommon' },
    { id: 'iron_will', name: 'Iron Will', cost: 1, block: 10, draw: 1, type: 'skill', rarity: 'uncommon' },
    { id: 'execution', name: 'Execution', cost: 2, damage: 14, vulnerable: 1, type: 'attack', rarity: 'uncommon' },
    { id: 'deep_delving', name: 'Deep Delving', cost: 1, heal: 8, block: 5, type: 'skill', rarity: 'uncommon' },
    { id: 'whirlwind_axe', name: 'Whirlwind Axe', cost: 2, damage: 6, hits: 3, type: 'attack', rarity: 'uncommon' },
    { id: 'dwarven_fortitude', name: 'Dwarven Fortitude', cost: 2, dexterity: 2, strength: 1, type: 'power', rarity: 'uncommon' },
    { id: 'gold_fever', name: 'Gold Fever', cost: 1, damage: 12, type: 'attack', rarity: 'uncommon' },
    { id: 'erebor_heritage', name: 'Erebor Heritage', cost: 1, block: 8, heal: 4, type: 'skill', rarity: 'uncommon' },
    { id: 'grudge_keeper', name: 'Grudge Keeper', cost: 2, damage: 10, strength: 1, type: 'attack', rarity: 'uncommon' },
    // === RARE (10) ===
    { id: 'khazad_dum', name: 'Khazad-dÃ»m', cost: 3, damage: 25, type: 'attack', rarity: 'rare' },
    { id: 'durin_crown', name: "Durin's Crown", cost: 2, strength: 3, type: 'power', rarity: 'rare' },
    { id: 'battle_fury', name: 'Battle Fury', cost: 2, damage: 8, hits: 3, type: 'attack', rarity: 'rare' },
    { id: 'mithril_coat_card', name: 'Mithril Coat', cost: 2, block: 25, type: 'skill', rarity: 'rare' },
    { id: 'erebor_king', name: 'King Under the Mountain', cost: 3, strength: 2, dexterity: 2, draw: 2, type: 'power', rarity: 'rare' },
    { id: 'axe_master', name: 'Axe Master', cost: 2, damage: 12, hits: 2, type: 'attack', rarity: 'rare' },
    { id: 'dwarven_last_stand', name: 'Dwarven Last Stand', cost: 2, damage: 30, block: 15, exhaust: true, type: 'attack', rarity: 'rare' },
    { id: 'stone_giant', name: 'Stone Giant', cost: 3, block: 30, strength: 1, type: 'skill', rarity: 'rare' },
    { id: 'ancestors_might', name: "Ancestors' Might", cost: 2, strength: 2, heal: 10, type: 'power', rarity: 'rare' },
    { id: 'champion_of_erebor', name: 'Champion of Erebor', cost: 3, damage: 20, vulnerable: 2, type: 'attack', rarity: 'rare' },
    // === ULTRA RARE (1) ===
    { id: 'son_of_gloin', name: 'Son of GlÃ³in', cost: 4, strength: 4, dexterity: 3, damage: 15, heal: 15, type: 'attack', rarity: 'ultra_rare' }
  ]
};


// ============================================
// STYLES
// ============================================
const styles = {
  app: {
    minHeight: '100vh',
    background: 'linear-gradient(135deg, #0d0705 0%, #1a0f08 25%, #2c1810 50%, #1a0f08 75%, #0d0705 100%)',
    color: '#f4e4bc',
    fontFamily: "'Cinzel', 'Georgia', serif",
    WebkitTapHighlightColor: 'transparent',
    touchAction: 'manipulation',
    position: 'relative',
    overflow: 'hidden',
  },
  backgroundOverlay: {
    position: 'fixed',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundImage: `url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d4af37' fill-opacity='0.03'/%3E%3C/svg%3E")`,
    pointerEvents: 'none',
    zIndex: 0,
  },
  contentWrapper: {
    position: 'relative',
    zIndex: 1,
    padding: '20px',
    minHeight: '100vh',
  },
  menuScreen: {
    textAlign: 'center',
    maxWidth: '800px',
    margin: 'clamp(10px, 3vw, 40px) auto',
    padding: 'clamp(20px, 5vw, 50px) clamp(15px, 4vw, 40px)',
    background: 'linear-gradient(145deg, rgba(45, 25, 15, 0.95) 0%, rgba(20, 10, 5, 0.98) 100%)',
    borderRadius: '24px',
    border: '3px solid transparent',
    borderImage: 'linear-gradient(135deg, #d4af37, #8b6914, #d4af37) 1',
    boxShadow: '0 0 60px rgba(212, 175, 55, 0.25), 0 20px 60px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.1)',
    position: 'relative',
    overflow: 'hidden',
  },
  menuDecoration: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    height: '4px',
    background: 'linear-gradient(90deg, transparent, #d4af37, transparent)',
  },
  menuTitle: {
    fontSize: 'clamp(1.5rem, 5vw, 3.5rem)',
    marginBottom: '8px',
    color: '#d4af37',
    textShadow: '0 2px 4px rgba(0,0,0,0.8), 0 0 40px rgba(212, 175, 55, 0.5)',
    fontWeight: '700',
    letterSpacing: '3px',
    textTransform: 'uppercase',
  },
  menuSubtitle: {
    color: '#c4a875',
    marginBottom: '30px',
    fontSize: 'clamp(1rem, 2vw, 1.4rem)',
    fontStyle: 'italic',
    letterSpacing: '2px',
    opacity: 0.9,
  },
  menuDescription: {
    marginBottom: '35px',
    fontSize: '1.1rem',
    lineHeight: '1.9',
    color: '#a89878',
    maxWidth: '600px',
    margin: '0 auto 35px',
  },
  button: {
    background: 'linear-gradient(145deg, #8b4513, #5a2d0a)',
    color: '#f4e4bc',
    border: '2px solid #d4af37',
    padding: 'clamp(12px, 2vw, 16px) clamp(20px, 4vw, 32px)',
    margin: '10px',
    borderRadius: '12px',
    fontSize: '1.1rem',
    cursor: 'pointer',
    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
    fontFamily: 'inherit',
    boxShadow: '0 4px 15px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15)',
    textShadow: '1px 1px 2px rgba(0,0,0,0.8)',
    fontWeight: '600',
    letterSpacing: '1px',
    position: 'relative',
    overflow: 'hidden',
  },
  characterSelect: {
    maxWidth: '1000px',
    margin: '0 auto',
    textAlign: 'center',
    padding: '30px 20px',
  },
  characterGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fit, minmax(min(280px, 90vw), 1fr))',
    gap: '40px',
    marginTop: '40px',
    padding: '0 20px',
  },
  characterCard: {
    background: 'linear-gradient(145deg, rgba(139, 69, 19, 0.3) 0%, rgba(30, 15, 8, 0.6) 100%)',
    border: '2px solid rgba(212, 175, 55, 0.5)',
    borderRadius: '20px',
    padding: '30px',
    cursor: 'pointer',
    transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
    boxShadow: '0 10px 40px rgba(0,0,0,0.5)',
    position: 'relative',
    overflow: 'hidden',
  },
  characterClass: {
    color: '#d4af37',
    fontWeight: 'bold',
    fontSize: '1.15rem',
    marginTop: '8px',
    letterSpacing: '2px',
    textTransform: 'uppercase',
  },
  characterStats: {
    margin: '20px 0',
    padding: '15px',
    background: 'rgba(0,0,0,0.4)',
    borderRadius: '12px',
    border: '1px solid rgba(212, 175, 55, 0.2)',
  },
  mapScreen: {
    maxWidth: '1100px',
    margin: '0 auto',
    padding: '20px',
  },
  characterInfo: {
    background: 'linear-gradient(145deg, rgba(139, 69, 19, 0.35) 0%, rgba(30, 15, 8, 0.5) 100%)',
    border: '2px solid #d4af37',
    borderRadius: '16px',
    padding: '25px',
    marginBottom: '40px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    gap: '30px',
    boxShadow: '0 8px 30px rgba(0,0,0,0.5)',
  },
  encounterPath: {
    display: 'flex',
    justifyContent: 'center',
    flexWrap: 'wrap',
    margin: '30px 0',
    gap: '20px',
    position: 'relative',
  },
  encounterNode: {
    background: 'linear-gradient(145deg, rgba(139, 69, 19, 0.4) 0%, rgba(50, 25, 12, 0.6) 100%)',
    border: '2px solid rgba(139, 69, 19, 0.6)',
    borderRadius: '16px',
    padding: '20px',
    cursor: 'pointer',
    transition: 'all 0.35s cubic-bezier(0.4, 0, 0.2, 1)',
    minWidth: '140px',
    textAlign: 'center',
    boxShadow: '0 6px 20px rgba(0,0,0,0.4)',
    position: 'relative',
  },
  encounterNodeCurrent: {
    borderColor: '#d4af37',
    boxShadow: '0 0 30px rgba(212, 175, 55, 0.5), 0 8px 30px rgba(0,0,0,0.5)',
    transform: 'scale(1.08)',
    background: 'linear-gradient(145deg, rgba(139, 69, 19, 0.5) 0%, rgba(60, 30, 15, 0.7) 100%)',
  },
  encounterNodeCompleted: {
    background: 'linear-gradient(145deg, rgba(34, 100, 34, 0.35) 0%, rgba(15, 50, 15, 0.5) 100%)',
    borderColor: '#228b22',
  },
  encounterNodeLocked: {
    opacity: 0.5,
    filter: 'grayscale(30%)',
  },
  combatScreen: {
    maxWidth: '1300px',
    margin: '0 auto',
    display: 'grid',
    gridTemplateRows: 'auto auto 1fr auto auto',
    minHeight: 'calc(100vh - 40px)',
    gap: '15px',
    padding: '10px',
  },
  enemyArea: {
    textAlign: 'center',
    padding: '20px',
    display: 'flex',
    justifyContent: 'center',
  },
  enemyCard: {
    background: 'linear-gradient(145deg, rgba(139, 20, 20, 0.35) 0%, rgba(60, 10, 10, 0.5) 100%)',
    border: '3px solid #dc143c',
    borderRadius: '16px',
    padding: '25px',
    display: 'inline-block',
    minWidth: '280px',
    boxShadow: '0 0 40px rgba(220, 20, 60, 0.25), 0 10px 30px rgba(0,0,0,0.5)',
  },
  hpBar: {
    background: 'linear-gradient(90deg, #1a1a1a, #2d2d2d)',
    borderRadius: '12px',
    overflow: 'hidden',
    margin: '12px 0',
    position: 'relative',
    height: '28px',
    border: '2px solid #555',
    boxShadow: 'inset 0 2px 6px rgba(0,0,0,0.5)',
  },
  hpFill: {
    background: 'linear-gradient(90deg, #8b0000, #dc143c, #ff4500)',
    height: '100%',
    transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
    boxShadow: 'inset 0 -3px 6px rgba(0,0,0,0.3), 0 0 10px rgba(220, 20, 60, 0.3)',
  },
  hpText: {
    position: 'absolute',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    fontSize: '13px',
    fontWeight: 'bold',
    textShadow: '1px 1px 3px #000',
    color: '#fff',
  },
  statusEffect: {
    display: 'inline-flex',
    alignItems: 'center',
    justifyContent: 'center',
    background: 'rgba(0,0,0,0.6)',
    borderRadius: '8px',
    padding: '6px 10px',
    margin: '4px',
    fontSize: '14px',
    border: '1px solid rgba(255,255,255,0.2)',
    boxShadow: '0 2px 6px rgba(0,0,0,0.3)',
  },
  playerArea: {
    textAlign: 'center',
    padding: '15px',
  },
  playerInfo: {
    background: 'linear-gradient(145deg, rgba(34, 100, 34, 0.35) 0%, rgba(15, 50, 15, 0.5) 100%)',
    border: '3px solid #228b22',
    borderRadius: '16px',
    padding: '18px 30px',
    display: 'inline-flex',
    alignItems: 'center',
    gap: '20px',
    boxShadow: '0 0 30px rgba(34, 139, 34, 0.25), 0 8px 25px rgba(0,0,0,0.4)',
  },
  combatLog: {
    background: 'linear-gradient(145deg, rgba(0,0,0,0.7) 0%, rgba(20,15,10,0.8) 100%)',
    borderRadius: '12px',
    padding: '15px',
    maxHeight: '120px',
    overflowY: 'auto',
    margin: '10px 30px',
    border: '1px solid rgba(212, 175, 55, 0.2)',
    boxShadow: 'inset 0 2px 10px rgba(0,0,0,0.5)',
  },
  logEntry: {
    margin: '6px 0',
    padding: '6px 12px',
    borderBottom: '1px solid rgba(244, 228, 188, 0.1)',
    fontSize: '13px',
    color: '#c4b89a',
  },
  handArea: {
    background: 'linear-gradient(0deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 50%, transparent 100%)',
    borderRadius: '20px 20px 0 0',
    padding: '25px',
    borderTop: '2px solid rgba(212, 175, 55, 0.4)',
    marginTop: 'auto',
  },
  hand: {
    display: 'flex',
    justifyContent: 'center',
    flexWrap: 'wrap',
    gap: 'clamp(8px, 2vw, 15px)',
    marginBottom: '20px',
    minHeight: '180px',
    alignItems: 'flex-end',
  },
  card: {
    width: 'clamp(100px, 18vw, 140px)',
    minHeight: 'clamp(140px, 25vw, 190px)',
    cursor: 'pointer',
    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
    position: 'relative',
    transformStyle: 'preserve-3d',
  },
  cardInner: {
    padding: '10px',
    height: '100%',
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
  },
  cardUnplayable: {
    opacity: 0.45,
    cursor: 'not-allowed',
    filter: 'grayscale(60%) brightness(0.7)',
  },
  cardCost: {
    position: 'absolute',
    top: '-12px',
    left: '-12px',
    background: 'linear-gradient(145deg, #ffd700, #b8960c)',
    color: '#000',
    borderRadius: '50%',
    width: '32px',
    height: '32px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontWeight: 'bold',
    fontSize: '15px',
    border: '2px solid #8b6914',
    boxShadow: '0 3px 8px rgba(0,0,0,0.5)',
    zIndex: 10,
  },
  cardArt: {
    width: '55px',
    height: '55px',
    margin: '8px 0',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    background: 'rgba(0,0,0,0.4)',
    borderRadius: '8px',
    border: '1px solid rgba(212,175,55,0.3)',
  },
  cardName: {
    fontWeight: 'bold',
    marginBottom: '6px',
    fontSize: '11px',
    textAlign: 'center',
    color: '#f4e4bc',
    textShadow: '1px 1px 2px #000',
  },
  cardEffects: {
    fontSize: '10px',
    textAlign: 'center',
    color: '#c4b89a',
    lineHeight: '1.4',
  },
  combatActions: {
    textAlign: 'center',
    marginTop: '10px',
  },
  endTurnBtn: {
    background: 'linear-gradient(145deg, #dc143c, #8b0000)',
    borderColor: '#ff6b6b',
    boxShadow: '0 0 20px rgba(220, 20, 60, 0.4), 0 4px 15px rgba(0,0,0,0.4)',
    padding: '18px 40px',
    fontSize: '1.15rem',
  },
  enemyTurnIndicator: {
    color: '#ff6b6b',
    fontWeight: 'bold',
    padding: '18px',
    fontSize: '1.3rem',
    textShadow: '0 0 20px rgba(255, 107, 107, 0.5)',
  },
  deckInfo: {
    textAlign: 'center',
    marginTop: '15px',
    padding: '12px',
    background: 'rgba(0,0,0,0.4)',
    borderRadius: '10px',
    display: 'flex',
    justifyContent: 'center',
    gap: '40px',
  },
  rewardsScreen: {
    textAlign: 'center',
    maxWidth: '650px',
    margin: '50px auto',
    padding: '50px',
    background: 'linear-gradient(145deg, rgba(45, 25, 15, 0.95) 0%, rgba(20, 10, 5, 0.98) 100%)',
    borderRadius: '24px',
    border: '3px solid #d4af37',
    boxShadow: '0 0 60px rgba(212, 175, 55, 0.35), 0 20px 60px rgba(0,0,0,0.6)',
  },
  rewardBtn: {
    display: 'block',
    margin: '18px auto',
    width: '300px',
  },
  deckView: {
    maxWidth: '1000px',
    margin: '0 auto',
    padding: '30px 20px',
  },
  deckGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fill, minmax(160px, 1fr))',
    gap: '20px',
    margin: '25px 0',
  },
  deckCard: {
    background: 'rgba(139, 69, 19, 0.35)',
    border: '2px solid rgba(212, 175, 55, 0.5)',
    borderRadius: '12px',
    padding: '15px',
    textAlign: 'center',
    transition: 'all 0.3s ease',
  },
  cardType: {
    fontSize: '11px',
    color: '#888',
    marginTop: '6px',
    textTransform: 'uppercase',
    letterSpacing: '1px',
  },
  mapActions: {
    textAlign: 'center',
    marginTop: '40px',
  },
  intentIcon: {
    display: 'inline-flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '8px 14px',
    background: 'rgba(0,0,0,0.6)',
    borderRadius: '8px',
    marginTop: '12px',
    fontSize: '15px',
    border: '1px solid rgba(255, 0, 0, 0.3)',
  },
  gameOver: {
    textAlign: 'center',
    maxWidth: '600px',
    margin: '80px auto',
    padding: '50px',
    background: 'linear-gradient(145deg, rgba(60, 20, 20, 0.95) 0%, rgba(30, 10, 10, 0.98) 100%)',
    borderRadius: '24px',
    border: '3px solid #dc143c',
    boxShadow: '0 0 60px rgba(220, 20, 60, 0.3), 0 20px 60px rgba(0,0,0,0.6)',
  },
  restSite: {
    textAlign: 'center',
    maxWidth: '900px',
    margin: '40px auto',
    padding: '40px',
    background: 'linear-gradient(145deg, rgba(30, 50, 30, 0.95) 0%, rgba(15, 30, 15, 0.98) 100%)',
    borderRadius: '24px',
    border: '3px solid #228b22',
    boxShadow: '0 0 60px rgba(34, 139, 34, 0.3), 0 20px 60px rgba(0,0,0,0.6)',
  },
  upgradeGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))',
    gap: '15px',
    margin: '25px 0',
    maxHeight: '400px',
    overflowY: 'auto',
    padding: '10px',
  },
  relicDisplay: {
    display: 'flex',
    gap: '10px',
    flexWrap: 'wrap',
    justifyContent: 'center',
    margin: '15px 0',
  },
  relicBadge: {
    background: 'rgba(212, 175, 55, 0.2)',
    border: '1px solid #d4af37',
    borderRadius: '8px',
    padding: '8px 12px',
    fontSize: '0.9rem',
    display: 'flex',
    alignItems: 'center',
    gap: '6px',
  },
  shopScreen: {
    textAlign: 'center',
    maxWidth: '1000px',
    margin: '30px auto',
    padding: '40px',
    background: 'linear-gradient(145deg, rgba(60, 40, 20, 0.95) 0%, rgba(30, 20, 10, 0.98) 100%)',
    borderRadius: '24px',
    border: '3px solid #d4af37',
    boxShadow: '0 0 60px rgba(212, 175, 55, 0.25), 0 20px 60px rgba(0,0,0,0.6)',
  },
  shopSection: {
    margin: '25px 0',
    padding: '20px',
    background: 'rgba(0,0,0,0.3)',
    borderRadius: '12px',
  },
  shopItem: {
    background: 'rgba(139, 69, 19, 0.3)',
    border: '2px solid rgba(212, 175, 55, 0.4)',
    borderRadius: '12px',
    padding: '15px',
    cursor: 'pointer',
    transition: 'all 0.3s ease',
    display: 'inline-block',
    margin: '10px',
    minWidth: '140px',
    verticalAlign: 'top',
  },
  difficultySelector: {
    display: 'flex',
    justifyContent: 'center',
    gap: '15px',
    flexWrap: 'wrap',
    margin: '30px 0',
  },
  difficultyOption: {
    background: 'rgba(139, 69, 19, 0.3)',
    border: '2px solid rgba(212, 175, 55, 0.4)',
    borderRadius: '12px',
    padding: '15px 25px',
    cursor: 'pointer',
    transition: 'all 0.3s ease',
    minWidth: '140px',
    textAlign: 'center',
  },
  difficultySelected: {
    borderColor: '#d4af37',
    boxShadow: '0 0 20px rgba(212, 175, 55, 0.4)',
    background: 'rgba(212, 175, 55, 0.2)',
  },
  shopPrice: {
    color: '#ffd700',
    fontWeight: 'bold',
    marginTop: '8px',
    fontSize: '1rem',
  },
  relicChoice: {
    background: 'rgba(212, 175, 55, 0.15)',
    border: '2px solid rgba(212, 175, 55, 0.5)',
    borderRadius: '12px',
    padding: '20px',
    cursor: 'pointer',
    transition: 'all 0.3s ease',
    textAlign: 'center',
    minWidth: '150px',
  },
  upgradeCard: {
    background: 'rgba(34, 139, 34, 0.2)',
    border: '2px solid rgba(144, 238, 144, 0.5)',
    borderRadius: '12px',
    padding: '12px',
    cursor: 'pointer',
    transition: 'all 0.3s ease',
  },
  victory: {
    textAlign: 'center',
    maxWidth: '700px',
    margin: '60px auto',
    padding: '60px',
    background: 'linear-gradient(145deg, rgba(40, 60, 40, 0.95) 0%, rgba(20, 40, 20, 0.98) 100%)',
    borderRadius: '24px',
    border: '3px solid #90ee90',
    boxShadow: '0 0 80px rgba(144, 238, 144, 0.3), 0 20px 60px rgba(0,0,0,0.6)',
  },
  tooltip: {
    position: 'absolute',
    bottom: '105%',
    left: '50%',
    transform: 'translateX(-50%)',
    background: 'linear-gradient(145deg, rgba(30, 20, 10, 0.98) 0%, rgba(15, 10, 5, 0.99) 100%)',
    border: '2px solid #d4af37',
    borderRadius: '8px',
    padding: '10px 14px',
    minWidth: '180px',
    maxWidth: '250px',
    zIndex: 1000,
    boxShadow: '0 4px 20px rgba(0,0,0,0.8)',
    fontSize: '12px',
    textAlign: 'left',
    pointerEvents: 'none',
  },
  tooltipTitle: {
    color: '#d4af37',
    fontWeight: 'bold',
    fontSize: '13px',
    marginBottom: '6px',
    borderBottom: '1px solid rgba(212,175,55,0.3)',
    paddingBottom: '4px',
  },
  tooltipText: {
    color: '#c4b89a',
    lineHeight: '1.4',
  },
  pileViewer: {
    position: 'fixed',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    background: 'linear-gradient(145deg, rgba(30, 20, 10, 0.98) 0%, rgba(15, 10, 5, 0.99) 100%)',
    border: '3px solid #d4af37',
    borderRadius: '16px',
    padding: '25px',
    maxWidth: '800px',
    maxHeight: '80vh',
    overflowY: 'auto',
    zIndex: 2000,
    boxShadow: '0 0 60px rgba(0,0,0,0.9)',
  },
  pileViewerOverlay: {
    position: 'fixed',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'rgba(0,0,0,0.7)',
    zIndex: 1999,
  },
};

// ============================================
// ONE RING BUTTON COMPONENT
// ============================================
const OneRingButton = ({ player, corruption, onActivate, disabled }) => {
  const hasRing = player.relics?.some(r => r === 'one_ring');
  const isActive = player.ringActive;
  
  if (!hasRing) return null;
  
  const wouldKill = corruption + 15 >= 100;
  
  return (
    <div style={{ position: 'relative', display: 'inline-block' }}>
      <button
        onClick={onActivate}
        disabled={disabled || isActive}
        style={{
          background: isActive 
            ? 'linear-gradient(145deg, #ff6600, #993300)'
            : wouldKill 
              ? 'linear-gradient(145deg, #660000, #330000)'
              : 'linear-gradient(145deg, #d4af37, #8b7355)',
          border: `2px solid ${isActive ? '#ff9900' : wouldKill ? '#ff0000' : '#ffd700'}`,
          borderRadius: '50%',
          width: '50px',
          height: '50px',
          cursor: disabled || isActive ? 'not-allowed' : 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: '1.5rem',
          boxShadow: isActive 
            ? '0 0 20px rgba(255, 102, 0, 0.8), inset 0 0 10px rgba(0,0,0,0.5)'
            : '0 0 10px rgba(212, 175, 55, 0.5)',
          transition: 'all 0.3s ease',
          animation: isActive ? 'pulse 1s infinite' : 'none',
          opacity: disabled ? 0.5 : 1
        }}
        title={isActive ? 'Ring is active!' : wouldKill ? 'â ï¸ WARNING: Will claim your soul!' : 'Put on the One Ring (+15 corruption)'}
      >
        ð
      </button>
      {isActive && (
        <div style={{
          position: 'absolute',
          top: '-5px',
          right: '-5px',
          background: '#ff6600',
          borderRadius: '50%',
          width: '15px',
          height: '15px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: '0.6rem',
          color: '#fff',
          fontWeight: 'bold'
        }}>â</div>
      )}
      {wouldKill && !isActive && (
        <div style={{
          position: 'absolute',
          top: '-8px',
          right: '-8px',
          background: '#ff0000',
          borderRadius: '50%',
          width: '20px',
          height: '20px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: '0.7rem',
          color: '#fff',
          fontWeight: 'bold',
          animation: 'pulse 0.5s infinite'
        }}>â </div>
      )}
    </div>
  );
};

// ============================================
// BOSS PHASE TRANSITION MODAL
// ============================================
const BossPhaseTransition = ({ phaseData, onComplete }) => {
  if (!phaseData) return null;
  
  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0, 0, 0, 0.95)',
      display: 'flex',
      flexDirection: 'column',
      justifyContent: 'center',
      alignItems: 'center',
      zIndex: 9999,
      animation: 'fadeIn 0.3s ease-out'
    }}>
      <div style={{
        background: 'linear-gradient(145deg, #4a0000, #1a0000)',
        border: '3px solid #ff3333',
        borderRadius: '20px',
        padding: '40px',
        maxWidth: '500px',
        textAlign: 'center',
        boxShadow: '0 0 60px rgba(255, 0, 0, 0.5)',
        animation: 'pulse 1s infinite'
      }}>
        <div style={{ fontSize: '3rem', marginBottom: '20px' }}>â ï¸</div>
        <h2 style={{ 
          color: '#ff6666', 
          fontSize: '1.8rem', 
          marginBottom: '15px',
          textShadow: '0 0 10px rgba(255, 0, 0, 0.8)'
        }}>
          PHASE TRANSITION
        </h2>
        <h3 style={{ 
          color: '#ffd700', 
          fontSize: '1.5rem', 
          marginBottom: '20px' 
        }}>
          {phaseData.phaseName}
        </h3>
        <p style={{ 
          color: '#f4e4bc', 
          fontSize: '1.1rem',
          marginBottom: '25px',
          fontStyle: 'italic'
        }}>
          "{phaseData.phaseMessage}"
        </p>
        {phaseData.newAbility && (
          <div style={{
            background: 'rgba(255, 100, 100, 0.2)',
            padding: '15px',
            borderRadius: '10px',
            border: '1px solid rgba(255, 100, 100, 0.5)',
            marginBottom: '20px'
          }}>
            <span style={{ color: '#ff9999', fontWeight: 'bold' }}>
              New Ability: {phaseData.newAbility.name}
            </span>
            {phaseData.newAbility.description && (
              <p style={{ color: '#c4b89a', fontSize: '0.9rem', margin: '5px 0 0' }}>
                {phaseData.newAbility.description}
              </p>
            )}
          </div>
        )}
        <button
          onClick={onComplete}
          style={{
            background: 'linear-gradient(145deg, #8b0000, #5a0000)',
            border: '2px solid #ff6666',
            borderRadius: '10px',
            padding: '12px 30px',
            color: '#fff',
            fontSize: '1rem',
            cursor: 'pointer',
            marginTop: '10px'
          }}
        >
          Continue Battle
        </button>
      </div>
    </div>
  );
};

// ============================================
// RING CLAIMED ENDING SCREEN
// ============================================
const RingClaimedEnding = ({ onRestart }) => (
  <div style={{
    position: 'fixed',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'linear-gradient(180deg, #000 0%, #1a0000 50%, #330000 100%)',
    display: 'flex',
    flexDirection: 'column',
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 10000,
    animation: 'fadeIn 1s ease-out'
  }}>
    <div style={{
      fontSize: '6rem',
      marginBottom: '30px',
      animation: 'pulse 2s infinite',
      filter: 'drop-shadow(0 0 30px rgba(255, 100, 0, 0.8))'
    }}>
      ð
    </div>
    <h1 style={{
      color: '#ff3300',
      fontSize: '2.5rem',
      textAlign: 'center',
      marginBottom: '20px',
      textShadow: '0 0 20px rgba(255, 0, 0, 0.8)'
    }}>
      CLAIMED BY SHADOW
    </h1>
    <p style={{
      color: '#c4b89a',
      fontSize: '1.2rem',
      textAlign: 'center',
      maxWidth: '600px',
      marginBottom: '15px',
      lineHeight: 1.6
    }}>
      The Ring has consumed you. Your will is no longer your own.
      You feel yourself fading, becoming a wraith bound to Sauron's will forever.
    </p>
    <p style={{
      color: '#ff6666',
      fontSize: '1rem',
      fontStyle: 'italic',
      marginBottom: '40px'
    }}>
      "Ash nazg durbatulÃ»k, ash nazg gimbatul..."
    </p>
    <button
      onClick={onRestart}
      style={{
        background: 'linear-gradient(145deg, #4a0000, #2d0000)',
        border: '2px solid #ff3333',
        borderRadius: '10px',
        padding: '15px 40px',
        color: '#fff',
        fontSize: '1.1rem',
        cursor: 'pointer'
      }}
    >
      Return to Menu
    </button>
  </div>
);

// ============================================
// MAIN COMPONENT
// ============================================

function App() {
  const [gameState, setGameState] = useState('menu');
  const [selectedUpgradeCard, setSelectedUpgradeCard] = useState(null);
  const [availableRelics, setAvailableRelics] = useState([]);
  const [shopItems, setShopItems] = useState({ cards: [], relics: [], removeCard: true });
  const [hasSavedGame, setHasSavedGame] = useState(false);
  const [difficulty, setDifficulty] = useState('normal');
  const [animatingDamage, setAnimatingDamage] = useState(false);
  const [animatingHeal, setAnimatingHeal] = useState(false);
  const [selectedCharacter, setSelectedCharacter] = useState(null);
  const [player, setPlayer] = useState(null);
  const [currentEnemy, setCurrentEnemy] = useState(null);
  
  // R002 - Enhanced Combat Mechanics state
  const [corruption, setCorruption] = useState(0); // Corruption meter (0-100)
  const [playedCardsThisTurn, setPlayedCardsThisTurn] = useState([]); // For combo detection
  const [activeCombo, setActiveCombo] = useState(null); // Currently triggered combo
  const [bossPhase, setBossPhase] = useState(1); // Current boss phase for multi-phase fights
  const [showPhaseTransition, setShowPhaseTransition] = useState(null); // Boss phase transition modal
  const [ringClaimedEnding, setRingClaimedEnding] = useState(false); // Ring claimed game over
  const [lastCrit, setLastCrit] = useState(null); // Track last critical hit for UI feedback
  const [enemies, setEnemies] = useState([]); // For multi-enemy encounters
  const [targetedEnemy, setTargetedEnemy] = useState(0); // Index of targeted enemy in multi-enemy
  
  // R003 - Character Progression state
  const [playerProgress, setPlayerProgress] = useState(() => loadPlayerProgress()); // Persistent progress
  const [sessionXP, setSessionXP] = useState(0); // XP earned this run
  const [showLevelUp, setShowLevelUp] = useState(false); // Level up notification
  const [pendingLevelUp, setPendingLevelUp] = useState(null); // Pending level up data
  const [showSkillTree, setShowSkillTree] = useState(false); // Skill tree modal
  const [showPrestige, setShowPrestige] = useState(false); // Prestige modal
  const [showResetConfirm, setShowResetConfirm] = useState(null); // Character key to reset, or 'all'
  
  // US-003: Adaptive Difficulty state
  const [adaptiveState, setAdaptiveState] = useState(() => loadAdaptiveState());
  const [adaptiveEnabled, setAdaptiveEnabled] = useState(true); // Toggle for adaptive difficulty
  
  const [currentEncounter, setCurrentEncounter] = useState(0);
  const [enemyType, setEnemyType] = useState(null);
  const [currentAct, setCurrentAct] = useState(1);
  const [showActTransition, setShowActTransition] = useState(false);
  const [rewardsTaken, setRewardsTaken] = useState({ gold: false, card: false, relic: false });
  
  const [hand, setHand] = useState([]);
  const [drawPile, setDrawPile] = useState([]);
  const [discardPile, setDiscardPile] = useState([]);
  const [exhaustPile, setExhaustPile] = useState([]);
  const [energy, setEnergy] = useState(0);
  const [turn, setTurn] = useState('player');
  const [combatTurn, setCombatTurn] = useState(1); // Track combat turn number for first-turn relic effects
  const [firstHitTaken, setFirstHitTaken] = useState(false); // Track if player took first hit this combat
  const [combatLog, setCombatLog] = useState([]);
  const combatInitialized = useRef(false);
  const [enemyIntent, setEnemyIntent] = useState(null);
  const [hoveredCard, setHoveredCard] = useState(null);
  const [previewedCard, setPreviewedCard] = useState(null); // For card detail overlay
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [viewingPile, setViewingPile] = useState(null); // 'draw', 'discard', 'exhaust', or null
  const [cardRewardChoices, setCardRewardChoices] = useState([]);
  const [runStats, setRunStats] = useState({ damageDealt: 0, damageTaken: 0, cardsPlayed: 0, turnsPlayed: 0, enemiesDefeated: 0 });
  const [showRestRemove, setShowRestRemove] = useState(false); // For rest site card removal UI
  const [restActionTaken, setRestActionTaken] = useState(false); // Prevent multiple rest site actions
  const xpAwardedThisCombat = useRef(false); // Prevent double XP awards
  const [currentEvent, setCurrentEvent] = useState(null); // Current event location
  const [eventOutcome, setEventOutcome] = useState(null); // 'bad', 'good', or 'great'
  const [eventResolved, setEventResolved] = useState(false); // Whether event has been resolved

  // R001 - Story Framework State
  const [storyState, setStoryState] = useState({
    viewedBeats: [],           // Story beats that have been shown
    unlockedBackstories: [],   // Character backstory milestones unlocked
    completedDialogues: [],    // Fellowship dialogues that have been completed
    milestonesAchieved: [],    // General milestones (first_combat, encounters_5, etc.)
    encountersCompleted: 0,     // Total encounters completed
    elitesDefeated: 0,         // Elite enemies defeated
    bossesDefeated: 0,         // Bosses defeated
    storyChoices: {},          // US-001: Track branching dialogue choices and story flags
    earnedCards: [],           // US-001: Cards earned through story choices
    earnedRelics: []           // US-001: Relics earned through story choices
  });
  const [currentStoryBeat, setCurrentStoryBeat] = useState(null); // Currently displaying story beat
  const [currentDialogue, setCurrentDialogue] = useState(null); // Currently active fellowship dialogue
  const [currentBranchingDialogue, setCurrentBranchingDialogue] = useState(null); // US-001: Current branching story dialogue
  const [pendingBackstoryReveal, setPendingBackstoryReveal] = useState(null); // Backstory waiting to be shown
  const [showStoryModal, setShowStoryModal] = useState(false); // Whether story modal is visible

  // Refs to track current pile values (fixes stale closure in startPlayerTurn)
  const drawPileRef = useRef([]);
  const discardPileRef = useRef([]);
  const handRef = useRef([]);
  const enemiesRef = useRef([]);

  // Keep refs in sync with state
  useEffect(() => { drawPileRef.current = drawPile; }, [drawPile]);
  useEffect(() => { discardPileRef.current = discardPile; }, [discardPile]);
  useEffect(() => { handRef.current = hand; }, [hand]);
  useEffect(() => { enemiesRef.current = enemies; }, [enemies]);

  // ENHANCEMENT: Custom hooks for better UX
  const { announce } = useGameAnnouncements();
  const { animationsEnabled } = useAnimationSettings();
  const { playHaptic, isMobile } = useMobileEnhancements();
  const { addTimer, clearAllTimers } = useTimerManager();
  
  // ENHANCEMENT: Combat state machine for preventing race conditions
  const [combatPhase, dispatchCombat] = useReducer(combatStateReducer, {
    phase: COMBAT_STATES.IDLE,
    turnNumber: 1
  });
  
  // ENHANCEMENT: Memoized deck operations for performance
  const deckOps = useMemo(() => createMemoizedDeckOperations(), []);

  // Character transformation helper
  const transformCharacter = useCallback((toAct) => {
    if (!player || !selectedCharacter) return;
    
    // Gandalf becomes Gandalf the White in Act 2
    if (selectedCharacter === 'gandalf' && toAct === 2) {
      setPlayer(prev => ({
        ...prev,
        name: "Gandalf the White",
        image: characterImages.gandalfWhite,
        maxEnergy: prev.maxEnergy + 1,
        transformed: true
      }));
      setCombatLog(prev => [...prev, "â¨ Gandalf has returned as Gandalf the White! (+1 Mana)"]);
    }
    
    // Strider becomes King Aragorn in Act 3
    if (selectedCharacter === 'aragorn' && toAct === 3) {
      setPlayer(prev => ({
        ...prev,
        name: "King Aragorn",
        image: characterImages.kingAragorn,
        maxEnergy: prev.maxEnergy + 1,
        transformed: true
      }));
      setCombatLog(prev => [...prev, "ð Strider has claimed his birthright as King Aragorn! (+1 Energy)"]);
    }
  }, [player, selectedCharacter]);

  // R001 - Story Framework Functions
  
  // Trigger a story beat to display
  const triggerStoryBeat = useCallback((beatId) => {
    const beat = STORY_BEATS[beatId];
    if (!beat || storyState.viewedBeats.includes(beatId)) return;
    
    setCurrentStoryBeat({ id: beatId, ...beat });
    setShowStoryModal(true);
    setStoryState(prev => ({
      ...prev,
      viewedBeats: [...prev.viewedBeats, beatId]
    }));
  }, [storyState.viewedBeats]);

  // Trigger branching dialogue based on game events (must be defined before checkStoryBeats)
  const checkBranchingDialogue = useCallback((trigger) => {
    if (!selectedCharacter) return;
    
    const dialogue = getCharacterBranchingDialogue(
      selectedCharacter, 
      trigger, 
      storyState.storyChoices
    );
    
    if (dialogue) {
      setCurrentBranchingDialogue({
        ...dialogue,
        showOutcome: false,
        selectedChoice: null
      });
    }
  }, [selectedCharacter, storyState.storyChoices]);

  // Check for story beats based on current game state
  const checkStoryBeats = useCallback((trigger, act, encounterIndex) => {
    for (const [beatId, beat] of Object.entries(STORY_BEATS)) {
      if (beat.act !== act) continue;
      if (storyState.viewedBeats.includes(beatId)) continue;
      
      if (beat.trigger === trigger) {
        if (trigger === 'encounter' && beat.encounterIndex === encounterIndex) {
          triggerStoryBeat(beatId);
          // US-001: Also check for branching dialogues at midpoints
          if (encounterIndex === 7) {
            setTimeout(() => checkBranchingDialogue('act1_midpoint'), 2000);
          }
          return;
        }
        if (trigger === 'act_start' || trigger === 'boss_defeated') {
          triggerStoryBeat(beatId);
          // US-001: Trigger branching dialogues for act openings
          if (trigger === 'act_start' && act === 1) {
            setTimeout(() => checkBranchingDialogue('act1_start'), 2000);
          }
          if (trigger === 'act_start' && act === 2) {
            setTimeout(() => checkBranchingDialogue('act2_opening'), 2000);
          }
          if (trigger === 'act_start' && act === 3) {
            setTimeout(() => checkBranchingDialogue('act3_start'), 2000);
          }
          return;
        }
      }
    }
    
    // US-001: Check for preboss branching dialogues
    if (trigger === 'encounter') {
      if (encounterIndex === 14) {
        checkBranchingDialogue('act1_preboss');
      } else if (encounterIndex === 29) {
        checkBranchingDialogue('act2_midpoint');
      } else if (encounterIndex === 40) {
        checkBranchingDialogue('act3_preboss');
      } else if (encounterIndex === 38) {
        checkBranchingDialogue('act3_midpoint');
      }
    }
  }, [storyState.viewedBeats, triggerStoryBeat, checkBranchingDialogue]);

  // Check and trigger backstory reveals
  const checkBackstoryTrigger = useCallback((milestone) => {
    if (!selectedCharacter || storyState.milestonesAchieved.includes(milestone)) return;
    
    const reveal = checkBackstoryMilestone(selectedCharacter, storyState.unlockedBackstories, milestone);
    if (reveal) {
      setPendingBackstoryReveal(reveal);
      setStoryState(prev => ({
        ...prev,
        milestonesAchieved: [...prev.milestonesAchieved, milestone],
        unlockedBackstories: [...prev.unlockedBackstories, milestone]
      }));
    }
  }, [selectedCharacter, storyState.milestonesAchieved, storyState.unlockedBackstories]);

  // Update story milestones after combat
  const updateStoryProgress = useCallback((eventType, data = {}) => {
    switch (eventType) {
      case 'combat_start':
        if (storyState.encountersCompleted === 0) {
          checkBackstoryTrigger('first_combat');
        }
        break;
      case 'combat_victory':
        const newEncounterCount = storyState.encountersCompleted + 1;
        setStoryState(prev => ({
          ...prev,
          encountersCompleted: newEncounterCount,
          elitesDefeated: prev.elitesDefeated + (data.isElite ? 1 : 0),
          bossesDefeated: prev.bossesDefeated + (data.isBoss ? 1 : 0)
        }));
        if (newEncounterCount === 5) checkBackstoryTrigger('encounters_5');
        if (data.isElite) checkBackstoryTrigger('elite_defeated');
        if (data.isBoss) checkBackstoryTrigger('boss_defeated');
        break;
      case 'act_start':
        if (data.act === 2) checkBackstoryTrigger('act2_start');
        if (data.act === 3) checkBackstoryTrigger('act3_start');
        break;
    }
  }, [storyState.encountersCompleted, checkBackstoryTrigger]);

  // Track victory progress - update player stats when game is won
  useEffect(() => {
    if (gameState === 'victory' && selectedCharacter) {
      setPlayerProgress(prev => {
        const updated = { ...prev };
        const existingData = updated[selectedCharacter] || {};
        const charData = {
          xp: 0,
          level: 1,
          totalXP: 0,
          skillPoints: 0,
          unlockedSkills: [],
          prestigeLevel: 0,
          gamesCompleted: 0,
          ...existingData
        };
        // Only increment if this is a fresh victory (not already counted)
        const newGamesCompleted = (Number(charData.gamesCompleted) || 0) + 1;
        if (newGamesCompleted > charData.gamesCompleted) {
          charData.gamesCompleted = newGamesCompleted;
          charData.xp = (Number(charData.xp) || 0) + (XP_REWARDS.act_completed * 3); // Bonus for completing all 3 acts
          updated[selectedCharacter] = charData;
          savePlayerProgress(updated);
        }
        return updated;
      });
    }
  }, [gameState, selectedCharacter]);

  // Handle fellowship dialogue choice
  const handleDialogueChoice = useCallback((choice) => {
    if (!currentDialogue || !player) return;
    
    let updatedPlayer = { ...player };
    const effect = choice.effect;
    
    // Apply effects
    if (effect.strength && !effect.tempStrength) {
      updatedPlayer.strength = (updatedPlayer.strength || 0) + effect.strength;
    }
    if (effect.dexterity && !effect.tempDexterity) {
      updatedPlayer.dexterity = (updatedPlayer.dexterity || 0) + effect.dexterity;
    }
    if (effect.heal) {
      updatedPlayer.hp = Math.min(updatedPlayer.hp + effect.heal, updatedPlayer.maxHp);
    }
    if (effect.maxHp) {
      updatedPlayer.maxHp += effect.maxHp;
      updatedPlayer.hp = Math.min(updatedPlayer.hp + effect.maxHp, updatedPlayer.maxHp);
    }
    if (effect.backstoryReveal) {
      checkBackstoryTrigger('dialogue_reveal');
    }
    
    setPlayer(updatedPlayer);
    
    // Store dialogue result for combat bonuses
    if (effect.tempStrength || effect.tempDexterity || effect.tempBlock) {
      setStoryState(prev => ({
        ...prev,
        pendingCombatBonus: {
          strength: effect.tempStrength ? effect.strength : 0,
          dexterity: effect.tempDexterity ? effect.dexterity : 0,
          block: effect.tempBlock ? effect.block : 0
        }
      }));
    }
    
    // Mark dialogue as completed
    setStoryState(prev => ({
      ...prev,
      completedDialogues: [...prev.completedDialogues, currentDialogue.dialogueId]
    }));
    
    // Store the outcome text to display
    setCurrentDialogue(prev => ({
      ...prev,
      selectedChoice: choice,
      showOutcome: true
    }));
  }, [currentDialogue, player, checkBackstoryTrigger]);

  // Close story modal
  const closeStoryModal = useCallback(() => {
    setShowStoryModal(false);
    setCurrentStoryBeat(null);
  }, []);

  // Close dialogue modal
  const closeDialogueModal = useCallback(() => {
    setCurrentDialogue(null);
  }, []);

  // Close backstory reveal
  const closeBackstoryReveal = useCallback(() => {
    setPendingBackstoryReveal(null);
  }, []);
  
  // US-001: Handle branching dialogue choice
  const handleBranchingDialogueChoice = useCallback((choice) => {
    if (!currentBranchingDialogue || !player) return;
    
    const effect = choice.effect || {};
    let updatedPlayer = { ...player };
    
    // Apply permanent stat bonuses
    if (effect.strength) {
      updatedPlayer.strength = (updatedPlayer.strength || 0) + effect.strength;
    }
    if (effect.dexterity) {
      updatedPlayer.dexterity = (updatedPlayer.dexterity || 0) + effect.dexterity;
    }
    if (effect.maxHp && effect.permanentBonus) {
      updatedPlayer.maxHp = (updatedPlayer.maxHp || 0) + effect.maxHp;
      updatedPlayer.hp = Math.min(updatedPlayer.hp + effect.maxHp, updatedPlayer.maxHp);
    }
    if (effect.heal) {
      const healAmount = effect.heal === 999 ? updatedPlayer.maxHp : effect.heal;
      updatedPlayer.hp = Math.min(updatedPlayer.hp + healAmount, updatedPlayer.maxHp);
    }
    if (effect.block) {
      updatedPlayer.block = (updatedPlayer.block || 0) + effect.block;
    }
    if (effect.corruptionRemove) {
      setCorruption(prev => Math.max(0, prev - effect.corruptionRemove));
    }
    if (effect.corruption) {
      setCorruption(prev => Math.min(99, prev + effect.corruption));
    }
    if (effect.gold) {
      updatedPlayer.gold = (updatedPlayer.gold || 0) + effect.gold;
    }
    
    // Add story card to deck
    if (effect.addCard && STORY_CARDS[effect.addCard]) {
      const storyCard = STORY_CARDS[effect.addCard];
      const cardWithUid = {
        ...storyCard,
        uid: `${storyCard.id}_${Date.now()}`
      };
      updatedPlayer.deck = [...updatedPlayer.deck, cardWithUid];
      setStoryState(prev => ({
        ...prev,
        earnedCards: [...prev.earnedCards, effect.addCard]
      }));
    }
    
    // Add story relic
    if (effect.addRelic && STORY_RELICS[effect.addRelic]) {
      updatedPlayer.relics = [...(updatedPlayer.relics || []), effect.addRelic];
      setStoryState(prev => ({
        ...prev,
        earnedRelics: [...prev.earnedRelics, effect.addRelic]
      }));
    }
    
    setPlayer(updatedPlayer);
    
    // Store story flag
    if (choice.storyFlag) {
      setStoryState(prev => ({
        ...prev,
        storyChoices: {
          ...prev.storyChoices,
          [choice.storyFlag]: true,
          [currentBranchingDialogue.id + '_completed']: true
        }
      }));
    }
    
    // Store the outcome to display
    setCurrentBranchingDialogue(prev => ({
      ...prev,
      selectedChoice: choice,
      showOutcome: true
    }));
  }, [currentBranchingDialogue, player]);
  
  // Close branching dialogue modal
  const closeBranchingDialogue = useCallback(() => {
    setCurrentBranchingDialogue(null);
  }, []);

  // Get character-specific dialogue response
  const getCharacterResponse = useCallback((responses) => {
    if (!selectedCharacter) return responses.aragorn;
    const charKey = selectedCharacter === 'gimli' ? 'gimli' : 
                    selectedCharacter === 'legolas' ? 'legolas' :
                    selectedCharacter === 'gandalf' ? 'gandalf' : 'aragorn';
    return responses[charKey] || responses.aragorn;
  }, [selectedCharacter]);

  // Get current battle location background
  const getCurrentBattleLocation = useCallback(() => {
    if (!enemyType) return BATTLE_LOCATIONS.misty_mountains;
    return getBattleLocation(enemyType);
  }, [enemyType]);

  const drawCardsHelper = useCallback((count, currentDrawPile, currentDiscardPile, currentHand) => {
    let newDrawPile = [...currentDrawPile];
    let newDiscardPile = [...currentDiscardPile];
    let newHand = [...currentHand];
    
    for (let i = 0; i < count && (newDrawPile.length > 0 || newDiscardPile.length > 0); i++) {
      if (newDrawPile.length === 0) {
        newDrawPile = [...newDiscardPile].sort(() => Math.random() - 0.5);
        newDiscardPile = [];
      }
      if (newDrawPile.length > 0) {
        newHand.push(newDrawPile.pop());
      }
    }
    return { newHand, newDrawPile, newDiscardPile };
  }, []);

  const getRandomIntent = useCallback((enemy) => {
    if (!enemy || !enemy.actions || enemy.actions.length === 0) return null;
    return enemy.actions[Math.floor(Math.random() * enemy.actions.length)];
  }, []);

  const initializeCharacter = (characterKey) => {
    const character = CHARACTERS[characterKey];
    setSelectedCharacter(characterKey);
    
    // R003 - Get progression data for this character
    const rawCharProgress = playerProgress[characterKey] || DEFAULT_PLAYER_PROGRESS[characterKey];
    // ALWAYS calculate level from XP - never trust stored level
    const actualLevel = getLevelFromXP(rawCharProgress.xp || 0);
    const charProgress = {
      ...rawCharProgress,
      level: actualLevel,
      xp: Math.max(0, Number(rawCharProgress.xp) || 0)
    };
    console.log('[startNewGame] charProgress:', JSON.stringify(charProgress));
    const skillBonuses = getSkillBonuses(characterKey, charProgress.unlockedSkills || []);
    const prestigeData = getPrestigeData(charProgress.prestigeLevel || 0);
    
    // R003 - Calculate level bonuses
    let levelHpBonus = 0;
    let levelEnergyBonus = 0;
    let levelGoldBonus = 0;
    for (let lvl = 2; lvl <= charProgress.level; lvl++) {
      if (LEVEL_BONUSES[lvl]?.maxHp) levelHpBonus += LEVEL_BONUSES[lvl].maxHp;
      if (LEVEL_BONUSES[lvl]?.maxEnergy) levelEnergyBonus += LEVEL_BONUSES[lvl].maxEnergy;
      if (LEVEL_BONUSES[lvl]?.startingGold) levelGoldBonus += LEVEL_BONUSES[lvl].startingGold;
    }
    
    // R003 - Get unlocked legendary cards
    const unlockedLegendaries = (LEGENDARY_CARDS[characterKey] || [])
      .filter(card => charProgress.level >= card.unlockLevel)
      .map((card, idx) => ({ ...card, uid: `legendary_${card.id}_${idx}` }));
    
    // Build starting deck with potential legendary cards
    const startingDeck = [
      ...character.startingDeck.map((card, index) => ({ ...card, uid: `${card.id}_${index}` })),
      ...(prestigeData.bonuses.bonusCard && unlockedLegendaries.length > 0 ? [unlockedLegendaries[0]] : [])
    ];
    
    // R003 - Get starting relic from prestige
    const startingRelics = [];
    if (prestigeData.bonuses.startingRelic) {
      const randomRelic = getRelicRewards(1, [])[0];
      if (randomRelic) startingRelics.push(randomRelic);
    }
    
    const baseMaxHp = Math.floor(character.maxHp * DIFFICULTY[difficulty].playerHpMod);
    const totalMaxHp = baseMaxHp + levelHpBonus + (skillBonuses.bonusHp || 0) + (prestigeData.bonuses.bonusHp || 0);
    
    setPlayer({
      ...character,
      hp: totalMaxHp,
      maxHp: totalMaxHp,
      energy: character.maxEnergy + levelEnergyBonus + (prestigeData.bonuses.startingEnergy || 0),
      maxEnergy: character.maxEnergy + levelEnergyBonus + (prestigeData.bonuses.startingEnergy || 0),
      block: skillBonuses.startingBlock || 0,
      strength: skillBonuses.startingStrength || 0,
      dexterity: skillBonuses.bonusDexterity || 0,
      vulnerable: 0,
      weak: 0,
      dodge: false,
      relics: startingRelics,
      potions: [],
      gold: DIFFICULTY[difficulty].startingGold + levelGoldBonus + (prestigeData.bonuses.startingGold || 0),
      deck: startingDeck,
      transformed: false,
      // R003 - Store progression info on player for reference
      level: charProgress.level,
      xp: charProgress.xp,
      skillBonuses: skillBonuses,
      prestigeLevel: charProgress.prestigeLevel || 0
    });
    
    // R003 - Reset session XP
    setSessionXP(0);
    
    // R003 - Reset level up notification state
    setShowLevelUp(false);
    setPendingLevelUp(null);
    
    setCurrentEncounter(0);
    setCurrentAct(1);
    setShowActTransition(false);
    
    // R001 - Reset and initialize story state for new game
    setStoryState({
      viewedBeats: [],
      unlockedBackstories: [],
      completedDialogues: [],
      milestonesAchieved: [],
      encountersCompleted: 0,
      elitesDefeated: 0,
      bossesDefeated: 0,
      storyChoices: {},          // US-001: Reset branching dialogue choices
      earnedCards: [],           // US-001: Reset earned story cards
      earnedRelics: []           // US-001: Reset earned story relics
    });
    setCurrentStoryBeat(null);
    setCurrentDialogue(null);
    setCurrentBranchingDialogue(null); // US-001: Reset branching dialogue
    setPendingBackstoryReveal(null);
    
    // R002 - Reset combat mechanics state for new game
    setCorruption(0);
    setPlayedCardsThisTurn([]);
    setActiveCombo(null);
    setBossPhase(1);
    setEnemies([]);
    
    // R001 - Trigger Act 1 opening story beat after a short delay
    setTimeout(() => {
      triggerStoryBeat('act1_opening');
    }, 500);
    
    setGameState('map');
  };

  const shuffleAndDeal = useCallback((deck, maxEnergy, enemy) => {
    const shuffled = [...deck].sort(() => Math.random() - 0.5);
    const { newHand, newDrawPile, newDiscardPile } = drawCardsHelper(5, shuffled, [], []);
    
    // Update state and refs
    setDrawPile(newDrawPile);
    drawPileRef.current = newDrawPile;
    setDiscardPile(newDiscardPile);
    discardPileRef.current = newDiscardPile;
    setExhaustPile([]);
    setHand(newHand);
    handRef.current = newHand;
    
    // Reset combat tracking
    setCombatTurn(1);
    setFirstHitTaken(false);
    
    setTurn('player');
    
    setCombatLog(['âï¸ Combat begins! Prepare for battle!']);
    setEnemyIntent(getRandomIntent(enemy));
  }, [drawCardsHelper, getRandomIntent]);

  const startCombat = useCallback((encounterIndex) => {
    const baseEncounter = ENCOUNTERS[encounterIndex];
    const encounter = getCharacterEncounter(encounterIndex, selectedCharacter, baseEncounter);
    
    // US-001: Check for multi-enemy encounter
    if (encounter.multiEnemy) {
      const multiEncounter = MULTI_ENEMY_ENCOUNTERS[encounter.multiEnemy];
      if (!multiEncounter) {
        console.error('Multi-enemy encounter not found:', encounter.multiEnemy);
        return;
      }
      
      // Create array of enemy instances
      const enemyInstances = multiEncounter.enemies.map((enemyKey, index) => {
        const baseEnemy = ENEMIES[enemyKey];
        if (!baseEnemy) {
          console.error('Enemy not found in multi-enemy:', enemyKey);
          return null;
        }
        
        const enemyElement = ENEMY_ELEMENTS[enemyKey] || null;
        let startBlock = 0;
        if (baseEnemy.ability?.type === 'startCombat' && baseEnemy.ability?.startBlock) {
          startBlock = baseEnemy.ability.startBlock;
        }
        
        // US-003: Get adaptive modifiers
        const adaptiveMods = adaptiveEnabled 
          ? getAdaptiveModifiers(adaptiveState, difficulty)
          : DIFFICULTY[difficulty];
        
        return {
          ...baseEnemy,
          id: enemyKey,
          instanceId: `${enemyKey}_${index}`, // Unique instance ID
          element: enemyElement,
          hp: Math.floor(baseEnemy.maxHp * adaptiveMods.enemyHpMod),
          maxHp: Math.floor(baseEnemy.maxHp * adaptiveMods.enemyHpMod),
          block: startBlock,
          strength: 0,
          vulnerable: 0,
          weak: 0,
          poison: 0,
          burn: 0,
          intent: getRandomIntent(baseEnemy) // Initialize intent
        };
      }).filter(Boolean);
      
      if (enemyInstances.length === 0) {
        console.error('No valid enemies in multi-enemy encounter');
        return;
      }
      
      // Set first enemy as current, all enemies in array
      setCurrentEnemy(enemyInstances[0]);
      setEnemies(enemyInstances);
      setTargetedEnemy(0);
      setEnemyType(encounter.multiEnemy);
      setCurrentEncounter(encounterIndex);
      
    } else {
      // Single enemy encounter (original logic)
      if (!encounter || !encounter.enemy) {
        // If no specific enemy, select by tier
        if (encounter.enemyTier) {
          encounter.enemy = selectRandomEnemyByTier(encounter.enemyTier, encounter.tier);
        } else {
          console.error('Invalid encounter at index:', encounterIndex);
          return;
        }
      }
      
      const enemyData = ENEMIES[encounter.enemy];
      if (!enemyData) {
        console.error('Enemy not found:', encounter.enemy);
        return;
      }
      
      // Check for startCombat abilities
      let startBlock = 0;
      if (enemyData.ability?.type === 'startCombat' && enemyData.ability?.startBlock) {
        startBlock = enemyData.ability.startBlock;
      }
      
      // R002 - Get enemy element for elemental combat
      const enemyElement = ENEMY_ELEMENTS[encounter.enemy] || null;
      
      // US-003: Get adaptive modifiers for single enemy
      const adaptiveMods = adaptiveEnabled 
        ? getAdaptiveModifiers(adaptiveState, difficulty)
        : DIFFICULTY[difficulty];
      
      const enemy = { 
        ...enemyData,
        id: encounter.enemy, // R002 - Store enemy type id for element lookup
        instanceId: encounter.enemy + '_0',
        element: enemyElement, // R002 - Store element directly on enemy
        hp: Math.floor(enemyData.maxHp * adaptiveMods.enemyHpMod),
        maxHp: Math.floor(enemyData.maxHp * adaptiveMods.enemyHpMod), // Ensure maxHp is set
        block: startBlock,
        strength: 0,
        vulnerable: 0,
        weak: 0,
        poison: 0,
        burn: 0,
        intent: getRandomIntent(enemyData) // Initialize intent for first turn visibility
      };
      
      setCurrentEnemy(enemy);
      setEnemies([enemy]); // US-001: Always use array, even for single enemy
      setTargetedEnemy(0);
      setEnemyType(encounter.enemy);
      setCurrentEncounter(encounterIndex);
    }
    
    // Get skill bonuses for starting stats (if any)
    const charProgress = playerProgress[selectedCharacter] || {};
    const skillBonuses = getSkillBonuses(selectedCharacter, charProgress.unlockedSkills || []);
    
    setPlayer(prev => ({
      ...prev,
      block: skillBonuses.startingBlock || 0,
      strength: skillBonuses.startingStrength || 0,
      dexterity: skillBonuses.bonusDexterity || 0,
      vulnerable: 0,
      weak: 0,
      // R003 - Always keep skillBonuses updated
      skillBonuses: skillBonuses
    }));
    
    // R001 - Trigger story progress for combat start
    updateStoryProgress('combat_start');
    
    // R001 - Check for encounter-based story beats
    const actNum = getCurrentAct(encounterIndex);
    checkStoryBeats('encounter', actNum, encounterIndex);
    
    combatInitialized.current = false;
    xpAwardedThisCombat.current = false; // Reset XP award flag for new combat
    setGameState('combat');
  }, [difficulty, updateStoryProgress, checkStoryBeats, playerProgress, selectedCharacter]);

  const startEncounter = useCallback((encounterIndex) => {
    const baseEncounter = ENCOUNTERS[encounterIndex];
    const encounter = getCharacterEncounter(encounterIndex, selectedCharacter, baseEncounter);
    if (encounter.type === 'rest') {
      setCurrentEncounter(encounterIndex);
      setGameState('rest');
      return;
    }
    if (encounter.type === 'shop') {
      setCurrentEncounter(encounterIndex);
      // Generate shop inventory with weighted rarity and colorless cards
      const shopCards = getCardRewards(selectedCharacter, 5, true);
      const shuffledRelics = getRelicRewards(2, player?.relics || []);
      setShopItems({ cards: shopCards, relics: shuffledRelics, removeCard: true });
      setGameState('shop');
      return;
    }
    if (encounter.type === 'event') {
      setCurrentEncounter(encounterIndex);
      setCurrentEvent(encounter.event);
      setEventOutcome(null);
      setEventResolved(false);
      setGameState('event');
      return;
    }
    startCombat(encounterIndex);
  }, [selectedCharacter, player, startCombat]);

  useEffect(() => {
    if (gameState === 'combat' && player && currentEnemy && !combatInitialized.current) {
      combatInitialized.current = true;
      // ENHANCEMENT: Use combat state machine
      dispatchCombat({ type: 'START_COMBAT' });
      setTimeout(() => {
        shuffleAndDeal(player.deck, player.maxEnergy, currentEnemy);
        dispatchCombat({ type: 'CARDS_DEALT' });
      }, 0);
    }
    
    // ENHANCEMENT: Cleanup when leaving combat to prevent memory leaks
    return () => {
      if (gameState !== 'combat') {
        clearAllTimers();
        dispatchCombat({ type: 'RESET' });
      }
    };
  }, [gameState, player, currentEnemy, shuffleAndDeal, clearAllTimers]);

  // Apply start-of-combat relic effects after shuffleAndDeal runs
  useEffect(() => {
    if (gameState === 'combat' && player && currentEnemy && combatTurn === 1 && turn === 'player') {
      // Apply start-of-combat relic bonuses
      const startBlock = getRelicBonus(player, 'startBlock');
      const startStrength = getRelicBonus(player, 'startStrength');  
      const startDex = getRelicBonus(player, 'startDexterity');
      const firstTurnDrawBonus = getRelicBonus(player, 'firstTurnDraw');
      const firstTurnEnergyBonus = getRelicBonus(player, 'firstTurnEnergy');
      const startDamage = getRelicBonus(player, 'startDamage');
      
      // Apply player bonuses
      if (startBlock > 0 || startStrength > 0 || startDex > 0) {
        setPlayer(prev => ({
          ...prev,
          block: (prev.block || 0) + startBlock,
          strength: (prev.strength || 0) + startStrength,
          dexterity: (prev.dexterity || 0) + startDex
        }));
      }
      
      // Apply first turn energy bonus (including skill bonus)
      const skillBonusEnergy = player.skillBonuses?.bonusEnergy || 0;
      if (firstTurnEnergyBonus > 0) {
        setEnergy(prev => prev + firstTurnEnergyBonus + skillBonusEnergy);
      } else {
        setEnergy(player.maxEnergy + getRelicBonus(player, 'bonusEnergy') + skillBonusEnergy + DIFFICULTY[difficulty].energyBonus);
      }
      
      // Apply first turn draw bonus
      if (firstTurnDrawBonus > 0 && drawPileRef.current.length > 0) {
        const { newHand, newDrawPile, newDiscardPile } = drawCardsHelper(
          firstTurnDrawBonus, 
          drawPileRef.current, 
          discardPileRef.current, 
          handRef.current
        );
        setHand(newHand);
        handRef.current = newHand;
        setDrawPile(newDrawPile);
        drawPileRef.current = newDrawPile;
        setDiscardPile(newDiscardPile);
        discardPileRef.current = newDiscardPile;
      }
      
      // Apply start damage to enemy (Moria Torch relic)
      if (startDamage > 0) {
        setCurrentEnemy(prev => ({
          ...prev,
          hp: Math.max(0, prev.hp - startDamage)
        }));
        setCombatLog(prev => [...prev, `ð¦ Moria Torch deals ${startDamage} damage!`]);
      }
      
      // Apply starting debuffs to enemy from relics
      const enemyStartVulnerable = getRelicBonus(player, 'enemyStartVulnerable');
      const enemyStartWeak = getRelicBonus(player, 'enemyStartWeak');
      if (enemyStartVulnerable > 0 || enemyStartWeak > 0) {
        setCurrentEnemy(prev => ({
          ...prev,
          vulnerable: (prev.vulnerable || 0) + enemyStartVulnerable,
          weak: (prev.weak || 0) + enemyStartWeak
        }));
        if (enemyStartVulnerable > 0) {
          setCombatLog(prev => [...prev, `ð¯ Enemy starts vulnerable (${enemyStartVulnerable} turns)!`]);
        }
        if (enemyStartWeak > 0) {
          setCombatLog(prev => [...prev, `ðµ Enemy starts weakened (${enemyStartWeak} turns)!`]);
        }
      }
    }
  }, [gameState, combatTurn, turn, difficulty, drawCardsHelper]);

  const executeCardEffect = useCallback((card, currentPlayer, enemy) => {
    let logMessage = `ð´ Played ${card.name}. `;
    let newEnemy = { ...enemy };
    let newPlayer = { ...currentPlayer };
    let extraEnergy = 0;
    let cardsToDraw = 0;
    
    // Special synergy cards
    if (card.burnSynergy) {
      // Conflagration: Deal damage equal to 3x burn on enemy
      const burnDamage = (newEnemy.burn || 0) * 3;
      if (burnDamage > 0) {
        const damageAfterBlock = Math.max(0, burnDamage - newEnemy.block);
        newEnemy.hp = Math.max(0, newEnemy.hp - damageAfterBlock);
        newEnemy.block = Math.max(0, newEnemy.block - burnDamage);
        SoundSystem.attack();
        logMessage += `ð¥ Conflagration deals ${burnDamage} damage from burn! `;
        setRunStats(prev => ({ ...prev, damageDealt: prev.damageDealt + damageAfterBlock }));
      } else {
        logMessage += `ð¥ No burn on enemy - no damage. `;
      }
    }
    
    if (card.damage) {
      const relicDamageBonus = getRelicBonus(currentPlayer, 'bonusDamage');
      const skillDamageBonus = currentPlayer.skillBonuses?.bonusDamage || 0;
      let baseDamage = card.damage + currentPlayer.strength + relicDamageBonus + skillDamageBonus;
      
      // Poison synergy: +1 damage per poison on enemy
      if (card.poisonSynergy && newEnemy.poison > 0) {
        baseDamage += newEnemy.poison;
        logMessage += `â ï¸ +${newEnemy.poison} damage from poison! `;
      }
      
      // R002 - Elemental damage modifier
      const cardElement = CARD_ELEMENTS[card.id];
      const enemyElement = newEnemy.element || ENEMY_ELEMENTS[newEnemy.id];
      const elementalMod = getElementalModifier(cardElement, enemyElement);
      if (elementalMod !== 1.0) {
        if (elementalMod > 1.0) {
          logMessage += `${ELEMENTS[cardElement]?.icon || ''} Super effective! `;
        } else {
          logMessage += `${ELEMENTS[cardElement]?.icon || ''} Not very effective... `;
        }
      }
      
      const hits = card.hits || 1;
      let totalDamage = 0;
      let critTriggered = false;
      
      for (let i = 0; i < hits; i++) {
        let damage = Math.max(1, baseDamage);
        
        // R002 - Critical hit calculation (only check once per card, not per hit)
        if (i === 0) {
          const critChance = calculateCritChance(card, currentPlayer, playedCardsThisTurn || []);
          critTriggered = rollCrit(critChance);
        }
        
        // Apply elemental modifier
        damage = Math.floor(damage * elementalMod);
        
        // Apply critical hit
        if (critTriggered) {
          damage = Math.floor(damage * CRIT_DAMAGE_MULTIPLIER);
        }
        
        const finalDamage = newEnemy.vulnerable > 0 ? Math.floor(damage * 1.5) : damage;
        const damageAfterBlock = Math.max(0, finalDamage - newEnemy.block);
        
        newEnemy.hp = Math.max(0, newEnemy.hp - damageAfterBlock);
        newEnemy.block = Math.max(0, newEnemy.block - finalDamage);
        totalDamage += damageAfterBlock;
      }
      
      SoundSystem.attack();
      if (critTriggered) {
        logMessage += `ð¥ CRITICAL HIT! ${totalDamage} damage${hits > 1 ? ` (${hits} hits)` : ''}! `;
      } else {
        logMessage += `âï¸ ${totalDamage} damage${hits > 1 ? ` (${hits} hits)` : ''}. `;
      }
      
      // Track damage dealt
      setRunStats(prev => ({ ...prev, damageDealt: prev.damageDealt + totalDamage }));
      
      // Apply relic-based status effects on attack
      const relicBurn = getRelicBonus(currentPlayer, 'attackBurn');
      if (relicBurn > 0) {
        newEnemy.burn = (newEnemy.burn || 0) + relicBurn;
        logMessage += `ð¥ Relic burn ${relicBurn}. `;
      }
      
      const relicVulnerable = getRelicBonus(currentPlayer, 'attackVulnerable');
      if (relicVulnerable > 0) {
        newEnemy.vulnerable = Math.max(newEnemy.vulnerable || 0, relicVulnerable);
        logMessage += `ð¯ Relic vulnerable ${relicVulnerable}. `;
      }
      
      const relicPoison = getRelicBonus(currentPlayer, 'attackPoison');
      if (relicPoison > 0) {
        newEnemy.poison = (newEnemy.poison || 0) + relicPoison;
        logMessage += `ð§ª Relic poison ${relicPoison}. `;
      }
      
      // Balrog flame aura - damage player when they attack
      const enemyAbility = enemy.ability;
      if (enemyAbility?.type === 'passive' && enemyAbility?.damageOnHit) {
        newPlayer.hp = Math.max(0, newPlayer.hp - enemyAbility.damageOnHit);
        logMessage += `ð¥ Flame Aura burns you for ${enemyAbility.damageOnHit}! `;
      }
      
      // Thorns damage - enemy deals damage back when attacked
      if (enemyAbility?.type === 'thorns' && enemyAbility?.thornsDamage) {
        newPlayer.hp = Math.max(0, newPlayer.hp - enemyAbility.thornsDamage);
        logMessage += `ð¦ Thorns deals ${enemyAbility.thornsDamage} damage! `;
      }
      
      // Enrage - enemy gains strength when damaged
      if (enemyAbility?.type === 'onDamaged' && enemyAbility?.enrageStrength) {
        newEnemy.strength = (newEnemy.strength || 0) + enemyAbility.enrageStrength;
        logMessage += `ð¡ Enemy enrages! +${enemyAbility.enrageStrength} strength. `;
      }
    }
    
    if (card.block) {
      const skillBlockBonus = currentPlayer.skillBonuses?.bonusBlock || 0;
      const blockAmount = card.block + currentPlayer.dexterity + skillBlockBonus;
      newPlayer.block = currentPlayer.block + blockAmount;
      SoundSystem.block();
      logMessage += `ð¡ï¸ +${blockAmount} block. `;
    }
    
    if (card.draw) {
      cardsToDraw = card.draw;
      logMessage += `ð Draw ${card.draw}. `;
    }
    
    if (card.strength) {
      newPlayer.strength = currentPlayer.strength + card.strength;
      logMessage += `ðª +${card.strength} strength. `;
    }
    
    if (card.dexterity) {
      newPlayer.dexterity = currentPlayer.dexterity + card.dexterity;
      logMessage += `ð +${card.dexterity} dexterity. `;
    }
    
    if (card.vulnerable) {
      newEnemy.vulnerable = Math.max(enemy.vulnerable, card.vulnerable);
      logMessage += `ð¯ Vulnerable ${card.vulnerable}. `;
    }
    
    if (card.weak) {
      newEnemy.weak = Math.max(enemy.weak, card.weak);
      logMessage += `ðµ Weak ${card.weak}. `;
    }
    
    if (card.poison) {
      const skillPoisonBonus = currentPlayer.skillBonuses?.poisonBonus || 0;
      const poisonAmount = card.poison + skillPoisonBonus;
      newEnemy.poison = (newEnemy.poison || 0) + poisonAmount;
      logMessage += `ð§ª Poison ${poisonAmount}. `;
    }
    
    if (card.burn) {
      const skillBurnBonus = currentPlayer.skillBonuses?.burnBonus || 0;
      const burnAmount = card.burn + skillBurnBonus;
      newEnemy.burn = (newEnemy.burn || 0) + burnAmount;
      logMessage += `ð¥ Burn ${burnAmount}. `;
    }
    
    if (card.heal) {
      const healAmount = card.heal;
      newPlayer.hp = Math.min(currentPlayer.maxHp, currentPlayer.hp + healAmount);
      logMessage += `â¤ï¸ +${healAmount} HP. `;
      SoundSystem.heal();
    }
    
    if (card.energy) {
      extraEnergy = card.energy;
      logMessage += `â¡ +${card.energy} energy. `;
    }
    
    if (card.dodge) {
      newPlayer.dodge = true;
      logMessage += `ð¨ Dodge (block retained). `;
    }
    
    return { newPlayer, newEnemy, logMessage, extraEnergy, cardsToDraw };
  }, []);

  const playCard = useCallback((card) => {
    SoundSystem.cardPlay();
    if (energy < card.cost || turn !== 'player') return;
    
    // ENHANCEMENT: Haptic feedback for mobile
    playHaptic(50);
    
    // ============================================
    // CURSE CARD HANDLING
    // ============================================
    if (card.type === 'curse') {
      // Unplayable curses
      if (card.unplayable) {
        setCombatLog(prev => [`â ${card.name} is unplayable!`, ...prev.slice(0, 5)]);
        return;
      }
      
      let logMessage = `â ï¸ ${card.name}: `;
      
      // Corruption gain
      if (card.corruption) {
        const newCorruption = Math.min(100, corruption + card.corruption);
        setCorruption(newCorruption);
        logMessage += `+${card.corruption} corruption (${newCorruption}/100). `;
        
        // Check for ring claiming soul
        if (newCorruption >= 100) {
          setRingClaimedEnding(true);
          return;
        }
      }
      
      // Strength gain (Ring Whispers)
      if (card.strength) {
        setPlayer(prev => ({
          ...prev,
          strength: (prev.strength || 0) + card.strength
        }));
        logMessage += `+${card.strength} STR. `;
      }
      
      // Draw cards (Ring Temptation)
      if (card.draw) {
        drawCardsHelper(card.draw);
        logMessage += `Draw ${card.draw}. `;
      }
      
      // Self debuffs (Shadow Grip)
      if (card.selfWeak) {
        setPlayer(prev => ({ ...prev, weak: (prev.weak || 0) + card.selfWeak }));
        logMessage += `Weak ${card.selfWeak}. `;
      }
      if (card.selfVulnerable) {
        setPlayer(prev => ({ ...prev, vulnerable: (prev.vulnerable || 0) + card.selfVulnerable }));
        logMessage += `Vuln ${card.selfVulnerable}. `;
      }
      
      // Lose energy (Despair)
      if (card.loseEnergy) {
        setEnergy(prev => Math.max(0, prev - card.loseEnergy));
        logMessage += `-${card.loseEnergy} energy. `;
      }
      
      setCombatLog(prev => [logMessage, ...prev.slice(0, 5)]);
      
      // Remove from hand
      setHand(prev => prev.filter(c => c.uid !== card.uid));
      
      // Handle exhaust/discard
      if (card.exhaust || card.ethereal) {
        setExhaustPile(prev => [...prev, card]);
      } else {
        setDiscardPile(prev => [...prev, card]);
      }
      
      // Deduct energy cost
      if (card.cost > 0 && card.cost < 999) {
        setEnergy(prev => prev - card.cost);
      }
      
      return; // Don't process as normal card
    }
    // ============================================
    // END CURSE CARD HANDLING
    // ============================================
    
    // US-002: Apply conditional effects based on battle conditions
    const battleState = {
      player,
      enemy: currentEnemy,
      enemies: enemies,
      hand,
      playedCardsThisTurn,
      combatTurn: combatPhase.turnNumber
    };
    const processedCard = applyConditionalEffects(card, battleState);
    
    // US-002: Announce if condition was triggered
    if (processedCard.conditionTriggered && card.conditional) {
      announce(`${card.name} - ${card.conditional.triggerText || 'Condition met!'} ${getCardDescription(processedCard, player?.strength || 0, player?.dexterity || 0)}`, 'assertive');
    } else {
      announce(`Playing ${card.name}. ${getCardDescription(processedCard, player?.strength || 0, player?.dexterity || 0)}`);
    }
    
    // Use ref to get latest enemies state (fixes stale closure issue)
    const currentEnemies = enemiesRef.current;
    const targetEnemy = currentEnemies[targetedEnemy] || currentEnemy;
    
    const { newPlayer, newEnemy, logMessage, extraEnergy, cardsToDraw } = 
      executeCardEffect(processedCard, player, targetEnemy);
    
    // US-001: Update enemies array with modified enemy
    let updatedEnemies = [...currentEnemies];
    let aoeDamageLog = '';
    
    // US-001: Handle hitAll for AoE damage
    if (processedCard.hitAll && processedCard.damage) {
      const relicDamageBonus = getRelicBonus(player, 'bonusDamage');
      const skillDamageBonus = player.skillBonuses?.bonusDamage || 0;
      const baseDamage = processedCard.damage + player.strength + relicDamageBonus + skillDamageBonus;
      
      updatedEnemies = currentEnemies.map((enemy, idx) => {
        if (enemy.hp <= 0 || idx === targetedEnemy) {
          // Skip dead enemies or targeted enemy (already handled)
          return idx === targetedEnemy ? newEnemy : enemy;
        }
        
        let damage = Math.max(1, baseDamage);
        const finalDamage = enemy.vulnerable > 0 ? Math.floor(damage * 1.5) : damage;
        const damageAfterBlock = Math.max(0, finalDamage - enemy.block);
        
        return {
          ...enemy,
          hp: Math.max(0, enemy.hp - damageAfterBlock),
          block: Math.max(0, enemy.block - finalDamage)
        };
      });
      
      const aoeHits = updatedEnemies.filter((e, i) => i !== targetedEnemy && currentEnemies[i].hp > 0).length;
      if (aoeHits > 0) {
        aoeDamageLog = ` ð¥ Hit ${aoeHits} other enemies!`;
      }
    } else {
      // Update only targeted enemy
      updatedEnemies[targetedEnemy] = newEnemy;
    }
    
    // ============================================
    // BOSS PHASE TRANSITION CHECK
    // ============================================
    const damagedEnemy = updatedEnemies[targetedEnemy];
    if (damagedEnemy && damagedEnemy.tier === 'boss' && damagedEnemy.hp < targetEnemy.hp) {
      const phaseTransition = checkBossPhaseTransition(
        damagedEnemy,
        targetEnemy.hp,
        damagedEnemy.hp,
        bossPhase
      );
      
      if (phaseTransition) {
        setBossPhase(phaseTransition.newPhaseNumber);
        setShowPhaseTransition(phaseTransition);
        // Apply new phase data to enemy
        updatedEnemies[targetedEnemy] = applyBossPhase(damagedEnemy, phaseTransition);
      }
    }
    // ============================================
    // END BOSS PHASE CHECK
    // ============================================
    
    // US-001: Apply debuffs to all enemies if card has hitAll
    if (processedCard.hitAll) {
      updatedEnemies = updatedEnemies.map(enemy => {
        if (enemy.hp <= 0) return enemy;
        let updatedEnemy = { ...enemy };
        if (processedCard.vulnerable) {
          updatedEnemy.vulnerable = Math.max(updatedEnemy.vulnerable || 0, processedCard.vulnerable);
        }
        if (processedCard.weak) {
          updatedEnemy.weak = Math.max(updatedEnemy.weak || 0, processedCard.weak);
        }
        if (processedCard.burn) {
          updatedEnemy.burn = (updatedEnemy.burn || 0) + processedCard.burn;
        }
        if (processedCard.poison) {
          updatedEnemy.poison = (updatedEnemy.poison || 0) + processedCard.poison;
        }
        return updatedEnemy;
      });
    }
    
    // R002 - Track played cards for combo detection
    const updatedPlayedCards = [...playedCardsThisTurn, card];
    setPlayedCardsThisTurn(updatedPlayedCards);
    
    // R002 - Check for combos
    const triggeredCombos = detectCombos(updatedPlayedCards);
    if (triggeredCombos.length > 0) {
      const combo = triggeredCombos[0]; // Use first combo found
      setActiveCombo(combo);
      
      // ENHANCEMENT: Announce combo
      announce(`Combo triggered! ${combo.name}. ${combo.description}`, 'assertive');
      playHaptic(100); // Strong haptic for combo
      
      // Apply combo effects
      if (combo.effect.bonusDamage && newEnemy.hp > 0) {
        const comboDamage = Math.max(0, combo.effect.bonusDamage - newEnemy.block);
        newEnemy.hp = Math.max(0, newEnemy.hp - comboDamage);
        newEnemy.block = Math.max(0, newEnemy.block - combo.effect.bonusDamage);
      }
      if (combo.effect.bonusBlock) {
        newPlayer.block = (newPlayer.block || 0) + combo.effect.bonusBlock;
      }
      if (combo.effect.bonusStrength) {
        newPlayer.strength = (newPlayer.strength || 0) + combo.effect.bonusStrength;
      }
      if (combo.effect.heal) {
        newPlayer.hp = Math.min(newPlayer.maxHp, newPlayer.hp + combo.effect.heal);
      }
      if (combo.effect.strength) {
        newPlayer.strength = (newPlayer.strength || 0) + combo.effect.strength;
      }
      if (combo.effect.dexterity) {
        newPlayer.dexterity = (newPlayer.dexterity || 0) + combo.effect.dexterity;
      }
      if (combo.effect.burn) {
        newEnemy.burn = (newEnemy.burn || 0) + combo.effect.burn;
      }
      if (combo.effect.poison) {
        newEnemy.poison = (newEnemy.poison || 0) + combo.effect.poison;
      }
      
      // Clear combo after brief display
      setTimeout(() => setActiveCombo(null), 2000);
    }
    
    // R002 - Apply corruption from shadow element cards (with Mithril resistance)
    const cardElement = CARD_ELEMENTS[card.id];
    if (cardElement === 'shadow') {
      const shadowCorruption = getCorruptionWithResistance(CORRUPTION_SOURCES.shadow_card, player);
      if (shadowCorruption > 0) {
        setCorruption(prev => Math.min(100, prev + shadowCorruption));
      }
    }
    
    // R002 - Remove corruption from light element cards
    if (cardElement === 'light') {
      setCorruption(prev => Math.max(0, prev - CORRUPTION_REMOVAL.light_card));
      if (corruption > 0) {
        setCombatLog(prev => [`â¨ Light cleanses corruption! (-${CORRUPTION_REMOVAL.light_card})`, ...prev.slice(0, 5)]);
      }
    }
    
    // R002 - Remove corruption from cleansing cards
    if (CORRUPTION_CLEANSING_CARDS.includes(card.id)) {
      const cleanseAmount = card.id === 'athelas' ? CORRUPTION_REMOVAL.athelas :
                           card.id === 'lothlorien_blessing' ? CORRUPTION_REMOVAL.lothlorien :
                           card.id === 'rivendell_rest' ? CORRUPTION_REMOVAL.rivendell : 3;
      setCorruption(prev => Math.max(0, prev - cleanseAmount));
      if (corruption > 0) {
        setCombatLog(prev => [`ð ${card.name} purifies your spirit! (-${cleanseAmount} corruption)`, ...prev.slice(0, 5)]);
      }
    }
    
    const newHand = hand.filter(c => c.uid !== card.uid);
    let finalHand = newHand;
    let finalDrawPile = drawPile;
    let finalDiscardPile = card.exhaust ? [...discardPile] : [...discardPile, card];
    
    // Handle exhaust cards
    if (card.exhaust) {
      setExhaustPile(prev => [...prev, card]);
    }
    
    if (cardsToDraw > 0) {
      const drawResult = drawCardsHelper(cardsToDraw, drawPile, finalDiscardPile, newHand);
      finalHand = drawResult.newHand;
      finalDrawPile = drawResult.newDrawPile;
      finalDiscardPile = drawResult.newDiscardPile;
    }
    
    // Update state and refs
    setHand(finalHand);
    handRef.current = finalHand;
    setDrawPile(finalDrawPile);
    drawPileRef.current = finalDrawPile;
    setDiscardPile(finalDiscardPile);
    discardPileRef.current = finalDiscardPile;
    setEnergy(energy - card.cost + extraEnergy);
    setPlayer(newPlayer);
    
    // US-001: Update both currentEnemy and enemies array
    setCurrentEnemy(updatedEnemies[targetedEnemy]);
    setEnemies(updatedEnemies);
    enemiesRef.current = updatedEnemies; // Update ref immediately to prevent stale data
    
    // US-001: Auto-target next living enemy if current died
    if (updatedEnemies[targetedEnemy].hp <= 0) {
      const nextAlive = updatedEnemies.findIndex(e => e.hp > 0);
      if (nextAlive !== -1) {
        setTargetedEnemy(nextAlive);
      }
    }
    
    let finalLogMessage = logMessage + aoeDamageLog + (card.exhaust ? '(Exhausted) ' : '');
    if (triggeredCombos.length > 0) {
      finalLogMessage = `ð COMBO: ${triggeredCombos[0].name}! ${triggeredCombos[0].description} ` + finalLogMessage;
    }
    
    // US-002: Add conditional trigger to log message
    if (processedCard.conditionTriggered && card.conditional) {
      finalLogMessage = `â¡ ${card.conditional.triggerText || 'Condition!'} ` + finalLogMessage;
    }
    
    setCombatLog(prev => [finalLogMessage, ...prev.slice(0, 5)]);
    setRunStats(prev => ({ ...prev, cardsPlayed: prev.cardsPlayed + 1 }));
  }, [energy, turn, player, currentEnemy, enemies, hand, drawPile, discardPile, executeCardEffect, drawCardsHelper, playHaptic, announce, addTimer, playedCardsThisTurn, combatPhase.turnNumber]);

  const usePotion = useCallback((potionId, index) => {
    if (turn !== 'player' || !player.potions[index]) return;
    
    const potion = POTIONS[potionId];
    if (!potion) return;
    
    SoundSystem.heal();
    let logMessage = `ð§ª Used ${potion.name}! `;
    
    if (potion.effect.heal) {
      setPlayer(prev => ({
        ...prev,
        hp: Math.min(prev.maxHp, prev.hp + potion.effect.heal)
      }));
      logMessage += `â¤ï¸ +${potion.effect.heal} HP. `;
    }
    if (potion.effect.strength) {
      setPlayer(prev => ({
        ...prev,
        strength: prev.strength + potion.effect.strength
      }));
      logMessage += `ðª +${potion.effect.strength} Strength. `;
    }
    if (potion.effect.dexterity) {
      setPlayer(prev => ({
        ...prev,
        dexterity: prev.dexterity + potion.effect.dexterity
      }));
      logMessage += `ð +${potion.effect.dexterity} Dexterity. `;
    }
    if (potion.effect.block) {
      setPlayer(prev => ({
        ...prev,
        block: prev.block + potion.effect.block
      }));
      logMessage += `ð¡ï¸ +${potion.effect.block} Block. `;
    }
    if (potion.effect.energy) {
      setEnergy(prev => prev + potion.effect.energy);
      logMessage += `â¡ +${potion.effect.energy} Energy. `;
    }
    if (potion.effect.damage && currentEnemy) {
      const damageAfterBlock = Math.max(0, potion.effect.damage - currentEnemy.block);
      setCurrentEnemy(prev => ({
        ...prev,
        hp: Math.max(0, prev.hp - damageAfterBlock),
        block: Math.max(0, prev.block - potion.effect.damage)
      }));
      logMessage += `ð¥ ${damageAfterBlock} damage to enemy. `;
      setRunStats(prev => ({ ...prev, damageDealt: prev.damageDealt + damageAfterBlock }));
    }
    
    // Remove the used potion
    setPlayer(prev => ({
      ...prev,
      potions: prev.potions.filter((_, i) => i !== index)
    }));
    
    setCombatLog(prev => [logMessage, ...prev.slice(0, 5)]);
  }, [turn, player, currentEnemy]);

  const enemyTurn = useCallback(() => {
    SoundSystem.enemyTurn();
    
    // US-001: Filter to only living enemies
    const livingEnemies = enemies.filter(e => e.hp > 0);
    if (livingEnemies.length === 0) return;
    
    // ENHANCEMENT: Haptic feedback for enemy turn
    playHaptic(30);
    
    let totalRawDamage = 0; // Track RAW damage before block
    // Reset enemy block at START of their turn (before they act)
    let updatedEnemies = enemies.map(e => ({ ...e, block: 0 }));
    let combinedLog = [];
    let remainingBlock = player.block; // Track remaining block as enemies attack
    
    // US-001: Process each living enemy's action
    livingEnemies.forEach((enemy, liveIdx) => {
      const enemyIndex = updatedEnemies.findIndex(e => e.instanceId === enemy.instanceId);
      if (enemyIndex === -1) return;
      
      const action = enemy.intent || getRandomIntent(enemy);
      let logMessage = `ð¹ ${enemy.name}: `;
      
      if (action.type === 'attack') {
        // ============================================
        // ONE RING MISS CHECK
        // ============================================
        if (player.ringActive && player.invisibility) {
          const missRoll = Math.random() * 100;
          if (missRoll < 25) {
            combinedLog.push(`ð¹ ${enemy.name}: ð MISS! (Ring invisibility)`);
            // Generate new intent for next turn even on miss
            const newIntent = getRandomIntent(enemy);
            updatedEnemies[enemyIndex] = {
              ...updatedEnemies[enemyIndex],
              intent: newIntent
            };
            return; // Skip this enemy's attack
          }
        }
        // ============================================
        // END RING MISS CHECK
        // ============================================
        
        let damage = Math.floor(((action.damage || 0) + (enemy.strength || 0)) * DIFFICULTY[difficulty].enemyDamageMod);
        
        // Uruk-hai berserk bonus at low HP
        const berserkAbility = enemy.ability;
        if (berserkAbility?.type === 'lowHealth' && berserkAbility?.bonusDamage) {
          if (enemy.hp < enemy.maxHp * 0.5) {
            damage += berserkAbility.bonusDamage;
          }
        }
        
        // Apply weak debuff to enemy damage
        const finalDamage = player.weak > 0 ? Math.floor(damage * 0.75) : damage;
        
        // Apply damage reductions
        const damageReduction = getRelicBonus(player, 'damageReduction');
        const skillDamageReduction = player.skillBonuses?.damageReduction || 0;
        
        // First hit reduction (Rohan Helm relic) - only applies to first enemy attack
        const firstHitReduction = !firstHitTaken && liveIdx === 0 ? getRelicBonus(player, 'firstHitReduction') : 0;
        if (!firstHitTaken && firstHitReduction > 0 && liveIdx === 0) {
          setFirstHitTaken(true);
        }
        
        // Calculate damage after flat reductions but BEFORE block
        const damageAfterReductions = Math.max(0, finalDamage - damageReduction - skillDamageReduction - firstHitReduction);
        
        // Apply block - each enemy consumes block in order
        const blockedAmount = Math.min(remainingBlock, damageAfterReductions);
        const actualDamage = damageAfterReductions - blockedAmount;
        remainingBlock = Math.max(0, remainingBlock - damageAfterReductions);
        
        totalRawDamage += actualDamage;
        
        logMessage += `âï¸ ${actualDamage} damage`;
        if (blockedAmount > 0) {
          logMessage += ` (${blockedAmount} blocked)`;
        }
        
        // Apply corruption from enemy attack
        if (action.corruption && action.corruption > 0) {
          const corruptionGain = getCorruptionWithResistance(action.corruption, player);
          if (corruptionGain > 0) {
            setCorruption(prev => Math.min(100, prev + corruptionGain));
            logMessage += ` ð +${corruptionGain} corruption`;
          }
        }
        
        // Nazgul heals when damaging player
        const damageAbility = enemy.ability;
        if (damageAbility?.type === 'onDamage' && damageAbility?.heal && actualDamage > 0) {
          updatedEnemies[enemyIndex] = {
            ...updatedEnemies[enemyIndex],
            hp: Math.min(enemy.maxHp, updatedEnemies[enemyIndex].hp + damageAbility.heal)
          };
          logMessage += ` â ï¸ heals ${damageAbility.heal}`;
        }
        
      } else if (action.type === 'defend') {
        const blockGain = action.block || 0;
        const previousBlock = updatedEnemies[enemyIndex].block || 0;
        updatedEnemies[enemyIndex] = {
          ...updatedEnemies[enemyIndex],
          block: previousBlock + blockGain
        };
        logMessage += `ð¡ï¸ +${blockGain} block`;
        
      } else if (action.type === 'buff') {
        const strengthGain = action.strength || 0;
        const blockGain = action.block || 0;
        updatedEnemies[enemyIndex] = {
          ...updatedEnemies[enemyIndex],
          strength: (updatedEnemies[enemyIndex].strength || 0) + strengthGain,
          block: (updatedEnemies[enemyIndex].block || 0) + blockGain
        };
        if (strengthGain > 0) logMessage += `ðª +${strengthGain} strength`;
        if (blockGain > 0) logMessage += ` ð¡ï¸ +${blockGain} block`;
        
      } else if (action.type === 'debuff') {
        const weakGain = action.weak || 0;
        const vulnerableGain = action.vulnerable || 0;
        
        setPlayer(prev => ({
          ...prev,
          weak: (prev.weak || 0) + weakGain,
          vulnerable: (prev.vulnerable || 0) + vulnerableGain
        }));
        
        if (weakGain > 0) logMessage += `ðµ weak ${weakGain} `;
        if (vulnerableGain > 0) logMessage += `ð¯ vuln ${vulnerableGain}`;
      }
      
      combinedLog.push(logMessage);
    });
    
    // Apply total damage to player (block already consumed above)
    if (totalRawDamage > 0) {
      setPlayer(prev => ({
        ...prev,
        hp: Math.max(0, prev.hp - totalRawDamage),
        block: remainingBlock
      }));
      
      SoundSystem.damage();
      setAnimatingDamage(true);
      playHaptic(100);
      addTimer(() => setAnimatingDamage(false), 300);
      setRunStats(prev => ({ ...prev, damageTaken: prev.damageTaken + totalRawDamage }));
      announce(`Enemies attack! You take ${totalRawDamage} total damage.`, 'assertive');
    } else {
      // Update block even if no damage taken
      setPlayer(prev => ({
        ...prev,
        block: remainingBlock
      }));
      announce(`Enemies attack, but your block absorbs all damage.`);
    }
    
    // Update enemies array
    setEnemies(updatedEnemies);
    enemiesRef.current = updatedEnemies; // Also update ref immediately
    setCurrentEnemy(updatedEnemies[targetedEnemy]);
    
    // Combined log entry for multi-enemy
    const logEntry = enemies.length > 1 
      ? `âï¸ Enemy attacks: ${combinedLog.join(' | ')}`
      : combinedLog[0] || 'ð¹ Enemy acts';
    setCombatLog(prev => [logEntry, ...prev.slice(0, 5)]);
  }, [enemies, player, difficulty, firstHitTaken, playHaptic, announce, addTimer, targetedEnemy]);

  const startPlayerTurn = useCallback(() => {
    if (!player || !currentEnemy) return;
    
    // Use ref to get latest enemies state (fixes stale closure issue)
    const currentEnemies = enemiesRef.current;
    
    // Increment combat turn counter
    setCombatTurn(prev => prev + 1);
    
    // ============================================
    // CURSE DAMAGE PROCESSING
    // ============================================
    const cursesWithDamage = player.deck?.filter(c => c.type === 'curse' && c.damagePerTurn) || [];
    if (cursesWithDamage.length > 0) {
      let totalCurseDamage = 0;
      cursesWithDamage.forEach(curse => {
        totalCurseDamage += curse.damagePerTurn;
      });
      if (totalCurseDamage > 0) {
        setPlayer(prev => ({
          ...prev,
          hp: Math.max(0, prev.hp - totalCurseDamage)
        }));
        setCombatLog(prev => [
          `â ï¸ Curse damage: -${totalCurseDamage} HP (${cursesWithDamage.map(c => c.name).join(', ')})`,
          ...prev.slice(0, 5)
        ]);
      }
    }
    // ============================================
    // END CURSE DAMAGE PROCESSING
    // ============================================
    
    // Apply enemy abilities that affect player at start of turn
    const startAbility = currentEnemy.ability;
    let weakAmount = 0;
    let corruptionFromEnemy = 0;
    if (startAbility?.type === 'startTurn' && startAbility?.weakPlayer) {
      weakAmount = startAbility.weakPlayer;
    }
    // Apply corruption per turn from enemy passive (e.g., Sauron's One Ring)
    if (startAbility?.corruptionPerTurn) {
      corruptionFromEnemy = getCorruptionWithResistance(startAbility.corruptionPerTurn, player);
      if (corruptionFromEnemy > 0) {
        setCorruption(prev => Math.min(100, prev + corruptionFromEnemy));
        setCombatLog(prev => [`ð ${currentEnemy.name}'s dark presence corrupts you! (+${corruptionFromEnemy} corruption)`, ...prev.slice(0, 5)]);
      }
    }
    
    // Apply One Ring turnDamage effect (damages player each turn)
    const turnDamage = getRelicBonus(player, 'turnDamage');
    
    // Apply turnBlock relic effect (Nenya, Ring of Water)
    const turnBlock = getRelicBonus(player, 'turnBlock');
    
    setPlayer(prev => ({
      ...prev,
      hp: turnDamage > 0 ? Math.max(1, prev.hp - turnDamage) : prev.hp,
      block: (prev.dodge ? prev.block : 0) + turnBlock,
      vulnerable: Math.max(0, prev.vulnerable - 1),
      weak: Math.max(weakAmount, prev.weak - 1 + weakAmount),
      dodge: false // Reset dodge after one turn
    }));
    
    if (turnBlock > 0) {
      setCombatLog(prev => [`ð§ Nenya grants ${turnBlock} block!`, ...prev.slice(0, 5)]);
    }
    
    if (turnDamage > 0) {
      setCombatLog(prev => [`ð The One Ring corrupts you for ${turnDamage} damage!`, ...prev.slice(0, 5)]);
    }
    
    // Apply turnBurn relic effect (Narya, Ring of Fire) - deals fire damage to enemy
    const turnBurn = getRelicBonus(player, 'turnBurn');
    
    // US-001: Apply poison and burn damage to ALL enemies (use ref for latest state)
    let dotLogs = [];
    const updatedEnemies = currentEnemies.map(enemy => {
      if (enemy.hp <= 0) return enemy;
      
      const poisonDamage = enemy.poison || 0;
      const burnDamage = enemy.burn || 0;
      const totalDot = poisonDamage + burnDamage + turnBurn;
      
      if (totalDot > 0) {
        let dotParts = [];
        if (poisonDamage > 0) dotParts.push(`ð§ª${poisonDamage}`);
        if (burnDamage > 0) dotParts.push(`ð¥${burnDamage}`);
        if (turnBurn > 0) dotParts.push(`ð¥${turnBurn} (Narya)`);
        dotLogs.push(`${enemy.name}: ${dotParts.join('+')}`);
      }
      
      // Generate new intent for next turn
      const newIntent = getRandomIntent(enemy);
      
      return {
        ...enemy,
        hp: Math.max(0, enemy.hp - totalDot),
        // NOTE: Enemy block is NOT reset here - it persists through player turn
        // Block is reset at start of enemy turn instead
        vulnerable: Math.max(0, (enemy.vulnerable || 0) - 1),
        weak: Math.max(0, (enemy.weak || 0) - 1),
        poison: Math.max(0, poisonDamage - 1),
        burn: burnDamage, // burn doesn't decrease
        intent: newIntent
      };
    });
    
    if (dotLogs.length > 0) {
      setCombatLog(prev => [`ð DoT damage: ${dotLogs.join(' | ')}`, ...prev.slice(0, 5)]);
    }
    
    // US-001: Update enemies array
    setEnemies(updatedEnemies);
    enemiesRef.current = updatedEnemies; // Also update ref immediately
    setCurrentEnemy(updatedEnemies[targetedEnemy]);
    
    // Read from refs to get latest pile values (fixes stale closure issue)
    const currentDrawPile = drawPileRef.current;
    const currentDiscardPile = discardPileRef.current;
    
    // R003 - Skill bonuses for draw and energy
    const skillExtraDraw = player.skillBonuses?.extraDraw || 0;
    const skillBonusEnergy = player.skillBonuses?.bonusEnergy || 0;
    const skillHealPerTurn = player.skillBonuses?.healPerTurn || 0;
    
    // Apply heal per turn from skills
    if (skillHealPerTurn > 0) {
      setPlayer(prev => ({
        ...prev,
        hp: Math.min(prev.maxHp, prev.hp + skillHealPerTurn)
      }));
      setCombatLog(prev => [`â¨ Skill heals you for ${skillHealPerTurn} HP!`, ...prev.slice(0, 5)]);
    }
    
    const drawCount = 5 + getRelicBonus(player, 'bonusDraw') + skillExtraDraw;
    const { newHand, newDrawPile, newDiscardPile } = drawCardsHelper(drawCount, currentDrawPile, currentDiscardPile, []);
    
    // Update state and refs
    setHand(newHand);
    handRef.current = newHand;
    setDrawPile(newDrawPile);
    drawPileRef.current = newDrawPile;
    setDiscardPile(newDiscardPile);
    discardPileRef.current = newDiscardPile;
    
    setEnergy(player.maxEnergy + getRelicBonus(player, 'bonusEnergy') + skillBonusEnergy + DIFFICULTY[difficulty].energyBonus);
    setTurn('player');
    SoundSystem.turnStart();
    // US-001: Enemy intents now set per-enemy in the updatedEnemies map above
  }, [player, currentEnemy, enemies, targetedEnemy, drawCardsHelper, getRandomIntent]);

  const endTurn = useCallback(() => {
    if (turn !== 'player') return;
    if (combatPhase.phase === COMBAT_STATES.ENDING_TURN) return; // Prevent double-clicking
    
    // ENHANCEMENT: Combat state machine
    dispatchCombat({ type: 'END_TURN' });
    
    // ENHANCEMENT: Haptic feedback for mobile
    playHaptic(30);
    
    // ENHANCEMENT: Screen reader announcement
    announce('Ending your turn. Enemy is attacking.');
    
    // R002 - Reset played cards for next turn combo tracking
    setPlayedCardsThisTurn([]);
    
    // ============================================
    // ONE RING DEACTIVATION
    // ============================================
    if (player.ringActive) {
      setPlayer(prev => ({
        ...prev,
        strength: Math.max(0, (prev.strength || 0) - 3),
        dexterity: Math.max(0, (prev.dexterity || 0) - 3),
        ringActive: false,
        invisibility: false
      }));
      setCombatLog(prev => ['ð The Ring\'s power fades...', ...prev.slice(0, 5)]);
    }
    // ============================================
    // END RING DEACTIVATION
    // ============================================
    
    // CORRUPTION TIMER: The Ring's burden grows heavier each turn in combat
    const turnCorruption = getCorruptionWithResistance(CORRUPTION_SOURCES.turn_passed, player);
    if (turnCorruption > 0) {
      setCorruption(prev => Math.min(99, prev + turnCorruption));
    }
    
    // Update both state and refs (refs needed for startPlayerTurn which runs via setTimeout)
    const newDiscardPile = [...discardPile, ...hand];
    setDiscardPile(newDiscardPile);
    discardPileRef.current = newDiscardPile;
    setHand([]);
    handRef.current = [];
    setTurn('enemy');
    setRunStats(prev => ({ ...prev, turnsPlayed: prev.turnsPlayed + 1 }));
    
    // ENHANCEMENT: Use timer manager for proper cleanup
    addTimer(() => {
      dispatchCombat({ type: 'START_ENEMY_TURN' });
      enemyTurn();
      addTimer(() => {
        dispatchCombat({ type: 'ENEMY_DONE' });
        startPlayerTurn();
      }, 1500);
    }, 1000);
  }, [turn, hand, discardPile, enemyTurn, startPlayerTurn, combatPhase.phase, playHaptic, announce, addTimer]);

  useEffect(() => {
    if (gameState !== 'combat') return;
    if (!currentEnemy || !player) return;
    
    // R002 - Check for corruption game over (must happen before victory check)
    if (corruption >= 100) {
      SoundSystem.defeat();
      setCombatLog(prev => ['ð THE SHADOW HAS CONSUMED YOU! Sauron wins...', ...prev.slice(0, 5)]);
      setTimeout(() => setGameState('gameover'), 1000);
      return;
    }
    
    // US-001: Check if ALL enemies are defeated (for multi-enemy support)
    // Special case: Weathertop - only need to kill one NazgÃ»l
    const baseEncounter = ENCOUNTERS[currentEncounter];
    const encounter = getCharacterEncounter(currentEncounter, selectedCharacter, baseEncounter);
    const multiEncounter = encounter?.multiEnemy ? MULTI_ENEMY_ENCOUNTERS[encounter.multiEnemy] : null;
    const fleeOnFirstKill = multiEncounter?.fleeOnFirstKill || false;
    
    const anyEnemyDefeated = enemies.some(e => e.hp <= 0);
    const allEnemiesDefeated = enemies.every(e => e.hp <= 0);
    const victoryConditionMet = fleeOnFirstKill ? anyEnemyDefeated : allEnemiesDefeated;
    
    if (victoryConditionMet) {
      SoundSystem.victory();
      const isBoss = encounter?.tier === 'boss';
      const isElite = encounter?.tier === 'elite';
      const isEliteOrBoss = isElite || isBoss;
      const isMultiEnemy = enemies.length > 1;
      
      // Special story for Weathertop
      if (multiEncounter?.storyOnVictory) {
        const story = multiEncounter.storyOnVictory;
        setCorruption(prev => Math.min(99, prev + (story.corruptionGain || 0)));
        setCombatLog(prev => [`ð ${story.title}: ${story.text.substring(0, 50)}...`, ...prev.slice(0, 5)]);
        // Could add a modal here for the full story
      }
      
      // US-003: Record combat result for adaptive difficulty
      if (adaptiveEnabled) {
        const combatResult = {
          victory: true,
          damageTaken: runStats.damageTaken || 0,
          damageDealt: runStats.damageDealt || 0,
          cardsPlayed: runStats.cardsPlayed || 0,
          turns: combatPhase.turnNumber || 1,
          isElite,
          isBoss,
          isMultiEnemy,
          timestamp: Date.now()
        };
        setAdaptiveState(prev => recordCombatResult(prev, combatResult));
      }
      
      // R002 - Apply corruption from defeating elites/bosses (with Mithril resistance)
      // Cap at 99 to prevent immediate game over - player can still win but is on the edge
      if (isBoss) {
        const bossCorruption = getCorruptionWithResistance(CORRUPTION_SOURCES.boss_defeated, player);
        if (bossCorruption > 0) {
          setCorruption(prev => Math.min(99, prev + bossCorruption));
          setCombatLog(prev => [`ð Defeating the darkness corrupts you... (+${bossCorruption} corruption)`, ...prev.slice(0, 5)]);
        }
      } else if (isElite) {
        const eliteCorruption = getCorruptionWithResistance(CORRUPTION_SOURCES.elite_defeated, player);
        if (eliteCorruption > 0) {
          setCorruption(prev => Math.min(99, prev + eliteCorruption));
          setCombatLog(prev => [`ð Defeating powerful evil corrupts you... (+${eliteCorruption} corruption)`, ...prev.slice(0, 5)]);
        }
      }
      
      // R001 - Update story progress on victory
      updateStoryProgress('combat_victory', { isElite, isBoss });
      
      // R001 - Check for boss victory story beats
      if (isBoss) {
        const actNum = getCurrentAct(currentEncounter);
        checkStoryBeats('boss_defeated', actNum, currentEncounter);
      }
      
      // Generate rewards based on enemy tier
      if (isBoss) {
        // Boss gives boss relics
        setAvailableRelics(getBossRelicRewards(3, player.relics));
      } else if (isElite) {
        // Elite gives regular relics
        setAvailableRelics(getRelicRewards(3, player.relics));
      } else {
        setAvailableRelics([]);
      }
      
      // Generate card choices using weighted rarity system with colorless cards
      const cardChoices = getCardRewards(selectedCharacter, 3, true);
      setCardRewardChoices(cardChoices);
      setRewardsTaken({ gold: false, card: false, relic: false });
      // US-001: Count all enemies in multi-enemy encounters
      setRunStats(prev => ({ ...prev, enemiesDefeated: prev.enemiesDefeated + enemies.length }));
      
      // R003 - Award XP for defeating enemy (ONLY ONCE per combat)
      if (xpAwardedThisCombat.current) {
        console.log('[XP AWARD] Skipping - XP already awarded this combat');
        setTimeout(() => setGameState('rewards'), 1000);
        return;
      }
      xpAwardedThisCombat.current = true; // Mark XP as awarded
      
      const charProgress = playerProgress[selectedCharacter];
      const prestigeData = getPrestigeData(charProgress?.prestigeLevel || 0);
      const xpMultiplier = prestigeData.bonuses.xpMultiplier || 1;
      
      let baseXP = XP_REWARDS.enemy_defeated;
      if (isBoss) baseXP = XP_REWARDS.boss_defeated;
      else if (isElite) baseXP = XP_REWARDS.elite_defeated;
      // US-001: Bonus XP for multi-enemy fights
      if (isMultiEnemy) baseXP += Math.floor(XP_REWARDS.enemy_defeated * 0.5 * (enemies.length - 1));
      
      // Bonus XP for perfect combat (no damage taken this combat)
      const perfectCombat = runStats.damageTaken === 0;
      if (perfectCombat) baseXP += XP_REWARDS.perfect_combat;
      
      const earnedXP = Math.floor(baseXP * xpMultiplier);
      setSessionXP(prev => prev + earnedXP);
      
      // Get current character data to calculate level up BEFORE setState
      const currentCharData = playerProgress[selectedCharacter] || {};
      const currentXP = Number(currentCharData.xp) || 0;
      const currentLevel = Number(currentCharData.level) || 1;
      const newXP = currentXP + earnedXP;
      
      // SAFEGUARD: Always calculate level from XP, never trust stored level
      const calculatedNewLevel = getLevelFromXP(newXP);
      
      // Log for debugging (visible in browser console)
      console.log('[XP AWARD]', {
        selectedCharacter,
        currentCharData: JSON.stringify(currentCharData),
        currentXP,
        currentLevel,
        earnedXP,
        newXP,
        calculatedNewLevel,
        XP_PER_LEVEL: JSON.stringify(XP_PER_LEVEL)
      });
      
      // Only level up if the calculated level is actually higher AND makes sense
      const didLevelUp = calculatedNewLevel > currentLevel && calculatedNewLevel <= 10 && newXP >= XP_PER_LEVEL[calculatedNewLevel - 1];
      
      if (didLevelUp) {
        console.log('[XP AWARD] Level up triggered:', currentLevel, '->', calculatedNewLevel);
      }
      
      // Update persistent progress
      setPlayerProgress(prev => {
        const updated = { ...prev };
        const existingData = updated[selectedCharacter] || {};
        
        const charData = {
          xp: 0,
          level: 1,
          totalXP: 0,
          skillPoints: 0,
          unlockedSkills: [],
          prestigeLevel: 0,
          gamesCompleted: 0,
          ...existingData
        };
        
        charData.xp = (Number(charData.xp) || 0) + earnedXP;
        charData.totalXP = (Number(charData.totalXP) || 0) + earnedXP;
        
        // SAFEGUARD: Always recalculate level from actual XP
        const levelFromXP = getLevelFromXP(charData.xp);
        charData.level = levelFromXP;
        
        // Only add skill points if we actually leveled up
        if (didLevelUp && LEVEL_BONUSES[calculatedNewLevel]?.skillPoint) {
          charData.skillPoints = (Number(charData.skillPoints) || 0) + LEVEL_BONUSES[calculatedNewLevel].skillPoint;
        }
        
        console.log('[XP AWARD] Saving charData:', JSON.stringify(charData));
        
        updated[selectedCharacter] = charData;
        savePlayerProgress(updated);
        return updated;
      });
      
      // Handle level up notification AFTER setPlayerProgress (not inside it)
      if (didLevelUp) {
        setPendingLevelUp({ level: calculatedNewLevel, bonuses: LEVEL_BONUSES[calculatedNewLevel] });
        setShowLevelUp(true);
        
        // Apply maxHp and maxEnergy bonuses
        const hpBonus = LEVEL_BONUSES[calculatedNewLevel]?.maxHp || 0;
        const energyBonus = LEVEL_BONUSES[calculatedNewLevel]?.maxEnergy || 0;
        if (hpBonus > 0 || energyBonus > 0) {
          setPlayer(prev => ({
            ...prev,
            maxHp: prev.maxHp + hpBonus,
            hp: prev.hp + hpBonus,
            maxEnergy: prev.maxEnergy + energyBonus
          }));
        }
      }
      
      setCombatLog(prev => [`â­ +${earnedXP} XP${perfectCombat ? ' (Perfect!)' : ''}`, ...prev.slice(0, 5)]);
      
      // Apply combatHeal relic effect at end of combat
      const combatHealAmount = getRelicBonus(player, 'combatHeal');
      if (combatHealAmount > 0) {
        setPlayer(prev => ({
          ...prev,
          hp: Math.min(prev.maxHp, prev.hp + combatHealAmount)
        }));
        setCombatLog(prev => [`ð Healed ${combatHealAmount} HP from relics!`, ...prev.slice(0, 5)]);
      }
      
      // R003 - Apply skill healPerCombat
      const skillHealPerCombat = player.skillBonuses?.healPerCombat || 0;
      if (skillHealPerCombat > 0) {
        setPlayer(prev => ({
          ...prev,
          hp: Math.min(prev.maxHp, prev.hp + skillHealPerCombat)
        }));
        setCombatLog(prev => [`â¨ Skills heal ${skillHealPerCombat} HP after combat!`, ...prev.slice(0, 5)]);
      }
      
      // Apply Phial of Galadriel corruption reduction at end of combat
      if (hasRelic(player, 'phial') && corruption > 0) {
        const phialReduction = CORRUPTION_RESISTANCE_RELICS.phial.reduction;
        setCorruption(prev => Math.max(0, prev - phialReduction));
        setCombatLog(prev => [`â¨ Phial of Galadriel cleanses ${phialReduction} corruption!`, ...prev.slice(0, 5)]);
      }
      
      setTimeout(() => setGameState('rewards'), 1000);
    } else if (player.hp <= 0) {
      SoundSystem.defeat();
      
      // US-003: Record combat loss for adaptive difficulty
      if (adaptiveEnabled) {
        const combatResult = {
          victory: false,
          damageTaken: runStats.damageTaken || 0,
          damageDealt: runStats.damageDealt || 0,
          cardsPlayed: runStats.cardsPlayed || 0,
          turns: combatPhase.turnNumber || 1,
          isElite: ENCOUNTERS[currentEncounter]?.tier === 'elite',
          isBoss: ENCOUNTERS[currentEncounter]?.tier === 'boss',
          timestamp: Date.now()
        };
        setAdaptiveState(prev => recordCombatResult(prev, combatResult));
      }
      
      setTimeout(() => setGameState('gameover'), 1000);
    }
  }, [currentEnemy, player, gameState, corruption, adaptiveEnabled, runStats, combatPhase.turnNumber, currentEncounter, playerProgress, selectedCharacter]);

  const proceedFromRewards = useCallback(() => {
    const encounter = ENCOUNTERS[currentEncounter];
    const currentActNum = getCurrentAct(currentEncounter);
    const isBoss = encounter?.tier === 'boss';
    
    // CORRUPTION TIMER: The Ring's burden grows with each step of the journey
    const passiveCorruption = getCorruptionWithResistance(CORRUPTION_SOURCES.encounter_progress, player);
    if (passiveCorruption > 0 && currentEncounter < ENCOUNTERS.length - 1) {
      setCorruption(prev => Math.min(99, prev + passiveCorruption));
    }
    
    // Check if this was an act boss
    if (isBoss && currentEncounter < ENCOUNTERS.length - 1) {
      // Act transition
      const nextAct = currentActNum + 1;
      setCurrentAct(nextAct);
      transformCharacter(nextAct);
      
      // R001 - Trigger act start story and update progress
      updateStoryProgress('act_start', { act: nextAct });
      
      setShowActTransition(true);
      setTimeout(() => {
        setShowActTransition(false);
        setCurrentEncounter(prev => prev + 1);
        
        // R001 - Check for act opening story beat after transition
        checkStoryBeats('act_start', nextAct, currentEncounter + 1);
        
        setGameState('map');
      }, 3000);
    } else if (currentEncounter < ENCOUNTERS.length - 1) {
      setCurrentEncounter(prev => prev + 1);
      setGameState('map');
    } else {
      // Final boss defeated - victory!
      SaveSystem.deleteSave().then(() => {
        setHasSavedGame(false);
      });
      setGameState('victory');
    }
  }, [currentEncounter, transformCharacter, updateStoryProgress, checkStoryBeats]);

  const selectReward = (rewardType, relicId = null, cardChoice = null) => {
    const encounter = ENCOUNTERS[currentEncounter];
    const isBoss = encounter?.tier === 'boss';
    const isEliteOrBoss = encounter?.tier === 'elite' || isBoss;
    
    if (rewardType === 'relic' && relicId) {
      if (!player.relics.includes(relicId)) {
        // Check both regular and boss relics
        const relic = RELICS[relicId] || BOSS_RELICS[relicId];
        
        // Apply bonusMaxHp immediately when acquiring relic
        const maxHpBonus = relic?.effect?.bonusMaxHp || 0;
        
        setPlayer(prev => ({
          ...prev,
          relics: [...prev.relics, relicId],
          maxHp: prev.maxHp + maxHpBonus,
          hp: prev.hp + maxHpBonus // Also heal the bonus HP
        }));
        
        // Apply Evenstar corruption reduction on acquisition
        if (relicId === 'evenstar' && corruption > 0) {
          const reduction = Math.min(corruption, CORRUPTION_RESISTANCE_RELICS.evenstar.reduction);
          setCorruption(prev => Math.max(0, prev - reduction));
          setCombatLog([`â¨ Acquired ${relic?.name || 'Unknown Relic'}!${maxHpBonus > 0 ? ` +${maxHpBonus} Max HP!` : ''} ð Light cleanses ${reduction} corruption!`]);
        } else {
          SoundSystem.heal();
          setCombatLog([`â¨ Acquired ${relic?.name || 'Unknown Relic'}!${maxHpBonus > 0 ? ` +${maxHpBonus} Max HP!` : ''}`]);
        }
      }
      setRewardsTaken(prev => ({ ...prev, relic: true }));
      setAvailableRelics([]);
      return;
    }
    
    if (rewardType === 'card' && cardChoice) {
      setPlayer(prev => ({
        ...prev,
        deck: [...prev.deck, { ...cardChoice, uid: `${cardChoice.id}_${Date.now()}` }]
      }));
      setCombatLog([`â¨ Added ${cardChoice.name} to your deck!`]);
      setRewardsTaken(prev => ({ ...prev, card: true }));
      setCardRewardChoices([]);
      return;
    } 
    
    if (rewardType === 'gold') {
      const baseGold = encounter?.reward?.gold || 25;
      // Add random gold for elites/bosses (50-100 range)
      const bonusGold = getRelicBonus(player, 'bonusGold');
      const goldAmount = (isEliteOrBoss ? baseGold + Math.floor(Math.random() * 50) : baseGold) + bonusGold;
      setPlayer(prev => ({ ...prev, gold: prev.gold + goldAmount }));
      SoundSystem.buttonClick();
      setCombatLog([`ð° Gained ${goldAmount} gold!${bonusGold > 0 ? ` (+${bonusGold} from relics)` : ''}`]);
      setRewardsTaken(prev => ({ ...prev, gold: true }));
      return;
    }
    
    if (rewardType === 'potion') {
      if (player.potions.length < 3) {
        const newPotion = getRandomPotion();
        setPlayer(prev => ({ ...prev, potions: [...prev.potions, newPotion] }));
        SoundSystem.heal();
        setCombatLog([`ð§ª Obtained ${POTIONS[newPotion].name}!`]);
      } else {
        setCombatLog([`â ï¸ Potion slots full!`]);
      }
      return;
    }
    
    if (rewardType === 'skip') {
      // Mark card as skipped
      setRewardsTaken(prev => ({ ...prev, card: true }));
      setCardRewardChoices([]);
      return;
    }
    
    if (rewardType === 'proceed') {
      proceedFromRewards();
    }
  };

  

  // Check for saved game on mount
  useEffect(() => {
    const checkSave = async () => {
      const hasSave = await SaveSystem.hasSave();
      setHasSavedGame(hasSave);
    };
    checkSave();
  }, []);

  // Auto-save when on map
  useEffect(() => {
    if (gameState === 'map' && player) {
      const saveData = {
        player,
        selectedCharacter,
        currentEncounter,
        currentAct,
        soundEnabled,
        difficulty
      };
      SaveSystem.save(saveData).then(() => {
        setHasSavedGame(true);
      });
    }
  }, [gameState, player, selectedCharacter, currentEncounter, currentAct, soundEnabled]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (gameState !== 'combat' || turn !== 'player') return;
      
      // E or Space to end turn
      if (e.key === 'e' || e.key === 'E' || e.key === ' ') {
        e.preventDefault();
        endTurn();
        return;
      }
      
      // Number keys 1-9 to play cards
      const num = parseInt(e.key);
      if (num >= 1 && num <= 9 && num <= hand.length) {
        const card = hand[num - 1];
        if (card && card.cost <= energy) {
          playCard(card);
        }
      }
      
      // D to view draw pile
      if (e.key === 'd' || e.key === 'D') {
        setViewingPile(viewingPile === 'draw' ? null : 'draw');
      }
      
      // S to view discard pile
      if (e.key === 's' || e.key === 'S') {
        setViewingPile(viewingPile === 'discard' ? null : 'discard');
      }
      
      // Escape to close overlays
      if (e.key === 'Escape') {
        if (previewedCard) {
          setPreviewedCard(null);
        } else {
          setViewingPile(null);
        }
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [gameState, turn, hand, energy, endTurn, playCard, viewingPile, previewedCard]);

  const loadGame = async () => {
    const saveData = await SaveSystem.load();
    if (saveData) {
      setPlayer(saveData.player);
      setSelectedCharacter(saveData.selectedCharacter);
      setCurrentEncounter(saveData.currentEncounter);
      setCurrentAct(saveData.currentAct || getCurrentAct(saveData.currentEncounter));
      setSoundEnabled(saveData.soundEnabled);
      SoundSystem.enabled = saveData.soundEnabled;
      setDifficulty(saveData.difficulty || 'normal');
      setGameState('map');
      SoundSystem.buttonClick();
    }
  };

  const deleteSave = async () => {
    await SaveSystem.deleteSave();
    setHasSavedGame(false);
  };


  const resetGame = () => {
    setGameState('menu');
    setPlayer(null);
    setSelectedCharacter(null);
    setCurrentEncounter(0);
    setCurrentEnemy(null);
    setCombatLog([]);
    setRunStats({ damageDealt: 0, damageTaken: 0, cardsPlayed: 0, turnsPlayed: 0, enemiesDefeated: 0 });
  };

  // ============================================
  // RENDER FUNCTIONS
  // ============================================

  const renderMenu = () => (
    <div style={styles.menuScreen}>
      <div style={styles.menuDecoration}></div>
      <h1 style={styles.menuTitle}>âï¸ Deck of the Rings âï¸</h1>
      <h2 style={styles.menuSubtitle}>A Middle-earth Card Game</h2>
      
      <div style={{ margin: '35px 0', display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '30px' }}>
        <Portrait src={characterImages.strider} size={100} border="#228b22" />
        <span style={{ fontSize: '2.5rem', color: '#d4af37', textShadow: '0 0 20px rgba(212,175,55,0.5)' }}>VS</span>
        <Portrait src={characterImages.balrog} size={100} border="#dc143c" />
      </div>
      
      <p style={styles.menuDescription}>
        Build your deck, master powerful cards, and battle the forces of darkness
        across Middle-earth. Choose your hero and begin your epic journey!
      </p>
      
      <RunicDivider />
      
      <div style={{ marginTop: '30px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '15px' }}>
        <MiddleEarthButton 
          variant="primary"
          onClick={() => setGameState('character-select')}
          style={{ minWidth: '250px' }}
        >
          ð¡ï¸ Begin New Adventure
        </MiddleEarthButton>
        
        <MiddleEarthButton 
          variant={soundEnabled ? 'secondary' : 'danger'}
          onClick={() => { setSoundEnabled(!soundEnabled); SoundSystem.enabled = !SoundSystem.enabled; SoundSystem.buttonClick(); }}
          style={{ minWidth: '200px' }}
        >
          {soundEnabled ? 'ð Sound On' : 'ð Sound Off'}
        </MiddleEarthButton>
        
        {hasSavedGame && !player && (
          <MiddleEarthButton 
            variant="secondary"
            onClick={loadGame}
            style={{ minWidth: '220px' }}
          >
            ð Load Saved Game
          </MiddleEarthButton>
        )}
        
        {hasSavedGame && (
          <MiddleEarthButton 
            variant="danger"
            onClick={deleteSave}
            style={{ minWidth: '180px', fontSize: '0.9rem', padding: '10px 20px' }}
          >
            ðï¸ Delete Save
          </MiddleEarthButton>
        )}
        
        {player && (
          <>
            <RunicDivider width="60%" opacity={0.4} />
            <MiddleEarthButton 
              variant="primary"
              onClick={() => setGameState('map')}
              style={{ minWidth: '220px' }}
            >
              ðºï¸ Continue Journey
            </MiddleEarthButton>
            <MiddleEarthButton 
              variant="default"
              onClick={() => setGameState('deck-view')}
              style={{ minWidth: '180px' }}
            >
              ð View Deck
            </MiddleEarthButton>
          </>
        )}
      </div>
    </div>
  );

  const renderCharacterSelect = () => (
    <div style={styles.characterSelect}>
      <h2 style={{ fontSize: 'clamp(1.5rem, 4vw, 2.5rem)', color: '#d4af37', marginBottom: '10px', textShadow: '0 2px 4px rgba(0,0,0,0.8)' }}>
        Choose Your Hero
      </h2>
      <p style={{ color: '#a89878', marginBottom: '10px', fontSize: '1.1rem' }}>
        Each hero has unique abilities and playstyle
      </p>
      <div style={{ marginBottom: '20px' }}>
        <h3 style={{ color: '#d4af37', marginBottom: '15px' }}>Select Difficulty</h3>
        <div style={styles.difficultySelector}>
          {Object.entries(DIFFICULTY).map(([key, diff]) => (
            <div 
              key={key}
              style={{
                ...styles.difficultyOption,
                ...(difficulty === key ? styles.difficultySelected : {})
              }}
              onClick={() => setDifficulty(key)}
            >
              <div style={{ fontWeight: 'bold', color: key === 'nightmare' ? '#ff6b6b' : '#f4e4bc', marginBottom: '5px' }}>
                {diff.name}
              </div>
              <div style={{ fontSize: '0.8rem', color: '#888' }}>{diff.description}</div>
            </div>
          ))}
        </div>
        
        {/* US-003: Adaptive Difficulty Toggle */}
        <div style={{
          marginTop: '15px',
          padding: '12px 18px',
          background: adaptiveEnabled ? 'rgba(34, 139, 34, 0.2)' : 'rgba(100, 100, 100, 0.2)',
          border: `2px solid ${adaptiveEnabled ? '#228b22' : '#666'}`,
          borderRadius: '10px',
          cursor: 'pointer',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          transition: 'all 0.2s ease'
        }}
        onClick={() => setAdaptiveEnabled(!adaptiveEnabled)}
        >
          <div>
            <div style={{ fontWeight: 'bold', color: adaptiveEnabled ? '#90ee90' : '#aaa', marginBottom: '4px' }}>
              âï¸ Adaptive Difficulty
            </div>
            <div style={{ fontSize: '0.75rem', color: '#999' }}>
              {adaptiveEnabled 
                ? `Game adjusts to your skill â¢ Current: ${(adaptiveState.currentScale * 100).toFixed(0)}%`
                : 'Click to enable dynamic difficulty scaling'}
            </div>
          </div>
          <div style={{
            width: '50px',
            height: '26px',
            background: adaptiveEnabled ? '#228b22' : '#555',
            borderRadius: '13px',
            padding: '2px',
            transition: 'all 0.2s ease'
          }}>
            <div style={{
              width: '22px',
              height: '22px',
              background: '#fff',
              borderRadius: '50%',
              transition: 'transform 0.2s ease',
              transform: adaptiveEnabled ? 'translateX(24px)' : 'translateX(0)'
            }} />
          </div>
        </div>
        
        {/* Adaptive Difficulty Stats */}
        {adaptiveEnabled && adaptiveState.recentCombats.length > 0 && (
          <div style={{
            marginTop: '10px',
            padding: '10px',
            background: 'rgba(0, 0, 0, 0.3)',
            borderRadius: '8px',
            fontSize: '0.75rem',
            color: '#999'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}>
              <span>Win Streak: {adaptiveState.winStreak}</span>
              <span>Loss Streak: {adaptiveState.lossStreak}</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <span>Combats: {adaptiveState.totalCombatsWon}W / {adaptiveState.totalCombatsLost}L</span>
              <span>Perfect: {adaptiveState.perfectCombats}</span>
            </div>
          </div>
        )}
      </div>

      
      <div style={styles.characterGrid}>
        {Object.entries(CHARACTERS).map(([key, character]) => {
          const rawCharProgress = playerProgress[key] || DEFAULT_PLAYER_PROGRESS[key];
          // ALWAYS calculate level from XP - never trust stored level
          const actualLevel = getLevelFromXP(rawCharProgress.xp || 0);
          const charProgress = {
            ...rawCharProgress,
            level: actualLevel,
            xp: Math.max(0, Number(rawCharProgress.xp) || 0)
          };
          const prestigeData = getPrestigeData(charProgress.prestigeLevel || 0);
          
          return (
          <div 
            key={key} 
            style={styles.characterCard} 
            onClick={() => initializeCharacter(key)}
            onMouseOver={(e) => {
              e.currentTarget.style.transform = 'translateY(-8px) scale(1.02)';
              e.currentTarget.style.boxShadow = '0 20px 50px rgba(212, 175, 55, 0.35)';
              e.currentTarget.style.borderColor = '#d4af37';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.transform = 'translateY(0) scale(1)';
              e.currentTarget.style.boxShadow = '0 10px 40px rgba(0,0,0,0.5)';
              e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.5)';
            }}
          >
            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '15px' }}>
              <Portrait src={character.image} size={140} border={key === 'aragorn' ? '#228b22' : '#4169e1'} />
            </div>
            <h3 style={{ fontSize: '1.6rem', margin: '10px 0 5px', color: '#f4e4bc' }}>{character.name}</h3>
            <p style={styles.characterClass}>{character.class}</p>
            
            {/* R003 - Level and Prestige Display */}
            <div style={{
              display: 'flex',
              justifyContent: 'center',
              gap: '15px',
              marginBottom: '10px',
              flexWrap: 'wrap',
            }}>
              <span style={{ 
                background: 'rgba(255, 215, 0, 0.2)', 
                padding: '4px 10px', 
                borderRadius: '10px',
                color: '#ffd700',
                fontSize: '0.85rem',
              }}>
                â­ Lvl {Math.max(1, Number(charProgress.level) || 1)}
              </span>
              {(Number(charProgress.prestigeLevel) || 0) > 0 && (
                <span style={{ 
                  background: 'rgba(138, 43, 226, 0.3)', 
                  padding: '4px 10px', 
                  borderRadius: '10px',
                  color: '#da70d6',
                  fontSize: '0.85rem',
                }}>
                  {prestigeData.icon} {prestigeData.name}
                </span>
              )}
              {(Number(charProgress.skillPoints) || 0) > 0 && (
                <span style={{ 
                  background: 'rgba(34, 139, 34, 0.3)', 
                  padding: '4px 10px', 
                  borderRadius: '10px',
                  color: '#90ee90',
                  fontSize: '0.85rem',
                  animation: 'pulse 2s infinite',
                }}>
                  ð® {charProgress.skillPoints} pts
                </span>
              )}
            </div>
            
            {/* XP Progress Bar */}
            <div style={{
              width: '80%',
              margin: '0 auto 10px',
              height: '6px',
              background: 'rgba(0, 0, 0, 0.4)',
              borderRadius: '3px',
              overflow: 'hidden',
            }}>
              <div style={{
                width: `${getXPProgress(Number(charProgress.xp) || 0, Math.max(1, Number(charProgress.level) || 1))}%`,
                height: '100%',
                background: 'linear-gradient(90deg, #ffd700, #ffaa00)',
              }} />
            </div>
            
            <div style={styles.characterStats}>
              <div style={{ margin: '8px 0', fontSize: '1.05rem' }}>â¤ï¸ Health: {character.maxHp}</div>
              <div style={{ margin: '8px 0', fontSize: '1.05rem' }}>â¡ {character.energyType}: {character.maxEnergy}/turn</div>
            </div>
            <p style={{ color: '#a89878', fontSize: '0.95rem', lineHeight: '1.6', marginTop: '10px' }}>
              {key === 'aragorn' 
                ? 'A mighty warrior-king. Focus on powerful attacks and building strength to overwhelm foes.'
                : key === 'legolas'
                ? 'An agile elven archer. Excel at precise multi-shots and evasive maneuvers.'
                : key === 'gimli'
                ? 'A stalwart dwarven warrior. High health and fury-powered axe attacks crush your enemies.'
                : 'A powerful wizard. Master fire and arcane magic with energy manipulation and devastating spells.'}
            </p>
          </div>
        )})}
      </div>
      
      <div style={{ display: 'flex', gap: '15px', justifyContent: 'center', marginTop: '40px', flexWrap: 'wrap' }}>
        <button 
          style={{...styles.button}} 
          onClick={() => setGameState('menu')}
        >
          â Back to Menu
        </button>
        <button 
          style={{
            ...styles.button, 
            background: 'linear-gradient(145deg, #8b0000, #5a0000)',
            fontSize: '0.85rem',
          }} 
          onClick={() => setShowResetConfirm('all')}
        >
          ð Reset All Progress
        </button>
      </div>
      
      {/* Reset Confirmation Modal */}
      {showResetConfirm && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.9)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 1000,
        }}>
          <div style={{
            background: 'linear-gradient(145deg, #2d1a0a, #1a0f05)',
            borderRadius: '20px',
            padding: '30px',
            maxWidth: '400px',
            width: '90%',
            border: '3px solid #ff6b6b',
            textAlign: 'center',
          }}>
            <h3 style={{ color: '#ff6b6b', marginBottom: '15px' }}>â ï¸ Reset Progress?</h3>
            <p style={{ color: '#c4b89a', marginBottom: '20px' }}>
              This will reset ALL character levels, XP, skill points, and prestige back to zero. This cannot be undone!
            </p>
            <div style={{ display: 'flex', gap: '15px', justifyContent: 'center' }}>
              <button
                style={{
                  ...styles.button,
                  background: 'linear-gradient(145deg, #8b0000, #5a0000)',
                }}
                onClick={() => {
                  // Reset all progress
                  const freshProgress = { ...DEFAULT_PLAYER_PROGRESS };
                  setPlayerProgress(freshProgress);
                  savePlayerProgress(freshProgress);
                  // Also reset session state
                  setSessionXP(0);
                  setShowLevelUp(false);
                  setPendingLevelUp(null);
                  setShowResetConfirm(null);
                }}
              >
                Yes, Reset All
              </button>
              <button
                style={{
                  ...styles.button,
                  background: 'linear-gradient(145deg, #228b22, #145214)',
                }}
                onClick={() => setShowResetConfirm(null)}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );

  const renderMap = () => {
    if (!player) return null;
    
    const actNum = getCurrentAct(currentEncounter);
    const actInfo = ACT_INFO[actNum];
    const actStartIdx = getActStartIndex(actNum);
    const actEncounters = actNum === 1 ? ACT_1_ENCOUNTERS : actNum === 2 ? ACT_2_ENCOUNTERS : ACT_3_ENCOUNTERS;
    
    // Get the player's current portrait (may be transformed)
    const playerImage = player.image || CHARACTERS[selectedCharacter]?.image;
    
    // Act transition screen
    if (showActTransition) {
      const newActInfo = ACT_INFO[actNum];
      return (
        <div style={{
          ...styles.mapScreen,
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '80vh',
          textAlign: 'center'
        }}>
          <h1 style={{color: '#d4af37', fontSize: '2.5rem', marginBottom: '20px', textShadow: '0 0 30px rgba(212,175,55,0.5)'}}>
            Act {actNum}
          </h1>
          <h2 style={{color: '#f4e4bc', fontSize: '2rem', marginBottom: '10px'}}>
            {newActInfo?.name}
          </h2>
          <p style={{color: '#c4b89a', fontSize: '1.2rem', fontStyle: 'italic', marginBottom: '30px'}}>
            {newActInfo?.subtitle}
          </p>
          {player.transformed && (
            <div style={{
              background: 'rgba(144,238,144,0.2)',
              border: '2px solid #90ee90',
              borderRadius: '12px',
              padding: '20px',
              marginBottom: '20px'
            }}>
              <p style={{color: '#90ee90', fontSize: '1.1rem'}}>
                â¨ {player.name} has awakened!
              </p>
            </div>
          )}
        </div>
      );
    }
    
    return (
      <div style={styles.mapScreen}>
        {/* Act Header */}
        <div style={{
          textAlign: 'center',
          marginBottom: '20px',
          padding: '15px',
          background: 'linear-gradient(145deg, rgba(139, 69, 19, 0.3) 0%, rgba(30, 15, 8, 0.5) 100%)',
          borderRadius: '12px',
          border: '1px solid rgba(212, 175, 55, 0.3)'
        }}>
          <h2 style={{color: '#d4af37', margin: 0, fontSize: '1.4rem'}}>Act {actNum}: {actInfo?.name}</h2>
          <p style={{color: '#c4b89a', margin: '5px 0 0', fontStyle: 'italic'}}>{actInfo?.subtitle}</p>
        </div>
        
        <div style={styles.characterInfo}>
          <Portrait src={playerImage} size={90} border="#228b22" />
          <div>
            <h2 style={{ margin: 0, color: '#d4af37', fontSize: '1.8rem' }}>{player.name}</h2>
            <p style={{ margin: '5px 0', color: '#c4b89a', fontSize: '1.1rem' }}>{player.class}</p>
            <div style={{ display: 'flex', gap: '25px', marginTop: '12px', fontSize: '1.1rem' }}>
              <span>â¤ï¸ {player.hp}/{player.maxHp}</span>
              <span>ð {player.deck.length} cards</span>
              <span>ð° {player.gold || 0} gold</span>
              {player.strength > 0 && <span>ðª {player.strength}</span>}
              {player.dexterity > 0 && <span>ð {player.dexterity}</span>}
            </div>
            {player.relics?.length > 0 && (
              <div style={styles.relicDisplay}>
                {player.relics.map(relicId => {
                  const relic = getRelic(relicId);
                  return (
                  <div 
                    key={relicId} 
                    style={{
                      ...styles.relicBadge,
                      flexDirection: 'column',
                      alignItems: 'center',
                      padding: '10px 14px',
                      minWidth: '100px',
                    }}
                  >
                    <div style={{display: 'flex', alignItems: 'center', gap: '6px'}}>
                      <span style={{fontSize: '1.2rem'}}>{relic?.icon}</span>
                      <span style={{fontSize: '0.85rem', fontWeight: 'bold', color: '#f4e4bc'}}>{relic?.name}</span>
                    </div>
                    <div style={{fontSize: '0.7rem', color: '#a89878', marginTop: '4px', textAlign: 'center'}}>
                      {relic?.description}
                    </div>
                  </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
        
        {/* CORRUPTION TIMER - Frodo's Burden on Map */}
        <div style={{
          background: corruption >= 75 ? 'rgba(60, 0, 0, 0.6)' : 'rgba(75, 0, 130, 0.2)',
          border: `2px solid ${corruption >= 75 ? '#8b0000' : corruption >= 50 ? '#ff6b00' : 'rgba(147, 112, 219, 0.5)'}`,
          borderRadius: '12px',
          padding: '12px 20px',
          marginBottom: '20px',
          display: 'flex',
          alignItems: 'center',
          gap: '15px',
          justifyContent: 'center',
          boxShadow: corruption >= 75 ? '0 0 20px rgba(139, 0, 0, 0.4)' : 'none',
        }}>
          <span style={{ fontSize: '1.5rem' }}>ð</span>
          <div style={{ flex: 1, maxWidth: '300px' }}>
            <div style={{ 
              fontSize: '0.85rem', 
              color: corruption >= 75 ? '#ff6b6b' : '#d4af37', 
              marginBottom: '5px',
              fontWeight: 'bold'
            }}>
              Frodo's Burden: {corruption}%
            </div>
            <div style={{
              width: '100%',
              height: '10px',
              background: 'rgba(0, 0, 0, 0.5)',
              borderRadius: '5px',
              overflow: 'hidden',
            }}>
              <div style={{
                width: `${corruption}%`,
                height: '100%',
                background: corruption >= 75 ? 'linear-gradient(90deg, #4a0080, #8b0000)' : 
                           corruption >= 50 ? 'linear-gradient(90deg, #4a0080, #ff6b00)' : 
                           'linear-gradient(90deg, #2d0066, #4a0080)',
                transition: 'width 0.5s ease',
              }} />
            </div>
            <div style={{ fontSize: '0.7rem', color: '#c4b89a', marginTop: '4px', fontStyle: 'italic' }}>
              {corruption >= 75 ? 'â ï¸ The Eye of Sauron turns toward you!' : 
               corruption >= 50 ? 'The Ring grows heavier with each step...' : 
               corruption >= 25 ? 'Dark whispers reach your ears...' : 
               'The journey to Mount Doom continues'}
            </div>
          </div>
          {corruption >= 50 && (
            <span style={{ fontSize: '1.2rem' }}>ðï¸</span>
          )}
        </div>
        
        <h3 style={{textAlign: 'center', color: '#d4af37', fontSize: '1.3rem', marginBottom: '20px'}}>
          ð Journey Progress ({currentEncounter - actStartIdx + 1}/{actEncounters.length})
        </h3>
        
        <div style={styles.encounterPath}>
          {actEncounters.map((baseEncounter, localIndex) => {
            const globalIndex = actStartIdx + localIndex;
            // Apply character-specific encounter modifications
            const encounter = getCharacterEncounter(globalIndex, selectedCharacter, { ...baseEncounter, act: actNum, actIndex: localIndex });
            const enemy = encounter.enemy ? ENEMIES[encounter.enemy] : null;
            const isRestSite = encounter.type === 'rest';
            const isShop = encounter.type === 'shop';
            const isEvent = encounter.type === 'event';
            const eventData = isEvent ? EVENT_LOCATIONS[encounter.event] : null;
            const isCurrent = globalIndex === currentEncounter;
            const isCompleted = globalIndex < currentEncounter;
            const isLocked = globalIndex > currentEncounter;
            const isElite = encounter.tier === 'elite';
            const isBoss = encounter.tier === 'boss';
            
            const nodeStyle = {
              ...styles.encounterNode,
              ...(isCurrent ? styles.encounterNodeCurrent : {}),
              ...(isCompleted ? styles.encounterNodeCompleted : {}),
              ...(isLocked ? styles.encounterNodeLocked : {}),
              ...(isBoss ? { borderColor: isCurrent ? '#ff6b6b' : '#8b0000', boxShadow: isCurrent ? '0 0 30px rgba(255,0,0,0.4)' : 'none' } : {}),
              ...(isElite ? { borderColor: isCurrent ? '#ffd700' : '#b8860b' } : {}),
              ...(isEvent ? { borderColor: isCurrent ? '#9370db' : '#6a5acd', boxShadow: isCurrent ? '0 0 30px rgba(147, 112, 219, 0.4)' : 'none' } : {}),
            };
            
            return (
              <div 
                key={globalIndex} 
                style={nodeStyle}
                onClick={() => isCurrent && startEncounter(globalIndex)}
                onMouseOver={(e) => {
                  if (isCurrent) {
                    e.currentTarget.style.transform = 'scale(1.12)';
                    e.currentTarget.style.boxShadow = isBoss ? '0 0 40px rgba(255, 0, 0, 0.6)' : isEvent ? '0 0 40px rgba(147, 112, 219, 0.6)' : '0 0 40px rgba(212, 175, 55, 0.6)';
                  }
                }}
                onMouseOut={(e) => {
                  if (isCurrent) {
                    e.currentTarget.style.transform = 'scale(1.08)';
                    e.currentTarget.style.boxShadow = isBoss ? '0 0 30px rgba(255, 0, 0, 0.4)' : isEvent ? '0 0 30px rgba(147, 112, 219, 0.4)' : '0 0 30px rgba(212, 175, 55, 0.5)';
                  }
                }}
              >
                {/* Tier indicator */}
                {isBoss && <div style={{position: 'absolute', top: '-10px', left: '50%', transform: 'translateX(-50%)', color: '#ff6b6b', fontWeight: 'bold', fontSize: '0.8rem'}}>ð BOSS</div>}
                {isElite && !isBoss && <div style={{position: 'absolute', top: '-10px', left: '50%', transform: 'translateX(-50%)', color: '#ffd700', fontWeight: 'bold', fontSize: '0.8rem'}}>â­ ELITE</div>}
                {isEvent && <div style={{position: 'absolute', top: '-10px', left: '50%', transform: 'translateX(-50%)', color: '#9370db', fontWeight: 'bold', fontSize: '0.8rem'}}>ð EVENT</div>}
                
                {isRestSite ? (
                  <div style={{ fontSize: '3rem', marginBottom: '10px' }}>ðï¸</div>
                ) : isShop ? (
                  <div style={{ fontSize: '3rem', marginBottom: '10px' }}>ðª</div>
                ) : isEvent ? (
                  <div style={{ fontSize: '3rem', marginBottom: '10px' }}>{eventData?.icon || 'â'}</div>
                ) : (
                  <div style={{ marginBottom: '10px' }}>
                    <Portrait 
                    src={enemy?.image} 
                    size={60} 
                    border={isCompleted ? '#228b22' : isCurrent ? (isBoss ? '#ff6b6b' : '#d4af37') : '#666'}
                  />
                  </div>
                )}
                <div style={{fontWeight: 'bold', fontSize: '0.85rem', marginTop: '8px'}}>
                  {isRestSite ? 'Rest Site' : isShop ? 'Merchant' : isEvent ? (eventData?.name?.split(' - ')[0] || 'Event') : enemy?.name}
                </div>
                {!isRestSite && !isShop && !isEvent && <div style={{ color: '#ff6b6b', fontSize: '0.9rem' }}>â¤ï¸ {enemy?.maxHp}</div>}
                {!isRestSite && !isShop && !isEvent && (isElite || isBoss) && (
                  <div style={{fontSize: '0.7rem', color: '#d4af37', marginTop: '4px'}}>
                    ð°+ð+â¨
                  </div>
                )}
                {isRestSite && <div style={{fontSize: '0.75rem', color: '#90ee90', marginTop: '4px'}}>Heal or Upgrade</div>}
                {isShop && <div style={{fontSize: '0.75rem', color: '#ffd700', marginTop: '4px'}}>Buy Cards & Relics</div>}
                {isEvent && <div style={{fontSize: '0.75rem', color: '#9370db', marginTop: '4px'}}>Random Event</div>}
                {isCompleted && <div style={{color: '#90ee90', marginTop: '8px', fontWeight: 'bold'}}>â {isEvent ? 'Visited' : 'Defeated'}</div>}
                {isCurrent && <div style={{color: isEvent ? '#9370db' : isBoss ? '#ff6b6b' : '#ffd700', marginTop: '8px', fontWeight: 'bold'}}>{isEvent ? 'ð Enter!' : 'âï¸ Challenge!'}</div>}
                {isLocked && <div style={{color: '#666', marginTop: '8px'}}>ð Locked</div>}
              </div>
            );
          })}
        </div>
        
        <div style={styles.mapActions}>
          <button 
            style={styles.button} 
            onClick={() => setGameState('deck-view')}
            onMouseOver={(e) => {
              e.currentTarget.style.transform = 'translateY(-3px)';
              e.currentTarget.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.3)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
            }}
          >
            ð View Deck
          </button>
          <button 
            style={styles.button} 
            onClick={() => setGameState('menu')}
            onMouseOver={(e) => {
              e.currentTarget.style.transform = 'translateY(-3px)';
              e.currentTarget.style.boxShadow = '0 8px 25px rgba(0,0,0,0.5)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
            }}
          >
            ð  Return to Menu
          </button>
        </div>
      </div>
    );
  };

  const renderCombat = () => {
    if (!currentEnemy || !player) return null;
    
    // R001 - Get battle location for background styling
    const battleLocation = getCurrentBattleLocation();
    
    return (
      <div style={{
        ...styles.combatScreen,
        background: battleLocation.gradient,
        position: 'relative',
      }}>
        {/* R001 - Location overlay */}
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: battleLocation.overlayColor,
          pointerEvents: 'none',
          zIndex: 0,
        }} />
        
        {/* R001 - Location name banner */}
        <div style={{
          position: 'absolute',
          top: '10px',
          left: '50%',
          transform: 'translateX(-50%)',
          background: 'rgba(0, 0, 0, 0.6)',
          padding: '8px 25px',
          borderRadius: '20px',
          border: '1px solid rgba(212, 175, 55, 0.4)',
          zIndex: 10,
        }}>
          <span style={{ color: '#d4af37', fontSize: '0.85rem', letterSpacing: '1px' }}>
            ð {battleLocation.name}
          </span>
        </div>
        
        {/* R002 - Corruption Meter - Frodo's Burden Timer */}
        <div style={{
          position: 'absolute',
          top: '50px',
          right: '20px',
          background: corruption >= 75 ? 'rgba(60, 0, 0, 0.85)' : 'rgba(0, 0, 0, 0.7)',
          padding: '10px 15px',
          borderRadius: '10px',
          border: `2px solid ${corruption >= 75 ? '#8b0000' : corruption >= 50 ? '#ff6b00' : corruption >= 25 ? '#8b4513' : 'rgba(75, 0, 130, 0.5)'}`,
          zIndex: 10,
          minWidth: '130px',
          boxShadow: corruption >= 75 ? '0 0 20px rgba(139, 0, 0, 0.5)' : 'none',
          animation: corruption >= 75 ? 'pulse 2s infinite' : 'none',
        }}>
          <div style={{ fontSize: '0.7rem', color: corruption >= 75 ? '#ff6b6b' : '#c4b89a', marginBottom: '3px', textAlign: 'center' }}>
            ð Frodo's Burden
          </div>
          <div style={{ fontSize: '0.65rem', color: corruption >= 50 ? '#ff9966' : '#9966ff', marginBottom: '5px', textAlign: 'center', fontStyle: 'italic' }}>
            {corruption >= 75 ? 'The Ring calls to Sauron!' : corruption >= 50 ? 'The weight grows heavy...' : corruption >= 25 ? 'Whispers of power...' : 'The journey continues'}
          </div>
          <div style={{
            width: '100%',
            height: '8px',
            background: 'rgba(0, 0, 0, 0.5)',
            borderRadius: '4px',
            overflow: 'hidden',
          }}>
            <div style={{
              width: `${corruption}%`,
              height: '100%',
              background: corruption >= 75 ? 'linear-gradient(90deg, #4a0080, #8b0000)' : 
                         corruption >= 50 ? 'linear-gradient(90deg, #4a0080, #ff6b00)' : 
                         'linear-gradient(90deg, #2d0066, #4a0080)',
              transition: 'width 0.3s ease',
            }} />
          </div>
          <div style={{ fontSize: '0.7rem', color: corruption >= 75 ? '#ff6b6b' : '#9966ff', textAlign: 'center', marginTop: '3px' }}>
            {corruption >= 100 ? 'ð CONSUMED!' : corruption >= 75 ? `â ï¸ ${corruption}% - DANGER!` : `${corruption}%`}
          </div>
          {corruption >= 90 && (
            <div style={{ fontSize: '0.6rem', color: '#ff4444', textAlign: 'center', marginTop: '2px', fontWeight: 'bold' }}>
              The Eye sees you!
            </div>
          )}
        </div>
        
        {/* R003 - XP/Level Display */}
        {player && selectedCharacter && (
          <div style={{
            position: 'absolute',
            top: '140px',
            right: '20px',
            background: 'rgba(0, 0, 0, 0.7)',
            padding: '10px 15px',
            borderRadius: '10px',
            border: '2px solid rgba(255, 215, 0, 0.5)',
            zIndex: 10,
            minWidth: '120px',
          }}>
            <div style={{ fontSize: '0.75rem', color: '#ffd700', marginBottom: '5px', textAlign: 'center' }}>
              â­ Level {getLevelFromXP(playerProgress[selectedCharacter]?.xp || 0)}
            </div>
            {/* DEBUG: Show actual XP value */}
            <div style={{ fontSize: '0.6rem', color: '#888', textAlign: 'center', marginBottom: '3px' }}>
              (XP: {playerProgress[selectedCharacter]?.xp || 0})
            </div>
            <div style={{
              width: '100%',
              height: '6px',
              background: 'rgba(0, 0, 0, 0.5)',
              borderRadius: '3px',
              overflow: 'hidden',
            }}>
              <div style={{
                width: `${getXPProgress(playerProgress[selectedCharacter]?.xp || 0, getLevelFromXP(playerProgress[selectedCharacter]?.xp || 0))}%`,
                height: '100%',
                background: 'linear-gradient(90deg, #ffd700, #ffaa00)',
                transition: 'width 0.3s ease',
              }} />
            </div>
            <div style={{ fontSize: '0.65rem', color: '#c4b89a', textAlign: 'center', marginTop: '3px' }}>
              +{sessionXP} XP this run
            </div>
          </div>
        )}
        
        {/* Combo Tracker UI */}
        <ComboTracker 
          hand={player?.hand || []}
          deck={player?.deck || []}
          playedCardsThisTurn={playedCardsThisTurn || []}
        />
        
        {/* R003 - Level Up Notification */}
        {showLevelUp && pendingLevelUp && (
          <div style={{
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            background: 'linear-gradient(145deg, rgba(255, 215, 0, 0.95), rgba(200, 160, 0, 0.95))',
            padding: '30px 50px',
            borderRadius: '20px',
            border: '4px solid #fff',
            zIndex: 200,
            textAlign: 'center',
            boxShadow: '0 0 50px rgba(255, 215, 0, 0.7)',
          }}>
            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1a0a00', marginBottom: '10px' }}>
              ð LEVEL UP! ð
            </div>
            <div style={{ fontSize: '1.5rem', color: '#2d1a00' }}>
              Level {pendingLevelUp.level}
            </div>
            <div style={{ fontSize: '1rem', color: '#4a3000', marginTop: '10px' }}>
              {pendingLevelUp.bonuses?.description || 'New abilities unlocked!'}
            </div>
            {pendingLevelUp.bonuses?.skillPoint && (
              <div style={{ fontSize: '0.9rem', color: '#006400', marginTop: '10px' }}>
                ð® +1 Skill Point available!
              </div>
            )}
            <button
              style={{
                ...styles.button,
                marginTop: '20px',
                background: 'linear-gradient(145deg, #228b22, #145214)',
              }}
              onClick={() => {
                setShowLevelUp(false);
                setPendingLevelUp(null);
              }}
            >
              Continue
            </button>
          </div>
        )}
        
        {/* R002 - Combo Display */}
        {activeCombo && (
          <div style={{
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            background: 'linear-gradient(145deg, rgba(212, 175, 55, 0.9), rgba(139, 115, 35, 0.9))',
            padding: '20px 40px',
            borderRadius: '15px',
            border: '3px solid #ffd700',
            zIndex: 100,
            textAlign: 'center',
            animation: 'pulse 0.5s ease-in-out',
            boxShadow: '0 0 30px rgba(255, 215, 0, 0.5)',
          }}>
            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1a0a00' }}>
              ð COMBO! ð
            </div>
            <div style={{ fontSize: '1.2rem', color: '#2d1a00', marginTop: '5px' }}>
              {activeCombo.name}
            </div>
            <div style={{ fontSize: '0.9rem', color: '#4a3000', marginTop: '5px', fontStyle: 'italic' }}>
              {activeCombo.description}
            </div>
          </div>
        )}
        
        {/* R002 - Enemy Element Display */}
        {currentEnemy && ENEMY_ELEMENTS[enemyType] && (
          <div style={{
            position: 'absolute',
            top: '50px',
            left: '20px',
            background: 'rgba(0, 0, 0, 0.7)',
            padding: '8px 12px',
            borderRadius: '10px',
            border: `2px solid ${ELEMENTS[ENEMY_ELEMENTS[enemyType]]?.color || '#666'}`,
            zIndex: 10,
          }}>
            <span style={{ fontSize: '0.8rem', color: ELEMENTS[ENEMY_ELEMENTS[enemyType]]?.color || '#fff' }}>
              {ELEMENTS[ENEMY_ELEMENTS[enemyType]]?.icon} {ELEMENTS[ENEMY_ELEMENTS[enemyType]]?.name}
            </span>
          </div>
        )}
        
        {/* Enemy Area - US-001: Multi-enemy support */}
        <div style={{ ...styles.enemyArea, position: 'relative', zIndex: 1 }}>
          <div style={{
            display: 'flex',
            flexWrap: 'wrap',
            justifyContent: 'center',
            gap: '15px',
            width: '100%'
          }}>
            {enemies.map((enemy, index) => {
              const isTargeted = targetedEnemy === index;
              const isDead = enemy.hp <= 0;
              const enemyBaseData = ENEMIES[enemy.id];
              
              return (
                <div 
                  key={enemy.instanceId || index}
                  style={{
                    ...styles.enemyCard,
                    opacity: isDead ? 0.4 : 1,
                    transform: isTargeted ? 'scale(1.05)' : 'scale(1)',
                    border: isTargeted ? '3px solid #ffd700' : '2px solid rgba(220, 20, 60, 0.5)',
                    boxShadow: isTargeted ? '0 0 20px rgba(255, 215, 0, 0.5)' : 'none',
                    cursor: isDead ? 'not-allowed' : 'pointer',
                    transition: 'all 0.2s ease',
                    minWidth: enemies.length > 2 ? '140px' : '180px',
                    flex: enemies.length > 2 ? '0 1 30%' : '0 1 45%'
                  }}
                  className={animatingDamage && isTargeted ? 'animate-shake' : ''}
                  onClick={() => !isDead && setTargetedEnemy(index)}
                >
                  {/* Target indicator */}
                  {isTargeted && !isDead && (
                    <div style={{
                      position: 'absolute',
                      top: '-8px',
                      left: '50%',
                      transform: 'translateX(-50%)',
                      background: '#ffd700',
                      color: '#1a0a00',
                      padding: '2px 8px',
                      borderRadius: '10px',
                      fontSize: '0.7rem',
                      fontWeight: 'bold'
                    }}>
                      ð¯ TARGET
                    </div>
                  )}
                  
                  <Portrait 
                    src={enemyBaseData?.image} 
                    size={enemies.length > 2 ? 70 : 90} 
                    border={isDead ? '#555' : '#dc143c'}
                  />
                  <h3 style={{ 
                    margin: '8px 0 5px', 
                    fontSize: enemies.length > 2 ? '0.95rem' : '1.1rem',
                    textDecoration: isDead ? 'line-through' : 'none',
                    color: isDead ? '#888' : '#f4e4bc'
                  }}>
                    {enemy.name}
                    {isDead && ' ð'}
                  </h3>
                  
                  {/* Show ability for single enemies or elites */}
                  {enemies.length <= 2 && enemyBaseData?.ability && !isDead && (
                    <div style={{ fontSize: '0.7rem', color: '#ff9966', marginBottom: '6px', fontStyle: 'italic' }}>
                      â¡ {enemyBaseData.ability.name}
                    </div>
                  )}
                  
                  {/* HP Bar */}
                  {!isDead && (
                    <div style={{...styles.hpBar, height: '16px'}}>
                      {(() => {
                        const hpPercent = (enemy.hp / enemy.maxHp) * 100;
                        let hpColor = 'linear-gradient(90deg, #8b0000, #dc143c, #ff4500)';
                        if (hpPercent <= 25) {
                          hpColor = 'linear-gradient(90deg, #4a0000, #8b0000, #a50000)';
                        } else if (hpPercent <= 50) {
                          hpColor = 'linear-gradient(90deg, #8b4500, #cc6600, #ff8c00)';
                        }
                        return <div style={{...styles.hpFill, width: `${hpPercent}%`, background: hpColor}}></div>;
                      })()}
                      <span style={{...styles.hpText, fontSize: '0.7rem'}}>{enemy.hp}/{enemy.maxHp}</span>
                    </div>
                  )}
                  
                  {/* Block Bar - PROMINENT display when enemy has block */}
                  {!isDead && enemy.block > 0 && (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '6px',
                      marginTop: '6px',
                      padding: '4px 10px',
                      background: 'linear-gradient(135deg, rgba(70, 130, 180, 0.4), rgba(100, 149, 237, 0.3))',
                      borderRadius: '8px',
                      border: '2px solid #4682b4',
                      boxShadow: '0 0 10px rgba(70, 130, 180, 0.5), inset 0 0 8px rgba(100, 149, 237, 0.3)'
                    }}>
                      <span style={{ fontSize: '1.2rem' }}>ð¡ï¸</span>
                      <span style={{ 
                        color: '#87ceeb', 
                        fontWeight: 'bold', 
                        fontSize: '1rem',
                        textShadow: '0 0 5px rgba(135, 206, 235, 0.8)'
                      }}>
                        {enemy.block} BLOCK
                      </span>
                    </div>
                  )}
                  
                  {/* Status effects with tooltips */}
                  {!isDead && (enemy.strength > 0 || enemy.vulnerable > 0 || enemy.weak > 0 || enemy.poison > 0 || enemy.burn > 0) && (
                    <div style={{
                      display: 'flex', 
                      flexWrap: 'wrap', 
                      justifyContent: 'center', 
                      gap: '4px', 
                      marginTop: '6px',
                      padding: '4px',
                      background: 'rgba(0, 0, 0, 0.3)',
                      borderRadius: '6px'
                    }}>
                      {enemy.strength > 0 && (
                        <div 
                          style={{
                            ...styles.statusEffect, 
                            fontSize: '0.75rem', 
                            padding: '3px 8px',
                            background: 'linear-gradient(135deg, rgba(255, 100, 100, 0.3), rgba(200, 50, 50, 0.2))',
                            borderColor: '#ff6b6b',
                            cursor: 'help'
                          }}
                          title={`Strength +${enemy.strength}: Deals ${enemy.strength} extra damage per attack`}
                        >
                          ðª +{enemy.strength} STR
                        </div>
                      )}
                      {enemy.vulnerable > 0 && (
                        <div 
                          style={{
                            ...styles.statusEffect, 
                            fontSize: '0.75rem', 
                            padding: '3px 8px',
                            background: 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(200, 150, 0, 0.2))',
                            borderColor: '#ffd700',
                            cursor: 'help'
                          }}
                          title={`Vulnerable (${enemy.vulnerable} turns): Takes 50% more damage`}
                        >
                          ð¯ {enemy.vulnerable}
                        </div>
                      )}
                      {enemy.weak > 0 && (
                        <div 
                          style={{
                            ...styles.statusEffect, 
                            fontSize: '0.75rem', 
                            padding: '3px 8px',
                            background: 'linear-gradient(135deg, rgba(150, 150, 255, 0.3), rgba(100, 100, 200, 0.2))',
                            borderColor: '#9999ff',
                            cursor: 'help'
                          }}
                          title={`Weak (${enemy.weak} turns): Deals 25% less damage`}
                        >
                          ðµ {enemy.weak}
                        </div>
                      )}
                      {enemy.poison > 0 && (
                        <div 
                          style={{
                            ...styles.statusEffect, 
                            fontSize: '0.75rem', 
                            padding: '3px 8px',
                            background: 'linear-gradient(135deg, rgba(0, 255, 100, 0.3), rgba(0, 200, 50, 0.2))',
                            borderColor: '#00ff66',
                            cursor: 'help'
                          }}
                          title={`Poison (${enemy.poison}): Takes ${enemy.poison} damage at start of turn, then reduces by 1`}
                        >
                          ð§ª {enemy.poison}
                        </div>
                      )}
                      {enemy.burn > 0 && (
                        <div 
                          style={{
                            ...styles.statusEffect, 
                            fontSize: '0.75rem', 
                            padding: '3px 8px',
                            background: 'linear-gradient(135deg, rgba(255, 100, 0, 0.3), rgba(200, 50, 0, 0.2))',
                            borderColor: '#ff6600',
                            cursor: 'help'
                          }}
                          title={`Burn (${enemy.burn}): Takes ${enemy.burn} fire damage at start of turn`}
                        >
                          ð¥ {enemy.burn}
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* Enemy Intent - What they will do next turn */}
                  {!isDead && enemy.intent && turn === 'player' && (
                    <div style={{
                      marginTop: '10px', 
                      padding: '6px 12px',
                      background: enemy.intent.type === 'attack' ? 'rgba(255, 50, 50, 0.2)' :
                                  enemy.intent.type === 'defend' ? 'rgba(70, 130, 180, 0.2)' :
                                  enemy.intent.type === 'buff' ? 'rgba(255, 170, 100, 0.2)' :
                                  'rgba(150, 100, 255, 0.2)',
                      borderRadius: '8px',
                      border: `1px solid ${
                        enemy.intent.type === 'attack' ? 'rgba(255, 100, 100, 0.5)' :
                        enemy.intent.type === 'defend' ? 'rgba(70, 130, 180, 0.5)' :
                        enemy.intent.type === 'buff' ? 'rgba(255, 170, 100, 0.5)' :
                        'rgba(150, 100, 255, 0.5)'
                      }`
                    }}>
                      <div style={{ fontSize: '0.65rem', color: '#999', marginBottom: '2px' }}>NEXT ACTION:</div>
                      {enemy.intent.type === 'attack' && (
                        <div style={{ color: '#ff6b6b', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                          <span style={{ fontSize: '1.1rem' }}>âï¸</span>
                          <span style={{ fontSize: '1rem' }}>
                            {(enemy.intent.damage || 0) + (enemy.strength || 0)} DMG
                          </span>
                          {enemy.intent.corruption > 0 && (
                            <span style={{ color: '#9966ff', fontSize: '0.8rem' }}>+{enemy.intent.corruption} ð</span>
                          )}
                        </div>
                      )}
                      {enemy.intent.type === 'defend' && (
                        <div style={{ color: '#6b8bff', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                          <span style={{ fontSize: '1.1rem' }}>ð¡ï¸</span>
                          <span style={{ fontSize: '1rem' }}>+{enemy.intent.block || 0} BLOCK</span>
                        </div>
                      )}
                      {enemy.intent.type === 'buff' && (
                        <div style={{ color: '#ffaa6b', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                          <span style={{ fontSize: '1.1rem' }}>ðª</span>
                          <span style={{ fontSize: '0.9rem' }}>
                            {enemy.intent.strength > 0 && `+${enemy.intent.strength} STR`}
                            {enemy.intent.block > 0 && enemy.intent.strength > 0 && ' & '}
                            {enemy.intent.block > 0 && `+${enemy.intent.block} BLK`}
                            {!enemy.intent.strength && !enemy.intent.block && 'BUFF'}
                          </span>
                        </div>
                      )}
                      {enemy.intent.type === 'debuff' && (
                        <div style={{ color: '#9966ff', fontWeight: 'bold', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px' }}>
                          <span style={{ fontSize: '1.1rem' }}>ð</span>
                          <span style={{ fontSize: '0.9rem' }}>DEBUFF</span>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
          
          {/* Multi-enemy indicator */}
          {enemies.length > 1 && (
            <div style={{
              textAlign: 'center',
              marginTop: '10px',
              color: '#d4af37',
              fontSize: '0.85rem'
            }}>
              âï¸ {enemies.filter(e => e.hp > 0).length}/{enemies.length} enemies remaining â¢ Click to target
            </div>
          )}
        </div>

        {/* Player Area */}
        <div style={{ ...styles.playerArea, position: 'relative', zIndex: 1 }}>
          <div style={styles.playerInfo} className={animatingDamage ? 'animate-damage' : animatingHeal ? 'animate-heal' : ''}>
            <Portrait 
              src={player.image || CHARACTERS[selectedCharacter]?.image} 
              size={70} 
              border="#228b22"
            />
            <div>
              <h3 style={{ margin: 0, fontSize: '1.2rem' }}>{player.name}</h3>
              <div style={{ marginTop: '8px', display: 'flex', flexWrap: 'wrap', gap: '12px' }}>
                <span style={{ fontSize: '1.05rem' }}>â¤ï¸ {player.hp}/{player.maxHp}</span>
                <span style={{ fontSize: '1.05rem', color: '#ffd700' }}>â¡ {energy}/{player.maxEnergy + getRelicBonus(player, 'bonusEnergy')}</span>
                {player.block > 0 && <span style={{ color: '#6b8bff' }}>ð¡ï¸ {player.block}</span>}
                {player.strength > 0 && <span style={{ color: '#ff8866' }}>ðª {player.strength}</span>}
                {player.dexterity > 0 && <span style={{ color: '#66ff88' }}>ð {player.dexterity}</span>}
              </div>
            </div>
          </div>
          {/* Potions */}
          {player.potions && player.potions.length > 0 && (
            <div style={{display: 'flex', gap: '10px', justifyContent: 'center', marginTop: '10px'}}>
              {player.potions.map((potionId, index) => {
                const potion = POTIONS[potionId];
                return (
                  <div 
                    key={index}
                    style={{
                      background: 'rgba(139, 69, 19, 0.5)',
                      border: '2px solid #d4af37',
                      borderRadius: '8px',
                      padding: '8px 12px',
                      cursor: turn === 'player' ? 'pointer' : 'not-allowed',
                      opacity: turn === 'player' ? 1 : 0.5,
                      transition: 'all 0.2s ease'
                    }}
                    onClick={() => usePotion(potionId, index)}
                    title={`${potion.name}: ${potion.description}`}
                    onMouseOver={(e) => {
                      if (turn === 'player') {
                        e.currentTarget.style.transform = 'scale(1.1)';
                        e.currentTarget.style.boxShadow = '0 0 15px rgba(212, 175, 55, 0.5)';
                      }
                    }}
                    onMouseOut={(e) => {
                      e.currentTarget.style.transform = 'scale(1)';
                      e.currentTarget.style.boxShadow = 'none';
                    }}
                  >
                    <span style={{fontSize: '1.5rem'}}>{potion.icon}</span>
                  </div>
                );
              })}
            </div>
          )}
          
          {/* One Ring Button */}
          {player.relics?.includes('one_ring') && (
            <div style={{ display: 'flex', justifyContent: 'center', marginTop: '10px' }}>
              <OneRingButton
                player={player}
                corruption={corruption}
                disabled={turn !== 'player'}
                onActivate={() => {
                  const newCorruption = corruption + 15;
                  if (newCorruption >= 100) {
                    setRingClaimedEnding(true);
                    return;
                  }
                  SoundSystem.buttonClick();
                  setCorruption(newCorruption);
                  setPlayer(prev => ({
                    ...prev,
                    strength: (prev.strength || 0) + 3,
                    dexterity: (prev.dexterity || 0) + 3,
                    ringActive: true,
                    invisibility: true
                  }));
                  setCombatLog(prev => [
                    `ð You put on the Ring! +3 STR, +3 DEX, 25% miss. +15 corruption (${newCorruption}/100)`,
                    ...prev.slice(0, 5)
                  ]);
                  announce('The Ring whispers promises of power...', 'assertive');
                }}
              />
            </div>
          )}
          
          {/* Status Effect Summary - Progressive Disclosure */}
          <StatusEffectSummary 
            player={player} 
            enemies={enemies} 
            targetedEnemy={targetedEnemy} 
          />
        </div>

        {/* Combat Log */}
        <div style={styles.combatLog}>
          {combatLog.map((message, index) => (
            <div key={index} style={{...styles.logEntry, opacity: 1 - (index * 0.15)}}>{message}</div>
          ))}
        </div>
        
        {/* Status Effect Legend */}
        <div style={{
          position: 'absolute',
          bottom: '10px',
          left: '10px',
          background: 'rgba(0, 0, 0, 0.85)',
          borderRadius: '8px',
          padding: '8px 12px',
          fontSize: '0.7rem',
          color: '#c4b89a',
          border: '1px solid rgba(212, 175, 55, 0.3)',
          maxWidth: '200px',
          zIndex: 50
        }}>
          <div style={{ fontWeight: 'bold', color: '#d4af37', marginBottom: '6px', borderBottom: '1px solid rgba(212, 175, 55, 0.3)', paddingBottom: '4px' }}>
            ð STATUS EFFECTS
          </div>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '3px' }}>
            <div title="Block absorbs incoming damage">ð¡ï¸ <strong style={{color: '#87ceeb'}}>Block</strong> - Absorbs damage</div>
            <div title="Strength adds damage to attacks">ðª <strong style={{color: '#ff6b6b'}}>Strength</strong> - +DMG per attack</div>
            <div title="Vulnerable takes 50% more damage">ð¯ <strong style={{color: '#ffd700'}}>Vulnerable</strong> - Takes +50% DMG</div>
            <div title="Weak deals 25% less damage">ðµ <strong style={{color: '#9999ff'}}>Weak</strong> - Deals -25% DMG</div>
            <div title="Poison deals damage each turn">ð§ª <strong style={{color: '#00ff66'}}>Poison</strong> - DMG per turn</div>
            <div title="Burn deals fire damage each turn">ð¥ <strong style={{color: '#ff6600'}}>Burn</strong> - Fire DMG per turn</div>
          </div>
        </div>
        
        {/* US-003: Adaptive Difficulty Indicator */}
        {adaptiveEnabled && adaptiveState.currentScale !== 1.0 && (
          <div style={{
            position: 'absolute',
            top: '10px',
            right: '10px',
            background: 'rgba(0, 0, 0, 0.7)',
            border: `2px solid ${getAdaptiveDifficultyLabel(adaptiveState.currentScale).color}`,
            borderRadius: '8px',
            padding: '6px 12px',
            fontSize: '0.75rem',
            color: getAdaptiveDifficultyLabel(adaptiveState.currentScale).color,
            zIndex: 50,
            display: 'flex',
            alignItems: 'center',
            gap: '5px'
          }}>
            <span>{getAdaptiveDifficultyLabel(adaptiveState.currentScale).icon}</span>
            <span>{getAdaptiveDifficultyLabel(adaptiveState.currentScale).label}</span>
            <span style={{ opacity: 0.7 }}>({(adaptiveState.currentScale * 100).toFixed(0)}%)</span>
          </div>
        )}

        {/* Hand - Using memoized GameCard for performance */}
        <div style={styles.handArea} role="region" aria-label="Your hand of cards">
          <div style={styles.hand} role="list" aria-label={`${hand.length} cards in hand`}>
            {hand.map((card, index) => (
              <GameCard
                key={`${card.uid}_${index}`}
                card={card}
                isPlayable={card.cost <= energy && turn === 'player'}
                isHovered={hoveredCard === card.uid}
                playerStrength={player.strength}
                playerDexterity={player.dexterity}
                dealDelay={index * 0.1}
                onPlay={playCard}
                onHover={setHoveredCard}
                onLeave={() => setHoveredCard(null)}
                onPreview={setPreviewedCard}
                styles={styles}
                animationsEnabled={animationsEnabled}
              />
            ))}
          </div>
          
          <div style={styles.combatActions}>
            {turn === 'player' && (
              <button 
                style={{...styles.button, ...styles.endTurnBtn}} 
                onClick={endTurn}
                aria-label="End your turn"
                onMouseOver={(e) => {
                  e.currentTarget.style.transform = 'scale(1.05)';
                  e.currentTarget.style.boxShadow = '0 0 30px rgba(220, 20, 60, 0.6)';
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.transform = 'scale(1)';
                  e.currentTarget.style.boxShadow = '0 0 20px rgba(220, 20, 60, 0.4)';
                }}
              >
                End Turn â¡ï¸ <span style={{fontSize: '0.7rem', opacity: 0.7}}>(E)</span>
              </button>
            )}
            {turn === 'enemy' && (
              <div style={styles.enemyTurnIndicator} role="status" aria-live="polite">â³ Enemy Turn...</div>
            )}
          </div>
        </div>

        {/* Deck Info */}
        <div style={styles.deckInfo}>
          <span 
            style={{cursor: 'pointer', padding: '5px 10px', borderRadius: '6px', background: 'rgba(212,175,55,0.1)'}}
            onClick={() => setViewingPile('draw')}
            title="Press D to view"
          >ð Draw: {drawPile.length}</span>
          <span 
            style={{cursor: 'pointer', padding: '5px 10px', borderRadius: '6px', background: 'rgba(212,175,55,0.1)'}}
            onClick={() => setViewingPile('discard')}
            title="Press S to view"
          >ðï¸ Discard: {discardPile.length}</span>
          {exhaustPile.length > 0 && (
            <span 
              style={{cursor: 'pointer', padding: '5px 10px', borderRadius: '6px', background: 'rgba(212,175,55,0.1)'}}
              onClick={() => setViewingPile('exhaust')}
            >ð Exhaust: {exhaustPile.length}</span>
          )}
          <span style={{fontSize: '0.75rem', color: '#666', marginLeft: '10px'}}>Keys: 1-9 play cards</span>
        </div>
        
        {/* Pile Viewer Modal */}
        {viewingPile && (
          <>
            <div style={styles.pileViewerOverlay} onClick={() => setViewingPile(null)} />
            <div style={styles.pileViewer}>
              <h3 style={{color: '#d4af37', marginBottom: '15px', textAlign: 'center'}}>
                {viewingPile === 'draw' ? 'ð Draw Pile' : viewingPile === 'discard' ? 'ðï¸ Discard Pile' : 'ð Exhaust Pile'}
              </h3>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '10px'}}>
                {(viewingPile === 'draw' ? drawPile : viewingPile === 'discard' ? discardPile : exhaustPile).map((card, i) => (
                  <div key={card.uid + i} style={{
                    background: 'rgba(139, 69, 19, 0.3)',
                    border: '1px solid rgba(212, 175, 55, 0.4)',
                    borderRadius: '8px',
                    padding: '8px',
                    textAlign: 'center',
                    fontSize: '11px'
                  }}>
                    <div style={{fontWeight: 'bold', color: '#f4e4bc'}}>{card.name}</div>
                    <div style={{color: '#888', fontSize: '10px'}}>{card.type}</div>
                  </div>
                ))}
                {(viewingPile === 'draw' ? drawPile : viewingPile === 'discard' ? discardPile : exhaustPile).length === 0 && (
                  <div style={{color: '#888', fontStyle: 'italic', gridColumn: '1/-1', textAlign: 'center'}}>Empty</div>
                )}
              </div>
              <button 
                style={{...styles.button, marginTop: '20px', display: 'block', margin: '20px auto 0'}}
                onClick={() => setViewingPile(null)}
              >Close</button>
            </div>
          </>
        )}
        
        {/* Card Detail Overlay - Shows when right-clicking a card */}
        {previewedCard && (
          <CardDetailOverlay 
            card={previewedCard}
            player={player}
            onClose={() => setPreviewedCard(null)}
            getCardArt={getCardArt}
          />
        )}
      </div>
    );
  };

  const renderRewards = () => {
    if (!currentEnemy) return null;
    
    const encounter = ENCOUNTERS[currentEncounter];
    const isEliteOrBoss = encounter?.tier === 'elite' || encounter?.tier === 'boss';
    const tierLabel = encounter?.tier === 'boss' ? 'ð BOSS' : encounter?.tier === 'elite' ? 'â­ ELITE' : '';
    
    // Check if all available rewards have been taken
    const goldTaken = rewardsTaken.gold;
    const cardTaken = rewardsTaken.card || cardRewardChoices.length === 0;
    const relicTaken = rewardsTaken.relic || availableRelics.length === 0;
    
    // For regular enemies: can take gold AND card
    // For elite/boss: can take gold AND card AND relic
    const canProceed = goldTaken && cardTaken && (isEliteOrBoss ? relicTaken : true);
    
    return (
      <div style={styles.rewardsScreen}>
        <h2 style={{ color: '#ffd700', fontSize: '2.5rem', marginBottom: '10px', textShadow: '0 0 20px rgba(255,215,0,0.5)' }}>
          ð Victory!
        </h2>
        {tierLabel && <div style={{color: encounter?.tier === 'boss' ? '#ff6b6b' : '#ffd700', fontSize: '1.2rem', marginBottom: '10px'}}>{tierLabel}</div>}
        <Portrait src={ENEMIES[enemyType]?.image} size={90} border="#228b22" />
        <p style={{ fontSize: '1.3rem', margin: '20px 0', color: '#c4b89a' }}>
          You have defeated the {currentEnemy.name}!
        </p>
        
        <div style={{margin: '25px 0'}}>
          <h3 style={{ color: '#d4af37', marginBottom: '15px', fontSize: '1.3rem' }}>
            {isEliteOrBoss ? 'Claim All Rewards:' : 'Claim Your Rewards:'}
          </h3>
          
          {/* Gold Reward */}
          {!goldTaken ? (
            <button 
              style={{...styles.button, ...styles.rewardBtn, background: 'linear-gradient(145deg, #8b7513, #5a4d0a)'}} 
              onClick={() => selectReward('gold')}
            >
              ð° Take Gold ({encounter?.reward?.gold || 25}{isEliteOrBoss ? '+' : ''})
            </button>
          ) : (
            <div style={{color: '#90ee90', margin: '10px 0'}}>â Gold Collected</div>
          )}
          
          {/* Card Choices */}
          {!cardTaken && cardRewardChoices.length > 0 && (
            <div style={{marginTop: '20px', marginBottom: '20px'}}>
              <p style={{color: '#c4b89a', marginBottom: '15px'}}>ð Choose a card to add to your deck:</p>
              <div style={{display: 'flex', gap: '15px', justifyContent: 'center', flexWrap: 'wrap'}}>
                {cardRewardChoices.map((card, i) => {
                  const rarityColor = card.rarity === 'ultra_rare' ? '#ff00ff' : 
                                     card.rarity === 'rare' ? '#ffd700' : 
                                     card.rarity === 'uncommon' ? '#1e90ff' : '#888';
                  // Build description from card properties
                  const cardDesc = [];
                  if (card.damage) cardDesc.push(`Deal ${card.damage} damage${card.hits > 1 ? ` x${card.hits}` : ''}`);
                  if (card.block) cardDesc.push(`Gain ${card.block} block`);
                  if (card.heal) cardDesc.push(`Heal ${card.heal} HP`);
                  if (card.draw) cardDesc.push(`Draw ${card.draw} card${card.draw > 1 ? 's' : ''}`);
                  if (card.strength) cardDesc.push(`+${card.strength} strength`);
                  if (card.dexterity) cardDesc.push(`+${card.dexterity} dexterity`);
                  if (card.energy) cardDesc.push(`+${card.energy} energy`);
                  if (card.vulnerable) cardDesc.push(`Apply ${card.vulnerable} vulnerable`);
                  if (card.weak) cardDesc.push(`Apply ${card.weak} weak`);
                  if (card.poison) cardDesc.push(`Apply ${card.poison} poison`);
                  if (card.burn) cardDesc.push(`Apply ${card.burn} burn`);
                  if (card.exhaust) cardDesc.push('Exhaust');
                  
                  return (
                  <div
                    key={card.id + i}
                    style={{
                      background: 'rgba(139, 69, 19, 0.4)',
                      border: `2px solid ${card.rarity === 'ultra_rare' ? '#ff00ff' : card.rarity === 'rare' ? '#ffd700' : 'rgba(212, 175, 55, 0.5)'}`,
                      borderRadius: '12px',
                      padding: '15px',
                      cursor: 'pointer',
                      transition: 'all 0.3s ease',
                      minWidth: '160px',
                      maxWidth: '200px',
                      textAlign: 'center',
                      boxShadow: card.rarity === 'ultra_rare' ? '0 0 15px rgba(255, 0, 255, 0.4)' : 
                                 card.rarity === 'rare' ? '0 0 10px rgba(255, 215, 0, 0.3)' : 'none'
                    }}
                    onClick={() => selectReward('card', null, card)}
                    onMouseOver={(e) => {
                      e.currentTarget.style.transform = 'translateY(-5px)';
                      e.currentTarget.style.borderColor = card.rarity === 'ultra_rare' ? '#ff00ff' : '#d4af37';
                      e.currentTarget.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.3)';
                    }}
                    onMouseOut={(e) => {
                      e.currentTarget.style.transform = 'translateY(0)';
                      e.currentTarget.style.borderColor = card.rarity === 'ultra_rare' ? '#ff00ff' : card.rarity === 'rare' ? '#ffd700' : 'rgba(212, 175, 55, 0.5)';
                      e.currentTarget.style.boxShadow = card.rarity === 'ultra_rare' ? '0 0 15px rgba(255, 0, 255, 0.4)' : 
                                 card.rarity === 'rare' ? '0 0 10px rgba(255, 215, 0, 0.3)' : 'none';
                    }}
                  >
                    {card.colorless && <div style={{fontSize: '0.65rem', color: '#aaa', marginBottom: '4px'}}>âª COLORLESS</div>}
                    <div style={styles.cardArt}>{getCardArt(card.id, card.type)}</div>
                    <div style={{fontWeight: 'bold', color: '#f4e4bc', marginTop: '8px', fontSize: '1rem'}}>{card.name}</div>
                    <div style={{fontSize: '0.75rem', color: rarityColor, marginTop: '4px', textTransform: 'uppercase'}}>{card.rarity?.replace('_', ' ')}</div>
                    <div style={{fontSize: '0.8rem', color: '#ffd700', marginTop: '6px'}}>
                      Cost: {card.cost} â¡
                    </div>
                    {/* Card description */}
                    <div style={{
                      fontSize: '0.75rem', 
                      color: '#c4b89a', 
                      marginTop: '8px', 
                      lineHeight: '1.4',
                      borderTop: '1px solid rgba(212, 175, 55, 0.3)',
                      paddingTop: '8px'
                    }}>
                      {cardDesc.length > 0 ? cardDesc.join('. ') + '.' : card.description || 'No description'}
                    </div>
                  </div>
                  );
                })}
              </div>
              <button
                style={{...styles.button, marginTop: '15px', fontSize: '0.9rem', padding: '12px 24px', opacity: 0.7}}
                onClick={() => selectReward('skip')}
              >
                Skip Card
              </button>
            </div>
          )}
          {cardTaken && <div style={{color: '#90ee90', margin: '10px 0'}}>â Card Selected</div>}
          
          {/* Relic Choices (only for elite/boss) */}
          {isEliteOrBoss && !relicTaken && availableRelics.length > 0 && (
            <div style={{margin: '20px 0'}}>
              <p style={{color: '#d4af37', marginBottom: '15px'}}>â¨ Choose a Relic:</p>
              <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', flexWrap: 'wrap' }}>
                {availableRelics.map(relicId => {
                  const relic = getRelic(relicId);
                  if (!relic) return null;
                  return (
                    <div 
                      key={relicId}
                      style={{
                        ...styles.relicChoice,
                        ...(relic.tier === 'boss' ? { borderColor: '#ff6b6b', boxShadow: '0 0 10px rgba(255, 107, 107, 0.3)' } : {})
                      }}
                      onClick={() => selectReward('relic', relicId)}
                      onMouseOver={(e) => {
                        e.currentTarget.style.transform = 'scale(1.05)';
                        e.currentTarget.style.borderColor = relic.tier === 'boss' ? '#ff6b6b' : '#d4af37';
                        e.currentTarget.style.boxShadow = `0 0 20px ${relic.tier === 'boss' ? 'rgba(255, 107, 107, 0.4)' : 'rgba(212, 175, 55, 0.4)'}`;
                      }}
                      onMouseOut={(e) => {
                        e.currentTarget.style.transform = 'scale(1)';
                        e.currentTarget.style.borderColor = relic.tier === 'boss' ? '#ff6b6b' : 'rgba(212, 175, 55, 0.5)';
                        e.currentTarget.style.boxShadow = relic.tier === 'boss' ? '0 0 10px rgba(255, 107, 107, 0.3)' : 'none';
                      }}
                    >
                      {relic.tier === 'boss' && <div style={{fontSize: '0.7rem', color: '#ff6b6b', marginBottom: '5px'}}>ð BOSS RELIC</div>}
                      <div style={{ fontSize: '2.5rem', marginBottom: '10px' }}>{relic.icon}</div>
                      <div style={{ fontWeight: 'bold', color: relic.tier === 'boss' ? '#ff6b6b' : '#d4af37', marginBottom: '8px' }}>{relic.name}</div>
                      <div style={{ fontSize: '0.85rem', color: '#a89878' }}>{relic.description}</div>
                      <div style={{ fontSize: '0.7rem', color: relic.rarity === 'ultra_rare' ? '#ff00ff' : relic.rarity === 'rare' ? '#ffd700' : relic.rarity === 'uncommon' ? '#1e90ff' : '#888', marginTop: '5px', textTransform: 'uppercase' }}>{relic.rarity?.replace('_', ' ')}</div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          {isEliteOrBoss && relicTaken && <div style={{color: '#90ee90', margin: '10px 0'}}>â Relic Acquired</div>}
        </div>
        
        <button 
          style={{
            ...styles.button,
            marginTop: '20px',
            opacity: canProceed ? 1 : 0.5,
            cursor: canProceed ? 'pointer' : 'not-allowed'
          }} 
          onClick={() => canProceed && selectReward('proceed')}
          onMouseOver={(e) => {
            if (canProceed) e.currentTarget.style.transform = 'translateY(-3px)';
          }}
          onMouseOut={(e) => {
            e.currentTarget.style.transform = 'translateY(0)';
          }}
        >
          {canProceed ? 'Continue Journey â' : 'Collect All Rewards First'}
        </button>
      </div>
    );
  };

  const renderDeckView = () => {
    if (!player) return null;
    
    return (
      <div style={styles.deckView}>
        <h2 style={{ textAlign: 'center', color: '#d4af37', fontSize: '2rem', marginBottom: '10px' }}>ð Your Deck</h2>
        <p style={{ textAlign: 'center', color: '#c4b89a', fontSize: '1.1rem' }}>Total Cards: {player.deck.length}</p>
        
        <div style={styles.deckGrid}>
          {player.deck.map((card, index) => (
            <div 
              key={`${card.uid}_${index}`} 
              style={styles.deckCard}
              onMouseOver={(e) => {
                e.currentTarget.style.transform = 'translateY(-5px) scale(1.03)';
                e.currentTarget.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.35)';
                e.currentTarget.style.borderColor = '#d4af37';
              }}
              onMouseOut={(e) => {
                e.currentTarget.style.transform = 'translateY(0) scale(1)';
                e.currentTarget.style.boxShadow = 'none';
                e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.5)';
              }}
            >
              <div style={styles.cardArt}>
                {getCardArt(card.id, card.type)}
              </div>
              <div style={{ 
                background: 'linear-gradient(145deg, #ffd700, #b8960c)', 
                color: '#000', 
                borderRadius: '50%', 
                width: '28px', 
                height: '28px', 
                display: 'inline-flex', 
                alignItems: 'center', 
                justifyContent: 'center',
                fontWeight: 'bold',
                margin: '8px 0',
                fontSize: '14px'
              }}>{card.cost}</div>
              <div style={{...styles.cardName, fontSize: '13px'}}>{card.name}</div>
              <div style={styles.cardType}>{card.type}</div>
              <div style={{fontSize: '11px', marginTop: '6px', color: '#aaa'}}>
                {card.damage && <span>âï¸{card.damage} </span>}
                {card.block && <span>ð¡ï¸{card.block} </span>}
                {card.draw && <span>ð{card.draw} </span>}
                {card.strength && <span>ðª{card.strength} </span>}
                {card.dexterity && <span>ð{card.dexterity} </span>}
              </div>
            </div>
          ))}
        </div>
        
        <div style={{ textAlign: 'center', marginTop: '40px' }}>
          <button 
            style={styles.button} 
            onClick={() => setGameState('map')}
            onMouseOver={(e) => {
              e.currentTarget.style.transform = 'translateY(-3px)';
              e.currentTarget.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.3)';
            }}
            onMouseOut={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
            }}
          >
            â Back to Map
          </button>
        </div>
      </div>
    );
  };

  const renderGameOver = () => (
    <div style={styles.gameOver}>
      <h2 style={{ color: '#dc143c', fontSize: '2.5rem', marginBottom: '20px', textShadow: '0 0 20px rgba(220,20,60,0.5)' }}>
        â ï¸ Defeat
      </h2>
      <p style={{ fontSize: '1.3rem', color: '#c4b89a', marginBottom: '30px' }}>
        You have fallen in battle. The darkness grows stronger...
      </p>
      <Portrait src={characterImages.balrog} size={120} border="#dc143c" />
      
      {/* Run Statistics */}
      <div style={{
        background: 'rgba(0,0,0,0.4)',
        borderRadius: '12px',
        padding: '20px',
        margin: '20px auto',
        maxWidth: '400px',
        border: '1px solid rgba(220,20,60,0.3)'
      }}>
        <h3 style={{color: '#d4af37', marginBottom: '15px'}}>ð Run Statistics</h3>
        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', textAlign: 'left'}}>
          <div style={{color: '#c4b89a'}}>âï¸ Damage Dealt:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.damageDealt}</div>
          <div style={{color: '#c4b89a'}}>ð Damage Taken:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.damageTaken}</div>
          <div style={{color: '#c4b89a'}}>ð´ Cards Played:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.cardsPlayed}</div>
          <div style={{color: '#c4b89a'}}>â±ï¸ Turns Taken:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.turnsPlayed}</div>
          <div style={{color: '#c4b89a'}}>ð¹ Enemies Defeated:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.enemiesDefeated}</div>
        </div>
      </div>
      
      <div style={{ marginTop: '40px' }}>
        <button 
          style={styles.button} 
          onClick={resetGame}
          onMouseOver={(e) => {
            e.currentTarget.style.transform = 'translateY(-3px)';
            e.currentTarget.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.4)';
          }}
          onMouseOut={(e) => {
            e.currentTarget.style.transform = 'translateY(0)';
            e.currentTarget.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
          }}
        >
          ð¡ï¸ Try Again
        </button>
      </div>
    </div>
  );

  const renderEvent = () => {
    if (!player || !currentEvent) return null;
    
    const eventData = EVENT_LOCATIONS[currentEvent];
    if (!eventData) return null;
    
    const handleEnterEvent = () => {
      const outcome = getRandomEventOutcome();
      setEventOutcome(outcome);
      
      const eventEffect = eventData.events[outcome];
      
      // Apply event effects
      setPlayer(prev => {
        let newPlayer = { ...prev };
        
        // Gold changes
        if (eventEffect.effect.gold) {
          newPlayer.gold = Math.max(0, prev.gold + eventEffect.effect.gold);
        }
        
        // Healing
        if (eventEffect.effect.heal) {
          const healAmount = eventEffect.effect.heal === 999 ? prev.maxHp : eventEffect.effect.heal;
          newPlayer.hp = Math.min(prev.maxHp, prev.hp + healAmount);
        }
        
        // Damage
        if (eventEffect.effect.damage) {
          newPlayer.hp = Math.max(1, prev.hp - eventEffect.effect.damage);
        }
        
        // Max HP changes
        if (eventEffect.effect.maxHp) {
          newPlayer.maxHp = Math.max(10, prev.maxHp + eventEffect.effect.maxHp);
          if (eventEffect.effect.maxHp > 0) {
            newPlayer.hp = Math.min(newPlayer.maxHp, prev.hp + eventEffect.effect.maxHp);
          }
        }
        
        // Strength bonus
        if (eventEffect.effect.strength) {
          newPlayer.strength = (prev.strength || 0) + eventEffect.effect.strength;
        }
        
        // Dexterity bonus
        if (eventEffect.effect.dexterity) {
          newPlayer.dexterity = (prev.dexterity || 0) + eventEffect.effect.dexterity;
        }
        
        return newPlayer;
      });
      
      // Special sanctuary corruption reduction
      if (currentEvent === 'rivendell') {
        setCorruption(prev => Math.max(0, prev - 30));
      } else if (currentEvent === 'lothlorien') {
        setCorruption(prev => Math.max(0, prev - 20));
      }
      
      // Handle relic reward
      if (eventEffect.effect.relic) {
        const relicReward = getRelicRewards(1, player.relics);
        if (relicReward.length > 0) {
          const relic = getRelic(relicReward[0]);
          const maxHpBonus = relic?.effect?.bonusMaxHp || 0;
          setPlayer(prev => ({
            ...prev,
            relics: [...prev.relics, relicReward[0]],
            maxHp: prev.maxHp + maxHpBonus,
            hp: prev.hp + maxHpBonus
          }));
        }
      }
      
      // Handle specific relic (like The One Ring)
      if (eventEffect.effect.specificRelic) {
        const specificRelicId = eventEffect.effect.specificRelic;
        if (!player.relics.includes(specificRelicId)) {
          const relic = getRelic(specificRelicId);
          const maxHpBonus = relic?.effect?.bonusMaxHp || 0;
          setPlayer(prev => ({
            ...prev,
            relics: [...prev.relics, specificRelicId],
            maxHp: prev.maxHp + maxHpBonus,
            hp: prev.hp + maxHpBonus
          }));
        }
      }
      
      // Handle corruption changes from events
      if (eventEffect.effect.corruption) {
        setCorruption(prev => Math.min(100, Math.max(0, prev + eventEffect.effect.corruption)));
      }
      
      // Handle card upgrade
      if (eventEffect.effect.upgradeRandom) {
        const upgradableCards = player.deck.filter(c => !c.upgraded && CARD_UPGRADES[c.id]);
        if (upgradableCards.length > 0) {
          const randomCard = upgradableCards[Math.floor(Math.random() * upgradableCards.length)];
          const upgraded = upgradeCard(randomCard);
          setPlayer(prev => ({
            ...prev,
            deck: prev.deck.map(c => c.uid === randomCard.uid ? upgraded : c)
          }));
        }
      }
      
      setEventResolved(true);
    };
    
    const handleContinue = () => {
      setCurrentEvent(null);
      setEventOutcome(null);
      setEventResolved(false);
      setCurrentEncounter(prev => prev + 1);
      setGameState('map');
    };
    
    const outcomeColors = {
      bad: '#ff6b6b',
      good: '#90ee90',
      great: '#ffd700'
    };
    
    const outcomeIcons = {
      bad: 'ð',
      good: 'â¨',
      great: 'ð'
    };
    
    return (
      <div style={{
        ...styles.mapScreen,
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        textAlign: 'center',
        padding: '40px'
      }}>
        <div style={{
          background: 'rgba(0,0,0,0.7)',
          borderRadius: '20px',
          padding: '40px',
          maxWidth: '600px',
          border: '2px solid rgba(212, 175, 55, 0.5)',
          boxShadow: '0 0 40px rgba(212, 175, 55, 0.2)'
        }}>
          <div style={{ fontSize: '4rem', marginBottom: '20px' }}>{eventData.icon}</div>
          <h2 style={{ color: '#d4af37', fontSize: '2rem', marginBottom: '10px' }}>
            {eventData.name}
          </h2>
          <p style={{ color: '#c4b89a', fontSize: '1.1rem', marginBottom: '30px', fontStyle: 'italic' }}>
            {eventData.description}
          </p>
          
          {!eventResolved ? (
            <button
              style={{
                ...styles.button,
                background: 'linear-gradient(145deg, #4a3c2a, #2a1c0a)',
                fontSize: '1.2rem',
                padding: '15px 40px'
              }}
              onClick={handleEnterEvent}
            >
              ð² Enter and See What Happens...
            </button>
          ) : (
            <div>
              <div style={{
                background: `rgba(${eventOutcome === 'bad' ? '139,0,0' : eventOutcome === 'great' ? '184,134,11' : '34,139,34'}, 0.3)`,
                borderRadius: '15px',
                padding: '25px',
                marginBottom: '25px',
                border: `2px solid ${outcomeColors[eventOutcome]}`
              }}>
                <div style={{ fontSize: '3rem', marginBottom: '10px' }}>
                  {outcomeIcons[eventOutcome]}
                </div>
                <h3 style={{ color: outcomeColors[eventOutcome], fontSize: '1.5rem', marginBottom: '10px' }}>
                  {eventData.events[eventOutcome].name}
                </h3>
                <p style={{ color: '#f4e4bc', fontSize: '1.1rem', marginBottom: '15px' }}>
                  {eventData.events[eventOutcome].description}
                </p>
                <p style={{ color: outcomeColors[eventOutcome], fontSize: '1rem', fontWeight: 'bold' }}>
                  {eventData.events[eventOutcome].message}
                </p>
              </div>
              
              <button
                style={{
                  ...styles.button,
                  background: 'linear-gradient(145deg, #228b22, #145214)',
                  fontSize: '1.1rem'
                }}
                onClick={handleContinue}
              >
                Continue Journey â
              </button>
            </div>
          )}
          
          <div style={{ marginTop: '25px', color: '#888', fontSize: '0.9rem' }}>
            â¤ï¸ HP: {player.hp}/{player.maxHp} | ð° Gold: {player.gold}
          </div>
        </div>
      </div>
    );
  };

  const renderShop = () => {
    if (!player) return null;
    
    const buyCard = (card, price) => {
      if (player.gold < price) return;
      SoundSystem.buttonClick();
      setPlayer(prev => ({
        ...prev,
        gold: prev.gold - price,
        deck: [...prev.deck, { ...card, uid: card.id + '_' + Date.now() }]
      }));
      setShopItems(prev => ({
        ...prev,
        cards: prev.cards.filter(c => c.id !== card.id)
      }));
    };
    
    const buyRelic = (relicId, price) => {
      if (player.gold < price || player.relics.includes(relicId)) return;
      SoundSystem.heal();
      const relic = getRelic(relicId);
      const maxHpBonus = relic?.effect?.bonusMaxHp || 0;
      setPlayer(prev => ({
        ...prev,
        gold: prev.gold - price,
        relics: [...prev.relics, relicId],
        maxHp: prev.maxHp + maxHpBonus,
        hp: prev.hp + maxHpBonus // Also heal the bonus HP
      }));
      setShopItems(prev => ({
        ...prev,
        relics: prev.relics.filter(r => r !== relicId)
      }));
      if (maxHpBonus > 0) {
        setCombatLog([`â¨ ${relic.name} grants +${maxHpBonus} Max HP!`]);
      }
    };
    
    const removeCard = (card) => {
      if (player.gold < 50 || player.deck.length <= 5) return;
      SoundSystem.buttonClick();
      setPlayer(prev => ({
        ...prev,
        gold: prev.gold - 50,
        deck: prev.deck.filter(c => c.uid !== card.uid)
      }));
      setShopItems(prev => ({ ...prev, removeCard: false }));
    };
    
    const leaveShop = () => {
      setCurrentEncounter(prev => prev + 1);
      setGameState('map');
    };
    
    const getCardPrice = (card) => card.rarity === 'rare' ? 100 : card.rarity === 'uncommon' ? 60 : 40;
    
    return (
      <div style={styles.shopScreen}>
        <h2 style={{ color: '#d4af37', fontSize: '2.2rem', marginBottom: '5px' }}>ðª Merchant</h2>
        <p style={{ color: '#ffd700', fontSize: '1.2rem', marginBottom: '20px' }}>ð° Gold: {player.gold}</p>
        
        <div style={styles.shopSection}>
          <h3 style={{ color: '#c4b89a', marginBottom: '15px' }}>Cards for Sale</h3>
          <div>
            {shopItems.cards.map((card, i) => {
              const price = getCardPrice(card);
              const canBuy = player.gold >= price;
              return (
                <div 
                  key={card.id + i}
                  style={{...styles.shopItem, opacity: canBuy ? 1 : 0.5}}
                  onClick={() => canBuy && buyCard(card, price)}
                >
                  <div style={styles.cardArt}>{getCardArt(card.id, card.type)}</div>
                  <div style={{fontWeight: 'bold', fontSize: '12px', color: '#f4e4bc'}}>{card.name}</div>
                  <div style={{fontSize: '10px', color: '#888', textTransform: 'uppercase'}}>{card.rarity}</div>
                  <div style={styles.shopPrice}>ð° {price}</div>
                </div>
              );
            })}
          </div>
        </div>
        
        {shopItems.relics.length > 0 && (
          <div style={styles.shopSection}>
            <h3 style={{ color: '#c4b89a', marginBottom: '15px' }}>Relics</h3>
            <div>
              {shopItems.relics.map(relicId => {
                const relic = getRelic(relicId);
                if (!relic) return null;
                const price = relic.rarity === 'rare' ? 200 : relic.rarity === 'uncommon' ? 150 : 100;
                const canBuy = player.gold >= price;
                return (
                  <div 
                    key={relicId}
                    style={{...styles.shopItem, opacity: canBuy ? 1 : 0.5}}
                    onClick={() => canBuy && buyRelic(relicId, price)}
                  >
                    <div style={{ fontSize: '2rem' }}>{relic.icon}</div>
                    <div style={{fontWeight: 'bold', color: '#d4af37'}}>{relic.name}</div>
                    <div style={{fontSize: '11px', color: '#888'}}>{relic.description}</div>
                    <div style={{fontSize: '0.7rem', color: relic.rarity === 'rare' ? '#ffd700' : relic.rarity === 'uncommon' ? '#1e90ff' : '#888', textTransform: 'uppercase'}}>{relic.rarity}</div>
                    <div style={styles.shopPrice}>ð° {price}</div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
        
        {shopItems.removeCard && player.deck.length > 5 && (
          <div style={styles.shopSection}>
            <h3 style={{ color: '#c4b89a', marginBottom: '15px' }}>Remove a Card (ð° 50)</h3>
            <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
              {player.deck.map((card, i) => (
                <div 
                  key={card.uid + i}
                  style={{...styles.shopItem, opacity: player.gold >= 50 ? 1 : 0.5, minWidth: '100px'}}
                  onClick={() => player.gold >= 50 && removeCard(card)}
                >
                  <div style={{fontWeight: 'bold', fontSize: '11px', color: '#ff6b6b'}}>{card.name}</div>
                  <div style={{fontSize: '10px', color: '#888'}}>Remove</div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        <button style={{...styles.button, marginTop: '20px'}} onClick={leaveShop}>
          Leave Shop â
        </button>
      </div>
    );
  };

  const renderRestSite = () => {
    if (!player) return null;
    const upgradableCards = player.deck.filter(c => !c.upgraded && CARD_UPGRADES[c.id]);
    
    const handleUpgrade = (card) => {
      if (restActionTaken) return; // Prevent multiple actions
      setRestActionTaken(true);
      SoundSystem.heal();
      const upgraded = upgradeCard(card);
      setPlayer(prev => ({
        ...prev,
        deck: prev.deck.map(c => c.uid === card.uid ? upgraded : c)
      }));
      setCombatLog([`â¨ Upgraded ${card.name} to ${upgraded.name}!`]);
      setShowRestRemove(false);
      setTimeout(() => {
        setCurrentEncounter(prev => prev + 1);
        setRestActionTaken(false);
        setGameState('map');
      }, 1500);
    };
    
    const handleRest = () => {
      if (restActionTaken) return; // Prevent multiple actions
      setRestActionTaken(true);
      SoundSystem.heal();
      const baseHealAmount = Math.floor(player.maxHp * 0.3);
      const restHealBonus = getRelicBonus(player, 'restHeal');
      const healAmount = baseHealAmount + restHealBonus;
      setPlayer(prev => ({
        ...prev,
        hp: Math.min(prev.maxHp, prev.hp + healAmount)
      }));
      // Also reduce some corruption when resting (base 5 + skill bonus)
      const skillCorruptionResist = player.skillBonuses?.corruptionResist || 0;
      const totalCorruptionReduction = 5 + skillCorruptionResist;
      const corruptionReduced = Math.min(corruption, totalCorruptionReduction);
      let logMsg = `â¤ï¸ Rested and healed ${healAmount} HP!`;
      if (restHealBonus > 0) {
        logMsg += ` (${restHealBonus} from Arwen's Grace)`;
      }
      if (corruptionReduced > 0) {
        setCorruption(prev => Math.max(0, prev - corruptionReduced));
        logMsg += ` â¨ -${corruptionReduced} corruption`;
      }
      setCombatLog([logMsg]);
      setShowRestRemove(false);
      setTimeout(() => {
        setCurrentEncounter(prev => prev + 1);
        setRestActionTaken(false);
        setGameState('map');
      }, 1500);
    };
    
    // Meditate option for corruption removal
    const handleMeditate = () => {
      if (restActionTaken) return;
      if (corruption <= 0) return;
      setRestActionTaken(true);
      SoundSystem.heal();
      const skillCorruptionResist = player.skillBonuses?.corruptionResist || 0;
      const baseMeditateReduction = CORRUPTION_REMOVAL.rest_site;
      const corruptionReduced = Math.min(corruption, baseMeditateReduction + skillCorruptionResist);
      setCorruption(prev => Math.max(0, prev - corruptionReduced));
      setCombatLog([`ð§ Meditated and cleansed ${corruptionReduced} corruption!`]);
      setShowRestRemove(false);
      setTimeout(() => {
        setCurrentEncounter(prev => prev + 1);
        setRestActionTaken(false);
        setGameState('map');
      }, 1500);
    };
    
    const handleRemoveCard = (card) => {
      if (restActionTaken) return; // Prevent multiple actions
      if (player.deck.length <= 5) return;
      setRestActionTaken(true);
      SoundSystem.buttonClick();
      setPlayer(prev => ({
        ...prev,
        deck: prev.deck.filter(c => c.uid !== card.uid)
      }));
      setCombatLog([`ðï¸ Removed ${card.name} from your deck!`]);
      setShowRestRemove(false);
      setTimeout(() => {
        setCurrentEncounter(prev => prev + 1);
        setRestActionTaken(false);
        setGameState('map');
      }, 1500);
    };
    
    return (
      <div style={styles.restSite}>
        <h2 style={{ color: '#90ee90', fontSize: '2.2rem', marginBottom: '10px' }}>ðï¸ Rest Site</h2>
        <p style={{ color: '#c4b89a', marginBottom: '25px' }}>Take a moment to recover or improve your skills</p>
        
        {restActionTaken && (
          <div style={{ 
            color: '#90ee90', 
            fontSize: '1.2rem', 
            marginBottom: '20px',
            padding: '10px 20px',
            background: 'rgba(144, 238, 144, 0.1)',
            borderRadius: '10px',
            border: '1px solid rgba(144, 238, 144, 0.3)'
          }}>
            â¨ Action complete! Returning to the road...
          </div>
        )}
        
        <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', marginBottom: '30px', flexWrap: 'wrap' }}>
          <button 
            style={{
              ...styles.button, 
              background: 'linear-gradient(145deg, #228b22, #145214)',
              opacity: restActionTaken ? 0.5 : 1,
              cursor: restActionTaken ? 'not-allowed' : 'pointer'
            }}
            onClick={handleRest}
            disabled={restActionTaken}
          >
            â¤ï¸ Rest (Heal 30%)
          </button>
          <button 
            style={{
              ...styles.button, 
              background: corruption > 0 ? 'linear-gradient(145deg, #4a0080, #2d0050)' : 'linear-gradient(145deg, #333, #222)',
              opacity: (restActionTaken || corruption <= 0) ? 0.5 : 1,
              cursor: (restActionTaken || corruption <= 0) ? 'not-allowed' : 'pointer'
            }}
            onClick={handleMeditate}
            disabled={restActionTaken || corruption <= 0}
            title={corruption > 0 ? `Cleanse up to ${CORRUPTION_REMOVAL.rest_site} corruption` : 'No corruption to cleanse'}
          >
            ð§ Meditate (-{Math.min(corruption, CORRUPTION_REMOVAL.rest_site)} corruption)
          </button>
          <button 
            style={{
              ...styles.button, 
              background: showRestRemove ? 'linear-gradient(145deg, #8b2222, #521414)' : 'linear-gradient(145deg, #8b4513, #5a2d0a)',
              opacity: restActionTaken ? 0.5 : 1,
              cursor: restActionTaken ? 'not-allowed' : 'pointer'
            }}
            onClick={() => !restActionTaken && setShowRestRemove(!showRestRemove)}
            disabled={restActionTaken}
          >
            ðï¸ {showRestRemove ? 'Hide Remove' : 'Remove a Card'}
          </button>
        </div>
        
        {/* Show current corruption level */}
        {corruption > 0 && (
          <div style={{
            marginBottom: '20px',
            padding: '10px 20px',
            background: 'rgba(75, 0, 130, 0.2)',
            borderRadius: '10px',
            border: '1px solid rgba(75, 0, 130, 0.4)'
          }}>
            <span style={{ color: '#9966ff' }}>ð Current Corruption: {corruption}/100</span>
            <span style={{ color: '#c4b89a', marginLeft: '15px', fontSize: '0.9rem' }}>
              ({getCorruptionLevel(corruption)})
            </span>
          </div>
        )}
        
        {showRestRemove && (
          <>
            <h3 style={{ color: '#ff6b6b', marginBottom: '15px' }}>Remove a Card (min 5 cards in deck):</h3>
            <div style={styles.upgradeGrid}>
              {player.deck.map((card, index) => (
                <div 
                  key={card.uid + index}
                  style={{
                    ...styles.upgradeCard,
                    borderColor: 'rgba(255, 107, 107, 0.5)',
                    background: 'rgba(139, 34, 34, 0.2)',
                    opacity: (player.deck.length <= 5 || restActionTaken) ? 0.5 : 1,
                    cursor: (player.deck.length <= 5 || restActionTaken) ? 'not-allowed' : 'pointer'
                  }}
                  onClick={() => handleRemoveCard(card)}
                  onMouseOver={(e) => {
                    if (player.deck.length > 5 && !restActionTaken) {
                      e.currentTarget.style.transform = 'scale(1.05)';
                      e.currentTarget.style.borderColor = '#ff6b6b';
                      e.currentTarget.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.4)';
                    }
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.transform = 'scale(1)';
                    e.currentTarget.style.borderColor = 'rgba(255, 107, 107, 0.5)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  <div style={styles.cardArt}>{getCardArt(card.id, card.type)}</div>
                  <div style={{fontWeight: 'bold', fontSize: '11px', color: '#f4e4bc'}}>{card.name}</div>
                  <div style={{fontSize: '10px', color: '#ff6b6b', marginTop: '5px'}}>Remove</div>
                </div>
              ))}
            </div>
          </>
        )}
        
        {!showRestRemove && (
          <>
            <h3 style={{ color: '#90ee90', marginBottom: '15px' }}>Or Upgrade a Card:</h3>
            <div style={styles.upgradeGrid}>
              {upgradableCards.map((card, index) => {
                const upgrade = CARD_UPGRADES[card.id];
                // Build upgrade description showing what changes
                const changes = [];
                if (upgrade.damage && upgrade.damage !== card.damage) {
                  changes.push(`âï¸ ${card.damage || 0} â ${upgrade.damage}`);
                }
                if (upgrade.block && upgrade.block !== card.block) {
                  changes.push(`ð¡ï¸ ${card.block || 0} â ${upgrade.block}`);
                }
                if (upgrade.heal && upgrade.heal !== card.heal) {
                  changes.push(`â¤ï¸ ${card.heal || 0} â ${upgrade.heal}`);
                }
                if (upgrade.draw && upgrade.draw !== card.draw) {
                  changes.push(`ð ${card.draw || 0} â ${upgrade.draw}`);
                }
                if (upgrade.strength && upgrade.strength !== card.strength) {
                  changes.push(`ðª ${card.strength || 0} â ${upgrade.strength}`);
                }
                if (upgrade.dexterity && upgrade.dexterity !== card.dexterity) {
                  changes.push(`ð ${card.dexterity || 0} â ${upgrade.dexterity}`);
                }
                if (upgrade.hits && upgrade.hits !== card.hits) {
                  changes.push(`Ã${card.hits || 1} â Ã${upgrade.hits}`);
                }
                if (upgrade.cost !== undefined && upgrade.cost !== card.cost) {
                  changes.push(`â¡ ${card.cost} â ${upgrade.cost}`);
                }
                if (upgrade.vulnerable && upgrade.vulnerable !== card.vulnerable) {
                  changes.push(`Vuln: ${card.vulnerable || 0} â ${upgrade.vulnerable}`);
                }
                if (upgrade.weak && upgrade.weak !== card.weak) {
                  changes.push(`Weak: ${card.weak || 0} â ${upgrade.weak}`);
                }
                if (upgrade.burn && upgrade.burn !== card.burn) {
                  changes.push(`ð¥ ${card.burn || 0} â ${upgrade.burn}`);
                }
                if (upgrade.poison && upgrade.poison !== card.poison) {
                  changes.push(`â ï¸ ${card.poison || 0} â ${upgrade.poison}`);
                }
                if (upgrade.energy && upgrade.energy !== card.energy) {
                  changes.push(`+${upgrade.energy} energy`);
                }
                
                return (
                <div 
                  key={card.uid + index}
                  style={{
                    ...styles.upgradeCard,
                    opacity: restActionTaken ? 0.5 : 1,
                    cursor: restActionTaken ? 'not-allowed' : 'pointer',
                    minWidth: '150px',
                    padding: '12px',
                  }}
                  onClick={() => handleUpgrade(card)}
                  onMouseOver={(e) => {
                    if (!restActionTaken) {
                      e.currentTarget.style.transform = 'scale(1.05)';
                      e.currentTarget.style.borderColor = '#90ee90';
                      e.currentTarget.style.boxShadow = '0 0 20px rgba(144, 238, 144, 0.4)';
                    }
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.transform = 'scale(1)';
                    e.currentTarget.style.borderColor = 'rgba(144, 238, 144, 0.5)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  <div style={styles.cardArt}>{getCardArt(card.id, card.type)}</div>
                  <div style={{fontWeight: 'bold', fontSize: '12px', color: '#f4e4bc'}}>{card.name}</div>
                  <div style={{fontSize: '11px', color: '#90ee90', marginTop: '5px', fontWeight: 'bold'}}>
                    â {upgrade.name}
                  </div>
                  {/* Show upgrade changes */}
                  <div style={{
                    fontSize: '10px', 
                    color: '#ffd700', 
                    marginTop: '6px',
                    borderTop: '1px solid rgba(144, 238, 144, 0.3)',
                    paddingTop: '6px',
                    lineHeight: '1.4',
                  }}>
                    {changes.length > 0 ? changes.join(' | ') : 'Enhanced effects'}
                  </div>
                </div>
              )})}
            </div>
            
            {upgradableCards.length === 0 && (
              <p style={{ color: '#888', fontStyle: 'italic' }}>No cards available to upgrade</p>
            )}
          </>
        )}
      </div>
    );
  };

  const renderVictory = () => {
    const rawCharProgress = playerProgress[selectedCharacter] || {};
    // ALWAYS calculate level from XP - never trust stored level
    const actualLevel = getLevelFromXP(rawCharProgress.xp || 0);
    const charProgress = {
      ...rawCharProgress,
      level: actualLevel,
      xp: Math.max(0, Number(rawCharProgress.xp) || 0)
    };
    const prestigeData = getPrestigeData(charProgress.prestigeLevel || 0);
    const canPrestigeNow = charProgress.level >= 10;
    
    const handlePrestige = () => {
      setPlayerProgress(prev => {
        const updated = { ...prev };
        const existingData = updated[selectedCharacter] || {};
        const charData = {
          xp: 0,
          level: 1,
          totalXP: 0,
          skillPoints: 0,
          unlockedSkills: [],
          prestigeLevel: 0,
          gamesCompleted: 0,
          ...existingData
        };
        charData.prestigeLevel = (Number(charData.prestigeLevel) || 0) + 1;
        charData.level = 1;
        charData.xp = 0;
        charData.skillPoints = 0;
        charData.unlockedSkills = [];
        updated[selectedCharacter] = charData;
        savePlayerProgress(updated);
        return updated;
      });
      resetGame();
    };
    
    return (
    <div style={styles.victory}>
      <h2 style={{ color: '#90ee90', fontSize: '2.8rem', marginBottom: '20px', textShadow: '0 0 30px rgba(144,238,144,0.5)' }}>
        ð Victory!
      </h2>
      
      {/* US-001: Corruption-based Ending Title */}
      {(() => {
        const corruptionEnding = getCorruptionEnding(corruption);
        const endingColor = corruption < 25 ? '#90ee90' : corruption < 50 ? '#ffd700' : corruption < 75 ? '#ff8c00' : '#dc143c';
        return (
          <div style={{
            background: `linear-gradient(145deg, ${endingColor}20, ${endingColor}10)`,
            borderRadius: '12px',
            padding: '20px',
            margin: '0 auto 25px',
            maxWidth: '500px',
            border: `2px solid ${endingColor}`,
          }}>
            <h3 style={{ color: endingColor, fontSize: '1.4rem', marginBottom: '10px' }}>
              {corruptionEnding.title}
            </h3>
            <p style={{ color: '#c4b89a', fontSize: '1rem', fontStyle: 'italic', marginBottom: '10px' }}>
              {corruptionEnding.description}
            </p>
            <div style={{ 
              color: endingColor, 
              fontSize: '0.9rem', 
              fontWeight: 'bold',
              background: 'rgba(0,0,0,0.3)',
              borderRadius: '6px',
              padding: '6px 12px',
              display: 'inline-block'
            }}>
              ð Final Corruption: {corruption}% â¢ Title: {corruptionEnding.bonusTitle}
            </div>
          </div>
        );
      })()}
      
      {/* US-001: Character Epilogue */}
      {selectedCharacter && (() => {
        const epilogue = getCharacterEpilogue(selectedCharacter, storyState.storyChoices);
        if (!epilogue) return null;
        return (
          <div style={{
            background: 'linear-gradient(145deg, rgba(107, 163, 199, 0.2), rgba(70, 130, 180, 0.1))',
            borderRadius: '12px',
            padding: '25px',
            margin: '0 auto 25px',
            maxWidth: '550px',
            border: '2px solid rgba(107, 163, 199, 0.5)',
          }}>
            <div style={{ fontSize: '0.85rem', color: '#6ba3c7', letterSpacing: '2px', marginBottom: '8px' }}>
              ð EPILOGUE
            </div>
            <h3 style={{ color: '#f4e4bc', fontSize: '1.3rem', marginBottom: '15px' }}>
              {epilogue.title}
            </h3>
            <p style={{ 
              color: '#c4b89a', 
              fontSize: '0.95rem', 
              lineHeight: '1.6',
              textAlign: 'left',
              fontStyle: 'italic'
            }}>
              {epilogue.text}
            </p>
            {epilogue.bonus && (
              <div style={{
                marginTop: '15px',
                padding: '10px',
                background: 'rgba(255, 215, 0, 0.1)',
                borderRadius: '8px',
                border: '1px solid rgba(255, 215, 0, 0.3)',
              }}>
                <span style={{ color: '#ffd700' }}>ð Unlocked: </span>
                <span style={{ color: '#90ee90' }}>
                  {epilogue.bonus.unlockCard ? `Card: ${STORY_CARDS[epilogue.bonus.unlockCard]?.name || epilogue.bonus.unlockCard}` : 'Special Bonus'}
                </span>
              </div>
            )}
          </div>
        );
      })()}
      
      {/* Story Choices Made */}
      {Object.keys(storyState.storyChoices).length > 0 && (
        <div style={{
          background: 'rgba(0,0,0,0.3)',
          borderRadius: '12px',
          padding: '15px 20px',
          margin: '0 auto 20px',
          maxWidth: '450px',
          border: '1px solid rgba(212, 175, 55, 0.3)',
        }}>
          <div style={{ fontSize: '0.85rem', color: '#d4af37', marginBottom: '10px' }}>
            ð Key Decisions Made: {Object.keys(storyState.storyChoices).filter(k => !k.includes('_completed')).length}
          </div>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', justifyContent: 'center' }}>
            {Object.keys(storyState.storyChoices)
              .filter(k => !k.includes('_completed'))
              .slice(0, 6)
              .map(key => (
                <span key={key} style={{
                  background: 'rgba(107, 163, 199, 0.2)',
                  padding: '4px 10px',
                  borderRadius: '12px',
                  fontSize: '0.75rem',
                  color: '#87ceeb',
                  border: '1px solid rgba(107, 163, 199, 0.3)'
                }}>
                  â {key.replace(/_/g, ' ')}
                </span>
              ))}
          </div>
        </div>
      )}
      
      <div style={{ display: 'flex', justifyContent: 'center', gap: '20px', marginBottom: '30px' }}>
        <Portrait src={player?.image || characterImages.strider} size={100} border="#90ee90" />
      </div>
      
      {/* R003 - XP Earned This Run */}
      <div style={{
        background: 'linear-gradient(145deg, rgba(255, 215, 0, 0.2), rgba(200, 160, 0, 0.1))',
        borderRadius: '12px',
        padding: '15px 25px',
        margin: '0 auto 20px',
        maxWidth: '350px',
        border: '2px solid rgba(255, 215, 0, 0.5)',
        textAlign: 'center',
      }}>
        <div style={{ fontSize: '1.3rem', color: '#ffd700' }}>
          â­ +{sessionXP + (XP_REWARDS.act_completed * 3)} XP Earned!
        </div>
        <div style={{ fontSize: '0.9rem', color: '#c4b89a', marginTop: '5px' }}>
          {selectedCharacter && `${CHARACTERS[selectedCharacter]?.name} is now Level ${Math.max(1, Number(charProgress.level) || 1)}`}
        </div>
      </div>
      
      {/* Run Statistics */}
      <div style={{
        background: 'rgba(0,0,0,0.4)',
        borderRadius: '12px',
        padding: '20px',
        margin: '20px auto',
        maxWidth: '400px',
        border: '1px solid rgba(144,238,144,0.3)'
      }}>
        <h3 style={{color: '#d4af37', marginBottom: '15px'}}>ð Run Statistics</h3>
        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', textAlign: 'left'}}>
          <div style={{color: '#c4b89a'}}>âï¸ Damage Dealt:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.damageDealt}</div>
          <div style={{color: '#c4b89a'}}>ð Damage Taken:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.damageTaken}</div>
          <div style={{color: '#c4b89a'}}>ð´ Cards Played:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.cardsPlayed}</div>
          <div style={{color: '#c4b89a'}}>â±ï¸ Turns Taken:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.turnsPlayed}</div>
          <div style={{color: '#c4b89a'}}>ð¹ Enemies Defeated:</div>
          <div style={{color: '#f4e4bc', fontWeight: 'bold'}}>{runStats.enemiesDefeated}</div>
        </div>
      </div>
      
      {/* R003 - Prestige Option */}
      {canPrestigeNow && (charProgress.prestigeLevel || 0) < 5 && (
        <div style={{
          background: 'linear-gradient(145deg, rgba(138, 43, 226, 0.3), rgba(75, 0, 130, 0.2))',
          borderRadius: '12px',
          padding: '20px',
          margin: '20px auto',
          maxWidth: '400px',
          border: '2px solid rgba(138, 43, 226, 0.5)',
        }}>
          <h3 style={{color: '#da70d6', marginBottom: '10px'}}>
            ð Prestige Available!
          </h3>
          <p style={{color: '#c4b89a', fontSize: '0.9rem', marginBottom: '15px'}}>
            Reset your level to 1 and gain permanent bonuses!
          </p>
          <div style={{color: '#90ee90', fontSize: '0.85rem', marginBottom: '15px'}}>
            Next tier: {PRESTIGE_LEVELS[(charProgress.prestigeLevel || 0) + 1]?.icon} {PRESTIGE_LEVELS[(charProgress.prestigeLevel || 0) + 1]?.name}
            <br />
            Bonuses: +{PRESTIGE_LEVELS[(charProgress.prestigeLevel || 0) + 1]?.bonuses.startingGold || 0} gold, 
            {PRESTIGE_LEVELS[(charProgress.prestigeLevel || 0) + 1]?.bonuses.xpMultiplier || 1}x XP
          </div>
          <button
            style={{
              ...styles.button,
              background: 'linear-gradient(145deg, #8b008b, #4b0082)',
            }}
            onClick={handlePrestige}
          >
            â¬ï¸ Prestige Up
          </button>
        </div>
      )}
      
      <div style={{ marginTop: '40px' }}>
        <button 
          style={styles.button} 
          onClick={resetGame}
          onMouseOver={(e) => {
            e.currentTarget.style.transform = 'translateY(-3px)';
            e.currentTarget.style.boxShadow = '0 8px 25px rgba(144, 238, 144, 0.4)';
          }}
          onMouseOut={(e) => {
            e.currentTarget.style.transform = 'translateY(0)';
            e.currentTarget.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
          }}
        >
          ð¡ï¸ Play Again
        </button>
      </div>
    </div>
  )};


  // R001 - Story Framework Render Components
  
  // Story Beat Modal - Shows narrative moments
  const renderStoryBeatModal = () => {
    if (!currentStoryBeat || !showStoryModal) return null;
    
    const location = BATTLE_LOCATIONS[currentStoryBeat.background] || BATTLE_LOCATIONS.misty_mountains;
    
    return (
      <>
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.85)',
            zIndex: 3000,
          }}
          onClick={closeStoryModal}
        />
        <div style={{
          position: 'fixed',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%)',
          background: location.gradient,
          borderRadius: '20px',
          padding: '40px',
          maxWidth: '700px',
          width: '90%',
          maxHeight: '85vh',
          overflowY: 'auto',
          zIndex: 3001,
          border: '3px solid #d4af37',
          boxShadow: '0 0 80px rgba(212, 175, 55, 0.4), 0 20px 60px rgba(0,0,0,0.8)',
          animation: 'fadeIn 0.5s ease-out',
        }}>
          {/* Location overlay */}
          <div style={{
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: location.overlayColor,
            borderRadius: '17px',
            pointerEvents: 'none',
          }} />
          
          {/* Content */}
          <div style={{ position: 'relative', zIndex: 1 }}>
            {/* Act & Location */}
            <div style={{
              textAlign: 'center',
              marginBottom: '15px',
              color: '#d4af37',
              fontSize: '0.9rem',
              letterSpacing: '2px',
              textTransform: 'uppercase',
            }}>
              Act {currentStoryBeat.act} â¢ {location.name}
            </div>
            
            {/* Title */}
            <h2 style={{
              textAlign: 'center',
              color: '#f4e4bc',
              fontSize: '2rem',
              marginBottom: '25px',
              textShadow: '0 0 20px rgba(244, 228, 188, 0.5)',
              fontFamily: "'Cinzel', Georgia, serif",
            }}>
              {currentStoryBeat.title}
            </h2>
            
            {/* Narrative */}
            <p style={{
              color: '#e8d8c8',
              fontSize: '1.15rem',
              lineHeight: '1.8',
              textAlign: 'center',
              marginBottom: '30px',
              fontStyle: 'italic',
            }}>
              {currentStoryBeat.narrative}
            </p>
            
            {/* Quote */}
            {currentStoryBeat.quote && (
              <div style={{
                background: 'rgba(0, 0, 0, 0.4)',
                borderLeft: '4px solid #d4af37',
                padding: '15px 25px',
                marginBottom: '30px',
                borderRadius: '0 10px 10px 0',
              }}>
                <p style={{
                  color: '#c4b89a',
                  fontSize: '1rem',
                  fontStyle: 'italic',
                  margin: 0,
                }}>
                  {currentStoryBeat.quote}
                </p>
              </div>
            )}
            
            {/* Continue Button */}
            <div style={{ textAlign: 'center' }}>
              <button
                style={{
                  ...styles.button,
                  background: 'linear-gradient(145deg, #d4af37, #8b6914)',
                  borderColor: '#f4cf57',
                  padding: '15px 50px',
                  fontSize: '1.1rem',
                }}
                onClick={closeStoryModal}
              >
                Continue Your Journey â
              </button>
            </div>
          </div>
        </div>
      </>
    );
  };

  // Backstory Reveal Modal
  const renderBackstoryRevealModal = () => {
    if (!pendingBackstoryReveal) return null;
    
    const characterData = CHARACTER_BACKSTORIES[selectedCharacter];
    
    return (
      <>
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.85)',
            zIndex: 3000,
          }}
          onClick={closeBackstoryReveal}
        />
        <div style={{
          position: 'fixed',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%)',
          background: 'linear-gradient(145deg, rgba(45, 35, 25, 0.98) 0%, rgba(25, 15, 10, 0.99) 100%)',
          borderRadius: '20px',
          padding: '40px',
          maxWidth: '600px',
          width: '90%',
          maxHeight: '85vh',
          overflowY: 'auto',
          zIndex: 3001,
          border: '3px solid #90ee90',
          boxShadow: '0 0 60px rgba(144, 238, 144, 0.3), 0 20px 60px rgba(0,0,0,0.8)',
          animation: 'fadeIn 0.5s ease-out',
        }}>
          {/* Unlock Banner */}
          <div style={{
            textAlign: 'center',
            marginBottom: '20px',
            color: '#90ee90',
            fontSize: '0.9rem',
            letterSpacing: '2px',
          }}>
            â¨ {pendingBackstoryReveal.unlockMessage} â¨
          </div>
          
          {/* Character Portrait */}
          <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '25px' }}>
            <Portrait src={player?.image} size={100} border="#90ee90" />
          </div>
          
          {/* Title */}
          <h3 style={{
            textAlign: 'center',
            color: '#d4af37',
            fontSize: '1.5rem',
            marginBottom: '20px',
          }}>
            {pendingBackstoryReveal.title}
          </h3>
          
          {/* Backstory Text */}
          <div style={{
            background: 'rgba(0, 0, 0, 0.4)',
            borderRadius: '12px',
            padding: '25px',
            marginBottom: '30px',
          }}>
            <p style={{
              color: '#e8d8c8',
              fontSize: '1.1rem',
              lineHeight: '1.8',
              fontStyle: 'italic',
              margin: 0,
            }}>
              "{pendingBackstoryReveal.text}"
            </p>
          </div>
          
          {/* Close Button */}
          <div style={{ textAlign: 'center' }}>
            <button
              style={{
                ...styles.button,
                background: 'linear-gradient(145deg, #228b22, #145214)',
                borderColor: '#90ee90',
              }}
              onClick={closeBackstoryReveal}
            >
              Continue
            </button>
          </div>
        </div>
      </>
    );
  };

  // Fellowship Dialogue Modal
  const renderDialogueModal = () => {
    if (!currentDialogue) return null;
    
    const dialogue = currentDialogue.dialogue;
    
    return (
      <>
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.85)',
            zIndex: 3000,
          }}
          onClick={currentDialogue.showOutcome ? closeDialogueModal : undefined}
        />
        <div style={{
          position: 'fixed',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%)',
          background: 'linear-gradient(145deg, rgba(30, 40, 50, 0.98) 0%, rgba(15, 20, 25, 0.99) 100%)',
          borderRadius: '20px',
          padding: '40px',
          maxWidth: '700px',
          width: '90%',
          maxHeight: '85vh',
          overflowY: 'auto',
          zIndex: 3001,
          border: '3px solid #6ba3c7',
          boxShadow: '0 0 60px rgba(107, 163, 199, 0.3), 0 20px 60px rgba(0,0,0,0.8)',
          animation: 'fadeIn 0.5s ease-out',
        }}>
          {/* Header */}
          <div style={{
            textAlign: 'center',
            marginBottom: '20px',
            color: '#6ba3c7',
            fontSize: '0.9rem',
            letterSpacing: '2px',
          }}>
            ð¬ {dialogue.location}
          </div>
          
          <h3 style={{
            textAlign: 'center',
            color: '#f4e4bc',
            fontSize: '1.6rem',
            marginBottom: '25px',
          }}>
            {dialogue.title}
          </h3>
          
          {/* Introduction */}
          <p style={{
            color: '#c4b89a',
            fontSize: '1.1rem',
            lineHeight: '1.7',
            textAlign: 'center',
            marginBottom: '30px',
            fontStyle: 'italic',
          }}>
            {dialogue.introduction}
          </p>
          
          {!currentDialogue.showOutcome ? (
            /* Choices */
            <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
              {dialogue.choices.map((choice, index) => (
                <button
                  key={choice.id}
                  style={{
                    background: 'rgba(0, 0, 0, 0.4)',
                    border: '2px solid rgba(107, 163, 199, 0.5)',
                    borderRadius: '12px',
                    padding: '15px 20px',
                    color: '#e8d8c8',
                    fontSize: '1rem',
                    textAlign: 'left',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease',
                  }}
                  onClick={() => handleDialogueChoice(choice)}
                  onMouseOver={(e) => {
                    e.currentTarget.style.borderColor = '#6ba3c7';
                    e.currentTarget.style.background = 'rgba(107, 163, 199, 0.15)';
                    e.currentTarget.style.transform = 'translateX(5px)';
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(107, 163, 199, 0.5)';
                    e.currentTarget.style.background = 'rgba(0, 0, 0, 0.4)';
                    e.currentTarget.style.transform = 'translateX(0)';
                  }}
                >
                  {choice.text}
                </button>
              ))}
            </div>
          ) : (
            /* Outcome */
            <div style={{ animation: 'fadeIn 0.5s ease-out' }}>
              {/* Selected choice */}
              <div style={{
                background: 'rgba(107, 163, 199, 0.2)',
                borderRadius: '12px',
                padding: '15px 20px',
                marginBottom: '20px',
                borderLeft: '4px solid #6ba3c7',
              }}>
                <p style={{ color: '#6ba3c7', fontSize: '0.9rem', margin: '0 0 5px 0' }}>You said:</p>
                <p style={{ color: '#e8d8c8', fontSize: '1rem', margin: 0 }}>
                  {currentDialogue.selectedChoice.text}
                </p>
              </div>
              
              {/* Response */}
              <div style={{
                background: 'rgba(212, 175, 55, 0.15)',
                borderRadius: '12px',
                padding: '15px 20px',
                marginBottom: '20px',
                borderLeft: '4px solid #d4af37',
              }}>
                <p style={{ color: '#d4af37', fontSize: '0.9rem', margin: '0 0 5px 0' }}>{player?.name} responds:</p>
                <p style={{ color: '#e8d8c8', fontSize: '1rem', fontStyle: 'italic', margin: 0 }}>
                  {getCharacterResponse(currentDialogue.selectedChoice.response)}
                </p>
              </div>
              
              {/* Outcome effect */}
              <div style={{
                background: 'rgba(144, 238, 144, 0.15)',
                borderRadius: '12px',
                padding: '15px 20px',
                marginBottom: '25px',
                textAlign: 'center',
              }}>
                <p style={{ color: '#90ee90', fontSize: '1rem', margin: 0, fontWeight: 'bold' }}>
                  â¨ {currentDialogue.selectedChoice.outcome}
                </p>
              </div>
              
              {/* Continue Button */}
              <div style={{ textAlign: 'center' }}>
                <button
                  style={{
                    ...styles.button,
                    background: 'linear-gradient(145deg, #6ba3c7, #3d6b8c)',
                    borderColor: '#8ac4e8',
                  }}
                  onClick={closeDialogueModal}
                >
                  Continue
                </button>
              </div>
            </div>
          )}
        </div>
      </>
    );
  };
  
  // US-001: Branching Story Dialogue Modal
  const renderBranchingDialogueModal = () => {
    if (!currentBranchingDialogue) return null;
    
    return (
      <>
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.9)',
            zIndex: 4000,
          }}
          onClick={currentBranchingDialogue.showOutcome ? closeBranchingDialogue : undefined}
        />
        <div style={{
          position: 'fixed',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%)',
          background: 'linear-gradient(145deg, rgba(45, 35, 25, 0.98) 0%, rgba(25, 15, 10, 0.99) 100%)',
          borderRadius: '20px',
          padding: '40px',
          maxWidth: '750px',
          width: '90%',
          maxHeight: '85vh',
          overflowY: 'auto',
          zIndex: 4001,
          border: '3px solid #d4af37',
          boxShadow: '0 0 60px rgba(212, 175, 55, 0.4), 0 20px 60px rgba(0,0,0,0.8)',
          animation: 'fadeIn 0.5s ease-out',
        }}>
          {/* Header */}
          <div style={{
            textAlign: 'center',
            marginBottom: '15px',
            color: '#d4af37',
            fontSize: '0.85rem',
            letterSpacing: '2px',
          }}>
            ð STORY CHOICE
          </div>
          
          <div style={{
            textAlign: 'center',
            marginBottom: '20px',
            color: '#6ba3c7',
            fontSize: '0.9rem',
          }}>
            ð {currentBranchingDialogue.location}
          </div>
          
          <h3 style={{
            textAlign: 'center',
            color: '#f4e4bc',
            fontSize: '1.8rem',
            marginBottom: '25px',
            textShadow: '0 0 20px rgba(212, 175, 55, 0.3)'
          }}>
            {currentBranchingDialogue.title}
          </h3>
          
          {/* Introduction */}
          <p style={{
            color: '#c4b89a',
            fontSize: '1.1rem',
            lineHeight: '1.8',
            textAlign: 'center',
            marginBottom: '35px',
            fontStyle: 'italic',
            padding: '0 20px',
          }}>
            {currentBranchingDialogue.introduction}
          </p>
          
          {!currentBranchingDialogue.showOutcome ? (
            /* Choices */
            <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
              {currentBranchingDialogue.choices.map((choice) => (
                <button
                  key={choice.id}
                  style={{
                    background: 'rgba(0, 0, 0, 0.5)',
                    border: '2px solid rgba(212, 175, 55, 0.5)',
                    borderRadius: '12px',
                    padding: '18px 24px',
                    color: '#e8d8c8',
                    fontSize: '1rem',
                    textAlign: 'left',
                    cursor: 'pointer',
                    transition: 'all 0.3s ease',
                  }}
                  onClick={() => handleBranchingDialogueChoice(choice)}
                  onMouseOver={(e) => {
                    e.currentTarget.style.borderColor = '#d4af37';
                    e.currentTarget.style.background = 'rgba(212, 175, 55, 0.15)';
                    e.currentTarget.style.transform = 'translateX(8px)';
                    e.currentTarget.style.boxShadow = '0 0 15px rgba(212, 175, 55, 0.3)';
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(212, 175, 55, 0.5)';
                    e.currentTarget.style.background = 'rgba(0, 0, 0, 0.5)';
                    e.currentTarget.style.transform = 'translateX(0)';
                    e.currentTarget.style.boxShadow = 'none';
                  }}
                >
                  <div style={{ marginBottom: '8px', fontWeight: 'bold' }}>{choice.text}</div>
                  <div style={{ fontSize: '0.85rem', color: '#90ee90', opacity: 0.9 }}>
                    Reward: {choice.outcome}
                  </div>
                </button>
              ))}
            </div>
          ) : (
            /* Outcome */
            <div style={{ animation: 'fadeIn 0.5s ease-out' }}>
              {/* Character Response */}
              <div style={{
                background: 'rgba(212, 175, 55, 0.1)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '20px',
                borderLeft: '4px solid #d4af37',
              }}>
                <p style={{ color: '#f4e4bc', fontSize: '1.1rem', margin: 0, lineHeight: '1.7', fontStyle: 'italic' }}>
                  "{currentBranchingDialogue.selectedChoice.response}"
                </p>
              </div>
              
              {/* Outcome Effect */}
              <div style={{
                background: 'linear-gradient(135deg, rgba(144, 238, 144, 0.2), rgba(100, 200, 100, 0.1))',
                borderRadius: '12px',
                padding: '18px 24px',
                marginBottom: '25px',
                textAlign: 'center',
                border: '1px solid rgba(144, 238, 144, 0.3)',
              }}>
                <p style={{ color: '#90ee90', fontSize: '1.1rem', margin: 0, fontWeight: 'bold' }}>
                  â¨ {currentBranchingDialogue.selectedChoice.outcome}
                </p>
              </div>
              
              {/* Story Impact */}
              {currentBranchingDialogue.selectedChoice.storyFlag && (
                <div style={{
                  textAlign: 'center',
                  marginBottom: '20px',
                  color: '#6ba3c7',
                  fontSize: '0.9rem',
                  fontStyle: 'italic'
                }}>
                  ð This choice will affect your story's ending...
                </div>
              )}
              
              {/* Continue Button */}
              <div style={{ textAlign: 'center' }}>
                <button
                  style={{
                    ...styles.button,
                    background: 'linear-gradient(145deg, #d4af37, #8b7355)',
                    borderColor: '#ffd700',
                    fontSize: '1.1rem',
                    padding: '14px 40px',
                  }}
                  onClick={closeBranchingDialogue}
                >
                  Continue Journey
                </button>
              </div>
            </div>
          )}
        </div>
      </>
    );
  };

  // Character Backstory Journal Button (shown on map)
  const renderBackstoryButton = () => {
    const unlockedCount = storyState.unlockedBackstories.length;
    if (unlockedCount === 0) return null;
    
    return (
      <button
        style={{
          position: 'fixed',
          bottom: '20px',
          right: '20px',
          background: 'linear-gradient(145deg, rgba(45, 35, 25, 0.95), rgba(25, 15, 10, 0.98))',
          border: '2px solid #d4af37',
          borderRadius: '12px',
          padding: '10px 15px',
          color: '#f4e4bc',
          fontSize: '0.9rem',
          cursor: 'pointer',
          zIndex: 100,
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          boxShadow: '0 4px 15px rgba(0,0,0,0.5)',
        }}
        onClick={() => {
          // Could expand to show full journal modal
          const backstories = getUnlockedBackstories(selectedCharacter, storyState.unlockedBackstories);
          if (backstories.length > 0) {
            setPendingBackstoryReveal(backstories[backstories.length - 1]);
          }
        }}
      >
        ð Lore ({unlockedCount}/5)
      </button>
    );
  };

  // R003 - Skill Tree Modal
  const renderSkillTreeModal = () => {
    if (!showSkillTree || !selectedCharacter) return null;
    
    const rawCharProgress = playerProgress[selectedCharacter] || {};
    // ALWAYS calculate level from XP - never trust stored level
    const actualLevel = getLevelFromXP(rawCharProgress.xp || 0);
    const charProgress = {
      ...rawCharProgress,
      level: actualLevel,
      xp: Math.max(0, Number(rawCharProgress.xp) || 0),
      skillPoints: Math.max(0, Number(rawCharProgress.skillPoints) || 0),
      unlockedSkills: Array.isArray(rawCharProgress.unlockedSkills) ? rawCharProgress.unlockedSkills : []
    };
    const tree = SKILL_TREES[selectedCharacter];
    if (!tree) return null;
    
    const handleUnlockSkill = (skill) => {
      if (!canUnlockSkill(skill, charProgress.unlockedSkills, charProgress.skillPoints)) return;
      
      setPlayerProgress(prev => {
        const updated = { ...prev };
        const existingData = updated[selectedCharacter] || {};
        const charData = {
          xp: 0,
          level: 1,
          totalXP: 0,
          skillPoints: 0,
          unlockedSkills: [],
          prestigeLevel: 0,
          gamesCompleted: 0,
          ...existingData
        };
        charData.unlockedSkills = [...(charData.unlockedSkills || []), skill.id];
        charData.skillPoints = Math.max(0, (Number(charData.skillPoints) || 0) - skill.cost);
        updated[selectedCharacter] = charData;
        savePlayerProgress(updated);
        
        // R003 - Update player's skillBonuses immediately when skill is unlocked
        const newSkillBonuses = getSkillBonuses(selectedCharacter, charData.unlockedSkills);
        setPlayer(prevPlayer => {
          if (!prevPlayer) return prevPlayer;
          const hpDiff = (newSkillBonuses.bonusHp || 0) - (prevPlayer.skillBonuses?.bonusHp || 0);
          const newMaxHp = prevPlayer.maxHp + hpDiff;
          return {
            ...prevPlayer,
            skillBonuses: newSkillBonuses,
            // Also update any stats that changed immediately
            maxHp: newMaxHp,
            // Increase current hp by the same amount when max hp increases
            hp: Math.min(prevPlayer.hp + Math.max(0, hpDiff), newMaxHp)
          };
        });
        
        return updated;
      });
    };
    
    return (
      <div 
        style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.95)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'flex-start',
          zIndex: 1000,
          overflowY: 'auto',
          padding: '20px',
        }}
        onClick={(e) => {
          // Close when clicking backdrop
          if (e.target === e.currentTarget) setShowSkillTree(false);
        }}
      >
        <div style={{
          background: 'linear-gradient(145deg, #2d1a0a, #1a0f05)',
          borderRadius: '20px',
          padding: '25px',
          maxWidth: '900px',
          width: '95%',
          margin: '20px auto',
          border: '3px solid #d4af37',
          position: 'relative',
        }}>
          {/* Fixed Close X button in corner */}
          <button
            style={{
              position: 'absolute',
              top: '10px',
              right: '10px',
              background: 'rgba(139, 0, 0, 0.8)',
              border: '2px solid #ff6b6b',
              borderRadius: '50%',
              width: '40px',
              height: '40px',
              color: '#fff',
              fontSize: '1.2rem',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 10,
            }}
            onClick={() => setShowSkillTree(false)}
          >
            â
          </button>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', paddingRight: '40px' }}>
            <h2 style={{ color: '#d4af37', margin: 0, fontSize: 'clamp(1rem, 4vw, 1.5rem)' }}>
              ð³ {tree.name}
            </h2>
            <div style={{ color: '#ffd700', fontSize: '1.1rem' }}>
              ð® {charProgress.skillPoints || 0} pts
            </div>
          </div>
          
          <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', justifyContent: 'center' }}>
            {Object.entries(tree.branches).map(([branchKey, branch]) => (
              <div key={branchKey} style={{
                background: 'rgba(0, 0, 0, 0.3)',
                borderRadius: '15px',
                padding: '15px',
                minWidth: '280px',
                maxWidth: '400px',
                flex: '1 1 280px',
                border: '2px solid rgba(212, 175, 55, 0.3)',
              }}>
                <h3 style={{ color: '#f4e4bc', marginBottom: '5px', fontSize: '1.1rem' }}>
                  {branch.icon} {branch.name}
                </h3>
                <p style={{ color: '#c4b89a', fontSize: '0.8rem', marginBottom: '12px' }}>
                  {branch.description}
                </p>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {branch.skills.map(skill => {
                    const isUnlocked = (charProgress.unlockedSkills || []).includes(skill.id);
                    const canUnlock = canUnlockSkill(skill, charProgress.unlockedSkills || [], charProgress.skillPoints || 0);
                    const isLocked = skill.requires && !(charProgress.unlockedSkills || []).includes(skill.requires);
                    
                    return (
                      <div
                        key={skill.id}
                        style={{
                          background: isUnlocked ? 'rgba(34, 139, 34, 0.3)' : 
                                     canUnlock ? 'rgba(255, 215, 0, 0.15)' : 'rgba(50, 50, 50, 0.3)',
                          border: `2px solid ${isUnlocked ? '#228b22' : canUnlock ? '#ffd700' : '#555'}`,
                          borderRadius: '10px',
                          padding: '12px',
                          cursor: canUnlock && !isUnlocked ? 'pointer' : 'default',
                          opacity: isLocked ? 0.5 : 1,
                          transition: 'all 0.2s ease',
                          minHeight: '44px', // Touch-friendly
                        }}
                        onClick={() => !isLocked && handleUnlockSkill(skill)}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '5px' }}>
                          <span style={{ color: isUnlocked ? '#90ee90' : '#f4e4bc', fontWeight: 'bold', fontSize: '0.9rem' }}>
                            {skill.name}
                          </span>
                          <span style={{ 
                            color: isUnlocked ? '#90ee90' : canUnlock ? '#ffd700' : '#888', 
                            fontSize: '0.85rem',
                            padding: '2px 8px',
                            background: isUnlocked ? 'rgba(34, 139, 34, 0.3)' : canUnlock ? 'rgba(255, 215, 0, 0.2)' : 'transparent',
                            borderRadius: '10px',
                          }}>
                            {isUnlocked ? 'â Unlocked' : isLocked ? 'ð Locked' : `${skill.cost} pts`}
                          </span>
                        </div>
                        <p style={{ color: '#c4b89a', fontSize: '0.75rem', margin: '5px 0 0' }}>
                          {skill.description}
                        </p>
                        {isLocked && (
                          <p style={{ color: '#ff6b6b', fontSize: '0.7rem', margin: '3px 0 0', fontStyle: 'italic' }}>
                            Requires previous skill
                          </p>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
          
          {/* Bottom close button for better accessibility */}
          <button
            style={{
              ...styles.button,
              marginTop: '25px',
              background: 'linear-gradient(145deg, #8b4513, #5a2d0a)',
              minHeight: '50px',
              fontSize: '1.1rem',
              width: '100%',
              maxWidth: '300px',
              display: 'block',
              margin: '25px auto 0',
            }}
            onClick={() => setShowSkillTree(false)}
          >
            Close Skill Tree
          </button>
        </div>
      </div>
    );
  };

  // R003 - Skill Tree Button (shown on map and character select)
  const renderSkillTreeButton = () => {
    if (!selectedCharacter) return null;
    const charProgress = playerProgress[selectedCharacter];
    const hasPoints = (charProgress?.skillPoints || 0) > 0;
    
    return (
      <button
        style={{
          position: 'fixed',
          bottom: '20px',
          left: '20px',
          background: hasPoints ? 
            'linear-gradient(145deg, rgba(255, 215, 0, 0.9), rgba(200, 160, 0, 0.9))' :
            'linear-gradient(145deg, rgba(45, 35, 25, 0.95), rgba(25, 15, 10, 0.98))',
          border: `2px solid ${hasPoints ? '#fff' : '#d4af37'}`,
          borderRadius: '12px',
          padding: '10px 15px',
          color: hasPoints ? '#1a0a00' : '#f4e4bc',
          fontSize: '0.9rem',
          cursor: 'pointer',
          zIndex: 100,
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          boxShadow: hasPoints ? '0 0 20px rgba(255, 215, 0, 0.5)' : '0 4px 15px rgba(0,0,0,0.5)',
          animation: hasPoints ? 'pulse 2s infinite' : 'none',
        }}
        onClick={() => setShowSkillTree(true)}
      >
        ð³ Skills {hasPoints ? `(${charProgress.skillPoints} pts!)` : ''}
      </button>
    );
  };

  return (
    <div style={styles.app}>
      <AnimationStyles />
      <div style={styles.backgroundOverlay}></div>
      <div style={styles.contentWrapper}>
        {gameState === 'menu' && renderMenu()}
        {gameState === 'character-select' && renderCharacterSelect()}
        {gameState === 'map' && renderMap()}
        {gameState === 'combat' && renderCombat()}
        {gameState === 'rewards' && renderRewards()}
        {gameState === 'deck-view' && renderDeckView()}
        {gameState === 'gameover' && renderGameOver()}
        {gameState === 'rest' && renderRestSite()}
        {gameState === 'shop' && renderShop()}
        {gameState === 'event' && renderEvent()}
        {gameState === 'victory' && renderVictory()}
      </div>
      
      {/* R001 - Story Framework Modals */}
      {renderStoryBeatModal()}
      {renderBackstoryRevealModal()}
      {renderDialogueModal()}
      {renderBranchingDialogueModal()}
      {gameState === 'map' && renderBackstoryButton()}
      
      {/* R003 - Character Progression UI */}
      {renderSkillTreeModal()}
      {(gameState === 'map' || gameState === 'combat') && renderSkillTreeButton()}
      
      {/* Boss Phase Transition Modal */}
      {showPhaseTransition && (
        <BossPhaseTransition
          phaseData={showPhaseTransition}
          onComplete={() => setShowPhaseTransition(null)}
        />
      )}
      
      {/* Ring Claimed Ending */}
      {ringClaimedEnding && (
        <RingClaimedEnding
          onRestart={() => {
            setRingClaimedEnding(false);
            setGameState('menu');
          }}
        />
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
